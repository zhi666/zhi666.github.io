<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="generator" content="Hexo 4.2.0"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><meta name="keywords" content="[object Object]"><meta name="description" content="Kubernetes高可用集群二进制部署（Runtime Containerd）Kubernetes（简称为：k8s）是Google在2014年6月开源的一个容器集群管理系统，使用Go语言开发，用于管理云平台中多个主机上的容器化的应用，Kubernetes的目标是让部署容器化的应用简单并且高效,Kubernetes提供了资源调度、部署管理、服务发现、扩容缩容、监控，维护等一整套功能，努力成为跨主机集群的自动部署、扩展以及运行应用程序容器的平台。 它支持一系列容器工具, 包括Docker、Containerd等。"><meta name="author" content="zhi666"><title>Kubernetes高可用集群二进制部署 - 逸尘秀</title><meta description="Kubernetes高可用集群二进制部署（Runtime Containerd）Kubernetes（简称为：k8s）是Google在2014年6月开源的一个容器集群管理系统，使用Go语言开发，用于管理云平台中多个主机上的容器化的应用，Kubernetes的目标是让部署容器化的应用简单并且高效,Kubernetes提供了资源调度、部署管理、服务发现、扩容缩容、监控，维护等一整套功能，努力成为跨主机"><meta property="og:type" content="article"><meta property="og:title" content="Kubernetes高可用集群二进制部署"><meta property="og:url" content="https://yc6.cool/2023/05/17/Kubernetes%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2/"><meta property="og:site_name" content="逸尘秀"><meta property="og:description" content="Kubernetes高可用集群二进制部署（Runtime Containerd）Kubernetes（简称为：k8s）是Google在2014年6月开源的一个容器集群管理系统，使用Go语言开发，用于管理云平台中多个主机上的容器化的应用，Kubernetes的目标是让部署容器化的应用简单并且高效,Kubernetes提供了资源调度、部署管理、服务发现、扩容缩容、监控，维护等一整套功能，努力成为跨主机"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2023-05-17T01:45:36.000Z"><meta property="article:modified_time" content="2023-11-01T02:25:44.539Z"><meta property="article:author" content="zhi666"><meta property="article:tag" content="Kubernetes"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://yc6.cool/img/avatar.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://yc6.cool/2023/05/17/Kubernetes%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2/"},"headline":"Kubernetes高可用集群二进制部署","image":["https://yc6.cool/img/avatar.png"],"datePublished":"2023-05-17T01:45:36.000Z","dateModified":"2023-11-01T02:25:44.539Z","author":{"@type":"Person","name":"zhi666"},"description":"Kubernetes高可用集群二进制部署（Runtime Containerd）Kubernetes（简称为：k8s）是Google在2014年6月开源的一个容器集群管理系统，使用Go语言开发，用于管理云平台中多个主机上的容器化的应用，Kubernetes的目标是让部署容器化的应用简单并且高效,Kubernetes提供了资源调度、部署管理、服务发现、扩容缩容、监控，维护等一整套功能，努力成为跨主机"}</script><link rel="alternative" href="/atom.xml" title="逸尘秀" type="application/atom+xml"><link rel="icon" href="/img/favicon.png"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css?family=Ubuntu:400,600|Source+Code+Pro|Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Microsoft YaHei:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&amp;amp;subset=latin,latin-ext|Inconsolata|Itim|Lobster.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/atom-one-dark.min.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.12/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><link rel="stylesheet" href="/css/style.css"><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="/js/globalUtils.js"></script><link rel="stylesheet" href="/live2d/waifu.css"><script type="text/javascript" async src="/live2d/autoload.js"></script></head><body class="is-3-column has-navbar-fixed-top"><nav class="navbar navbar-main is-fixed-top"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.png" alt="逸尘秀" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/media">影音</a><a class="navbar-item" href="/album">相册</a><a class="navbar-item" href="/friend">友链</a><a class="navbar-item" href="/self-talking">碎碎念</a><a class="navbar-item" href="/message">留言</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/zhi666"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a><a class="navbar-item" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon" id="night-icon"></i></a></div></div></div></nav><script type="text/javascript" src="/js/theme-setting.js"></script><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2023-05-17  <a class="commentCountImg" href="/2023/05/17/Kubernetes%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2/#comment-container"><span class="display-none-class">0c6016ad13db3099cdedc763e113d194</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="0c6016ad13db3099cdedc763e113d194">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>1 小时  <i class="fas fa-pencil-alt"> </i>8.3 k</span><span class="level-item" id="busuanzi_container_page_pv"><i class="far fa-eye"></i>&nbsp;&nbsp;<span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">Kubernetes高可用集群二进制部署</h1><div class="content"><h1 id="Kubernetes高可用集群二进制部署（Runtime-Containerd）"><a href="#Kubernetes高可用集群二进制部署（Runtime-Containerd）" class="headerlink" title="Kubernetes高可用集群二进制部署（Runtime Containerd）"></a>Kubernetes高可用集群二进制部署（Runtime Containerd）</h1><p>Kubernetes（简称为：k8s）是Google在2014年6月开源的一个容器集群管理系统，使用Go语言开发，用于管理云平台中多个主机上的容器化的应用，Kubernetes的目标是让部署容器化的应用简单并且高效,Kubernetes提供了资源调度、部署管理、服务发现、扩容缩容、监控，维护等一整套功能，努力成为跨主机集群的自动部署、扩展以及运行应用程序容器的平台。 它支持一系列容器工具, 包括Docker、Containerd等。</p>
<a id="more"></a>

<h1 id="一、集群环境准备"><a href="#一、集群环境准备" class="headerlink" title="一、集群环境准备"></a>一、集群环境准备</h1><h2 id="1-1-主机规划"><a href="#1-1-主机规划" class="headerlink" title="1.1 主机规划"></a>1.1 主机规划</h2><table>
<thead>
<tr>
<th>主机IP地址</th>
<th>主机名</th>
<th>主机配置</th>
<th>主机角色</th>
<th>软件列表</th>
</tr>
</thead>
<tbody><tr>
<td>192.168.224.12</td>
<td>k8s-master1</td>
<td>2C4G</td>
<td>master</td>
<td>kube-apiserver、kube-controller-manager、kube-scheduler、etcd、kubelet、kube-proxy、Containerd、runc</td>
</tr>
<tr>
<td>192.168.224.13</td>
<td>k8s-master2</td>
<td>2C4G</td>
<td>master</td>
<td>kube-apiserver、kube-controller-manager、kube-scheduler、etcd、kubelet、kube-proxy、Containerd、runc</td>
</tr>
<tr>
<td>192.168.224.14</td>
<td>k8s-master3</td>
<td>2C4G</td>
<td>master</td>
<td>kube-apiserver、kube-controller-manager、kube-scheduler、etcd、kubelet、kube-proxy、Containerd、runc</td>
</tr>
<tr>
<td>192.168.224.15</td>
<td>k8s-worker1</td>
<td>2C4G</td>
<td>worker</td>
<td>kubelet、kube-proxy、Containerd、runc</td>
</tr>
<tr>
<td>192.168.224.10</td>
<td>ha1</td>
<td>1C2G</td>
<td>LB</td>
<td>haproxy、keepalived</td>
</tr>
<tr>
<td>192.168.224.11</td>
<td>ha2</td>
<td>1C2G</td>
<td>LB</td>
<td>haproxy、keepalived</td>
</tr>
<tr>
<td>192.168.224.100</td>
<td>/</td>
<td>/</td>
<td>VIP(虚拟IP)</td>
<td></td>
</tr>
</tbody></table>
<h2 id="1-2-软件版本"><a href="#1-2-软件版本" class="headerlink" title="1.2 软件版本"></a>1.2 软件版本</h2><table>
<thead>
<tr>
<th>软件名称</th>
<th>版本</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>CentOS7</td>
<td>kernel版本：5.17</td>
<td></td>
</tr>
<tr>
<td>kubernetes</td>
<td>v1.21.10</td>
<td></td>
</tr>
<tr>
<td>etcd</td>
<td>v3.5.2</td>
<td>最新版本</td>
</tr>
<tr>
<td>calico</td>
<td>v3.19.4</td>
<td></td>
</tr>
<tr>
<td>coredns</td>
<td>v1.8.4</td>
<td></td>
</tr>
<tr>
<td>containerd</td>
<td>1.6.1</td>
<td></td>
</tr>
<tr>
<td>runc</td>
<td>1.1.0</td>
<td></td>
</tr>
<tr>
<td>haproxy</td>
<td>5.18</td>
<td>YUM源默认</td>
</tr>
<tr>
<td>keepalived</td>
<td>3.5</td>
<td>YUM源默认</td>
</tr>
</tbody></table>
<h2 id="1-3-网络分配"><a href="#1-3-网络分配" class="headerlink" title="1.3 网络分配"></a>1.3 网络分配</h2><table>
<thead>
<tr>
<th>网络名称</th>
<th>网段</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>Node网络</td>
<td>192.168.224.0/24</td>
<td></td>
</tr>
<tr>
<td>Service网络</td>
<td>10.96.0.0/16</td>
<td></td>
</tr>
<tr>
<td>Pod网络</td>
<td>10.244.0.0/16</td>
<td></td>
</tr>
</tbody></table>
<h1 id="二、集群部署"><a href="#二、集群部署" class="headerlink" title="二、集群部署"></a>二、集群部署</h1><h2 id="2-1主机准备"><a href="#2-1主机准备" class="headerlink" title="2.1主机准备"></a>2.1主机准备</h2><h3 id="2-1-1-主机名设置"><a href="#2-1-1-主机名设置" class="headerlink" title="2.1.1 主机名设置"></a>2.1.1 主机名设置</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl <span class="built_in">set-hostname</span> xxx</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">关于主机名参见<span class="number">1.1</span>小节主机规划表</span><br></pre></td></tr></table></figure>



<h3 id="2-1-2-主机与IP地址解析"><a href="#2-1-2-主机与IP地址解析" class="headerlink" title="2.1.2 主机与IP地址解析"></a>2.1.2 主机与IP地址解析</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt; EOF</span><br><span class="line"><span class="number">192.168</span>.<span class="number">224.10</span> ha1</span><br><span class="line"><span class="number">192.168</span>.<span class="number">224.11</span> ha2</span><br><span class="line"><span class="number">192.168</span>.<span class="number">224.12</span> k8s<span class="literal">-master1</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">224.13</span> k8s<span class="literal">-master2</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">224.14</span> k8s<span class="literal">-master3</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">224.15</span> k8s<span class="literal">-worker1</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h3 id="2-1-3-主机安全设置"><a href="#2-1-3-主机安全设置" class="headerlink" title="2.1.3 主机安全设置"></a>2.1.3 主机安全设置</h3><h4 id="2-1-3-1-关闭防火墙"><a href="#2-1-3-1-关闭防火墙" class="headerlink" title="2.1.3.1 关闭防火墙"></a>2.1.3.1 关闭防火墙</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systmctl disable firewalld</span><br><span class="line">firewall<span class="literal">-cmd</span> -<span class="literal">-state</span></span><br></pre></td></tr></table></figure>



<h4 id="2-1-3-2-关闭selinux"><a href="#2-1-3-2-关闭selinux" class="headerlink" title="2.1.3.2 关闭selinux"></a>2.1.3.2 关闭selinux</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setenforce <span class="number">0</span></span><br><span class="line">sed <span class="literal">-ri</span> <span class="string">'s/SELINUX=enforcing/SELINUX=disabled/'</span> /etc/selinux/config</span><br><span class="line">sestatus</span><br></pre></td></tr></table></figure>





<h3 id="2-1-4-交换分区设置"><a href="#2-1-4-交换分区设置" class="headerlink" title="2.1.4 交换分区设置"></a>2.1.4 交换分区设置</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">swapoff <span class="literal">-a</span></span><br><span class="line">sed <span class="literal">-ri</span> <span class="string">'s/.*swap.*/#&amp;/'</span> /etc/fstab</span><br><span class="line">echo <span class="string">"vm.swappiness=0"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line">sysctl <span class="literal">-p</span></span><br></pre></td></tr></table></figure>



<h3 id="2-1-5-主机系统时间同步"><a href="#2-1-5-主机系统时间同步" class="headerlink" title="2.1.5 主机系统时间同步"></a>2.1.5 主机系统时间同步</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">安装软件</span><br><span class="line">yum <span class="literal">-y</span> install ntpdate</span><br><span class="line"></span><br><span class="line">制定时间同步计划任务</span><br><span class="line">crontab <span class="literal">-e</span></span><br><span class="line"><span class="number">0</span> */<span class="number">1</span> * * * ntpdate time1.aliyun.com</span><br></pre></td></tr></table></figure>



<h3 id="2-1-6-主机系统优化"><a href="#2-1-6-主机系统优化" class="headerlink" title="2.1.6 主机系统优化"></a>2.1.6 主机系统优化</h3><blockquote>
<p>limit优化</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ulimit <span class="literal">-SHn</span> <span class="number">65535</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt;&gt; /etc/security/limits.conf</span><br><span class="line">* soft nofile <span class="number">655360</span></span><br><span class="line">* hard nofile <span class="number">131072</span></span><br><span class="line">* soft nproc <span class="number">655350</span></span><br><span class="line">* hard nproc <span class="number">655350</span></span><br><span class="line">* soft memlock unlimited</span><br><span class="line">* hard memlock unlimited</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h3 id="2-1-7-ipvs管理工具安装及模块加载"><a href="#2-1-7-ipvs管理工具安装及模块加载" class="headerlink" title="2.1.7 ipvs管理工具安装及模块加载"></a>2.1.7 ipvs管理工具安装及模块加载</h3><blockquote>
<p>为集群节点安装，负载均衡节点不用安装</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="literal">-y</span> install ipvsadm ipset sysstat conntrack libseccomp</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">所有节点配置ipvs模块，在内核<span class="number">4.19</span>+版本nf_conntrack_ipv4已经改为nf_conntrack， <span class="number">4.18</span>以下使用nf_conntrack_ipv4即可： </span><br><span class="line"> </span><br><span class="line">modprobe -- ip_vs </span><br><span class="line">modprobe -- ip_vs_rr </span><br><span class="line">modprobe -- ip_vs_wrr </span><br><span class="line">modprobe -- ip_vs_sh </span><br><span class="line">modprobe -- nf_conntrack</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">创建 /etc/modules<span class="literal">-load</span>.d/ipvs.conf 并加入以下内容： </span><br><span class="line">cat &gt;/etc/modules<span class="literal">-load</span>.d/ipvs.conf &lt;&lt;EOF </span><br><span class="line">ip_vs </span><br><span class="line">ip_vs_lc </span><br><span class="line">ip_vs_wlc </span><br><span class="line">ip_vs_rr </span><br><span class="line">ip_vs_wrr </span><br><span class="line">ip_vs_lblc </span><br><span class="line">ip_vs_lblcr </span><br><span class="line">ip_vs_dh </span><br><span class="line">ip_vs_sh </span><br><span class="line">ip_vs_fo </span><br><span class="line">ip_vs_nq </span><br><span class="line">ip_vs_sed </span><br><span class="line">ip_vs_ftp </span><br><span class="line">ip_vs_sh </span><br><span class="line">nf_conntrack </span><br><span class="line">ip_tables </span><br><span class="line">ip_set </span><br><span class="line">xt_set </span><br><span class="line">ipt_set </span><br><span class="line">ipt_rpfilter </span><br><span class="line">ipt_REJECT </span><br><span class="line">ipip </span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h3 id="2-1-8-加载containerd相关内核模块"><a href="#2-1-8-加载containerd相关内核模块" class="headerlink" title="2.1.8 加载containerd相关内核模块"></a>2.1.8 加载containerd相关内核模块</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">临时加载模块</span><br><span class="line"></span><br><span class="line">modprobe overlay</span><br><span class="line">modprobe br_netfilter</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">永久性加载模块</span><br><span class="line"></span><br><span class="line">cat &gt; /etc/modules<span class="literal">-load</span>.d/containerd.conf &lt;&lt; EOF</span><br><span class="line">overlay</span><br><span class="line">br_netfilter</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">设置为开机启动</span><br><span class="line">systemctl enable -<span class="literal">-now</span> systemd<span class="literal">-modules</span><span class="literal">-load</span>.service</span><br></pre></td></tr></table></figure>



<h3 id="2-1-9-Linux内核升级"><a href="#2-1-9-Linux内核升级" class="headerlink" title="2.1.9 Linux内核升级"></a>2.1.9 Linux内核升级</h3><blockquote>
<p>在所有节点中安装,需要重新操作系统更换内核。</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># yum -y install perl</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># yum -y install https://www.elrepo.org/elrepo-release-7.0-4.el7.elrepo.noarch.rpm</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># yum  --enablerepo="elrepo-kernel"  -y install kernel-ml.x86_64</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># grub2-set-default 0</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># grub2-mkconfig -o /boot/grub2/grub.cfg</span></span><br></pre></td></tr></table></figure>





<h3 id="2-1-10-Linux内核优化"><a href="#2-1-10-Linux内核优化" class="headerlink" title="2.1.10 Linux内核优化"></a>2.1.10 Linux内核优化</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/sysctl.d/k8s.conf</span><br><span class="line">net.ipv4.ip_forward = <span class="number">1</span></span><br><span class="line">net.bridge.bridge<span class="literal">-nf</span><span class="literal">-call</span><span class="literal">-iptables</span> = <span class="number">1</span></span><br><span class="line">net.bridge.bridge<span class="literal">-nf</span><span class="literal">-call</span><span class="literal">-ip6tables</span> = <span class="number">1</span></span><br><span class="line">fs.may_detach_mounts = <span class="number">1</span></span><br><span class="line">vm.overcommit_memory=<span class="number">1</span></span><br><span class="line">vm.panic_on_oom=<span class="number">0</span></span><br><span class="line">fs.inotify.max_user_watches=<span class="number">89100</span></span><br><span class="line">fs.file<span class="literal">-max</span>=<span class="number">52706963</span></span><br><span class="line">fs.nr_open=<span class="number">52706963</span></span><br><span class="line">net.netfilter.nf_conntrack_max=<span class="number">2310720</span></span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_keepalive_time = <span class="number">600</span></span><br><span class="line">net.ipv4.tcp_keepalive_probes = <span class="number">3</span></span><br><span class="line">net.ipv4.tcp_keepalive_intvl =<span class="number">15</span></span><br><span class="line">net.ipv4.tcp_max_tw_buckets = <span class="number">36000</span></span><br><span class="line">net.ipv4.tcp_tw_reuse = <span class="number">1</span></span><br><span class="line">net.ipv4.tcp_max_orphans = <span class="number">327680</span></span><br><span class="line">net.ipv4.tcp_orphan_retries = <span class="number">3</span></span><br><span class="line">net.ipv4.tcp_syncookies = <span class="number">1</span></span><br><span class="line">net.ipv4.tcp_max_syn_backlog = <span class="number">16384</span></span><br><span class="line">net.ipv4.ip_conntrack_max = <span class="number">131072</span></span><br><span class="line">net.ipv4.tcp_max_syn_backlog = <span class="number">16384</span></span><br><span class="line">net.ipv4.tcp_timestamps = <span class="number">0</span></span><br><span class="line">net.core.somaxconn = <span class="number">16384</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -<span class="literal">-system</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">所有节点配置完内核后，重启服务器，保证重启后内核依旧加载</span><br><span class="line">reboot <span class="literal">-h</span> now</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">重启后查看ipvs模块加载情况：</span><br><span class="line">lsmod | grep -<span class="literal">-color</span>=auto <span class="literal">-e</span> ip_vs <span class="literal">-e</span> nf_conntrack</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">重启后查看containerd相关模块加载情况：</span><br><span class="line">lsmod | egrep <span class="string">'br_netfilter | overlay'</span></span><br></pre></td></tr></table></figure>





<h3 id="2-1-11-其它工具安装-选装"><a href="#2-1-11-其它工具安装-选装" class="headerlink" title="2.1.11 其它工具安装(选装)"></a>2.1.11 其它工具安装(选装)</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install wget jq psmisc vim net<span class="literal">-tools</span> telnet yum<span class="literal">-utils</span> device<span class="literal">-mapper</span><span class="literal">-persistent</span><span class="literal">-data</span> lvm2 git lrzsz <span class="literal">-y</span></span><br></pre></td></tr></table></figure>





<h2 id="2-2-负载均衡器准备"><a href="#2-2-负载均衡器准备" class="headerlink" title="2.2 负载均衡器准备"></a>2.2 负载均衡器准备</h2><h3 id="2-2-1-安装haproxy与keepalived"><a href="#2-2-1-安装haproxy与keepalived" class="headerlink" title="2.2.1 安装haproxy与keepalived"></a>2.2.1 安装haproxy与keepalived</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="literal">-y</span> install haproxy keepalived</span><br></pre></td></tr></table></figure>



<h3 id="2-2-2-HAProxy配置"><a href="#2-2-2-HAProxy配置" class="headerlink" title="2.2.2 HAProxy配置"></a>2.2.2 HAProxy配置</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/etc/haproxy/haproxy.cfg&lt;&lt;<span class="string">"EOF"</span></span><br><span class="line">global</span><br><span class="line"> maxconn <span class="number">2000</span></span><br><span class="line"> u<span class="built_in">limit-n</span> <span class="number">16384</span></span><br><span class="line"> log <span class="number">127.0</span>.<span class="number">0.1</span> local0 err</span><br><span class="line"> stats timeout <span class="number">30</span>s</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line"> log global</span><br><span class="line"> mode http</span><br><span class="line"> option httplog</span><br><span class="line"> timeout connect <span class="number">5000</span></span><br><span class="line"> timeout client <span class="number">50000</span></span><br><span class="line"> timeout server <span class="number">50000</span></span><br><span class="line"> timeout http<span class="literal">-request</span> <span class="number">15</span>s</span><br><span class="line"> timeout http<span class="literal">-keep</span><span class="literal">-alive</span> <span class="number">15</span>s</span><br><span class="line"></span><br><span class="line">frontend monitor<span class="operator">-in</span></span><br><span class="line"> bind *:<span class="number">33305</span></span><br><span class="line"> mode http</span><br><span class="line"> option httplog</span><br><span class="line"> monitor<span class="literal">-uri</span> /monitor</span><br><span class="line"></span><br><span class="line">frontend k8s<span class="literal">-master</span></span><br><span class="line"> bind <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">6443</span></span><br><span class="line"> bind <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6443</span></span><br><span class="line"> mode tcp</span><br><span class="line"> option tcplog</span><br><span class="line"> tcp<span class="literal">-request</span> inspect<span class="literal">-delay</span> <span class="number">5</span>s</span><br><span class="line"> default_backend k8s<span class="literal">-master</span></span><br><span class="line"></span><br><span class="line">backend k8s<span class="literal">-master</span></span><br><span class="line"> mode tcp</span><br><span class="line"> option tcplog</span><br><span class="line"> option tcp<span class="literal">-check</span></span><br><span class="line"> balance roundrobin</span><br><span class="line"> default<span class="literal">-server</span> inter <span class="number">10</span>s downinter <span class="number">5</span>s rise <span class="number">2</span> fall <span class="number">2</span> slowstart <span class="number">60</span>s maxconn <span class="number">250</span> maxqueue <span class="number">256</span> weight <span class="number">100</span></span><br><span class="line"> server  k8s<span class="literal">-master1</span>  <span class="number">192.168</span>.<span class="number">224.12</span>:<span class="number">6443</span> check</span><br><span class="line"> server  k8s<span class="literal">-master2</span>  <span class="number">192.168</span>.<span class="number">224.13</span>:<span class="number">6443</span> check</span><br><span class="line"> server  k8s<span class="literal">-master3</span>  <span class="number">192.168</span>.<span class="number">224.14</span>:<span class="number">6443</span> check</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h3 id="2-2-3-KeepAlived"><a href="#2-2-3-KeepAlived" class="headerlink" title="2.2.3 KeepAlived"></a>2.2.3 KeepAlived</h3><blockquote>
<p>主从配置不一致，需要注意。</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">ha1:</span><br><span class="line"></span><br><span class="line">cat &gt;/etc/keepalived/keepalived.conf&lt;&lt;<span class="string">"EOF"</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">script_user root</span><br><span class="line">   enable_script_security</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_apiserver &#123;</span><br><span class="line">   script <span class="string">"/etc/keepalived/check_apiserver.sh"</span></span><br><span class="line">   interval <span class="number">5</span></span><br><span class="line">   weight <span class="literal">-5</span></span><br><span class="line">   fall <span class="number">2</span> </span><br><span class="line">rise <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">   state MASTER</span><br><span class="line">   interface ens33</span><br><span class="line">   mcast_src_ip <span class="number">192.168</span>.<span class="number">224.10</span></span><br><span class="line">   virtual_router_id <span class="number">51</span></span><br><span class="line">   priority <span class="number">100</span></span><br><span class="line">   advert_int <span class="number">2</span></span><br><span class="line">   authentication &#123;</span><br><span class="line">       auth_type PASS</span><br><span class="line">       auth_pass K8SHA_KA_AUTH</span><br><span class="line">   &#125;</span><br><span class="line">   virtual_ipaddress &#123;</span><br><span class="line">       <span class="number">192.168</span>.<span class="number">224.100</span></span><br><span class="line">   &#125;</span><br><span class="line">   track_script &#123;</span><br><span class="line">      chk_apiserver</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">ha2:</span><br><span class="line"></span><br><span class="line">cat &gt;/etc/keepalived/keepalived.conf&lt;&lt;<span class="string">"EOF"</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">script_user root</span><br><span class="line">   enable_script_security</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_apiserver &#123;</span><br><span class="line">   script <span class="string">"/etc/keepalived/check_apiserver.sh"</span></span><br><span class="line">  interval <span class="number">5</span></span><br><span class="line">   weight <span class="literal">-5</span></span><br><span class="line">   fall <span class="number">2</span> </span><br><span class="line">rise <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">   state BACKUP</span><br><span class="line">   interface ens33</span><br><span class="line">   mcast_src_ip <span class="number">192.168</span>.<span class="number">224.11</span></span><br><span class="line">   virtual_router_id <span class="number">51</span></span><br><span class="line">   priority <span class="number">99</span></span><br><span class="line">   advert_int <span class="number">2</span></span><br><span class="line">   authentication &#123;</span><br><span class="line">       auth_type PASS</span><br><span class="line">       auth_pass K8SHA_KA_AUTH</span><br><span class="line">   &#125;</span><br><span class="line">   virtual_ipaddress &#123;</span><br><span class="line">       <span class="number">192.168</span>.<span class="number">224.100</span></span><br><span class="line">   &#125;</span><br><span class="line">   track_script &#123;</span><br><span class="line">      chk_apiserver</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h3 id="2-2-4-健康检查脚本"><a href="#2-2-4-健康检查脚本" class="headerlink" title="2.2.4 健康检查脚本"></a>2.2.4 健康检查脚本</h3><blockquote>
<p>ha1及ha2均要配置</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/keepalived/check_apiserver.sh &lt;&lt;<span class="string">"EOF"</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">err=<span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> <span class="variable">$</span>(seq <span class="number">1</span> <span class="number">3</span>)</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">   check_code=<span class="variable">$</span>(pgrep haproxy)</span><br><span class="line">   <span class="keyword">if</span> [[ <span class="variable">$check_code</span> == <span class="string">""</span> ]]; then</span><br><span class="line">       err=<span class="variable">$</span>(expr <span class="variable">$err</span> + <span class="number">1</span>)</span><br><span class="line">       sleep <span class="number">1</span></span><br><span class="line">       <span class="keyword">continue</span></span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line">       err=<span class="number">0</span></span><br><span class="line">       <span class="keyword">break</span></span><br><span class="line">   fi</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$err</span> != <span class="string">"0"</span> ]]; then</span><br><span class="line">   echo <span class="string">"systemctl stop keepalived"</span></span><br><span class="line">   /usr/bin/systemctl stop keepalived</span><br><span class="line">   <span class="keyword">exit</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">   <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">fi</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /etc/keepalived/check_apiserver.sh</span><br></pre></td></tr></table></figure>



<h3 id="2-2-5-启动服务并验证"><a href="#2-2-5-启动服务并验证" class="headerlink" title="2.2.5 启动服务并验证"></a>2.2.5 启动服务并验证</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon<span class="literal">-reload</span></span><br><span class="line">systemctl enable -<span class="literal">-now</span> haproxy</span><br><span class="line">systemctl enable -<span class="literal">-now</span> keepalived</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip address show</span><br></pre></td></tr></table></figure>



<h2 id="2-3-配置免密登录"><a href="#2-3-配置免密登录" class="headerlink" title="2.3 配置免密登录"></a>2.3 配置免密登录</h2><blockquote>
<p>在k8s-master1上操作</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh<span class="literal">-keygen</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ssh<span class="literal">-copy</span><span class="literal">-id</span> root@k8s<span class="literal">-master1</span></span><br><span class="line">ssh<span class="literal">-copy</span><span class="literal">-id</span> root@k8s<span class="literal">-master2</span></span><br><span class="line">ssh<span class="literal">-copy</span><span class="literal">-id</span> root@k8s<span class="literal">-master3</span></span><br><span class="line">ssh<span class="literal">-copy</span><span class="literal">-id</span> root@k8s<span class="literal">-worker1</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh root@k8s<span class="literal">-master1</span></span><br></pre></td></tr></table></figure>



<h2 id="2-4-部署ETCD集群"><a href="#2-4-部署ETCD集群" class="headerlink" title="2.4 部署ETCD集群"></a>2.4 部署ETCD集群</h2><p>部署高可用ETCD数据库集群</p>
<blockquote>
<p>在k8s-master1上操作。</p>
</blockquote>
<h3 id="2-4-1-创建工作目录"><a href="#2-4-1-创建工作目录" class="headerlink" title="2.4.1 创建工作目录"></a>2.4.1 创建工作目录</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir <span class="literal">-p</span> /<span class="keyword">data</span>/k8s<span class="literal">-work</span></span><br></pre></td></tr></table></figure>



<h3 id="2-4-2-获取cfssl工具"><a href="#2-4-2-获取cfssl工具" class="headerlink" title="2.4.2 获取cfssl工具"></a>2.4.2 获取cfssl工具</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /<span class="keyword">data</span>/k8s<span class="literal">-work</span></span><br><span class="line">wget https://pkg.cfssl.org/R1.<span class="number">2</span>/cfssl_linux<span class="literal">-amd64</span></span><br><span class="line">wget https://pkg.cfssl.org/R1.<span class="number">2</span>/cfssljson_linux<span class="literal">-amd64</span></span><br><span class="line">wget https://pkg.cfssl.org/R1.<span class="number">2</span>/cfssl<span class="literal">-certinfo_linux</span><span class="literal">-amd64</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">说明：</span><br><span class="line">cfssl是使用go编写，由CloudFlare开源的一款PKI/TLS工具。主要程序有：</span><br><span class="line"></span><br><span class="line">- cfssl，是CFSSL的命令行工具</span><br><span class="line">- cfssljson用来从cfssl程序获取JSON输出，并将证书，密钥，CSR和bundle写入文件中。</span><br></pre></td></tr></table></figure>





<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x cfssl*</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mv cfssl_linux<span class="literal">-amd64</span> /usr/local/bin/cfssl</span><br><span class="line">mv cfssljson_linux<span class="literal">-amd64</span> /usr/local/bin/cfssljson</span><br><span class="line">mv cfssl<span class="literal">-certinfo_linux</span><span class="literal">-amd64</span> /usr/local/bin/cfssl<span class="literal">-certinfo</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cfssl version</span></span><br><span class="line">Version: <span class="number">1.2</span>.<span class="number">0</span></span><br><span class="line">Revision: dev</span><br><span class="line">Runtime: go1.<span class="number">6</span></span><br></pre></td></tr></table></figure>





<h3 id="2-4-3-创建CA证书"><a href="#2-4-3-创建CA证书" class="headerlink" title="2.4.3 创建CA证书"></a>2.4.3 创建CA证书</h3><h4 id="2-4-3-1-配置ca证书请求文件"><a href="#2-4-3-1-配置ca证书请求文件" class="headerlink" title="2.4.3.1 配置ca证书请求文件"></a>2.4.3.1 配置ca证书请求文件</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ca<span class="literal">-csr</span>.json &lt;&lt;<span class="string">"EOF"</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">      <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">      <span class="string">"size"</span>: <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"kubemsb"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"CN"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"ca"</span>: &#123;</span><br><span class="line">          <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h4 id="2-4-3-2-创建ca证书"><a href="#2-4-3-2-创建ca证书" class="headerlink" title="2.4.3.2 创建ca证书"></a>2.4.3.2 创建ca证书</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert <span class="literal">-initca</span> ca<span class="literal">-csr</span>.json | cfssljson <span class="literal">-bare</span> ca</span><br></pre></td></tr></table></figure>



<h4 id="2-4-3-3-配置ca证书策略"><a href="#2-4-3-3-配置ca证书策略" class="headerlink" title="2.4.3.3 配置ca证书策略"></a>2.4.3.3 配置ca证书策略</h4><p>可以选择这个方式</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl print<span class="literal">-defaults</span> config &gt; ca<span class="literal">-config</span>.json</span><br></pre></td></tr></table></figure>

<p>或者这个</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ca<span class="literal">-config</span>.json &lt;&lt;<span class="string">"EOF"</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"signing"</span>: &#123;</span><br><span class="line">      <span class="string">"default"</span>: &#123;</span><br><span class="line">          <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">        &#125;,</span><br><span class="line">      <span class="string">"profiles"</span>: &#123;</span><br><span class="line">          <span class="string">"kubernetes"</span>: &#123;</span><br><span class="line">              <span class="string">"usages"</span>: [</span><br><span class="line">                  <span class="string">"signing"</span>,</span><br><span class="line">                  <span class="string">"key encipherment"</span>,</span><br><span class="line">                  <span class="string">"server auth"</span>,</span><br><span class="line">                  <span class="string">"client auth"</span></span><br><span class="line">              ],</span><br><span class="line">              <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server auth 表示client可以对使用该ca对server提供的证书进行验证</span><br><span class="line"></span><br><span class="line">client auth 表示server可以使用该ca对client提供的证书进行验证</span><br></pre></td></tr></table></figure>





<h3 id="2-4-4-创建etcd证书"><a href="#2-4-4-创建etcd证书" class="headerlink" title="2.4.4 创建etcd证书"></a>2.4.4 创建etcd证书</h3><h4 id="2-4-4-1-配置etcd请求文件"><a href="#2-4-4-1-配置etcd请求文件" class="headerlink" title="2.4.4.1 配置etcd请求文件"></a>2.4.4.1 配置etcd请求文件</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; etcd<span class="literal">-csr</span>.json &lt;&lt;<span class="string">"EOF"</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"etcd"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [</span><br><span class="line">    <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"192.168.224.12"</span>,</span><br><span class="line">    <span class="string">"192.168.224.13"</span>,</span><br><span class="line">    <span class="string">"192.168.224.14"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [&#123;</span><br><span class="line">    <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">    <span class="string">"ST"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">    <span class="string">"L"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">    <span class="string">"O"</span>: <span class="string">"kubemsb"</span>,</span><br><span class="line">    <span class="string">"OU"</span>: <span class="string">"CN"</span></span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h4 id="2-4-4-2-生成etcd证书"><a href="#2-4-4-2-生成etcd证书" class="headerlink" title="2.4.4.2 生成etcd证书"></a>2.4.4.2 生成etcd证书</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert <span class="literal">-ca</span>=ca.pem <span class="literal">-ca</span><span class="literal">-key</span>=ca<span class="literal">-key</span>.pem <span class="literal">-config</span>=ca<span class="literal">-config</span>.json <span class="literal">-profile</span>=kubernetes etcd<span class="literal">-csr</span>.json | cfssljson  <span class="literal">-bare</span> etcd</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ls</span></span><br><span class="line">输出</span><br><span class="line">ca<span class="literal">-config</span>.json  ca.csr  ca<span class="literal">-csr</span>.json  ca<span class="literal">-key</span>.pem  ca.pem  etcd.csr  etcd<span class="literal">-csr</span>.json  etcd<span class="literal">-key</span>.pem  etcd.pem</span><br></pre></td></tr></table></figure>



<h3 id="2-4-5-部署etcd集群"><a href="#2-4-5-部署etcd集群" class="headerlink" title="2.4.5  部署etcd集群"></a>2.4.5  部署etcd集群</h3><h4 id="2-4-5-1-下载etcd软件包"><a href="#2-4-5-1-下载etcd软件包" class="headerlink" title="2.4.5.1 下载etcd软件包"></a>2.4.5.1 下载etcd软件包</h4><p><a href="https://imgse.com/i/p9BSjN6"><img src="https://s1.ax1x.com/2023/05/09/p9BSjN6.png" alt="p9BSjN6.png"></a></p>
<p><a href="https://imgse.com/i/p9BpS3D"><img src="https://s1.ax1x.com/2023/05/09/p9BpS3D.png" alt="p9BpS3D.png"></a></p>
<p><a href="https://imgse.com/i/p9BpPud"><img src="https://s1.ax1x.com/2023/05/09/p9BpPud.png" alt="p9BpPud.png"></a></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/etcd<span class="literal">-io</span>/etcd/releases/download/v3.<span class="number">5.2</span>/etcd<span class="literal">-v3</span>.<span class="number">5.2</span><span class="literal">-linux</span><span class="literal">-amd64</span>.tar.gz</span><br></pre></td></tr></table></figure>



<h4 id="2-4-5-2-安装etcd软件"><a href="#2-4-5-2-安装etcd软件" class="headerlink" title="2.4.5.2 安装etcd软件"></a>2.4.5.2 安装etcd软件</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar <span class="literal">-xvf</span> etcd<span class="literal">-v3</span>.<span class="number">5.2</span><span class="literal">-linux</span><span class="literal">-amd64</span>.tar.gz</span><br><span class="line">cp <span class="literal">-p</span> etcd<span class="literal">-v3</span>.<span class="number">5.2</span><span class="literal">-linux</span><span class="literal">-amd64</span>/etcd* /usr/local/bin/</span><br></pre></td></tr></table></figure>





<h4 id="2-4-5-3-分发etcd软件"><a href="#2-4-5-3-分发etcd软件" class="headerlink" title="2.4.5.3 分发etcd软件"></a>2.4.5.3 分发etcd软件</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scp etcd<span class="literal">-v3</span>.<span class="number">5.2</span><span class="literal">-linux</span><span class="literal">-amd64</span>/etcd* k8s<span class="literal">-master2</span>:/usr/local/bin/</span><br><span class="line"></span><br><span class="line">scp etcd<span class="literal">-v3</span>.<span class="number">5.2</span><span class="literal">-linux</span><span class="literal">-amd64</span>/etcd* k8s<span class="literal">-master3</span>:/usr/local/bin/</span><br></pre></td></tr></table></figure>





<h4 id="2-4-5-4-创建配置文件"><a href="#2-4-5-4-创建配置文件" class="headerlink" title="2.4.5.4 创建配置文件"></a>2.4.5.4 创建配置文件</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/etcd</span><br></pre></td></tr></table></figure>





<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;  /etc/etcd/etcd.conf &lt;&lt;<span class="string">"EOF"</span></span><br><span class="line"><span class="comment">#[Member]</span></span><br><span class="line">ETCD_NAME=<span class="string">"etcd1"</span></span><br><span class="line">ETCD_DATA_DIR=<span class="string">"/var/lib/etcd/default.etcd"</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">"https://192.168.224.12:2380"</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">"https://192.168.224.12:2379,http://127.0.0.1:2379"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#[Clustering]</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">"https://192.168.224.12:2380"</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">"https://192.168.224.12:2379"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">"etcd1=https://192.168.224.12:2380,etcd2=https://192.168.224.13:2380,etcd3=https://192.168.224.14:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">"etcd-cluster"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">"new"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">说明：</span><br><span class="line">ETCD_NAME：节点名称，集群中唯一</span><br><span class="line">ETCD_DATA_DIR：数据目录</span><br><span class="line">ETCD_LISTEN_PEER_URLS：集群通信监听地址</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS：客户端访问监听地址</span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS：集群通告地址</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS：客户端通告地址</span><br><span class="line">ETCD_INITIAL_CLUSTER：集群节点地址</span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN：集群Token</span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE：加入集群的当前状态，new是新集群，existing表示加入已有集群</span><br></pre></td></tr></table></figure>



<h4 id="2-4-5-5-创建服务配置文件"><a href="#2-4-5-5-创建服务配置文件" class="headerlink" title="2.4.5.5 创建服务配置文件"></a>2.4.5.5 创建服务配置文件</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir <span class="literal">-p</span> /etc/etcd/ssl</span><br><span class="line">mkdir <span class="literal">-p</span> /var/lib/etcd/default.etcd</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /<span class="keyword">data</span>/k8s<span class="literal">-work</span></span><br><span class="line">cp ca*.pem /etc/etcd/ssl</span><br><span class="line">cp etcd*.pem /etc/etcd/ssl</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/systemd/system/etcd.service &lt;&lt;<span class="string">"EOF"</span></span><br><span class="line">[<span class="type">Unit</span>]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">After=network.target</span><br><span class="line">After=network<span class="literal">-online</span>.target</span><br><span class="line">Wants=network<span class="literal">-online</span>.target</span><br><span class="line"></span><br><span class="line">[<span class="type">Service</span>]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=-/etc/etcd/etcd.conf</span><br><span class="line">WorkingDirectory=/var/lib/etcd/</span><br><span class="line">ExecStart=/usr/local/bin/etcd \</span><br><span class="line">  -<span class="literal">-cert</span><span class="operator">-file</span>=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">  -<span class="literal">-key</span><span class="operator">-file</span>=/etc/etcd/ssl/etcd<span class="literal">-key</span>.pem \</span><br><span class="line">  -<span class="literal">-trusted</span><span class="literal">-ca</span><span class="operator">-file</span>=/etc/etcd/ssl/ca.pem \</span><br><span class="line">  -<span class="literal">-peer</span><span class="literal">-cert</span><span class="operator">-file</span>=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">  -<span class="literal">-peer</span><span class="literal">-key</span><span class="operator">-file</span>=/etc/etcd/ssl/etcd<span class="literal">-key</span>.pem \</span><br><span class="line">  -<span class="literal">-peer</span><span class="literal">-trusted</span><span class="literal">-ca</span><span class="operator">-file</span>=/etc/etcd/ssl/ca.pem \</span><br><span class="line">  -<span class="literal">-peer</span><span class="literal">-client</span><span class="literal">-cert</span><span class="literal">-auth</span> \</span><br><span class="line">  -<span class="literal">-client</span><span class="literal">-cert</span><span class="literal">-auth</span></span><br><span class="line">Restart=on<span class="literal">-failure</span></span><br><span class="line">RestartSec=<span class="number">5</span></span><br><span class="line">LimitNOFILE=<span class="number">65536</span></span><br><span class="line"></span><br><span class="line">[<span class="type">Install</span>]</span><br><span class="line">WantedBy=multi<span class="literal">-user</span>.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h4 id="2-4-5-6-同步etcd配置到集群其它master节点"><a href="#2-4-5-6-同步etcd配置到集群其它master节点" class="headerlink" title="2.4.5.6 同步etcd配置到集群其它master节点"></a>2.4.5.6 同步etcd配置到集群其它master节点</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">创建目录</span><br><span class="line">mkdir <span class="literal">-p</span> /etc/etcd</span><br><span class="line">mkdir <span class="literal">-p</span> /etc/etcd/ssl</span><br><span class="line">mkdir <span class="literal">-p</span> /var/lib/etcd/default.etcd</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">服务配置文件,需要修改etcd节点名称及IP地址</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> k8s<span class="literal">-master2</span> k8s<span class="literal">-master3</span> ;\</span><br><span class="line"><span class="keyword">do</span> \</span><br><span class="line">scp /etc/etcd/etcd.conf <span class="variable">$i:</span>/etc/etcd/ ;\</span><br><span class="line">done</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">k8s<span class="literal">-master2</span>:</span><br><span class="line"></span><br><span class="line">cat /etc/etcd/etcd.conf</span><br><span class="line"><span class="comment">#[Member]</span></span><br><span class="line">ETCD_NAME=<span class="string">"etcd2"</span></span><br><span class="line">ETCD_DATA_DIR=<span class="string">"/var/lib/etcd/default.etcd"</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">"https://192.168.224.13:2380"</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">"https://192.168.224.13:2379,http://127.0.0.1:2379"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#[Clustering]</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">"https://192.168.224.13:2380"</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">"https://192.168.224.13:2379"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">"etcd1=https://192.168.224.12:2380,etcd2=https://192.168.224.13:2380,etcd3=https://192.168.224.14:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">"etcd-cluster"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">"new"</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">k8s<span class="literal">-master3</span>:</span><br><span class="line"></span><br><span class="line">cat /etc/etcd/etcd.conf</span><br><span class="line"><span class="comment">#[Member]</span></span><br><span class="line">ETCD_NAME=<span class="string">"etcd3"</span></span><br><span class="line">ETCD_DATA_DIR=<span class="string">"/var/lib/etcd/default.etcd"</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">"https://192.168.224.14:2380"</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">"https://192.168.224.14:2379,http://127.0.0.1:2379"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#[Clustering]</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">"https://192.168.224.14:2380"</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">"https://192.168.224.14:2379"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">"etcd1=https://192.168.224.12:2380,etcd2=https://192.168.224.13:2380,etcd3=https://192.168.224.14:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">"etcd-cluster"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">"new"</span></span><br></pre></td></tr></table></figure>









<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">证书文件</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> k8s<span class="literal">-master2</span> k8s<span class="literal">-master3</span> ;\</span><br><span class="line"><span class="keyword">do</span> \</span><br><span class="line">scp /etc/etcd/ssl/* <span class="variable">$i:</span>/etc/etcd/ssl ;\</span><br><span class="line">done</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">服务启动配置文件</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> k8s<span class="literal">-master2</span> k8s<span class="literal">-master3</span> ;\</span><br><span class="line"><span class="keyword">do</span> \</span><br><span class="line">scp /etc/systemd/system/etcd.service <span class="variable">$i:</span>/etc/systemd/system/ ;\</span><br><span class="line">done</span><br></pre></td></tr></table></figure>



<h4 id="2-4-5-7-启动etcd集群"><a href="#2-4-5-7-启动etcd集群" class="headerlink" title="2.4.5.7 启动etcd集群"></a>2.4.5.7 启动etcd集群</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon<span class="literal">-reload</span></span><br><span class="line">systemctl enable -<span class="literal">-now</span> etcd.service</span><br><span class="line">systemctl status etcd</span><br></pre></td></tr></table></figure>



<h4 id="2-4-5-8-验证集群状态"><a href="#2-4-5-8-验证集群状态" class="headerlink" title="2.4.5.8 验证集群状态"></a>2.4.5.8 验证集群状态</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL_API=<span class="number">3</span> /usr/local/bin/etcdctl -<span class="literal">-write</span><span class="literal">-out</span>=table -<span class="literal">-cacert</span>=/etc/etcd/ssl/ca.pem -<span class="literal">-cert</span>=/etc/etcd/ssl/etcd.pem -<span class="literal">-key</span>=/etc/etcd/ssl/etcd<span class="literal">-key</span>.pem -<span class="literal">-endpoints</span>=https://<span class="number">192.168</span>.<span class="number">224.12</span>:<span class="number">2379</span>,https://<span class="number">192.168</span>.<span class="number">224.13</span>:<span class="number">2379</span>,https://<span class="number">192.168</span>.<span class="number">224.14</span>:<span class="number">2379</span> endpoint health</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+----------------------------+--------+-------------+-------+</span><br><span class="line">|          ENDPOINT          | HEALTH |    TOOK     | ERROR |</span><br><span class="line">+----------------------------+--------+-------------+-------+</span><br><span class="line">| https://<span class="number">192.168</span>.<span class="number">224.14</span>:<span class="number">2379</span> |   true | <span class="number">10.393062</span>ms |       |</span><br><span class="line">| https://<span class="number">192.168</span>.<span class="number">224.12</span>:<span class="number">2379</span> |   true |  <span class="number">15.70437</span>ms |       |</span><br><span class="line">| https://<span class="number">192.168</span>.<span class="number">224.13</span>:<span class="number">2379</span> |   true | <span class="number">15.871684</span>ms |       |</span><br><span class="line">+----------------------------+--------+-------------+-------+</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">检查ETCD数据库性能</span><br><span class="line">ETCDCTL_API=<span class="number">3</span> /usr/local/bin/etcdctl -<span class="literal">-write</span><span class="literal">-out</span>=table -<span class="literal">-cacert</span>=/etc/etcd/ssl/ca.pem -<span class="literal">-cert</span>=/etc/etcd/ssl/etcd.pem -<span class="literal">-key</span>=/etc/etcd/ssl/etcd<span class="literal">-key</span>.pem -<span class="literal">-endpoints</span>=https://<span class="number">192.168</span>.<span class="number">224.12</span>:<span class="number">2379</span>,https://<span class="number">192.168</span>.<span class="number">224.13</span>:<span class="number">2379</span>,https://<span class="number">192.168</span>.<span class="number">224.14</span>:<span class="number">2379</span> check perf</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">59</span> / <span class="number">60</span> Boooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooom  !  <span class="number">98.33</span>%</span><br><span class="line">PASS: Throughput is <span class="number">151</span> writes/s</span><br><span class="line">PASS: Slowest request took <span class="number">0.066478</span>s</span><br><span class="line">PASS: Stddev is <span class="number">0.002354</span>s</span><br><span class="line">PASS</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL_API=<span class="number">3</span> /usr/local/bin/etcdctl -<span class="literal">-write</span><span class="literal">-out</span>=table -<span class="literal">-cacert</span>=/etc/etcd/ssl/ca.pem -<span class="literal">-cert</span>=/etc/etcd/ssl/etcd.pem -<span class="literal">-key</span>=/etc/etcd/ssl/etcd<span class="literal">-key</span>.pem -<span class="literal">-endpoints</span>=https://<span class="number">192.168</span>.<span class="number">224.12</span>:<span class="number">2379</span>,https://<span class="number">192.168</span>.<span class="number">224.13</span>:<span class="number">2379</span>,https://<span class="number">192.168</span>.<span class="number">224.14</span>:<span class="number">2379</span> member list</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+------------------+---------+-------+----------------------------+----------------------------+------------+</span><br><span class="line">|        ID        | STATUS  | NAME  |         PEER ADDRS         |        CLIENT ADDRS        | IS LEARNER |</span><br><span class="line">+------------------+---------+-------+----------------------------+----------------------------+------------+</span><br><span class="line">| <span class="number">9</span>b449b0ff1d4c375 | started | etcd1 | https://<span class="number">192.168</span>.<span class="number">224.12</span>:<span class="number">2380</span> | https://<span class="number">192.168</span>.<span class="number">224.12</span>:<span class="number">2379</span> |      false |</span><br><span class="line">| d1fbb74bc6a61e5c | started | etcd2 | https://<span class="number">192.168</span>.<span class="number">224.13</span>:<span class="number">2380</span> | https://<span class="number">192.168</span>.<span class="number">224.13</span>:<span class="number">2379</span> |      false |</span><br><span class="line">| f60b205fb02fe23c | started | etcd3 | https://<span class="number">192.168</span>.<span class="number">224.14</span>:<span class="number">2380</span> | https://<span class="number">192.168</span>.<span class="number">224.14</span>:<span class="number">2379</span> |      false |</span><br><span class="line">+------------------+---------+-------+----------------------------+----------------------------+------------+</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL_API=<span class="number">3</span> /usr/local/bin/etcdctl -<span class="literal">-write</span><span class="literal">-out</span>=table -<span class="literal">-cacert</span>=/etc/etcd/ssl/ca.pem -<span class="literal">-cert</span>=/etc/etcd/ssl/etcd.pem -<span class="literal">-key</span>=/etc/etcd/ssl/etcd<span class="literal">-key</span>.pem -<span class="literal">-endpoints</span>=https://<span class="number">192.168</span>.<span class="number">224.12</span>:<span class="number">2379</span>,https://<span class="number">192.168</span>.<span class="number">224.13</span>:<span class="number">2379</span>,https://<span class="number">192.168</span>.<span class="number">224.14</span>:<span class="number">2379</span> endpoint status</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line">|          ENDPOINT          |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |</span><br><span class="line">+----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line">| https://<span class="number">192.168</span>.<span class="number">224.12</span>:<span class="number">2379</span> | <span class="number">9</span>b449b0ff1d4c375 |   <span class="number">3.5</span>.<span class="number">2</span> |   <span class="number">24</span> MB |      true |      false |         <span class="number">2</span> |     <span class="number">403774</span> |             <span class="number">403774</span> |        |</span><br><span class="line">| https://<span class="number">192.168</span>.<span class="number">224.13</span>:<span class="number">2379</span> | d1fbb74bc6a61e5c |   <span class="number">3.5</span>.<span class="number">2</span> |   <span class="number">24</span> MB |     false |      false |         <span class="number">2</span> |     <span class="number">403774</span> |             <span class="number">403774</span> |        |</span><br><span class="line">| https://<span class="number">192.168</span>.<span class="number">224.14</span>:<span class="number">2379</span> | f60b205fb02fe23c |   <span class="number">3.5</span>.<span class="number">2</span> |   <span class="number">24</span> MB |     false |      false |         <span class="number">2</span> |     <span class="number">403774</span> |             <span class="number">403774</span> |        |</span><br><span class="line">+----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br></pre></td></tr></table></figure>





<h2 id="2-5-Kubernetes集群部署"><a href="#2-5-Kubernetes集群部署" class="headerlink" title="2.5 Kubernetes集群部署"></a>2.5 Kubernetes集群部署</h2><h3 id="2-5-1-Kubernetes软件包下载"><a href="#2-5-1-Kubernetes软件包下载" class="headerlink" title="2.5.1 Kubernetes软件包下载"></a>2.5.1 Kubernetes软件包下载</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://dl.k8s.io/v1.<span class="number">21.10</span>/kubernetes<span class="literal">-server</span><span class="literal">-linux</span><span class="literal">-amd64</span>.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment">#最新v1.27.1版本</span></span><br><span class="line">wget https://dl.k8s.io/v1.<span class="number">27.1</span>/kubernetes<span class="literal">-server</span><span class="literal">-linux</span><span class="literal">-amd64</span>.tar.gz</span><br></pre></td></tr></table></figure>



<h3 id="2-5-2-Kubernetes软件包安装"><a href="#2-5-2-Kubernetes软件包安装" class="headerlink" title="2.5.2 Kubernetes软件包安装"></a>2.5.2 Kubernetes软件包安装</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tar <span class="literal">-xvf</span> kubernetes<span class="literal">-server</span><span class="literal">-linux</span><span class="literal">-amd64</span>.tar.gz</span><br><span class="line"></span><br><span class="line">cd kubernetes/server/bin/</span><br><span class="line"></span><br><span class="line">cp kube<span class="literal">-apiserver</span> kube<span class="literal">-controller</span><span class="literal">-manager</span> kube<span class="literal">-scheduler</span> kubectl /usr/local/bin/</span><br></pre></td></tr></table></figure>





<h3 id="2-5-3-Kubernetes软件分发"><a href="#2-5-3-Kubernetes软件分发" class="headerlink" title="2.5.3 Kubernetes软件分发"></a>2.5.3 Kubernetes软件分发</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp kube<span class="literal">-apiserver</span> kube<span class="literal">-controller</span><span class="literal">-manager</span> kube<span class="literal">-scheduler</span> kubectl k8s<span class="literal">-master2</span>:/usr/local/bin/</span><br><span class="line">scp kube<span class="literal">-apiserver</span> kube<span class="literal">-controller</span><span class="literal">-manager</span> kube<span class="literal">-scheduler</span> kubectl k8s<span class="literal">-master3</span>:/usr/local/bin/</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">scp kubelet kube<span class="literal">-proxy</span> k8s<span class="literal">-master1</span>:/usr/local/bin</span><br><span class="line">scp kubelet kube<span class="literal">-proxy</span> k8s<span class="literal">-master2</span>:/usr/local/bin</span><br><span class="line">scp kubelet kube<span class="literal">-proxy</span> k8s<span class="literal">-master3</span>:/usr/local/bin</span><br><span class="line">scp kubelet kube<span class="literal">-proxy</span> k8s<span class="literal">-worker1</span>:/usr/local/bin</span><br></pre></td></tr></table></figure>



<h3 id="2-5-4-在集群节点上创建目录"><a href="#2-5-4-在集群节点上创建目录" class="headerlink" title="2.5.4 在集群节点上创建目录"></a>2.5.4 在集群节点上创建目录</h3><blockquote>
<p>所有节点</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir <span class="literal">-p</span> /etc/kubernetes/        </span><br><span class="line">mkdir <span class="literal">-p</span> /etc/kubernetes/ssl     </span><br><span class="line">mkdir <span class="literal">-p</span> /var/log/kubernetes</span><br></pre></td></tr></table></figure>



<h3 id="2-5-5-部署api-server"><a href="#2-5-5-部署api-server" class="headerlink" title="2.5.5 部署api-server"></a>2.5.5 部署api-server</h3><h4 id="2-5-5-1-创建apiserver证书请求文件"><a href="#2-5-5-1-创建apiserver证书请求文件" class="headerlink" title="2.5.5.1 创建apiserver证书请求文件"></a>2.5.5.1 创建apiserver证书请求文件</h4><p><code>cd  /data/k8s-work</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube<span class="literal">-apiserver</span><span class="literal">-csr</span>.json &lt;&lt; <span class="string">"EOF"</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [</span><br><span class="line">    <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"192.168.224.12"</span>,</span><br><span class="line">    <span class="string">"192.168.224.13"</span>,</span><br><span class="line">    <span class="string">"192.168.224.14"</span>,</span><br><span class="line">    <span class="string">"192.168.224.15"</span>,</span><br><span class="line">    <span class="string">"192.168.224.16"</span>,</span><br><span class="line">    <span class="string">"192.168.224.17"</span>,</span><br><span class="line">    <span class="string">"192.168.224.18"</span>,</span><br><span class="line">    <span class="string">"192.168.224.19"</span>,</span><br><span class="line">    <span class="string">"192.168.224.20"</span>,</span><br><span class="line">    <span class="string">"192.168.224.100"</span>,</span><br><span class="line">    <span class="string">"10.96.0.1"</span>,</span><br><span class="line">    <span class="string">"kubernetes"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default.svc"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default.svc.cluster"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default.svc.cluster.local"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"kubemsb"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"CN"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">说明：</span><br><span class="line">如果 hosts 字段不为空则需要指定授权使用该证书的 IP（含VIP） 或域名列表。由于该证书被 集群使用，需要将节点的IP都填上，为了方便后期扩容可以多写几个预留的IP。</span><br><span class="line">同时还需要填写 service 网络的首个IP(一般是 kube<span class="literal">-apiserver</span> 指定的 service<span class="literal">-cluster</span><span class="literal">-ip</span><span class="literal">-range</span> 网段的第一个IP，如 <span class="number">10.96</span>.<span class="number">0.1</span>)。</span><br></pre></td></tr></table></figure>



<h4 id="2-5-5-2-生成apiserver证书及token文件"><a href="#2-5-5-2-生成apiserver证书及token文件" class="headerlink" title="2.5.5.2 生成apiserver证书及token文件"></a>2.5.5.2 生成apiserver证书及token文件</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert <span class="literal">-ca</span>=ca.pem <span class="literal">-ca</span><span class="literal">-key</span>=ca<span class="literal">-key</span>.pem <span class="literal">-config</span>=ca<span class="literal">-config</span>.json <span class="literal">-profile</span>=kubernetes kube<span class="literal">-apiserver</span><span class="literal">-csr</span>.json | cfssljson <span class="literal">-bare</span> kube<span class="literal">-apiserver</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; token.csv &lt;&lt; EOF</span><br><span class="line"><span class="variable">$</span>(head <span class="literal">-c</span> <span class="number">16</span> /dev/urandom | od <span class="literal">-An</span> <span class="literal">-t</span> x | tr <span class="literal">-d</span> <span class="string">' '</span>),kubelet<span class="literal">-bootstrap</span>,<span class="number">10001</span>,<span class="string">"system:kubelet-bootstrap"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">说明：</span><br><span class="line">创建TLS机制所需TOKEN</span><br><span class="line">TLS Bootstraping：Master apiserver启用TLS认证后，Node节点kubelet和kube<span class="literal">-proxy</span>与kube<span class="literal">-apiserver</span>进行通信，必须使用CA签发的有效证书才可以，当Node节点很多时，这种客户端证书颁发需要大量工作，同样也会增加集群扩展复杂度。为了简化流程，Kubernetes引入了TLS bootstraping机制来自动颁发客户端证书，kubelet会以一个低权限用户自动向apiserver申请证书，kubelet的证书由apiserver动态签署。所以强烈建议在Node上使用这种方式，目前主要用于kubelet，kube<span class="literal">-proxy</span>还是由我们统一颁发一个证书。</span><br></pre></td></tr></table></figure>





<h4 id="2-5-5-3-创建apiserver服务配置文件"><a href="#2-5-5-3-创建apiserver服务配置文件" class="headerlink" title="2.5.5.3 创建apiserver服务配置文件"></a>2.5.5.3 创建apiserver服务配置文件</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/kubernetes/kube<span class="literal">-apiserver</span>.conf &lt;&lt; <span class="string">"EOF"</span></span><br><span class="line">KUBE_APISERVER_OPTS=<span class="string">"--enable-admission-plugins=NamespaceLifecycle,NodeRestriction,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota \</span></span><br><span class="line"><span class="string">  --anonymous-auth=false \</span></span><br><span class="line"><span class="string">  --bind-address=192.168.224.12 \</span></span><br><span class="line"><span class="string">  --secure-port=6443 \</span></span><br><span class="line"><span class="string">  --advertise-address=192.168.224.12 \</span></span><br><span class="line"><span class="string">  --insecure-port=0 \</span></span><br><span class="line"><span class="string">  --authorization-mode=Node,RBAC \</span></span><br><span class="line"><span class="string">  --runtime-config=api/all=true \</span></span><br><span class="line"><span class="string">  --enable-bootstrap-token-auth \</span></span><br><span class="line"><span class="string">  --service-cluster-ip-range=10.96.0.0/16 \</span></span><br><span class="line"><span class="string">  --token-auth-file=/etc/kubernetes/token.csv \</span></span><br><span class="line"><span class="string">  --service-node-port-range=30000-32767 \</span></span><br><span class="line"><span class="string">  --tls-cert-file=/etc/kubernetes/ssl/kube-apiserver.pem  \</span></span><br><span class="line"><span class="string">  --tls-private-key-file=/etc/kubernetes/ssl/kube-apiserver-key.pem \</span></span><br><span class="line"><span class="string">  --client-ca-file=/etc/kubernetes/ssl/ca.pem \</span></span><br><span class="line"><span class="string">  --kubelet-client-certificate=/etc/kubernetes/ssl/kube-apiserver.pem \</span></span><br><span class="line"><span class="string">  --kubelet-client-key=/etc/kubernetes/ssl/kube-apiserver-key.pem \</span></span><br><span class="line"><span class="string">  --service-account-key-file=/etc/kubernetes/ssl/ca-key.pem \</span></span><br><span class="line"><span class="string">  --service-account-signing-key-file=/etc/kubernetes/ssl/ca-key.pem  \</span></span><br><span class="line"><span class="string">  --service-account-issuer=api \</span></span><br><span class="line"><span class="string">  --etcd-cafile=/etc/etcd/ssl/ca.pem \</span></span><br><span class="line"><span class="string">  --etcd-certfile=/etc/etcd/ssl/etcd.pem \</span></span><br><span class="line"><span class="string">  --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \</span></span><br><span class="line"><span class="string">  --etcd-servers=https://192.168.224.12:2379,https://192.168.224.13:2379,https://192.168.224.14:2379 \</span></span><br><span class="line"><span class="string">  --enable-swagger-ui=true \</span></span><br><span class="line"><span class="string">  --allow-privileged=true \</span></span><br><span class="line"><span class="string">  --apiserver-count=3 \</span></span><br><span class="line"><span class="string">  --audit-log-maxage=30 \</span></span><br><span class="line"><span class="string">  --audit-log-maxbackup=3 \</span></span><br><span class="line"><span class="string">  --audit-log-maxsize=100 \</span></span><br><span class="line"><span class="string">  --audit-log-path=/var/log/kube-apiserver-audit.log \</span></span><br><span class="line"><span class="string">  --event-ttl=1h \</span></span><br><span class="line"><span class="string">  --alsologtostderr=true \</span></span><br><span class="line"><span class="string">  --logtostderr=false \</span></span><br><span class="line"><span class="string">  --log-dir=/var/log/kubernetes \</span></span><br><span class="line"><span class="string">  --v=4"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h4 id="2-5-5-4-创建apiserver服务管理配置文件"><a href="#2-5-5-4-创建apiserver服务管理配置文件" class="headerlink" title="2.5.5.4 创建apiserver服务管理配置文件"></a>2.5.5.4 创建apiserver服务管理配置文件</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/systemd/system/kube<span class="literal">-apiserver</span>.service &lt;&lt; <span class="string">"EOF"</span></span><br><span class="line">[<span class="type">Unit</span>]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=etcd.service</span><br><span class="line">Wants=etcd.service</span><br><span class="line"></span><br><span class="line">[<span class="type">Service</span>]</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/kube<span class="literal">-apiserver</span>.conf</span><br><span class="line">ExecStart=/usr/local/bin/kube<span class="literal">-apiserver</span> <span class="variable">$KUBE_APISERVER_OPTS</span></span><br><span class="line">Restart=on<span class="literal">-failure</span></span><br><span class="line">RestartSec=<span class="number">5</span></span><br><span class="line">Type=notify</span><br><span class="line">LimitNOFILE=<span class="number">65536</span></span><br><span class="line"></span><br><span class="line">[<span class="type">Install</span>]</span><br><span class="line">WantedBy=multi<span class="literal">-user</span>.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h4 id="2-5-5-5-同步文件到集群master节点"><a href="#2-5-5-5-同步文件到集群master节点" class="headerlink" title="2.5.5.5 同步文件到集群master节点"></a>2.5.5.5 同步文件到集群master节点</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp ca*.pem /etc/kubernetes/ssl/</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp kube<span class="literal">-apiserver</span>*.pem /etc/kubernetes/ssl/</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp token.csv /etc/kubernetes/</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp /etc/kubernetes/token.csv k8s<span class="literal">-master2</span>:/etc/kubernetes</span><br><span class="line">scp /etc/kubernetes/token.csv k8s<span class="literal">-master3</span>:/etc/kubernetes</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp /etc/kubernetes/ssl/kube<span class="literal">-apiserver</span>*.pem k8s<span class="literal">-master2</span>:/etc/kubernetes/ssl</span><br><span class="line">scp /etc/kubernetes/ssl/kube<span class="literal">-apiserver</span>*.pem k8s<span class="literal">-master3</span>:/etc/kubernetes/ssl</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp /etc/kubernetes/ssl/ca*.pem k8s<span class="literal">-master2</span>:/etc/kubernetes/ssl</span><br><span class="line">scp /etc/kubernetes/ssl/ca*.pem k8s<span class="literal">-master3</span>:/etc/kubernetes/ssl</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">scp /etc/kubernetes/kube<span class="literal">-apiserver</span>.conf k8s<span class="literal">-master2</span>:/etc/kubernetes/kube<span class="literal">-apiserver</span>.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># cat /etc/kubernetes/kube-apiserver.conf</span></span><br><span class="line">KUBE_APISERVER_OPTS=<span class="string">"--enable-admission-plugins=NamespaceLifecycle,NodeRestriction,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota \</span></span><br><span class="line"><span class="string">  --anonymous-auth=false \</span></span><br><span class="line"><span class="string">  --bind-address=192.168.224.13 \</span></span><br><span class="line"><span class="string">  --secure-port=6443 \</span></span><br><span class="line"><span class="string">  --advertise-address=192.168.224.13 \</span></span><br><span class="line"><span class="string">  --insecure-port=0 \</span></span><br><span class="line"><span class="string">  --authorization-mode=Node,RBAC \</span></span><br><span class="line"><span class="string">  --runtime-config=api/all=true \</span></span><br><span class="line"><span class="string">  --enable-bootstrap-token-auth \</span></span><br><span class="line"><span class="string">  --service-cluster-ip-range=10.96.0.0/16 \</span></span><br><span class="line"><span class="string">  --token-auth-file=/etc/kubernetes/token.csv \</span></span><br><span class="line"><span class="string">  --service-node-port-range=30000-32767 \</span></span><br><span class="line"><span class="string">  --tls-cert-file=/etc/kubernetes/ssl/kube-apiserver.pem  \</span></span><br><span class="line"><span class="string">  --tls-private-key-file=/etc/kubernetes/ssl/kube-apiserver-key.pem \</span></span><br><span class="line"><span class="string">  --client-ca-file=/etc/kubernetes/ssl/ca.pem \</span></span><br><span class="line"><span class="string">  --kubelet-client-certificate=/etc/kubernetes/ssl/kube-apiserver.pem \</span></span><br><span class="line"><span class="string">  --kubelet-client-key=/etc/kubernetes/ssl/kube-apiserver-key.pem \</span></span><br><span class="line"><span class="string">  --service-account-key-file=/etc/kubernetes/ssl/ca-key.pem \</span></span><br><span class="line"><span class="string">  --service-account-signing-key-file=/etc/kubernetes/ssl/ca-key.pem  \</span></span><br><span class="line"><span class="string">  --service-account-issuer=api \</span></span><br><span class="line"><span class="string">  --etcd-cafile=/etc/etcd/ssl/ca.pem \</span></span><br><span class="line"><span class="string">  --etcd-certfile=/etc/etcd/ssl/etcd.pem \</span></span><br><span class="line"><span class="string">  --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \</span></span><br><span class="line"><span class="string">  --etcd-servers=https://192.168.224.12:2379,https://192.168.224.13:2379,https://192.168.224.14:2379 \</span></span><br><span class="line"><span class="string">  --enable-swagger-ui=true \</span></span><br><span class="line"><span class="string">  --allow-privileged=true \</span></span><br><span class="line"><span class="string">  --apiserver-count=3 \</span></span><br><span class="line"><span class="string">  --audit-log-maxage=30 \</span></span><br><span class="line"><span class="string">  --audit-log-maxbackup=3 \</span></span><br><span class="line"><span class="string">  --audit-log-maxsize=100 \</span></span><br><span class="line"><span class="string">  --audit-log-path=/var/log/kube-apiserver-audit.log \</span></span><br><span class="line"><span class="string">  --event-ttl=1h \</span></span><br><span class="line"><span class="string">  --alsologtostderr=true \</span></span><br><span class="line"><span class="string">  --logtostderr=false \</span></span><br><span class="line"><span class="string">  --log-dir=/var/log/kubernetes \</span></span><br><span class="line"><span class="string">  --v=4"</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">scp /etc/kubernetes/kube<span class="literal">-apiserver</span>.conf k8s<span class="literal">-master3</span>:/etc/kubernetes/kube<span class="literal">-apiserver</span>.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># cat /etc/kubernetes/kube-apiserver.conf</span></span><br><span class="line">KUBE_APISERVER_OPTS=<span class="string">"--enable-admission-plugins=NamespaceLifecycle,NodeRestriction,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota \</span></span><br><span class="line"><span class="string">  --anonymous-auth=false \</span></span><br><span class="line"><span class="string">  --bind-address=192.168.224.14 \</span></span><br><span class="line"><span class="string">  --secure-port=6443 \</span></span><br><span class="line"><span class="string">  --advertise-address=192.168.224.14 \</span></span><br><span class="line"><span class="string">  --insecure-port=0 \</span></span><br><span class="line"><span class="string">  --authorization-mode=Node,RBAC \</span></span><br><span class="line"><span class="string">  --runtime-config=api/all=true \</span></span><br><span class="line"><span class="string">  --enable-bootstrap-token-auth \</span></span><br><span class="line"><span class="string">  --service-cluster-ip-range=10.96.0.0/16 \</span></span><br><span class="line"><span class="string">  --token-auth-file=/etc/kubernetes/token.csv \</span></span><br><span class="line"><span class="string">  --service-node-port-range=30000-32767 \</span></span><br><span class="line"><span class="string">  --tls-cert-file=/etc/kubernetes/ssl/kube-apiserver.pem  \</span></span><br><span class="line"><span class="string">  --tls-private-key-file=/etc/kubernetes/ssl/kube-apiserver-key.pem \</span></span><br><span class="line"><span class="string">  --client-ca-file=/etc/kubernetes/ssl/ca.pem \</span></span><br><span class="line"><span class="string">  --kubelet-client-certificate=/etc/kubernetes/ssl/kube-apiserver.pem \</span></span><br><span class="line"><span class="string">  --kubelet-client-key=/etc/kubernetes/ssl/kube-apiserver-key.pem \</span></span><br><span class="line"><span class="string">  --service-account-key-file=/etc/kubernetes/ssl/ca-key.pem \</span></span><br><span class="line"><span class="string">  --service-account-signing-key-file=/etc/kubernetes/ssl/ca-key.pem  \</span></span><br><span class="line"><span class="string">  --service-account-issuer=api \</span></span><br><span class="line"><span class="string">  --etcd-cafile=/etc/etcd/ssl/ca.pem \</span></span><br><span class="line"><span class="string">  --etcd-certfile=/etc/etcd/ssl/etcd.pem \</span></span><br><span class="line"><span class="string">  --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \</span></span><br><span class="line"><span class="string">  --etcd-servers=https://192.168.224.12:2379,https://192.168.224.13:2379,https://192.168.224.14:2379 \</span></span><br><span class="line"><span class="string">  --enable-swagger-ui=true \</span></span><br><span class="line"><span class="string">  --allow-privileged=true \</span></span><br><span class="line"><span class="string">  --apiserver-count=3 \</span></span><br><span class="line"><span class="string">  --audit-log-maxage=30 \</span></span><br><span class="line"><span class="string">  --audit-log-maxbackup=3 \</span></span><br><span class="line"><span class="string">  --audit-log-maxsize=100 \</span></span><br><span class="line"><span class="string">  --audit-log-path=/var/log/kube-apiserver-audit.log \</span></span><br><span class="line"><span class="string">  --event-ttl=1h \</span></span><br><span class="line"><span class="string">  --alsologtostderr=true \</span></span><br><span class="line"><span class="string">  --logtostderr=false \</span></span><br><span class="line"><span class="string">  --log-dir=/var/log/kubernetes \</span></span><br><span class="line"><span class="string">  --v=4"</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scp /etc/systemd/system/kube<span class="literal">-apiserver</span>.service k8s<span class="literal">-master2</span>:/etc/systemd/system/kube<span class="literal">-apiserver</span>.service</span><br><span class="line"></span><br><span class="line">scp /etc/systemd/system/kube<span class="literal">-apiserver</span>.service k8s<span class="literal">-master3</span>:/etc/systemd/system/kube<span class="literal">-apiserver</span>.service</span><br></pre></td></tr></table></figure>



<h4 id="2-5-5-6-启动apiserver服务"><a href="#2-5-5-6-启动apiserver服务" class="headerlink" title="2.5.5.6 启动apiserver服务"></a>2.5.5.6 启动apiserver服务</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon<span class="literal">-reload</span></span><br><span class="line">systemctl enable -<span class="literal">-now</span> kube<span class="literal">-apiserver</span></span><br><span class="line"></span><br><span class="line">systemctl status kube<span class="literal">-apiserver</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试</span></span><br><span class="line">curl -<span class="literal">-insecure</span> https://<span class="number">192.168</span>.<span class="number">224.12</span>:<span class="number">6443</span>/</span><br><span class="line">curl -<span class="literal">-insecure</span> https://<span class="number">192.168</span>.<span class="number">224.13</span>:<span class="number">6443</span>/</span><br><span class="line">curl -<span class="literal">-insecure</span> https://<span class="number">192.168</span>.<span class="number">224.14</span>:<span class="number">6443</span>/</span><br><span class="line">curl -<span class="literal">-insecure</span> https://<span class="number">192.168</span>.<span class="number">224.100</span>:<span class="number">6443</span>/</span><br></pre></td></tr></table></figure>



<h3 id="2-5-6-部署kubectl"><a href="#2-5-6-部署kubectl" class="headerlink" title="2.5.6 部署kubectl"></a>2.5.6 部署kubectl</h3><h4 id="2-5-6-1-创建kubectl证书请求文件"><a href="#2-5-6-1-创建kubectl证书请求文件" class="headerlink" title="2.5.6.1 创建kubectl证书请求文件"></a>2.5.6.1 创建kubectl证书请求文件</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; admin<span class="literal">-csr</span>.json &lt;&lt; <span class="string">"EOF"</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"admin"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"system:masters"</span>,             </span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"system"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">说明：</span><br><span class="line"></span><br><span class="line">后续 kube<span class="literal">-apiserver</span> 使用 RBAC 对客户端(如 kubelet、kube<span class="literal">-proxy</span>、Pod)请求进行授权；</span><br><span class="line">kube<span class="literal">-apiserver</span> 预定义了一些 RBAC 使用的 RoleBindings，如 cluster<span class="literal">-admin</span> 将 Group system:masters 与 Role cluster<span class="literal">-admin</span> 绑定，该 Role 授予了调用kube<span class="literal">-apiserver</span> 的所有 API的权限；</span><br><span class="line">O指定该证书的 Group 为 system:masters，kubelet 使用该证书访问 kube<span class="literal">-apiserver</span> 时 ，由于证书被 CA 签名，所以认证通过，同时由于证书用户组为经过预授权的 system:masters，所以被授予访问所有 API 的权限；</span><br><span class="line">注：</span><br><span class="line">这个admin 证书，是将来生成管理员用的kubeconfig 配置文件用的，现在我们一般建议使用RBAC 来对kubernetes 进行角色权限控制， kubernetes 将证书中的CN 字段 作为User， O 字段作为 Group；</span><br><span class="line"><span class="string">"O"</span>: <span class="string">"system:masters"</span>, 必须是system:masters，否则后面kubectl create clusterrolebinding报错。</span><br></pre></td></tr></table></figure>



<h4 id="2-5-6-2-生成证书文件"><a href="#2-5-6-2-生成证书文件" class="headerlink" title="2.5.6.2 生成证书文件"></a>2.5.6.2 生成证书文件</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert <span class="literal">-ca</span>=ca.pem <span class="literal">-ca</span><span class="literal">-key</span>=ca<span class="literal">-key</span>.pem <span class="literal">-config</span>=ca<span class="literal">-config</span>.json <span class="literal">-profile</span>=kubernetes admin<span class="literal">-csr</span>.json | cfssljson <span class="literal">-bare</span> admin</span><br></pre></td></tr></table></figure>



<h4 id="2-5-6-3-复制文件到指定目录"><a href="#2-5-6-3-复制文件到指定目录" class="headerlink" title="2.5.6.3 复制文件到指定目录"></a>2.5.6.3 复制文件到指定目录</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp admin*.pem /etc/kubernetes/ssl/</span><br></pre></td></tr></table></figure>



<h4 id="2-5-6-4-生成kubeconfig配置文件"><a href="#2-5-6-4-生成kubeconfig配置文件" class="headerlink" title="2.5.6.4 生成kubeconfig配置文件"></a>2.5.6.4 生成kubeconfig配置文件</h4><p>kube.config 为 kubectl 的配置文件，包含访问 apiserver 的所有信息，如 apiserver 地址、CA 证书和自身使用的证书</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl config <span class="built_in">set-cluster</span> kubernetes -<span class="literal">-certificate</span><span class="literal">-authority</span>=ca.pem -<span class="literal">-embed</span><span class="literal">-certs</span>=true -<span class="literal">-server</span>=https://<span class="number">192.168</span>.<span class="number">224.100</span>:<span class="number">6443</span> -<span class="literal">-kubeconfig</span>=kube.config</span><br><span class="line"></span><br><span class="line">kubectl config <span class="built_in">set-credentials</span> admin -<span class="literal">-client</span><span class="literal">-certificate</span>=admin.pem -<span class="literal">-client</span><span class="literal">-key</span>=admin<span class="literal">-key</span>.pem -<span class="literal">-embed</span><span class="literal">-certs</span>=true -<span class="literal">-kubeconfig</span>=kube.config</span><br><span class="line"></span><br><span class="line">kubectl config <span class="built_in">set-context</span> kubernetes -<span class="literal">-cluster</span>=kubernetes -<span class="literal">-user</span>=admin -<span class="literal">-kubeconfig</span>=kube.config</span><br><span class="line"></span><br><span class="line">kubectl config <span class="built_in">use-context</span> kubernetes -<span class="literal">-kubeconfig</span>=kube.config</span><br></pre></td></tr></table></figure>



<h4 id="2-5-6-5-准备kubectl配置文件并进行角色绑定"><a href="#2-5-6-5-准备kubectl配置文件并进行角色绑定" class="headerlink" title="2.5.6.5 准备kubectl配置文件并进行角色绑定"></a>2.5.6.5 准备kubectl配置文件并进行角色绑定</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir ~/.kube</span><br><span class="line">cp kube.config ~/.kube/config</span><br><span class="line">kubectl create clusterrolebinding kube<span class="literal">-apiserver</span>:kubelet<span class="literal">-apis</span> -<span class="literal">-clusterrole</span>=system:kubelet<span class="literal">-api</span><span class="literal">-admin</span> -<span class="literal">-user</span> kubernetes -<span class="literal">-kubeconfig</span>=/root/.kube/config</span><br></pre></td></tr></table></figure>



<h4 id="2-5-6-6-查看集群状态"><a href="#2-5-6-6-查看集群状态" class="headerlink" title="2.5.6.6 查看集群状态"></a>2.5.6.6 查看集群状态</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export KUBECONFIG=<span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">查看集群信息</span><br><span class="line">kubectl cluster<span class="literal">-info</span></span><br><span class="line"></span><br><span class="line">查看集群组件状态</span><br><span class="line">kubectl get componentstatuses</span><br><span class="line"></span><br><span class="line">查看命名空间中资源对象</span><br><span class="line">kubectl get all -<span class="literal">-all</span><span class="literal">-namespaces</span></span><br></pre></td></tr></table></figure>



<h4 id="2-5-6-7-同步kubectl配置文件到集群其它master节点"><a href="#2-5-6-7-同步kubectl配置文件到集群其它master节点" class="headerlink" title="2.5.6.7 同步kubectl配置文件到集群其它master节点"></a>2.5.6.7 同步kubectl配置文件到集群其它master节点</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">k8s<span class="literal">-master2</span>:</span><br><span class="line">mkdir /root/.kube</span><br><span class="line"></span><br><span class="line">k8s<span class="literal">-master3</span>:</span><br><span class="line">mkdir /root/.kube</span><br></pre></td></tr></table></figure>





<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp /root/.kube/config k8s<span class="literal">-master2</span>:/root/.kube/config</span><br><span class="line">scp /root/.kube/config k8s<span class="literal">-master3</span>:/root/.kube/config</span><br></pre></td></tr></table></figure>



<h4 id="2-5-6-8-配置kubectl命令补全-可选"><a href="#2-5-6-8-配置kubectl命令补全-可选" class="headerlink" title="2.5.6.8 配置kubectl命令补全(可选)"></a>2.5.6.8 配置kubectl命令补全(可选)</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">yum install <span class="literal">-y</span> bash<span class="literal">-completion</span></span><br><span class="line">source /usr/share/bash<span class="literal">-completion</span>/bash_completion</span><br><span class="line">source &lt;(kubectl completion bash)</span><br><span class="line">kubectl completion bash &gt; ~/.kube/completion.bash.inc</span><br><span class="line">source <span class="string">'/root/.kube/completion.bash.inc'</span>  </span><br><span class="line">source <span class="variable">$HOME</span>/.bash_profile</span><br><span class="line">或者</span><br><span class="line">添加命令自动补全：</span><br><span class="line">yum install <span class="literal">-y</span> bash<span class="literal">-completion</span></span><br><span class="line">vim ~/.bashrc</span><br><span class="line">添加</span><br><span class="line">source &lt;(kubectl completion bash)</span><br><span class="line"></span><br><span class="line">执行下</span><br><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></figure>





<h3 id="2-5-7-部署kube-controller-manager"><a href="#2-5-7-部署kube-controller-manager" class="headerlink" title="2.5.7  部署kube-controller-manager"></a>2.5.7  部署kube-controller-manager</h3><h4 id="2-5-7-1-创建kube-controller-manager证书请求文件"><a href="#2-5-7-1-创建kube-controller-manager证书请求文件" class="headerlink" title="2.5.7.1 创建kube-controller-manager证书请求文件"></a>2.5.7.1 创建kube-controller-manager证书请求文件</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube<span class="literal">-controller</span><span class="literal">-manager</span><span class="literal">-csr</span>.json &lt;&lt; <span class="string">"EOF"</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"system:kube-controller-manager"</span>,</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: <span class="number">2048</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"hosts"</span>: [</span><br><span class="line">      <span class="string">"127.0.0.1"</span>,</span><br><span class="line">      <span class="string">"192.168.224.12"</span>,</span><br><span class="line">      <span class="string">"192.168.224.13"</span>,</span><br><span class="line">      <span class="string">"192.168.224.14"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">        <span class="string">"ST"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">        <span class="string">"L"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">        <span class="string">"O"</span>: <span class="string">"system:kube-controller-manager"</span>,</span><br><span class="line">        <span class="string">"OU"</span>: <span class="string">"system"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">说明：</span><br><span class="line"></span><br><span class="line">hosts 列表包含所有 kube<span class="literal">-controller</span><span class="literal">-manager</span> 节点 IP；</span><br><span class="line">CN 为 system:kube<span class="literal">-controller</span><span class="literal">-manager</span>;</span><br><span class="line">O 为 system:kube<span class="literal">-controller</span><span class="literal">-manager</span>，kubernetes 内置的 ClusterRoleBindings system:kube<span class="literal">-controller</span><span class="literal">-manager</span> 赋予 kube<span class="literal">-controller</span><span class="literal">-manager</span> 工作所需的权限</span><br></pre></td></tr></table></figure>



<h4 id="2-5-7-2-创建kube-controller-manager证书文件"><a href="#2-5-7-2-创建kube-controller-manager证书文件" class="headerlink" title="2.5.7.2 创建kube-controller-manager证书文件"></a>2.5.7.2 创建kube-controller-manager证书文件</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert <span class="literal">-ca</span>=ca.pem <span class="literal">-ca</span><span class="literal">-key</span>=ca<span class="literal">-key</span>.pem <span class="literal">-config</span>=ca<span class="literal">-config</span>.json <span class="literal">-profile</span>=kubernetes kube<span class="literal">-controller</span><span class="literal">-manager</span><span class="literal">-csr</span>.json | cfssljson <span class="literal">-bare</span> kube<span class="literal">-controller</span><span class="literal">-manager</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ls</span></span><br><span class="line"></span><br><span class="line">kube<span class="literal">-controller</span><span class="literal">-manager</span>.csr     </span><br><span class="line">kube<span class="literal">-controller</span><span class="literal">-manager</span><span class="literal">-csr</span>.json</span><br><span class="line">kube<span class="literal">-controller</span><span class="literal">-manager</span><span class="literal">-key</span>.pem</span><br><span class="line">kube<span class="literal">-controller</span><span class="literal">-manager</span>.pem</span><br></pre></td></tr></table></figure>



<h4 id="2-5-7-3-创建kube-controller-manager的kube-controller-manager-kubeconfig"><a href="#2-5-7-3-创建kube-controller-manager的kube-controller-manager-kubeconfig" class="headerlink" title="2.5.7.3  创建kube-controller-manager的kube-controller-manager.kubeconfig"></a>2.5.7.3  创建kube-controller-manager的kube-controller-manager.kubeconfig</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl config <span class="built_in">set-cluster</span> kubernetes -<span class="literal">-certificate</span><span class="literal">-authority</span>=ca.pem -<span class="literal">-embed</span><span class="literal">-certs</span>=true -<span class="literal">-server</span>=https://<span class="number">192.168</span>.<span class="number">224.100</span>:<span class="number">6443</span> -<span class="literal">-kubeconfig</span>=kube<span class="literal">-controller</span><span class="literal">-manager</span>.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config <span class="built_in">set-credentials</span> system:kube<span class="literal">-controller</span><span class="literal">-manager</span> -<span class="literal">-client</span><span class="literal">-certificate</span>=kube<span class="literal">-controller</span><span class="literal">-manager</span>.pem -<span class="literal">-client</span><span class="literal">-key</span>=kube<span class="literal">-controller</span><span class="literal">-manager</span><span class="literal">-key</span>.pem -<span class="literal">-embed</span><span class="literal">-certs</span>=true -<span class="literal">-kubeconfig</span>=kube<span class="literal">-controller</span><span class="literal">-manager</span>.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config <span class="built_in">set-context</span> system:kube<span class="literal">-controller</span><span class="literal">-manager</span> -<span class="literal">-cluster</span>=kubernetes -<span class="literal">-user</span>=system:kube<span class="literal">-controller</span><span class="literal">-manager</span> -<span class="literal">-kubeconfig</span>=kube<span class="literal">-controller</span><span class="literal">-manager</span>.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config <span class="built_in">use-context</span> system:kube<span class="literal">-controller</span><span class="literal">-manager</span> -<span class="literal">-kubeconfig</span>=kube<span class="literal">-controller</span><span class="literal">-manager</span>.kubeconfig</span><br></pre></td></tr></table></figure>



<h4 id="2-5-7-4-创建kube-controller-manager配置文件"><a href="#2-5-7-4-创建kube-controller-manager配置文件" class="headerlink" title="2.5.7.4 创建kube-controller-manager配置文件"></a>2.5.7.4 创建kube-controller-manager配置文件</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube<span class="literal">-controller</span><span class="literal">-manager</span>.conf &lt;&lt; <span class="string">"EOF"</span></span><br><span class="line">KUBE_CONTROLLER_MANAGER_OPTS=<span class="string">"--port=10252 \</span></span><br><span class="line"><span class="string">  --secure-port=10257 \</span></span><br><span class="line"><span class="string">  --bind-address=127.0.0.1 \</span></span><br><span class="line"><span class="string">  --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span></span><br><span class="line"><span class="string">  --service-cluster-ip-range=10.96.0.0/16 \</span></span><br><span class="line"><span class="string">  --cluster-name=kubernetes \</span></span><br><span class="line"><span class="string">  --cluster-signing-cert-file=/etc/kubernetes/ssl/ca.pem \</span></span><br><span class="line"><span class="string">  --cluster-signing-key-file=/etc/kubernetes/ssl/ca-key.pem \</span></span><br><span class="line"><span class="string">  --allocate-node-cidrs=true \</span></span><br><span class="line"><span class="string">  --cluster-cidr=10.244.0.0/16 \</span></span><br><span class="line"><span class="string">  --experimental-cluster-signing-duration=87600h \</span></span><br><span class="line"><span class="string">  --root-ca-file=/etc/kubernetes/ssl/ca.pem \</span></span><br><span class="line"><span class="string">  --service-account-private-key-file=/etc/kubernetes/ssl/ca-key.pem \</span></span><br><span class="line"><span class="string">  --leader-elect=true \</span></span><br><span class="line"><span class="string">  --feature-gates=RotateKubeletServerCertificate=true \</span></span><br><span class="line"><span class="string">  --controllers=*,bootstrapsigner,tokencleaner \</span></span><br><span class="line"><span class="string">  --horizontal-pod-autoscaler-use-rest-clients=true \</span></span><br><span class="line"><span class="string">  --horizontal-pod-autoscaler-sync-period=10s \</span></span><br><span class="line"><span class="string">  --tls-cert-file=/etc/kubernetes/ssl/kube-controller-manager.pem \</span></span><br><span class="line"><span class="string">  --tls-private-key-file=/etc/kubernetes/ssl/kube-controller-manager-key.pem \</span></span><br><span class="line"><span class="string">  --use-service-account-credentials=true \</span></span><br><span class="line"><span class="string">  --alsologtostderr=true \</span></span><br><span class="line"><span class="string">  --logtostderr=false \</span></span><br><span class="line"><span class="string">  --log-dir=/var/log/kubernetes \</span></span><br><span class="line"><span class="string">  --v=2"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h4 id="2-5-7-5-创建服务启动文件"><a href="#2-5-7-5-创建服务启动文件" class="headerlink" title="2.5.7.5 创建服务启动文件"></a>2.5.7.5 创建服务启动文件</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube<span class="literal">-controller</span><span class="literal">-manager</span>.service &lt;&lt; <span class="string">"EOF"</span></span><br><span class="line">[<span class="type">Unit</span>]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[<span class="type">Service</span>]</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/kube<span class="literal">-controller</span><span class="literal">-manager</span>.conf</span><br><span class="line">ExecStart=/usr/local/bin/kube<span class="literal">-controller</span><span class="literal">-manager</span> <span class="variable">$KUBE_CONTROLLER_MANAGER_OPTS</span></span><br><span class="line">Restart=on<span class="literal">-failure</span></span><br><span class="line">RestartSec=<span class="number">5</span></span><br><span class="line"></span><br><span class="line">[<span class="type">Install</span>]</span><br><span class="line">WantedBy=multi<span class="literal">-user</span>.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h4 id="2-5-7-6-同步文件到集群master节点"><a href="#2-5-7-6-同步文件到集群master节点" class="headerlink" title="2.5.7.6 同步文件到集群master节点"></a>2.5.7.6 同步文件到集群master节点</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cp kube<span class="literal">-controller</span><span class="literal">-manager</span>*.pem /etc/kubernetes/ssl/</span><br><span class="line">cp kube<span class="literal">-controller</span><span class="literal">-manager</span>.kubeconfig /etc/kubernetes/</span><br><span class="line">cp kube<span class="literal">-controller</span><span class="literal">-manager</span>.conf /etc/kubernetes/</span><br><span class="line">cp kube<span class="literal">-controller</span><span class="literal">-manager</span>.service /usr/lib/systemd/system/</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">scp  kube<span class="literal">-controller</span><span class="literal">-manager</span>*.pem k8s<span class="literal">-master2</span>:/etc/kubernetes/ssl/</span><br><span class="line">scp  kube<span class="literal">-controller</span><span class="literal">-manager</span>*.pem k8s<span class="literal">-master3</span>:/etc/kubernetes/ssl/</span><br><span class="line">scp  kube<span class="literal">-controller</span><span class="literal">-manager</span>.kubeconfig kube<span class="literal">-controller</span><span class="literal">-manager</span>.conf k8s<span class="literal">-master2</span>:/etc/kubernetes/</span><br><span class="line">scp  kube<span class="literal">-controller</span><span class="literal">-manager</span>.kubeconfig kube<span class="literal">-controller</span><span class="literal">-manager</span>.conf k8s<span class="literal">-master3</span>:/etc/kubernetes/</span><br><span class="line">scp  kube<span class="literal">-controller</span><span class="literal">-manager</span>.service k8s<span class="literal">-master2</span>:/usr/lib/systemd/system/</span><br><span class="line">scp  kube<span class="literal">-controller</span><span class="literal">-manager</span>.service k8s<span class="literal">-master3</span>:/usr/lib/systemd/system/</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看证书</span></span><br><span class="line">openssl x509 <span class="operator">-in</span> /etc/kubernetes/ssl/kube<span class="literal">-controller</span><span class="literal">-manager</span>.pem <span class="literal">-noout</span> <span class="literal">-text</span></span><br></pre></td></tr></table></figure>



<h4 id="2-5-7-7-启动服务"><a href="#2-5-7-7-启动服务" class="headerlink" title="2.5.7.7 启动服务"></a>2.5.7.7 启动服务</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon<span class="literal">-reload</span> </span><br><span class="line">systemctl enable -<span class="literal">-now</span> kube<span class="literal">-controller</span><span class="literal">-manager</span></span><br><span class="line">systemctl status kube<span class="literal">-controller</span><span class="literal">-manager</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get componentstatuses</span><br></pre></td></tr></table></figure>





<h3 id="2-5-8-部署kube-scheduler"><a href="#2-5-8-部署kube-scheduler" class="headerlink" title="2.5.8 部署kube-scheduler"></a>2.5.8 部署kube-scheduler</h3><h4 id="2-5-8-1-创建kube-scheduler证书请求文件"><a href="#2-5-8-1-创建kube-scheduler证书请求文件" class="headerlink" title="2.5.8.1 创建kube-scheduler证书请求文件"></a>2.5.8.1 创建kube-scheduler证书请求文件</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube<span class="literal">-scheduler</span><span class="literal">-csr</span>.json &lt;&lt; <span class="string">"EOF"</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"system:kube-scheduler"</span>,</span><br><span class="line">    <span class="string">"hosts"</span>: [</span><br><span class="line">      <span class="string">"127.0.0.1"</span>,</span><br><span class="line">      <span class="string">"192.168.224.12"</span>,</span><br><span class="line">      <span class="string">"192.168.224.13"</span>,</span><br><span class="line">      <span class="string">"192.168.224.14"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: <span class="number">2048</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">        <span class="string">"ST"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">        <span class="string">"L"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">        <span class="string">"O"</span>: <span class="string">"system:kube-scheduler"</span>,</span><br><span class="line">        <span class="string">"OU"</span>: <span class="string">"system"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h4 id="2-5-8-2-生成kube-scheduler证书"><a href="#2-5-8-2-生成kube-scheduler证书" class="headerlink" title="2.5.8.2 生成kube-scheduler证书"></a>2.5.8.2 生成kube-scheduler证书</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert <span class="literal">-ca</span>=ca.pem <span class="literal">-ca</span><span class="literal">-key</span>=ca<span class="literal">-key</span>.pem <span class="literal">-config</span>=ca<span class="literal">-config</span>.json <span class="literal">-profile</span>=kubernetes kube<span class="literal">-scheduler</span><span class="literal">-csr</span>.json | cfssljson <span class="literal">-bare</span> kube<span class="literal">-scheduler</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ls</span></span><br><span class="line">kube<span class="literal">-scheduler</span>.csr</span><br><span class="line">kube<span class="literal">-scheduler</span><span class="literal">-csr</span>.json</span><br><span class="line">kube<span class="literal">-scheduler</span><span class="literal">-key</span>.pem</span><br><span class="line">kube<span class="literal">-scheduler</span>.pem</span><br></pre></td></tr></table></figure>



<h4 id="2-5-8-3-创建kube-scheduler的kubeconfig"><a href="#2-5-8-3-创建kube-scheduler的kubeconfig" class="headerlink" title="2.5.8.3 创建kube-scheduler的kubeconfig"></a>2.5.8.3 创建kube-scheduler的kubeconfig</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl config <span class="built_in">set-cluster</span> kubernetes -<span class="literal">-certificate</span><span class="literal">-authority</span>=ca.pem -<span class="literal">-embed</span><span class="literal">-certs</span>=true -<span class="literal">-server</span>=https://<span class="number">192.168</span>.<span class="number">224.100</span>:<span class="number">6443</span> -<span class="literal">-kubeconfig</span>=kube<span class="literal">-scheduler</span>.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config <span class="built_in">set-credentials</span> system:kube<span class="literal">-scheduler</span> -<span class="literal">-client</span><span class="literal">-certificate</span>=kube<span class="literal">-scheduler</span>.pem -<span class="literal">-client</span><span class="literal">-key</span>=kube<span class="literal">-scheduler</span><span class="literal">-key</span>.pem -<span class="literal">-embed</span><span class="literal">-certs</span>=true -<span class="literal">-kubeconfig</span>=kube<span class="literal">-scheduler</span>.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config <span class="built_in">set-context</span> system:kube<span class="literal">-scheduler</span> -<span class="literal">-cluster</span>=kubernetes -<span class="literal">-user</span>=system:kube<span class="literal">-scheduler</span> -<span class="literal">-kubeconfig</span>=kube<span class="literal">-scheduler</span>.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config <span class="built_in">use-context</span> system:kube<span class="literal">-scheduler</span> -<span class="literal">-kubeconfig</span>=kube<span class="literal">-scheduler</span>.kubeconfig</span><br></pre></td></tr></table></figure>



<h4 id="2-5-8-4-创建服务配置文件"><a href="#2-5-8-4-创建服务配置文件" class="headerlink" title="2.5.8.4 创建服务配置文件"></a>2.5.8.4 创建服务配置文件</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube<span class="literal">-scheduler</span>.conf &lt;&lt; <span class="string">"EOF"</span></span><br><span class="line">KUBE_SCHEDULER_OPTS=<span class="string">"--address=127.0.0.1 \</span></span><br><span class="line"><span class="string">--kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \</span></span><br><span class="line"><span class="string">--leader-elect=true \</span></span><br><span class="line"><span class="string">--alsologtostderr=true \</span></span><br><span class="line"><span class="string">--logtostderr=false \</span></span><br><span class="line"><span class="string">--log-dir=/var/log/kubernetes \</span></span><br><span class="line"><span class="string">--v=2"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h4 id="2-5-8-5创建服务启动配置文件"><a href="#2-5-8-5创建服务启动配置文件" class="headerlink" title="2.5.8.5创建服务启动配置文件"></a>2.5.8.5创建服务启动配置文件</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube<span class="literal">-scheduler</span>.service &lt;&lt; <span class="string">"EOF"</span></span><br><span class="line">[<span class="type">Unit</span>]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[<span class="type">Service</span>]</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/kube<span class="literal">-scheduler</span>.conf</span><br><span class="line">ExecStart=/usr/local/bin/kube<span class="literal">-scheduler</span> <span class="variable">$KUBE_SCHEDULER_OPTS</span></span><br><span class="line">Restart=on<span class="literal">-failure</span></span><br><span class="line">RestartSec=<span class="number">5</span></span><br><span class="line"></span><br><span class="line">[<span class="type">Install</span>]</span><br><span class="line">WantedBy=multi<span class="literal">-user</span>.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h4 id="2-5-8-6-同步文件至集群master节点"><a href="#2-5-8-6-同步文件至集群master节点" class="headerlink" title="2.5.8.6 同步文件至集群master节点"></a>2.5.8.6 同步文件至集群master节点</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cp kube<span class="literal">-scheduler</span>*.pem /etc/kubernetes/ssl/</span><br><span class="line">cp kube<span class="literal">-scheduler</span>.kubeconfig /etc/kubernetes/</span><br><span class="line">cp kube<span class="literal">-scheduler</span>.conf /etc/kubernetes/</span><br><span class="line">cp kube<span class="literal">-scheduler</span>.service /usr/lib/systemd/system/</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">scp  kube<span class="literal">-scheduler</span>*.pem k8s<span class="literal">-master2</span>:/etc/kubernetes/ssl/</span><br><span class="line">scp  kube<span class="literal">-scheduler</span>*.pem k8s<span class="literal">-master3</span>:/etc/kubernetes/ssl/</span><br><span class="line">scp  kube<span class="literal">-scheduler</span>.kubeconfig kube<span class="literal">-scheduler</span>.conf k8s<span class="literal">-master2</span>:/etc/kubernetes/</span><br><span class="line">scp  kube<span class="literal">-scheduler</span>.kubeconfig kube<span class="literal">-scheduler</span>.conf k8s<span class="literal">-master3</span>:/etc/kubernetes/</span><br><span class="line">scp  kube<span class="literal">-scheduler</span>.service k8s<span class="literal">-master2</span>:/usr/lib/systemd/system/</span><br><span class="line">scp  kube<span class="literal">-scheduler</span>.service k8s<span class="literal">-master3</span>:/usr/lib/systemd/system/</span><br></pre></td></tr></table></figure>



<h4 id="2-5-8-7-启动服务"><a href="#2-5-8-7-启动服务" class="headerlink" title="2.5.8.7 启动服务"></a>2.5.8.7 启动服务</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon<span class="literal">-reload</span></span><br><span class="line">systemctl enable -<span class="literal">-now</span> kube<span class="literal">-scheduler</span></span><br><span class="line">systemctl status kube<span class="literal">-scheduler</span></span><br></pre></td></tr></table></figure>



<h3 id="2-5-9-工作节点（worker-node）部署"><a href="#2-5-9-工作节点（worker-node）部署" class="headerlink" title="2.5.9 工作节点（worker node）部署"></a>2.5.9 工作节点（worker node）部署</h3><h4 id="2-5-9-1-Containerd安装及配置"><a href="#2-5-9-1-Containerd安装及配置" class="headerlink" title="2.5.9.1 Containerd安装及配置"></a>2.5.9.1 Containerd安装及配置</h4><h5 id="2-5-9-1-1-获取软件包"><a href="#2-5-9-1-1-获取软件包" class="headerlink" title="2.5.9.1.1 获取软件包"></a>2.5.9.1.1 获取软件包</h5><p><a href="https://imgse.com/i/p9BEYjK"><img src="https://s1.ax1x.com/2023/05/09/p9BEYjK.png" alt="p9BEYjK.png"></a></p>
<p><a href="https://imgse.com/i/p9BEr9I"><img src="https://s1.ax1x.com/2023/05/09/p9BEr9I.png" alt="p9BEr9I.png"></a></p>
<p><a href="https://imgse.com/i/p9BEs3t"><img src="https://s1.ax1x.com/2023/05/09/p9BEs3t.png" alt="p9BEs3t.png"></a></p>
<p><a href="https://imgse.com/i/p9BEgu8"><img src="https://s1.ax1x.com/2023/05/09/p9BEgu8.png" alt="p9BEgu8.png"></a></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/containerd/containerd/releases/download/v1.<span class="number">6.1</span>/cri<span class="literal">-containerd</span><span class="literal">-cni</span><span class="literal">-1</span>.<span class="number">6.1</span><span class="literal">-linux</span><span class="literal">-amd64</span>.tar.gz</span><br></pre></td></tr></table></figure>



<h5 id="2-5-9-1-2-安装containerd"><a href="#2-5-9-1-2-安装containerd" class="headerlink" title="2.5.9.1.2 安装containerd"></a>2.5.9.1.2 安装containerd</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar <span class="literal">-xf</span> cri<span class="literal">-containerd</span><span class="literal">-cni</span><span class="literal">-1</span>.<span class="number">6.1</span><span class="literal">-linux</span><span class="literal">-amd64</span>.tar.gz <span class="literal">-C</span> /</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">默认解压后会有如下目录：</span><br><span class="line">etc</span><br><span class="line">opt</span><br><span class="line">usr</span><br><span class="line">会把对应的目解压到/下对应目录中，这样就省去复制文件步骤。</span><br></pre></td></tr></table></figure>



<h5 id="2-5-9-1-3-生成配置文件并修改"><a href="#2-5-9-1-3-生成配置文件并修改" class="headerlink" title="2.5.9.1.3 生成配置文件并修改"></a>2.5.9.1.3 生成配置文件并修改</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/containerd</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">containerd config default &gt;/etc/containerd/config.toml</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ls /etc/containerd/</span></span><br><span class="line">config.toml</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">下面的配置文件中已修改，可不执行，仅修改默认时执行。</span><br><span class="line">sed <span class="literal">-i</span> <span class="string">'s@systemd_cgroup = false@systemd_cgroup = true@'</span> /etc/containerd/config.toml</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">下面的配置文件中已修改，可不执行，仅修改默认时执行。</span><br><span class="line">sed <span class="literal">-i</span> <span class="string">'s@k8s.gcr.io/pause:3.6@registry.aliyuncs.com/google_containers/pause:3.6@'</span> /etc/containerd/config.toml</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat &gt;/etc/containerd/config.toml&lt;&lt;EOF</span></span><br><span class="line">root = <span class="string">"/var/lib/containerd"</span></span><br><span class="line">state = <span class="string">"/run/containerd"</span></span><br><span class="line">oom_score = <span class="literal">-999</span></span><br><span class="line"></span><br><span class="line">[<span class="type">grpc</span>]</span><br><span class="line">  address = <span class="string">"/run/containerd/containerd.sock"</span></span><br><span class="line">  uid = <span class="number">0</span></span><br><span class="line">  gid = <span class="number">0</span></span><br><span class="line">  max_recv_message_size = <span class="number">16777216</span></span><br><span class="line">  max_send_message_size = <span class="number">16777216</span></span><br><span class="line"></span><br><span class="line">[<span class="type">debug</span>]</span><br><span class="line">  address = <span class="string">""</span></span><br><span class="line">  uid = <span class="number">0</span></span><br><span class="line">  gid = <span class="number">0</span></span><br><span class="line">  level = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">[<span class="type">metrics</span>]</span><br><span class="line">  address = <span class="string">""</span></span><br><span class="line">  grpc_histogram = false</span><br><span class="line"></span><br><span class="line">[<span class="type">cgroup</span>]</span><br><span class="line">  path = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">[<span class="type">plugins</span>]</span><br><span class="line">  [<span class="type">plugins.cgroups</span>]</span><br><span class="line">    no_prometheus = false</span><br><span class="line">  [<span class="type">plugins.cri</span>]</span><br><span class="line">    stream_server_address = <span class="string">"127.0.0.1"</span></span><br><span class="line">    stream_server_port = <span class="string">"0"</span></span><br><span class="line">    enable_selinux = false</span><br><span class="line">    sandbox_image = <span class="string">"registry.aliyuncs.com/google_containers/pause:3.6"</span></span><br><span class="line">    stats_collect_period = <span class="number">10</span></span><br><span class="line">    systemd_cgroup = true</span><br><span class="line">    enable_tls_streaming = false</span><br><span class="line">    max_container_log_line_size = <span class="number">16384</span></span><br><span class="line">    [<span class="type">plugins.cri.containerd</span>]</span><br><span class="line">      snapshotter = <span class="string">"overlayfs"</span></span><br><span class="line">      no_pivot = false</span><br><span class="line">      [<span class="type">plugins.cri.containerd.default_runtime</span>]</span><br><span class="line">        runtime_type = <span class="string">"io.containerd.runtime.v1.linux"</span></span><br><span class="line">        runtime_engine = <span class="string">""</span></span><br><span class="line">        runtime_root = <span class="string">""</span></span><br><span class="line">      [<span class="type">plugins.cri.containerd.untrusted_workload_runtime</span>]</span><br><span class="line">        runtime_type = <span class="string">""</span></span><br><span class="line">        runtime_engine = <span class="string">""</span></span><br><span class="line">        runtime_root = <span class="string">""</span></span><br><span class="line">    [<span class="type">plugins.cri.cni</span>]</span><br><span class="line">      bin_dir = <span class="string">"/opt/cni/bin"</span></span><br><span class="line">      conf_dir = <span class="string">"/etc/cni/net.d"</span></span><br><span class="line">      conf_template = <span class="string">"/etc/cni/net.d/10-default.conf"</span></span><br><span class="line">    [<span class="type">plugins.cri.registry</span>]</span><br><span class="line">      [<span class="type">plugins.cri.registry.mirrors</span>]</span><br><span class="line">        [<span class="type">plugins.cri.registry.mirrors.</span><span class="string">"docker.io"</span>]</span><br><span class="line">          endpoint = [</span><br><span class="line">            <span class="string">"https://docker.mirrors.ustc.edu.cn"</span>,</span><br><span class="line">            <span class="string">"http://hub-mirror.c.163.com"</span></span><br><span class="line">          ]</span><br><span class="line">        [<span class="type">plugins.cri.registry.mirrors.</span><span class="string">"gcr.io"</span>]</span><br><span class="line">          endpoint = [</span><br><span class="line">            <span class="string">"https://gcr.mirrors.ustc.edu.cn"</span></span><br><span class="line">          ]</span><br><span class="line">        [<span class="type">plugins.cri.registry.mirrors.</span><span class="string">"k8s.gcr.io"</span>]</span><br><span class="line">          endpoint = [</span><br><span class="line">            <span class="string">"https://gcr.mirrors.ustc.edu.cn/google-containers/"</span></span><br><span class="line">          ]</span><br><span class="line">        [<span class="type">plugins.cri.registry.mirrors.</span><span class="string">"quay.io"</span>]</span><br><span class="line">          endpoint = [</span><br><span class="line">            <span class="string">"https://quay.mirrors.ustc.edu.cn"</span></span><br><span class="line">          ]</span><br><span class="line">        [<span class="type">plugins.cri.registry.mirrors.</span><span class="string">"harbor.kubemsb.com"</span>]</span><br><span class="line">          endpoint = [</span><br><span class="line">            <span class="string">"http://harbor.kubemsb.com"</span></span><br><span class="line">          ]</span><br><span class="line">    [<span class="type">plugins.cri.x509_key_pair_streaming</span>]</span><br><span class="line">      tls_cert_file = <span class="string">""</span></span><br><span class="line">      tls_key_file = <span class="string">""</span></span><br><span class="line">  [<span class="type">plugins.diff</span>-<span class="type">service</span>]</span><br><span class="line">    default = [<span class="string">"walking"</span>]</span><br><span class="line">  [<span class="type">plugins.linux</span>]</span><br><span class="line">    shim = <span class="string">"containerd-shim"</span></span><br><span class="line">    runtime = <span class="string">"runc"</span></span><br><span class="line">    runtime_root = <span class="string">""</span></span><br><span class="line">    no_shim = false</span><br><span class="line">    shim_debug = false</span><br><span class="line">  [<span class="type">plugins.opt</span>]</span><br><span class="line">    path = <span class="string">"/opt/containerd"</span></span><br><span class="line">  [<span class="type">plugins.restart</span>]</span><br><span class="line">    interval = <span class="string">"10s"</span></span><br><span class="line">  [<span class="type">plugins.scheduler</span>]</span><br><span class="line">    pause_threshold = <span class="number">0.02</span></span><br><span class="line">    deletion_threshold = <span class="number">0</span></span><br><span class="line">    mutation_threshold = <span class="number">100</span></span><br><span class="line">    schedule_delay = <span class="string">"0s"</span></span><br><span class="line">    startup_delay = <span class="string">"100ms"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h5 id="2-5-9-1-4-安装runc"><a href="#2-5-9-1-4-安装runc" class="headerlink" title="2.5.9.1.4 安装runc"></a>2.5.9.1.4 安装runc</h5><blockquote>
<p>由于上述软件包中包含的runc对系统依赖过多，所以建议单独下载安装。</p>
<p>默认runc执行时提示：runc: symbol lookup error: runc: undefined symbol: seccomp_notify_respond</p>
</blockquote>
<p><a href="https://imgse.com/i/p9BeG3n"><img src="https://s1.ax1x.com/2023/05/09/p9BeG3n.png" alt="p9BeG3n.png"></a></p>
<p><a href="https://imgse.com/i/p9BeaHU"><img src="https://s1.ax1x.com/2023/05/09/p9BeaHU.png" alt="p9BeaHU.png"></a></p>
<p><a href="https://imgse.com/i/p9Beyg1"><img src="https://s1.ax1x.com/2023/05/09/p9Beyg1.png" alt="p9Beyg1.png"></a></p>
<p><a href="https://imgse.com/i/p9BefED"><img src="https://s1.ax1x.com/2023/05/09/p9BefED.png" alt="p9BefED.png"></a></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/opencontainers/runc/releases/download/v1.<span class="number">1.0</span>/runc.amd64</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x runc.amd64</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">替换掉原软件包中的runc</span><br><span class="line"></span><br><span class="line">mv runc.amd64 /usr/local/sbin/runc</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># runc -v</span></span><br><span class="line">runc version <span class="number">1.1</span>.<span class="number">0</span></span><br><span class="line">commit: v1.<span class="number">1.0</span><span class="literal">-0</span><span class="literal">-g067aaf85</span></span><br><span class="line">spec: <span class="number">1.0</span>.<span class="number">2</span><span class="literal">-dev</span></span><br><span class="line">go: go1.<span class="number">17.6</span></span><br><span class="line">libseccomp: <span class="number">2.5</span>.<span class="number">3</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable containerd</span><br><span class="line">systemctl start containerd</span><br></pre></td></tr></table></figure>





<h4 id="2-5-9-2-部署kubelet"><a href="#2-5-9-2-部署kubelet" class="headerlink" title="2.5.9.2 部署kubelet"></a>2.5.9.2 部署kubelet</h4><blockquote>
<p>在k8s-master1上操作</p>
</blockquote>
<h5 id="2-5-9-2-1-创建kubelet-bootstrap-kubeconfig"><a href="#2-5-9-2-1-创建kubelet-bootstrap-kubeconfig" class="headerlink" title="2.5.9.2.1 创建kubelet-bootstrap.kubeconfig"></a>2.5.9.2.1 创建kubelet-bootstrap.kubeconfig</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">BOOTSTRAP_TOKEN=<span class="variable">$</span>(awk <span class="operator">-F</span> <span class="string">","</span> <span class="string">'&#123;print $1&#125;'</span> /etc/kubernetes/token.csv)</span><br><span class="line"></span><br><span class="line">kubectl config <span class="built_in">set-cluster</span> kubernetes -<span class="literal">-certificate</span><span class="literal">-authority</span>=ca.pem -<span class="literal">-embed</span><span class="literal">-certs</span>=true -<span class="literal">-server</span>=https://<span class="number">192.168</span>.<span class="number">224.100</span>:<span class="number">6443</span> -<span class="literal">-kubeconfig</span>=kubelet<span class="literal">-bootstrap</span>.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config <span class="built_in">set-credentials</span> kubelet<span class="literal">-bootstrap</span> -<span class="literal">-token</span>=<span class="variable">$</span>&#123;BOOTSTRAP_TOKEN&#125; -<span class="literal">-kubeconfig</span>=kubelet<span class="literal">-bootstrap</span>.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config <span class="built_in">set-context</span> default -<span class="literal">-cluster</span>=kubernetes -<span class="literal">-user</span>=kubelet<span class="literal">-bootstrap</span> -<span class="literal">-kubeconfig</span>=kubelet<span class="literal">-bootstrap</span>.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config <span class="built_in">use-context</span> default -<span class="literal">-kubeconfig</span>=kubelet<span class="literal">-bootstrap</span>.kubeconfig</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding cluster<span class="literal">-system</span><span class="literal">-anonymous</span> -<span class="literal">-clusterrole</span>=cluster<span class="literal">-admin</span> -<span class="literal">-user</span>=kubelet<span class="literal">-bootstrap</span></span><br><span class="line"></span><br><span class="line">kubectl create clusterrolebinding kubelet<span class="literal">-bootstrap</span> -<span class="literal">-clusterrole</span>=system:node<span class="literal">-bootstrapper</span> -<span class="literal">-user</span>=kubelet<span class="literal">-bootstrap</span> -<span class="literal">-kubeconfig</span>=kubelet<span class="literal">-bootstrap</span>.kubeconfig</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe clusterrolebinding cluster<span class="literal">-system</span><span class="literal">-anonymous</span></span><br><span class="line"></span><br><span class="line">kubectl describe clusterrolebinding kubelet<span class="literal">-bootstrap</span></span><br></pre></td></tr></table></figure>



<h5 id="2-5-9-2-2-创建kubelet配置文件"><a href="#2-5-9-2-2-创建kubelet配置文件" class="headerlink" title="2.5.9.2.2 创建kubelet配置文件"></a>2.5.9.2.2 创建kubelet配置文件</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kubelet.json &lt;&lt; <span class="string">"EOF"</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"kind"</span>: <span class="string">"KubeletConfiguration"</span>,</span><br><span class="line">  <span class="string">"apiVersion"</span>: <span class="string">"kubelet.config.k8s.io/v1beta1"</span>,</span><br><span class="line">  <span class="string">"authentication"</span>: &#123;</span><br><span class="line">    <span class="string">"x509"</span>: &#123;</span><br><span class="line">      <span class="string">"clientCAFile"</span>: <span class="string">"/etc/kubernetes/ssl/ca.pem"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"webhook"</span>: &#123;</span><br><span class="line">      <span class="string">"enabled"</span>: true,</span><br><span class="line">      <span class="string">"cacheTTL"</span>: <span class="string">"2m0s"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"anonymous"</span>: &#123;</span><br><span class="line">      <span class="string">"enabled"</span>: false</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"authorization"</span>: &#123;</span><br><span class="line">    <span class="string">"mode"</span>: <span class="string">"Webhook"</span>,</span><br><span class="line">    <span class="string">"webhook"</span>: &#123;</span><br><span class="line">      <span class="string">"cacheAuthorizedTTL"</span>: <span class="string">"5m0s"</span>,</span><br><span class="line">      <span class="string">"cacheUnauthorizedTTL"</span>: <span class="string">"30s"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"address"</span>: <span class="string">"192.168.224.12"</span>,</span><br><span class="line">  <span class="string">"port"</span>: <span class="number">10250</span>,</span><br><span class="line">  <span class="string">"readOnlyPort"</span>: <span class="number">10255</span>,</span><br><span class="line">  <span class="string">"cgroupDriver"</span>: <span class="string">"systemd"</span>,                    </span><br><span class="line">  <span class="string">"hairpinMode"</span>: <span class="string">"promiscuous-bridge"</span>,</span><br><span class="line">  <span class="string">"serializeImagePulls"</span>: false,</span><br><span class="line">  <span class="string">"clusterDomain"</span>: <span class="string">"cluster.local."</span>,</span><br><span class="line">  <span class="string">"clusterDNS"</span>: [<span class="string">"10.96.0.2"</span>]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h5 id="2-5-9-2-3-创建kubelet服务启动管理文件"><a href="#2-5-9-2-3-创建kubelet服务启动管理文件" class="headerlink" title="2.5.9.2.3 创建kubelet服务启动管理文件"></a>2.5.9.2.3 创建kubelet服务启动管理文件</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kubelet.service &lt;&lt; <span class="string">"EOF"</span></span><br><span class="line">[<span class="type">Unit</span>]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=containerd.service</span><br><span class="line">Requires=containerd.service</span><br><span class="line"></span><br><span class="line">[<span class="type">Service</span>]</span><br><span class="line">WorkingDirectory=/var/lib/kubelet</span><br><span class="line">ExecStart=/usr/local/bin/kubelet \</span><br><span class="line">  -<span class="literal">-bootstrap</span><span class="literal">-kubeconfig</span>=/etc/kubernetes/kubelet<span class="literal">-bootstrap</span>.kubeconfig \</span><br><span class="line">  -<span class="literal">-cert</span><span class="literal">-dir</span>=/etc/kubernetes/ssl \</span><br><span class="line">  -<span class="literal">-kubeconfig</span>=/etc/kubernetes/kubelet.kubeconfig \</span><br><span class="line">  -<span class="literal">-config</span>=/etc/kubernetes/kubelet.json \</span><br><span class="line">  -<span class="literal">-cni</span><span class="literal">-bin</span><span class="literal">-dir</span>=/opt/cni/bin \</span><br><span class="line">  -<span class="literal">-cni</span><span class="literal">-conf</span><span class="literal">-dir</span>=/etc/cni/net.d \</span><br><span class="line">  -<span class="literal">-container</span><span class="literal">-runtime</span>=remote \</span><br><span class="line">  -<span class="literal">-container</span><span class="literal">-runtime</span><span class="literal">-endpoint</span>=unix:///run/containerd/containerd.sock \</span><br><span class="line">  -<span class="literal">-network</span><span class="literal">-plugin</span>=cni \</span><br><span class="line">  -<span class="literal">-rotate</span><span class="literal">-certificates</span> \</span><br><span class="line">  -<span class="literal">-pod</span><span class="literal">-infra</span><span class="literal">-container</span><span class="literal">-image</span>=registry.aliyuncs.com/google_containers/pause:<span class="number">3.2</span> \</span><br><span class="line">  -<span class="literal">-root</span><span class="literal">-dir</span>=/etc/cni/net.d \</span><br><span class="line">  -<span class="literal">-alsologtostderr</span>=true \</span><br><span class="line">  -<span class="literal">-logtostderr</span>=false \</span><br><span class="line">  -<span class="literal">-log</span><span class="literal">-dir</span>=/var/log/kubernetes \</span><br><span class="line">  -<span class="literal">-v</span>=<span class="number">2</span></span><br><span class="line">Restart=on<span class="literal">-failure</span></span><br><span class="line">RestartSec=<span class="number">5</span></span><br><span class="line"></span><br><span class="line">[<span class="type">Install</span>]</span><br><span class="line">WantedBy=multi<span class="literal">-user</span>.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h5 id="2-5-9-2-4-同步文件到集群节点"><a href="#2-5-9-2-4-同步文件到集群节点" class="headerlink" title="2.5.9.2.4 同步文件到集群节点"></a>2.5.9.2.4 同步文件到集群节点</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp kubelet<span class="literal">-bootstrap</span>.kubeconfig /etc/kubernetes/</span><br><span class="line">cp kubelet.json /etc/kubernetes/</span><br><span class="line">cp kubelet.service /usr/lib/systemd/system/</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span>  k8s<span class="literal">-master2</span> k8s<span class="literal">-master3</span> k8s<span class="literal">-worker1</span>;<span class="keyword">do</span> scp kubelet<span class="literal">-bootstrap</span>.kubeconfig kubelet.json <span class="variable">$i:</span>/etc/kubernetes/;done</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span>  k8s<span class="literal">-master2</span> k8s<span class="literal">-master3</span> k8s<span class="literal">-worker1</span>;<span class="keyword">do</span> scp ca.pem <span class="variable">$i:</span>/etc/kubernetes/ssl/;done</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> k8s<span class="literal">-master2</span> k8s<span class="literal">-master3</span> k8s<span class="literal">-worker1</span>;<span class="keyword">do</span> scp kubelet.service <span class="variable">$i:</span>/usr/lib/systemd/system/;done</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">说明：</span><br><span class="line">kubelet.json中address需要修改为当前主机IP地址。</span><br></pre></td></tr></table></figure>





<h5 id="2-5-9-2-5-创建目录及启动服务"><a href="#2-5-9-2-5-创建目录及启动服务" class="headerlink" title="2.5.9.2.5 创建目录及启动服务"></a>2.5.9.2.5 创建目录及启动服务</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir <span class="literal">-p</span> /var/lib/kubelet</span><br><span class="line">mkdir <span class="literal">-p</span> /var/log/kubernetes</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon<span class="literal">-reload</span></span><br><span class="line">systemctl enable -<span class="literal">-now</span> kubelet</span><br><span class="line"></span><br><span class="line">systemctl status kubelet</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME          STATUS     ROLES    AGE     VERSION</span><br><span class="line">k8s<span class="literal">-master1</span>   NotReady   &lt;none&gt;   <span class="number">2</span>m55s   v1.<span class="number">21.10</span></span><br><span class="line">k8s<span class="literal">-master2</span>   NotReady   &lt;none&gt;   <span class="number">45</span>s     v1.<span class="number">21.10</span></span><br><span class="line">k8s<span class="literal">-master3</span>   NotReady   &lt;none&gt;   <span class="number">39</span>s     v1.<span class="number">21.10</span></span><br><span class="line">k8s<span class="literal">-worker1</span>   NotReady   &lt;none&gt;   <span class="number">5</span>m1s    v1.<span class="number">21.10</span></span><br></pre></td></tr></table></figure>





<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get csr</span></span><br><span class="line">NAME        AGE     SIGNERNAME                                    REQUESTOR           CONDITION</span><br><span class="line">csr<span class="literal">-b949p</span>   <span class="number">7</span>m55s   kubernetes.io/kube<span class="literal">-apiserver</span><span class="literal">-client</span><span class="literal">-kubelet</span>   kubelet<span class="literal">-bootstrap</span>   Approved,Issued</span><br><span class="line">csr<span class="literal">-c9hs4</span>   <span class="number">3</span>m34s   kubernetes.io/kube<span class="literal">-apiserver</span><span class="literal">-client</span><span class="literal">-kubelet</span>   kubelet<span class="literal">-bootstrap</span>   Approved,Issued</span><br><span class="line">csr<span class="literal">-r8vhp</span>   <span class="number">5</span>m50s   kubernetes.io/kube<span class="literal">-apiserver</span><span class="literal">-client</span><span class="literal">-kubelet</span>   kubelet<span class="literal">-bootstrap</span>   Approved,Issued</span><br><span class="line">csr<span class="literal">-zb4sr</span>   <span class="number">3</span>m40s   kubernetes.io/kube<span class="literal">-apiserver</span><span class="literal">-client</span><span class="literal">-kubelet</span>   kubelet<span class="literal">-bootstrap</span>   Approved,Issued</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">说明：</span><br><span class="line">确认kubelet服务启动成功后，接着到master上Approve一下bootstrap请求。</span><br></pre></td></tr></table></figure>





<h4 id="2-5-9-3-部署kube-proxy"><a href="#2-5-9-3-部署kube-proxy" class="headerlink" title="2.5.9.3 部署kube-proxy"></a>2.5.9.3 部署kube-proxy</h4><h5 id="2-5-9-3-1-创建kube-proxy证书请求文件"><a href="#2-5-9-3-1-创建kube-proxy证书请求文件" class="headerlink" title="2.5.9.3.1 创建kube-proxy证书请求文件"></a>2.5.9.3.1 创建kube-proxy证书请求文件</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube<span class="literal">-proxy</span><span class="literal">-csr</span>.json &lt;&lt; <span class="string">"EOF"</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"system:kube-proxy"</span>,</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"kubemsb"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"CN"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h5 id="2-5-9-3-2-生成证书"><a href="#2-5-9-3-2-生成证书" class="headerlink" title="2.5.9.3.2 生成证书"></a>2.5.9.3.2 生成证书</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert <span class="literal">-ca</span>=ca.pem <span class="literal">-ca</span><span class="literal">-key</span>=ca<span class="literal">-key</span>.pem <span class="literal">-config</span>=ca<span class="literal">-config</span>.json <span class="literal">-profile</span>=kubernetes kube<span class="literal">-proxy</span><span class="literal">-csr</span>.json | cfssljson <span class="literal">-bare</span> kube<span class="literal">-proxy</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ls kube-proxy*</span></span><br><span class="line">kube<span class="literal">-proxy</span>.csr  kube<span class="literal">-proxy</span><span class="literal">-csr</span>.json  kube<span class="literal">-proxy</span><span class="literal">-key</span>.pem  kube<span class="literal">-proxy</span>.pem</span><br></pre></td></tr></table></figure>



<h5 id="2-5-9-3-3-创建kubeconfig文件"><a href="#2-5-9-3-3-创建kubeconfig文件" class="headerlink" title="2.5.9.3.3 创建kubeconfig文件"></a>2.5.9.3.3 创建kubeconfig文件</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl config <span class="built_in">set-cluster</span> kubernetes -<span class="literal">-certificate</span><span class="literal">-authority</span>=ca.pem -<span class="literal">-embed</span><span class="literal">-certs</span>=true -<span class="literal">-server</span>=https://<span class="number">192.168</span>.<span class="number">224.100</span>:<span class="number">6443</span> -<span class="literal">-kubeconfig</span>=kube<span class="literal">-proxy</span>.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config <span class="built_in">set-credentials</span> kube<span class="literal">-proxy</span> -<span class="literal">-client</span><span class="literal">-certificate</span>=kube<span class="literal">-proxy</span>.pem -<span class="literal">-client</span><span class="literal">-key</span>=kube<span class="literal">-proxy</span><span class="literal">-key</span>.pem -<span class="literal">-embed</span><span class="literal">-certs</span>=true -<span class="literal">-kubeconfig</span>=kube<span class="literal">-proxy</span>.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config <span class="built_in">set-context</span> default -<span class="literal">-cluster</span>=kubernetes -<span class="literal">-user</span>=kube<span class="literal">-proxy</span> -<span class="literal">-kubeconfig</span>=kube<span class="literal">-proxy</span>.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config <span class="built_in">use-context</span> default -<span class="literal">-kubeconfig</span>=kube<span class="literal">-proxy</span>.kubeconfig</span><br></pre></td></tr></table></figure>



<h5 id="2-5-9-3-4-创建服务配置文件"><a href="#2-5-9-3-4-创建服务配置文件" class="headerlink" title="2.5.9.3.4 创建服务配置文件"></a>2.5.9.3.4 创建服务配置文件</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube<span class="literal">-proxy</span>.yaml &lt;&lt; <span class="string">"EOF"</span></span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">bindAddress: <span class="number">192.168</span>.<span class="number">224.12</span></span><br><span class="line">clientConnection:</span><br><span class="line">  kubeconfig: /etc/kubernetes/kube<span class="literal">-proxy</span>.kubeconfig</span><br><span class="line">clusterCIDR: <span class="number">10.244</span>.<span class="number">0.0</span>/<span class="number">16</span></span><br><span class="line">healthzBindAddress: <span class="number">192.168</span>.<span class="number">224.12</span>:<span class="number">10256</span></span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">metricsBindAddress: <span class="number">192.168</span>.<span class="number">224.12</span>:<span class="number">10249</span></span><br><span class="line">mode: <span class="string">"ipvs"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h5 id="2-5-9-3-5-创建服务启动管理文件"><a href="#2-5-9-3-5-创建服务启动管理文件" class="headerlink" title="2.5.9.3.5 创建服务启动管理文件"></a>2.5.9.3.5 创建服务启动管理文件</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;  kube<span class="literal">-proxy</span>.service &lt;&lt; <span class="string">"EOF"</span></span><br><span class="line">[<span class="type">Unit</span>]</span><br><span class="line">Description=Kubernetes Kube<span class="literal">-Proxy</span> Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[<span class="type">Service</span>]</span><br><span class="line">WorkingDirectory=/var/lib/kube<span class="literal">-proxy</span></span><br><span class="line">ExecStart=/usr/local/bin/kube<span class="literal">-proxy</span> \</span><br><span class="line">  -<span class="literal">-config</span>=/etc/kubernetes/kube<span class="literal">-proxy</span>.yaml \</span><br><span class="line">  -<span class="literal">-alsologtostderr</span>=true \</span><br><span class="line">  -<span class="literal">-logtostderr</span>=false \</span><br><span class="line">  -<span class="literal">-log</span><span class="literal">-dir</span>=/var/log/kubernetes \</span><br><span class="line">  -<span class="literal">-v</span>=<span class="number">2</span></span><br><span class="line">Restart=on<span class="literal">-failure</span></span><br><span class="line">RestartSec=<span class="number">5</span></span><br><span class="line">LimitNOFILE=<span class="number">65536</span></span><br><span class="line"></span><br><span class="line">[<span class="type">Install</span>]</span><br><span class="line">WantedBy=multi<span class="literal">-user</span>.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h5 id="2-5-9-3-6-同步文件到集群工作节点主机"><a href="#2-5-9-3-6-同步文件到集群工作节点主机" class="headerlink" title="2.5.9.3.6 同步文件到集群工作节点主机"></a>2.5.9.3.6 同步文件到集群工作节点主机</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp kube<span class="literal">-proxy</span>*.pem /etc/kubernetes/ssl/</span><br><span class="line">cp kube<span class="literal">-proxy</span>.kubeconfig kube<span class="literal">-proxy</span>.yaml /etc/kubernetes/</span><br><span class="line">cp kube<span class="literal">-proxy</span>.service /usr/lib/systemd/system/</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> k8s<span class="literal">-master2</span> k8s<span class="literal">-master3</span> k8s<span class="literal">-worker1</span>;<span class="keyword">do</span> scp kube<span class="literal">-proxy</span>.kubeconfig kube<span class="literal">-proxy</span>.yaml <span class="variable">$i:</span>/etc/kubernetes/;done</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> k8s<span class="literal">-master2</span> k8s<span class="literal">-master3</span> k8s<span class="literal">-worker1</span>;<span class="keyword">do</span> scp  kube<span class="literal">-proxy</span>.service <span class="variable">$i:</span>/usr/lib/systemd/system/;done</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">说明：</span><br><span class="line">修改kube<span class="literal">-proxy</span>.yaml中IP地址为当前主机IP.</span><br></pre></td></tr></table></figure>



<h5 id="2-5-9-3-7-服务启动"><a href="#2-5-9-3-7-服务启动" class="headerlink" title="2.5.9.3.7 服务启动"></a>2.5.9.3.7 服务启动</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir <span class="literal">-p</span> /var/lib/kube<span class="literal">-proxy</span></span><br></pre></td></tr></table></figure>





<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon<span class="literal">-reload</span></span><br><span class="line">systemctl enable -<span class="literal">-now</span> kube<span class="literal">-proxy</span></span><br><span class="line"></span><br><span class="line">systemctl status kube<span class="literal">-proxy</span></span><br></pre></td></tr></table></figure>



<h3 id="2-5-10-网络组件部署-Calico"><a href="#2-5-10-网络组件部署-Calico" class="headerlink" title="2.5.10 网络组件部署 Calico"></a>2.5.10 网络组件部署 Calico</h3><h4 id="2-5-10-1-下载"><a href="#2-5-10-1-下载" class="headerlink" title="2.5.10.1 下载"></a>2.5.10.1 下载</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://docs.projectcalico.org/v3.<span class="number">19</span>/manifests/calico.yaml</span><br></pre></td></tr></table></figure>



<h4 id="2-5-10-2-修改文件"><a href="#2-5-10-2-修改文件" class="headerlink" title="2.5.10.2 修改文件"></a>2.5.10.2 修改文件</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">3683</span>             - name: CALICO_IPV4POOL_CIDR</span><br><span class="line"><span class="number">3684</span>               value: <span class="string">"10.244.0.0/16"</span></span><br></pre></td></tr></table></figure>



<h4 id="2-5-10-3-应用文件"><a href="#2-5-10-3-应用文件" class="headerlink" title="2.5.10.3 应用文件"></a>2.5.10.3 应用文件</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply <span class="operator">-f</span> calico.yaml</span><br></pre></td></tr></table></figure>





<h4 id="2-5-10-4-验证应用结果"><a href="#2-5-10-4-验证应用结果" class="headerlink" title="2.5.10.4 验证应用结果"></a>2.5.10.4 验证应用结果</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -A</span></span><br><span class="line">NAMESPACE     NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube<span class="literal">-system</span>   calico<span class="literal">-kube</span><span class="literal">-controllers</span><span class="literal">-7cc8dd57d9</span><span class="literal">-tf2m5</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">72</span>s</span><br><span class="line">kube<span class="literal">-system</span>   calico<span class="literal">-node</span><span class="literal">-llw5w</span>                          <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">72</span>s</span><br><span class="line">kube<span class="literal">-system</span>   calico<span class="literal">-node</span><span class="literal">-mhh6g</span>                          <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">72</span>s</span><br><span class="line">kube<span class="literal">-system</span>   calico<span class="literal">-node</span><span class="literal">-twj99</span>                          <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">72</span>s</span><br><span class="line">kube<span class="literal">-system</span>   calico<span class="literal">-node</span><span class="literal">-zh6xl</span>                          <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">72</span>s</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME          STATUS   ROLES    AGE   VERSION</span><br><span class="line">k8s<span class="literal">-master1</span>   Ready    &lt;none&gt;   <span class="number">55</span>m   v1.<span class="number">21.10</span></span><br><span class="line">k8s<span class="literal">-master2</span>   Ready    &lt;none&gt;   <span class="number">53</span>m   v1.<span class="number">21.10</span></span><br><span class="line">k8s<span class="literal">-master3</span>   Ready    &lt;none&gt;   <span class="number">53</span>m   v1.<span class="number">21.10</span></span><br><span class="line">k8s<span class="literal">-worker1</span>   Ready    &lt;none&gt;   <span class="number">57</span>m   v1.<span class="number">21.10</span></span><br></pre></td></tr></table></figure>



<h3 id="2-5-10-部署CoreDNS"><a href="#2-5-10-部署CoreDNS" class="headerlink" title="2.5.10 部署CoreDNS"></a>2.5.10 部署CoreDNS</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;  coredns.yaml &lt;&lt; <span class="string">"EOF"</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube<span class="literal">-system</span></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac<span class="literal">-defaults</span></span><br><span class="line">  name: system:coredns</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">    - <span class="string">""</span></span><br><span class="line">    resources:</span><br><span class="line">    - endpoints</span><br><span class="line">    - services</span><br><span class="line">    - pods</span><br><span class="line">    - namespaces</span><br><span class="line">    verbs:</span><br><span class="line">    - list</span><br><span class="line">    - watch</span><br><span class="line">  - apiGroups:</span><br><span class="line">    - discovery.k8s.io</span><br><span class="line">    resources:</span><br><span class="line">    - endpointslices</span><br><span class="line">    verbs:</span><br><span class="line">    - list</span><br><span class="line">    - watch</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: <span class="string">"true"</span></span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac<span class="literal">-defaults</span></span><br><span class="line">  name: system:coredns</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:coredns</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube<span class="literal">-system</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube<span class="literal">-system</span></span><br><span class="line"><span class="keyword">data</span>:</span><br><span class="line">  Corefile: |</span><br><span class="line">    .:<span class="number">53</span> &#123;</span><br><span class="line">        errors</span><br><span class="line">        health &#123;</span><br><span class="line">          lameduck <span class="number">5</span>s</span><br><span class="line">        &#125;</span><br><span class="line">        ready</span><br><span class="line">        kubernetes cluster.local  <span class="keyword">in</span><span class="literal">-addr</span>.arpa ip6.arpa &#123;</span><br><span class="line">          fallthrough <span class="keyword">in</span><span class="literal">-addr</span>.arpa ip6.arpa</span><br><span class="line">        &#125;</span><br><span class="line">        prometheus :<span class="number">9153</span></span><br><span class="line">        forward . /etc/resolv.conf &#123;</span><br><span class="line">          max_concurrent <span class="number">1000</span></span><br><span class="line">        &#125;</span><br><span class="line">        cache <span class="number">30</span></span><br><span class="line">        loop</span><br><span class="line">        reload</span><br><span class="line">        loadbalance</span><br><span class="line">    &#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube<span class="literal">-system</span></span><br><span class="line">  labels:</span><br><span class="line">    k8s<span class="literal">-app</span>: kube<span class="literal">-dns</span></span><br><span class="line">    kubernetes.io/name: <span class="string">"CoreDNS"</span></span><br><span class="line">spec:</span><br><span class="line">  <span class="comment"># replicas: not specified here:</span></span><br><span class="line">  <span class="comment"># 1. Default is 1.</span></span><br><span class="line">  <span class="comment"># 2. Will be tuned in real time if DNS horizontal auto-scaling is turned on.</span></span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxUnavailable: <span class="number">1</span></span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s<span class="literal">-app</span>: kube<span class="literal">-dns</span></span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s<span class="literal">-app</span>: kube<span class="literal">-dns</span></span><br><span class="line">    spec:</span><br><span class="line">      priorityClassName: system<span class="literal">-cluster</span><span class="literal">-critical</span></span><br><span class="line">      serviceAccountName: coredns</span><br><span class="line">      tolerations:</span><br><span class="line">        - key: <span class="string">"CriticalAddonsOnly"</span></span><br><span class="line">          operator: <span class="string">"Exists"</span></span><br><span class="line">      nodeSelector:</span><br><span class="line">        kubernetes.io/os: linux</span><br><span class="line">      affinity:</span><br><span class="line">         podAntiAffinity:</span><br><span class="line">           preferredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">           - weight: <span class="number">100</span></span><br><span class="line">             podAffinityTerm:</span><br><span class="line">               labelSelector:</span><br><span class="line">                 matchExpressions:</span><br><span class="line">                   - key: k8s<span class="literal">-app</span></span><br><span class="line">                     operator: <span class="keyword">In</span></span><br><span class="line">                     values: [<span class="string">"kube-dns"</span>]</span><br><span class="line">               topologyKey: kubernetes.io/hostname</span><br><span class="line">      containers:</span><br><span class="line">      - name: coredns</span><br><span class="line">        image: coredns/coredns:<span class="number">1.8</span>.<span class="number">4</span></span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            memory: <span class="number">170</span>Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: <span class="number">100</span>m</span><br><span class="line">            memory: <span class="number">70</span>Mi</span><br><span class="line">        args: [ <span class="string">"-conf"</span>, <span class="string">"/etc/coredns/Corefile"</span> ]</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: config<span class="literal">-volume</span></span><br><span class="line">          mountPath: /etc/coredns</span><br><span class="line">          readOnly: true</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: <span class="number">53</span></span><br><span class="line">          name: dns</span><br><span class="line">          protocol: UDP</span><br><span class="line">        - containerPort: <span class="number">53</span></span><br><span class="line">          name: dns<span class="literal">-tcp</span></span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: <span class="number">9153</span></span><br><span class="line">          name: metrics</span><br><span class="line">          protocol: TCP</span><br><span class="line">        securityContext:</span><br><span class="line">          allowPrivilegeEscalation: false</span><br><span class="line">          capabilities:</span><br><span class="line">            add:</span><br><span class="line">            - NET_BIND_SERVICE</span><br><span class="line">            drop:</span><br><span class="line">            - all</span><br><span class="line">          readOnlyRootFilesystem: true</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /health</span><br><span class="line">            port: <span class="number">8080</span></span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: <span class="number">60</span></span><br><span class="line">          timeoutSeconds: <span class="number">5</span></span><br><span class="line">          successThreshold: <span class="number">1</span></span><br><span class="line">          failureThreshold: <span class="number">5</span></span><br><span class="line">        readinessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /ready</span><br><span class="line">            port: <span class="number">8181</span></span><br><span class="line">            scheme: HTTP</span><br><span class="line">      dnsPolicy: Default</span><br><span class="line">      volumes:</span><br><span class="line">        - name: config<span class="literal">-volume</span></span><br><span class="line">          configMap:</span><br><span class="line">            name: coredns</span><br><span class="line">            items:</span><br><span class="line">            - key: Corefile</span><br><span class="line">              path: Corefile</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: kube<span class="literal">-dns</span></span><br><span class="line">  namespace: kube<span class="literal">-system</span></span><br><span class="line">  annotations:</span><br><span class="line">    prometheus.io/port: <span class="string">"9153"</span></span><br><span class="line">    prometheus.io/scrape: <span class="string">"true"</span></span><br><span class="line">  labels:</span><br><span class="line">    k8s<span class="literal">-app</span>: kube<span class="literal">-dns</span></span><br><span class="line">    kubernetes.io/cluster<span class="literal">-service</span>: <span class="string">"true"</span></span><br><span class="line">    kubernetes.io/name: <span class="string">"CoreDNS"</span></span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    k8s<span class="literal">-app</span>: kube<span class="literal">-dns</span></span><br><span class="line">  clusterIP: <span class="number">10.96</span>.<span class="number">0.2</span></span><br><span class="line">  ports:</span><br><span class="line">  - name: dns</span><br><span class="line">    port: <span class="number">53</span></span><br><span class="line">    protocol: UDP</span><br><span class="line">  - name: dns<span class="literal">-tcp</span></span><br><span class="line">    port: <span class="number">53</span></span><br><span class="line">    protocol: TCP</span><br><span class="line">  - name: metrics</span><br><span class="line">    port: <span class="number">9153</span></span><br><span class="line">    protocol: TCP</span><br><span class="line"> </span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply <span class="operator">-f</span> coredns.yaml</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -A</span></span><br><span class="line">NAMESPACE     NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube<span class="literal">-system</span>   calico<span class="literal">-kube</span><span class="literal">-controllers</span><span class="literal">-7cc8dd57d9</span><span class="literal">-tf2m5</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">4</span>m7s</span><br><span class="line">kube<span class="literal">-system</span>   calico<span class="literal">-node</span><span class="literal">-llw5w</span>                          <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">4</span>m7s</span><br><span class="line">kube<span class="literal">-system</span>   calico<span class="literal">-node</span><span class="literal">-mhh6g</span>                          <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">4</span>m7s</span><br><span class="line">kube<span class="literal">-system</span>   calico<span class="literal">-node</span><span class="literal">-twj99</span>                          <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">4</span>m7s</span><br><span class="line">kube<span class="literal">-system</span>   calico<span class="literal">-node</span><span class="literal">-zh6xl</span>                          <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">4</span>m7s</span><br><span class="line">kube<span class="literal">-system</span>   coredns<span class="literal">-675db8b7cc</span><span class="literal">-ncnf6</span>                   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">26</span>s</span><br></pre></td></tr></table></figure>

<p>这里可以测试coredns是否生效</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig -t a www.baidu.com @10.96.0.2</span><br></pre></td></tr></table></figure>





<h3 id="2-5-11-部署应用验证"><a href="#2-5-11-部署应用验证" class="headerlink" title="2.5.11 部署应用验证"></a>2.5.11 部署应用验证</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;  nginx.yaml  &lt;&lt; <span class="string">"EOF"</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ReplicationController</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx<span class="literal">-web</span></span><br><span class="line">spec:</span><br><span class="line">  replicas: <span class="number">2</span></span><br><span class="line">  selector:</span><br><span class="line">    name: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: nginx</span><br><span class="line">          image: nginx:<span class="number">1.19</span>.<span class="number">6</span></span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: <span class="number">80</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx<span class="literal">-service</span><span class="literal">-nodeport</span></span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">    - port: <span class="number">80</span></span><br><span class="line">      targetPort: <span class="number">80</span></span><br><span class="line">      nodePort: <span class="number">30001</span></span><br><span class="line">      protocol: TCP</span><br><span class="line">  type: NodePort</span><br><span class="line">  selector:</span><br><span class="line">    name: nginx</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply <span class="operator">-f</span> nginx.yaml</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -o wide</span></span><br><span class="line">NAME              READY   STATUS    RESTARTS   AGE     IP              NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx<span class="literal">-web</span><span class="literal">-2ghbj</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">4</span>m31s   <span class="number">10.244</span>.<span class="number">194.65</span>   k8s<span class="literal">-worker1</span>   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx<span class="literal">-web</span><span class="literal">-dgdcx</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">4</span>m31s   <span class="number">10.244</span>.<span class="number">224.1</span>    k8s<span class="literal">-master2</span>   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>





<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get all</span></span><br><span class="line">NAME                  READY   STATUS              RESTARTS   AGE</span><br><span class="line">pod/nginx<span class="literal">-web</span><span class="literal">-2ghbj</span>   <span class="number">0</span>/<span class="number">1</span>     ContainerCreating   <span class="number">0</span>          <span class="number">33</span>s</span><br><span class="line">pod/nginx<span class="literal">-web</span><span class="literal">-dgdcx</span>   <span class="number">0</span>/<span class="number">1</span>     ContainerCreating   <span class="number">0</span>          <span class="number">33</span>s</span><br><span class="line"></span><br><span class="line">NAME                              DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicationcontroller/nginx<span class="literal">-web</span>   <span class="number">2</span>         <span class="number">2</span>         <span class="number">0</span>       <span class="number">33</span>s</span><br><span class="line"></span><br><span class="line">NAME                             TYPE        CLUSTER<span class="literal">-IP</span>      EXTERNAL<span class="literal">-IP</span>   PORT(S)        AGE</span><br><span class="line">service/kubernetes               ClusterIP   <span class="number">10.96</span>.<span class="number">0.1</span>       &lt;none&gt;        <span class="number">443</span>/TCP        <span class="number">4</span>h8m</span><br><span class="line">service/nginx<span class="literal">-service</span><span class="literal">-nodeport</span>   NodePort    <span class="number">10.96</span>.<span class="number">145.204</span>   &lt;none&gt;        <span class="number">80</span>:<span class="number">30001</span>/TCP   <span class="number">33</span>s</span><br><span class="line">[<span class="type">root</span>@<span class="type">k8s</span>-<span class="type">master1</span> <span class="type">k8s</span>-<span class="type">work</span>]<span class="comment">#</span></span><br></pre></td></tr></table></figure>



<p><a href="https://imgse.com/i/p9BUVo9"><img src="https://s1.ax1x.com/2023/05/09/p9BUVo9.png" alt="p9BUVo9.png"></a></p>
</div><ul class="post-copyright"><li><strong>本文标题：</strong><a href="https://yc6.cool/2023/05/17/Kubernetes高可用集群二进制部署/">Kubernetes高可用集群二进制部署</a></li><li><strong>本文作者：</strong><a href="https://yc6.cool">yichen</a></li><li><strong>本文链接：</strong><a href="https://yc6.cool/2023/05/17/Kubernetes高可用集群二进制部署/">https://yc6.cool/2023/05/17/Kubernetes高可用集群二进制部署/</a></li><li><strong>版权声明：</strong><span>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明出处！</span></li></ul><div><div class="recommend-post"><span class="is-size-6 has-text-grey has-mr-7"># 相关文章</span><br><span>  1.<a class="is-size-6" href="/2022/03/12/openresty%E7%BB%93%E5%90%88lua%E5%AF%B9%E5%90%8C%E4%B8%80%E6%9D%A1%E5%9F%9F%E5%90%8D%E5%88%A4%E6%96%AD%E5%8F%82%E6%95%B0%E5%81%9A%E8%B4%9F%E8%BD%BD/" target="_blank">openresty结合lua对域名参数做负载均衡</a><br></span><span>  2.<a class="is-size-6" href="/2021/07/31/nginx%E5%88%A4%E6%96%AD%E5%BE%AE%E4%BF%A1%E7%AB%AF%E8%B7%B3%E8%BD%AC%E4%B8%8D%E5%90%8C%E9%A1%B5%E9%9D%A2/" target="_blank">nginx判断微信端跳转不同页面</a><br></span><span>  3.<a class="is-size-6" href="/2020/09/30/nftables/" target="_blank">nftables</a><br></span><span>  4.<a class="is-size-6" href="/2020/08/04/k8s%E4%B8%ADYAML%E6%96%87%E4%BB%B6%E7%BC%96%E5%86%99%E4%B8%8E%E4%BD%BF%E7%94%A8/" target="_blank">k8s中yaml文件编写与使用</a><br></span><span>  5.<a class="is-size-6" href="/2020/08/04/k8s%E6%90%AD%E5%BB%BA/" target="_blank">kubernetes搭建</a><br></span><span>  6.<a class="is-size-6" href="/2020/08/04/%E5%88%9B%E5%BB%BAcentos%E9%95%9C%E5%83%8F%E6%94%AF%E6%8C%81ssh/" target="_blank">创建centos镜像支持ssh远程连接</a><br></span><span>  7.<a class="is-size-6" href="/2020/08/04/docker%E4%B8%80%E9%94%AE%E5%AE%89%E8%A3%85%E9%85%B7Q%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BAQQ%E6%9C%BA%E5%99%A8%E4%BA%BA/" target="_blank">docke一键安装酷Q搭建个人QQ机器人</a><br></span><span>  8.<a class="is-size-6" href="/2020/08/04/docker%E6%95%B0%E6%8D%AE%E5%8C%96%E6%8C%81%E4%B9%85%E5%8D%B7%E6%8F%92%E4%BB%B6/" target="_blank">docker数据持久卷插件</a><br></span></div><div class="recommend-post"><span class="is-size-6 has-text-grey has-mr-7"># 推荐文章</span><br><span>  1.<a class="is-size-6" href="/2020/08/04/docker%E4%BD%BF%E7%94%A8/" target="_blank">docker的使用</a><br></span><span>  2.<a class="is-size-6" href="/2020/08/03/mysql%E5%9F%BA%E7%A1%80/" target="_blank">mysql基础</a><br></span><span>  3.<a class="is-size-6" href="/2020/08/03/nginx%E5%9F%BA%E7%A1%80/" target="_blank">nginx基础</a><br></span><span>  4.<a class="is-size-6" href="/2020/08/04/python3%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E9%87%8D%E7%82%B9/" target="_blank">python3基础知识重点</a><br></span><span>  5.<a class="is-size-6" href="/2023/05/07/Linux%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%B3%BB%E7%BB%9F%E7%9B%91%E6%8E%A7/" target="_blank">Prometheus监控linux</a><br></span><span>  6.<a class="is-size-6" href="/2023/05/10/Prometheus%E4%BD%BF%E7%94%A8%E9%82%AE%E7%AE%B1%E6%8E%A5%E6%94%B6%E5%91%8A%E8%AD%A6%E9%80%9A%E7%9F%A5/" target="_blank">Prometheus使用邮件接收告警通知</a><br></span></div></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/css/share.min.css"><div class="social-share"></div><script src="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button is-info donate"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="https://yichenxiu.com/tupian/tubiao/alipay1.jpg" alt="支付宝"></span></a><a class="button is-success donate"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="https://i.328888.xyz/2023/03/05/dZXCk.jpeg" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2023/11/01/python%E4%B9%8BSelenium%E6%A8%A1%E5%9D%97/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">python之Selenium模块的使用</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2023/05/10/Prometheus%E4%BD%BF%E7%94%A8%E6%89%8B%E6%9C%BA%E7%94%B5%E8%AF%9D_%E7%9F%AD%E4%BF%A1%E6%8E%A5%E6%94%B6%E5%91%8A%E8%AD%A6%E9%80%9A%E7%9F%A5/"><span class="level-item">Prometheus使用手机电话_短信接收告警通知</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/gitalk/1.6.0/gitalk.css"><script> $.getScript('/js/gitalk.min.js', function () { 
            var gitalk = new Gitalk({
            language:'zh-CN',
            id: '0c6016ad13db3099cdedc763e113d194',
            repo: 'issue_database',
            owner: 'zhi666',
            clientID: '1b861f81e9a79ee6028d',
            clientSecret: 'cc629aff090aa9c60d5e13ddf7fcfce14f00a478',
            admin: ["zhi666"],
            createIssueManually: true,
            distractionFreeMode: true,
            perPage: 10,
            pagerDirection: 'last',
            proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token',
            
            enableHotKey: true,
            isLocked: false
        })
        gitalk.render('comment-container')});</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1 is-sticky"><div class="card widget toc-scroll" id="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list toc"><li><a class="is-flex toc-item" id="toc-item-Kubernetes高可用集群二进制部署（Runtime-Containerd）" href="#Kubernetes高可用集群二进制部署（Runtime-Containerd）"><span>Kubernetes高可用集群二进制部署（Runtime Containerd）</span></a></li><li><a class="is-flex toc-item" id="toc-item-一、集群环境准备" href="#一、集群环境准备"><span>一、集群环境准备</span></a><ul class="menu-list toc"><li><a class="is-flex toc-item" id="toc-item-1-1-主机规划" href="#1-1-主机规划"><span>1.1 主机规划</span></a></li><li><a class="is-flex toc-item" id="toc-item-1-2-软件版本" href="#1-2-软件版本"><span>1.2 软件版本</span></a></li><li><a class="is-flex toc-item" id="toc-item-1-3-网络分配" href="#1-3-网络分配"><span>1.3 网络分配</span></a></li></ul></li><li><a class="is-flex toc-item" id="toc-item-二、集群部署" href="#二、集群部署"><span>二、集群部署</span></a><ul class="menu-list toc"><li><a class="is-flex toc-item" id="toc-item-2-1主机准备" href="#2-1主机准备"><span>2.1主机准备</span></a><ul class="menu-list toc"><li><a class="is-flex toc-item" id="toc-item-2-1-1-主机名设置" href="#2-1-1-主机名设置"><span>2.1.1 主机名设置</span></a></li><li><a class="is-flex toc-item" id="toc-item-2-1-2-主机与IP地址解析" href="#2-1-2-主机与IP地址解析"><span>2.1.2 主机与IP地址解析</span></a></li><li><a class="is-flex toc-item" id="toc-item-2-1-3-2-关闭selinux" href="#2-1-3-2-关闭selinux"><span>2.1.3.2 关闭selinux</span></a></li><li><a class="is-flex toc-item" id="toc-item-2-1-4-交换分区设置" href="#2-1-4-交换分区设置"><span>2.1.4 交换分区设置</span></a></li><li><a class="is-flex toc-item" id="toc-item-2-1-5-主机系统时间同步" href="#2-1-5-主机系统时间同步"><span>2.1.5 主机系统时间同步</span></a></li><li><a class="is-flex toc-item" id="toc-item-2-1-6-主机系统优化" href="#2-1-6-主机系统优化"><span>2.1.6 主机系统优化</span></a></li><li><a class="is-flex toc-item" id="toc-item-2-1-7-ipvs管理工具安装及模块加载" href="#2-1-7-ipvs管理工具安装及模块加载"><span>2.1.7 ipvs管理工具安装及模块加载</span></a></li><li><a class="is-flex toc-item" id="toc-item-2-1-8-加载containerd相关内核模块" href="#2-1-8-加载containerd相关内核模块"><span>2.1.8 加载containerd相关内核模块</span></a></li><li><a class="is-flex toc-item" id="toc-item-2-1-9-Linux内核升级" href="#2-1-9-Linux内核升级"><span>2.1.9 Linux内核升级</span></a></li><li><a class="is-flex toc-item" id="toc-item-2-1-10-Linux内核优化" href="#2-1-10-Linux内核优化"><span>2.1.10 Linux内核优化</span></a></li><li><a class="is-flex toc-item" id="toc-item-2-1-11-其它工具安装-选装" href="#2-1-11-其它工具安装-选装"><span>2.1.11 其它工具安装(选装)</span></a></li></ul></li><li><a class="is-flex toc-item" id="toc-item-2-2-负载均衡器准备" href="#2-2-负载均衡器准备"><span>2.2 负载均衡器准备</span></a><ul class="menu-list toc"><li><a class="is-flex toc-item" id="toc-item-2-2-1-安装haproxy与keepalived" href="#2-2-1-安装haproxy与keepalived"><span>2.2.1 安装haproxy与keepalived</span></a></li><li><a class="is-flex toc-item" id="toc-item-2-2-2-HAProxy配置" href="#2-2-2-HAProxy配置"><span>2.2.2 HAProxy配置</span></a></li><li><a class="is-flex toc-item" id="toc-item-2-2-3-KeepAlived" href="#2-2-3-KeepAlived"><span>2.2.3 KeepAlived</span></a></li><li><a class="is-flex toc-item" id="toc-item-2-2-4-健康检查脚本" href="#2-2-4-健康检查脚本"><span>2.2.4 健康检查脚本</span></a></li><li><a class="is-flex toc-item" id="toc-item-2-2-5-启动服务并验证" href="#2-2-5-启动服务并验证"><span>2.2.5 启动服务并验证</span></a></li></ul></li><li><a class="is-flex toc-item" id="toc-item-2-3-配置免密登录" href="#2-3-配置免密登录"><span>2.3 配置免密登录</span></a></li><li><a class="is-flex toc-item" id="toc-item-2-4-部署ETCD集群" href="#2-4-部署ETCD集群"><span>2.4 部署ETCD集群</span></a><ul class="menu-list toc"><li><a class="is-flex toc-item" id="toc-item-2-4-1-创建工作目录" href="#2-4-1-创建工作目录"><span>2.4.1 创建工作目录</span></a></li><li><a class="is-flex toc-item" id="toc-item-2-4-2-获取cfssl工具" href="#2-4-2-获取cfssl工具"><span>2.4.2 获取cfssl工具</span></a></li><li><a class="is-flex toc-item" id="toc-item-2-4-3-3-配置ca证书策略" href="#2-4-3-3-配置ca证书策略"><span>2.4.3.3 配置ca证书策略</span></a></li><li><a class="is-flex toc-item" id="toc-item-2-4-4-2-生成etcd证书" href="#2-4-4-2-生成etcd证书"><span>2.4.4.2 生成etcd证书</span></a></li><li><a class="is-flex toc-item" id="toc-item-2-4-5-8-验证集群状态" href="#2-4-5-8-验证集群状态"><span>2.4.5.8 验证集群状态</span></a></li></ul></li><li><a class="is-flex toc-item" id="toc-item-2-5-Kubernetes集群部署" href="#2-5-Kubernetes集群部署"><span>2.5 Kubernetes集群部署</span></a><ul class="menu-list toc"><li><a class="is-flex toc-item" id="toc-item-2-5-1-Kubernetes软件包下载" href="#2-5-1-Kubernetes软件包下载"><span>2.5.1 Kubernetes软件包下载</span></a></li><li><a class="is-flex toc-item" id="toc-item-2-5-2-Kubernetes软件包安装" href="#2-5-2-Kubernetes软件包安装"><span>2.5.2 Kubernetes软件包安装</span></a></li><li><a class="is-flex toc-item" id="toc-item-2-5-3-Kubernetes软件分发" href="#2-5-3-Kubernetes软件分发"><span>2.5.3 Kubernetes软件分发</span></a></li><li><a class="is-flex toc-item" id="toc-item-2-5-4-在集群节点上创建目录" href="#2-5-4-在集群节点上创建目录"><span>2.5.4 在集群节点上创建目录</span></a></li><li><a class="is-flex toc-item" id="toc-item-2-5-5-6-启动apiserver服务" href="#2-5-5-6-启动apiserver服务"><span>2.5.5.6 启动apiserver服务</span></a></li><li><a class="is-flex toc-item" id="toc-item-2-5-6-8-配置kubectl命令补全-可选" href="#2-5-6-8-配置kubectl命令补全-可选"><span>2.5.6.8 配置kubectl命令补全(可选)</span></a></li><li><a class="is-flex toc-item" id="toc-item-2-5-7-7-启动服务" href="#2-5-7-7-启动服务"><span>2.5.7.7 启动服务</span></a></li><li><a class="is-flex toc-item" id="toc-item-2-5-8-7-启动服务" href="#2-5-8-7-启动服务"><span>2.5.8.7 启动服务</span></a></li><li><a class="is-flex toc-item" id="toc-item-2-5-9-3-7-服务启动" href="#2-5-9-3-7-服务启动"><span>2.5.9.3.7 服务启动</span></a></li><li><a class="is-flex toc-item" id="toc-item-2-5-10-4-验证应用结果" href="#2-5-10-4-验证应用结果"><span>2.5.10.4 验证应用结果</span></a></li><li><a class="is-flex toc-item" id="toc-item-2-5-10-部署CoreDNS" href="#2-5-10-部署CoreDNS"><span>2.5.10 部署CoreDNS</span></a></li><li><a class="is-flex toc-item" id="toc-item-2-5-11-部署应用验证" href="#2-5-11-部署应用验证"><span>2.5.11 部署应用验证</span></a></li></ul></li></ul></li></ul></div></div><script type="text/javascript" async>
        $(document).ready(function () { //参考自 https://github.com/ppoffice/hexo-theme-icarus/pull/616/files
            var observerTopMargin;
            var scrollObserver;
            var headerElems = $(".headerlink");
            var activeTocItem;
        
            function initIntersectionObserver(docHeight) {
                observerTopMargin = docHeight;
                scrollObserver = new IntersectionObserver(scrollCallBack,
                    {
                        root: null,  // viewpoint
                        rootMargin: docHeight + "px 0px -80% 0px"  // cover top 30% of viewport to the top of document
                    })
            }
        
            function scrollCallBack(entries, observer) {
                if ($(window).scrollTop() > observerTopMargin * 0.7) { 
                    // User somehow scroll to 70% of observerTopMargin (which is inited as 200% document height)
                    // Observer top margin need to extend to cover all the space to the top of the document
                    initIntersectionObserver(observerTopMargin * 2)
                    observer.disconnect();
                    return;
                }
                let toActive;
                if (entries[0].intersectionRatio == 1) {  // enter viewed area
                    let entry = entries.reduce((u, v) => (u.target.toc_id > v.target.toc_id ? u : v));  // get the lowest item
                    toActive = $("#toc-item-" + $(entry.target).attr("href").substr(1));
                } else {
                    let entry = entries.reduce((u, v) => (u.target.toc_id < v.target.toc_id ? u : v));  // get the highest item
                    let idx = Math.max(entry.target.toc_id - 1, 0);
                    toActive = $("#toc-item-" + $(headerElems[idx]).attr("href").substr(1));
                }
                if (activeTocItem) activeTocItem.removeClass("is-current");
                activeTocItem = toActive
                activeTocItem.addClass("is-current");
            }
        
            initIntersectionObserver($(document).height() * 2);
            headerElems.each(function (index, obj) {
                obj.toc_id = index;
                scrollObserver.observe(obj);
            })
        });</script></div><div class="card widget"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="is-rounded" src="/img/toudong.jpg" alt="逸尘秀"></figure><p class="title is-size-4 is-block line-height-inherit">逸尘秀</p><p class="is-size-6 is-block">只此一生 ， 必须快乐 ！</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>深圳</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">136</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">17</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">55</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://weibo.com/u/6155656382" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-white is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/zhi666"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-white is-marginless" target="_blank" rel="noopener" title="Weibo" href="https://weibo.com/u/6155656382"><i class="fab fa-weibo"></i></a><a class="level-item button is-transparent is-white is-marginless" target="_blank" rel="noopener" title="Email" href="mailto:1378373724@qq.com"><i class="fa fa-envelope"></i></a><a class="level-item button is-transparent is-white is-marginless" target="_blank" rel="noopener" title="Next" href="https://zhi666.github.io/remove.io"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-white is-marginless" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a></div><div><hr><p id="hitokoto">:D 一言句子获取中...</p><script type="text/javascript" defer>function getYiyan(){
                                $.getJSON("https://v1.hitokoto.cn/", function (data) {
                                if(data){
                                    $('#hitokoto').html("");
                                    $('#hitokoto').append("<strong style='color: #3273dc;'>"+data.hitokoto+"</strong>"+
                                    "<p>"+"来源《"+data.from+"》</p><p>提供者-"+data.creator+"</p>");
                                }});}
                                $(function (){getYiyan();$('#hitokoto').click(function(){getYiyan();})});</script></div></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新评论</h3><span class="body_hot_comment">加载中，最新评论有1分钟缓存...</span></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content size-small"><p><time dateTime="2023-11-01T02:25:44.578Z">2023-11-01</time></p><p class="title is-6"><a class="link-muted" href="/2023/11/01/selenlium%E6%89%B9%E9%87%8F%E6%B7%BB%E5%8A%A0dns%E5%9F%9F%E5%90%8D/">批量添加dns域名解析</a></p><p class="is-uppercase"><i class="fas fa-folder-open has-text-grey"> </i><a class="link-muted" href="/categories/python/">python</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2023-05-17T01:45:36.000Z">2023-05-17</time></p><p class="title is-6"><a class="link-muted" href="/2023/05/17/Kubernetes%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2/">Kubernetes高可用集群二进制部署</a></p><p class="is-uppercase"><i class="fas fa-folder-open has-text-grey"> </i><a class="link-muted" href="/categories/linux3/">linux3</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2023-05-10T06:25:36.000Z">2023-05-10</time></p><p class="title is-6"><a class="link-muted" href="/2023/05/10/Prometheus%E4%BD%BF%E7%94%A8%E6%89%8B%E6%9C%BA%E7%94%B5%E8%AF%9D_%E7%9F%AD%E4%BF%A1%E6%8E%A5%E6%94%B6%E5%91%8A%E8%AD%A6%E9%80%9A%E7%9F%A5/">Prometheus使用手机电话_短信接收告警通知</a></p><p class="is-uppercase"><i class="fas fa-folder-open has-text-grey"> </i><a class="link-muted" href="/categories/linux2/">linux2</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2023-05-10T06:22:36.000Z">2023-05-10</time></p><p class="title is-6"><a class="link-muted" href="/2023/05/10/Prometheus%E4%BD%BF%E7%94%A8%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%8E%A5%E6%94%B6%E5%91%8A%E8%AD%A6%E9%80%9A%E7%9F%A5/">Prometheus使用企业微信接收告警通知</a></p><p class="is-uppercase"><i class="fas fa-folder-open has-text-grey"> </i><a class="link-muted" href="/categories/linux2/">linux2</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2023-05-10T06:20:36.000Z">2023-05-10</time></p><p class="title is-6"><a class="link-muted" href="/2023/05/10/Prometheus%E4%BD%BF%E7%94%A8%E4%BC%81%E4%B8%9A%E9%92%89%E9%92%89%E5%91%8A%E8%AD%A6%E9%80%9A%E7%9F%A5/">Prometheus使用企业钉钉接收告警通知</a></p><p class="is-uppercase"><i class="fas fa-folder-open has-text-grey"> </i><a class="link-muted" href="/categories/linux2/">linux2</a></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/English/"><span class="level-start"><span class="level-item">English</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/HTML/"><span class="level-start"><span class="level-item">HTML</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/JS/"><span class="level-start"><span class="level-item">JS</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/html/"><span class="level-start"><span class="level-item">html</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/linux1/"><span class="level-start"><span class="level-item">linux1</span></span><span class="level-end"><span class="level-item tag">15</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/linux2/"><span class="level-start"><span class="level-item">linux2</span></span><span class="level-end"><span class="level-item tag">33</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/linux3/"><span class="level-start"><span class="level-item">linux3</span></span><span class="level-end"><span class="level-item tag">27</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/python/"><span class="level-start"><span class="level-item">python</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/web/"><span class="level-start"><span class="level-item">web</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/work/"><span class="level-start"><span class="level-item">work</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><a class="level is-mobile is-marginless" href="/categories/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/archives/2023/11/"><span class="level-start"><span class="level-item">十一月 2023</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2023/05/"><span class="level-start"><span class="level-item">五月 2023</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2023/04/"><span class="level-start"><span class="level-item">四月 2023</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2023/02/"><span class="level-start"><span class="level-item">二月 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2022/06/"><span class="level-start"><span class="level-item">六月 2022</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><a class="level is-mobile is-marginless" href="/archives/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/linux/"><span class="tag">linux</span><span class="tag is-grey-lightest">18</span></a></div><div class="control"><a class="tags has-addons" href="/tags/docker/"><span class="tag">docker</span><span class="tag is-grey-lightest">16</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Prometheus/"><span class="tag">Prometheus</span><span class="tag is-grey-lightest">14</span></a></div><div class="control"><a class="tags has-addons" href="/tags/html/"><span class="tag">html</span><span class="tag is-grey-lightest">14</span></a></div><div class="control"><a class="tags has-addons" href="/tags/python/"><span class="tag">python</span><span class="tag is-grey-lightest">12</span></a></div><div class="control"><a class="tags has-addons" href="/tags/web/"><span class="tag">web</span><span class="tag is-grey-lightest">12</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nginx/"><span class="tag">nginx</span><span class="tag is-grey-lightest">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mysql/"><span class="tag">mysql</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%AE%B9%E5%99%A8/"><span class="tag">容器</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"><span class="tag">数据库</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/"><span class="tag">科学上网</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/work/"><span class="tag">work</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%87%AA%E5%8A%A8%E5%8C%96/"><span class="tag">自动化</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8D%9A%E5%AE%A2/"><span class="tag">博客</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%B7%A5%E4%BD%9C/"><span class="tag">工作</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%B7%A5%E5%85%B7/"><span class="tag">工具</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ssl/"><span class="tag">ssl</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/"><span class="tag">文件系统</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%97%A5%E5%BF%97/"><span class="tag">日志</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%97%A5%E5%BF%97%E5%8A%A0%E5%AF%86/"><span class="tag">日志加密</span><span class="tag is-grey-lightest">3</span></a></div></div><div class="field is-grouped is-grouped-multiline"><a class="tags has-addons" href="/tags/"><span class="tag">查看全部&gt;&gt;</span></a></div></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=zhi666FeedsId&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="zhi666FeedsId" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button is-primary" type="submit" value="订阅"></div></div><p class="help">输入邮箱开始订阅，更博后邮件通知！</p></form></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.png" alt="逸尘秀" height="28"></a><p class="size-small"><span>&copy; 2023 yichen</span>  Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a>,Modify by <a href="https://github.com/removeif/hexo-theme-amazing" target="_blank">removeif</a> <br><span>© 版权说明：[本网站所有内容均收集于互联网或自己创作,<br />&nbsp;&nbsp;&nbsp;&nbsp;方便于网友与自己学习交流，如有侵权，请<a href="/message" target="_blank">留言</a>，立即处理]<br /></span><span><span id="statistic-times">loading...</span><script>function createTime(time) {
            var n = new Date(time);
            now.setTime(now.getTime() + 250),
                days = (now - n) / 1e3 / 60 / 60 / 24,
                dnum = Math.floor(days),
                hours = (now - n) / 1e3 / 60 / 60 - 24 * dnum,
                hnum = Math.floor(hours),
            1 == String(hnum).length && (hnum = "0" + hnum),
                minutes = (now - n) / 1e3 / 60 - 1440 * dnum - 60 * hnum,
                mnum = Math.floor(minutes),
            1 == String(mnum).length && (mnum = "0" + mnum),
                seconds = (now - n) / 1e3 - 86400 * dnum - 3600 * hnum - 60 * mnum,
                snum = Math.round(seconds),
            1 == String(snum).length && (snum = "0" + snum),
                document.getElementById("statistic-times").innerHTML = "❤️本站自 <strong>"+time.split(" ")[0].replace(/\//g,".")+"</strong> 已运行 <strong>" + dnum + "</strong> 天 <strong>" + hnum + "</strong> 小时 <strong>" + mnum + "</strong> 分 <strong>" + snum + "</strong> 秒！❤️";
        }var now = new Date();setInterval("createTime('2020/08/02 00:00:00')", 250,"");</script><br></span><div class="size-small"><span>❤️感谢 <strong><span id="busuanzi_value_site_uv">99+</span></strong> 小伙伴的 <strong><span id="busuanzi_value_site_pv">99+</span></strong> 次光临！❤️</span></div></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/zhi666"><i class="fab fa-github"></i></a></p></div><div class="sideMusic"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="/js/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><meting-js style="width: auto;height: 2000px;" server="netease" type="playlist" id="2364053447" theme="#2980b9" loop="all" autoplay="false" order="list" storageName="aplayer-setting" lrctype="0" list-max-height="400px" fixed="true"></meting-js></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            site: {
                url: 'https://yc6.cool',
                external_link: {"enable":true,"exclude":[]}
            },
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" defer></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back-to-top.js" defer></script><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.12/js/lightgallery-all.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer></script><!--!--><!--!--><!--!--><script src="/js/toc.js" defer></script><script src="/js/main.js" defer></script><script>$.getScript('/js/comment-issue-data.js',function(){loadIssueData('1b861f81e9a79ee6028d','cc629aff090aa9c60d5e13ddf7fcfce14f00a478','zhi666','issue_database',false);})</script><link rel="stylesheet" href="/css/insight.css"><div class="searchbox ins-search"><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"><input class="searchbox-input ins-search-input" type="text" placeholder="想要查找什么..."><span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"></div></div></div></div><script>(function (window) {
            var INSIGHT_CONFIG = {
                TRANSLATION: {
                    POSTS: '文章',
                    PAGES: '页面',
                    CATEGORIES: '分类',
                    TAGS: '标签',
                    UNTITLED: '(无标题)',
                },
                CONTENT_URL: '/content.json',
            };
            window.INSIGHT_CONFIG = INSIGHT_CONFIG;
        })(window);</script><script src="/js/insight.js" defer></script></body></html>