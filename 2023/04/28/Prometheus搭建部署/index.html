<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="generator" content="Hexo 4.2.0"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><meta name="keywords" content="[object Object]"><meta name="description" content="Prometheus搭建部署官网地址：https://prometheus.io/
安装准备
同步时间
timedatectl set-timezone Asia/Shanghai
我这台服务器ip是192.168.224.11登入，建立相应文件夹"><meta name="author" content="zhi666"><title>Prometheus搭建部署 - 逸尘秀</title><meta description="Prometheus搭建部署官网地址：https:&amp;#x2F;&amp;#x2F;prometheus.io&amp;#x2F; 安装准备 同步时间 timedatectl set-timezone Asia&amp;#x2F;Shanghai 我这台服务器ip是192.168.224.11登入，建立相应文件夹"><meta property="og:type" content="article"><meta property="og:title" content="Prometheus搭建部署"><meta property="og:url" content="https://yc6.cool/2023/04/28/Prometheus%E6%90%AD%E5%BB%BA%E9%83%A8%E7%BD%B2/"><meta property="og:site_name" content="逸尘秀"><meta property="og:description" content="Prometheus搭建部署官网地址：https:&amp;#x2F;&amp;#x2F;prometheus.io&amp;#x2F; 安装准备 同步时间 timedatectl set-timezone Asia&amp;#x2F;Shanghai 我这台服务器ip是192.168.224.11登入，建立相应文件夹"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2023-04-28T02:20:36.000Z"><meta property="article:modified_time" content="2023-11-01T02:25:44.544Z"><meta property="article:author" content="zhi666"><meta property="article:tag" content="Prometheus"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://yc6.cool/img/avatar.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://yc6.cool/2023/04/28/Prometheus%E6%90%AD%E5%BB%BA%E9%83%A8%E7%BD%B2/"},"headline":"Prometheus搭建部署","image":["https://yc6.cool/img/avatar.png"],"datePublished":"2023-04-28T02:20:36.000Z","dateModified":"2023-11-01T02:25:44.544Z","author":{"@type":"Person","name":"zhi666"},"description":"Prometheus搭建部署官网地址：https:&#x2F;&#x2F;prometheus.io&#x2F; 安装准备 同步时间 timedatectl set-timezone Asia&#x2F;Shanghai 我这台服务器ip是192.168.224.11登入，建立相应文件夹"}</script><link rel="alternative" href="/atom.xml" title="逸尘秀" type="application/atom+xml"><link rel="icon" href="/img/favicon.png"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css?family=Ubuntu:400,600|Source+Code+Pro|Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Microsoft YaHei:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&amp;amp;subset=latin,latin-ext|Inconsolata|Itim|Lobster.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/atom-one-dark.min.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.12/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><link rel="stylesheet" href="/css/style.css"><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="/js/globalUtils.js"></script><link rel="stylesheet" href="/live2d/waifu.css"><script type="text/javascript" async src="/live2d/autoload.js"></script></head><body class="is-3-column has-navbar-fixed-top"><nav class="navbar navbar-main is-fixed-top"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.png" alt="逸尘秀" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/media">影音</a><a class="navbar-item" href="/album">相册</a><a class="navbar-item" href="/friend">友链</a><a class="navbar-item" href="/self-talking">碎碎念</a><a class="navbar-item" href="/message">留言</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/zhi666"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a><a class="navbar-item" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon" id="night-icon"></i></a></div></div></div></nav><script type="text/javascript" src="/js/theme-setting.js"></script><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2023-04-28  <a class="commentCountImg" href="/2023/04/28/Prometheus%E6%90%AD%E5%BB%BA%E9%83%A8%E7%BD%B2/#comment-container"><span class="display-none-class">009fc7c98b286c2ad3d5f7355d3a59ca</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="009fc7c98b286c2ad3d5f7355d3a59ca">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>2 小时  <i class="fas fa-pencil-alt"> </i>14.2 k</span><span class="level-item" id="busuanzi_container_page_pv"><i class="far fa-eye"></i>&nbsp;&nbsp;<span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">Prometheus搭建部署</h1><div class="content"><h1 id="Prometheus搭建部署"><a href="#Prometheus搭建部署" class="headerlink" title="Prometheus搭建部署"></a>Prometheus搭建部署</h1><p>官网地址：<code>https://prometheus.io/</code></p>
<p>安装准备</p>
<p>同步时间</p>
<p>timedatectl set-timezone Asia/Shanghai</p>
<p>我这台服务器ip是<code>192.168.224.11</code>登入，建立相应文件夹</p>
<a id="more"></a>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p promethues</span><br><span class="line">mkdir -p promethues&#x2F;server</span><br><span class="line">mkdir -p promethues&#x2F;client</span><br><span class="line">touch  promethues&#x2F;server&#x2F;rules.yml</span><br><span class="line">chmod 777 promethues&#x2F;server&#x2F;rules.yml</span><br></pre></td></tr></table></figure>

<h3 id="一，安装Prometheus-Server"><a href="#一，安装Prometheus-Server" class="headerlink" title="一，安装Prometheus Server"></a>一，安装Prometheus Server</h3><p>通过docker方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">安装docker</span><br><span class="line">curl -fsSl https:&#x2F;&#x2F;get.docker.com | sh</span><br><span class="line"></span><br><span class="line">systemctl start docker</span><br><span class="line">systemctl enable docker</span><br><span class="line"></span><br><span class="line">安装自动补全插件</span><br><span class="line">yum install -y bash-completion</span><br><span class="line"></span><br><span class="line">source &#x2F;usr&#x2F;share&#x2F;bash-completion&#x2F;completions&#x2F;docker</span><br><span class="line">source &#x2F;usr&#x2F;share&#x2F;bash-completion&#x2F;bash_completion</span><br></pre></td></tr></table></figure>

<p>Docker 部署 Prometheus 说明：</p>
<blockquote>
<p>监控端安装：<br>Prometheus Server(普罗米修斯监控主服务器 )<br>Node Exporter (收集Host硬件和操作系统信息)<br>cAdvisor (负责收集Host上运行的容器信息)<br>Grafana (展示普罗米修斯监控界面）</p>
</blockquote>
<blockquote>
<p>被监控安装：<br>Node Exporter (收集Host硬件和操作系统信息)<br>cAdvisor (负责收集Host上运行的容器信息)</p>
</blockquote>
<h4 id="1-安装Node-Exporter"><a href="#1-安装Node-Exporter" class="headerlink" title="1.安装Node Exporter"></a>1.安装Node Exporter</h4><ul>
<li>所有服务器安装</li>
<li>Node Exporter 收集系统信息，用于监控CPU、内存、磁盘使用率、磁盘读写等系统信息</li>
<li>–net=host，这样 Prometheus Server 可以直接与 Node Exporter 通信</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 9100:9100 \</span><br><span class="line">-v &quot;&#x2F;proc:&#x2F;host&#x2F;proc&quot; \</span><br><span class="line">-v &quot;&#x2F;sys:&#x2F;host&#x2F;sys&quot; \</span><br><span class="line">-v &quot;&#x2F;:&#x2F;rootfs&quot; \</span><br><span class="line">-v &quot;&#x2F;etc&#x2F;localtime:&#x2F;etc&#x2F;localtime&quot; \</span><br><span class="line">--net&#x3D;host \</span><br><span class="line">prom&#x2F;node-exporter \</span><br><span class="line">--path.procfs &#x2F;host&#x2F;proc \</span><br><span class="line">--path.sysfs &#x2F;host&#x2F;sys \</span><br><span class="line">--collector.filesystem.ignored-mount-points &quot;^&#x2F;(sys|proc|dev|host|etc)($|&#x2F;)&quot;</span><br></pre></td></tr></table></figure>

<h4 id="2-安装cAdvisor"><a href="#2-安装cAdvisor" class="headerlink" title="2.安装cAdvisor"></a>2.安装cAdvisor</h4><ul>
<li>所有服务器安装</li>
<li>cAdvisor 收集docker信息，用于展示docker的cpu、内存、上传下载等信息</li>
<li>–net=host，这样 Prometheus Server 可以直接与 cAdvisor 通信</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">-v &quot;&#x2F;etc&#x2F;localtime:&#x2F;etc&#x2F;localtime&quot; \</span><br><span class="line">--volume&#x3D;&#x2F;:&#x2F;rootfs:ro \</span><br><span class="line">--volume&#x3D;&#x2F;var&#x2F;run:&#x2F;var&#x2F;run:rw \</span><br><span class="line">--volume&#x3D;&#x2F;sys:&#x2F;sys:ro \</span><br><span class="line">--volume&#x3D;&#x2F;var&#x2F;lib&#x2F;docker&#x2F;:&#x2F;var&#x2F;lib&#x2F;docker:ro \</span><br><span class="line">--volume&#x3D;&#x2F;dev&#x2F;disk&#x2F;:&#x2F;dev&#x2F;disk:ro \</span><br><span class="line">--publish&#x3D;18104:8080 \</span><br><span class="line">--detach&#x3D;true \</span><br><span class="line">--name&#x3D;cadvisor \</span><br><span class="line">--privileged&#x3D;true \</span><br><span class="line">google&#x2F;cadvisor:latest</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">可以进入容器查看：</span><br><span class="line">sudo docker exec -it 容器id &#x2F;bin&#x2F;sh</span><br></pre></td></tr></table></figure>

<h4 id="3-安装Prometheus-Server"><a href="#3-安装Prometheus-Server" class="headerlink" title="3.安装Prometheus Server"></a>3.安装Prometheus Server</h4><p>监控端安装</p>
<p>1）编辑配置文件</p>
<ul>
<li>首先在本地创建 prometheus.yml 这是普罗米修斯的配置文件</li>
<li>将下方内容写入到文件中</li>
<li>将监听的地址改为自己本机地址</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"># my global config</span><br><span class="line">global:</span><br><span class="line">  scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.</span><br><span class="line">  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.</span><br><span class="line">  # scrape_timeout is set to the global default (10s).</span><br><span class="line"> </span><br><span class="line"># Alertmanager configuration</span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">  - static_configs:</span><br><span class="line">    - targets:</span><br><span class="line">      # - alertmanager:9093</span><br><span class="line"> </span><br><span class="line"># Load rules once and periodically evaluate them according to the global &#39;evaluation_interval&#39;.</span><br><span class="line">rule_files:</span><br><span class="line">  # - &quot;first_rules.yml&quot;</span><br><span class="line">  # - &quot;second_rules.yml&quot;</span><br><span class="line"> </span><br><span class="line"># A scrape configuration containing exactly one endpoint to scrape:</span><br><span class="line"># Here it&#39;s Prometheus itself.</span><br><span class="line">scrape_configs:</span><br><span class="line">  # The job name is added as a label &#96;job&#x3D;&lt;job_name&gt;&#96; to any timeseries scraped from this config.</span><br><span class="line">  - job_name: &#39;prometheus&#39;</span><br><span class="line"> </span><br><span class="line">    # metrics_path defaults to &#39;&#x2F;metrics&#39;</span><br><span class="line">    # scheme defaults to &#39;http&#39;.</span><br><span class="line"> </span><br><span class="line">    static_configs:</span><br><span class="line">    #监听的地址s</span><br><span class="line">    - targets: [&#39;localhost:9090&#39;,&#39;192.168.224.11:8088&#39;,&#39;192.168.224.11:9090&#39;]</span><br></pre></td></tr></table></figure>

<p>2）启动容器</p>
<p>1&gt; prometheus.yml配置文件</p>
<p>prometheus.yml内需配置外网ip，内网ip除了本机，在grafana识别不到！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"># my global confi</span><br><span class="line">global:</span><br><span class="line">  scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.</span><br><span class="line">  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.</span><br><span class="line">  # scrape_timeout is set to the global default (10s).</span><br><span class="line"> </span><br><span class="line"># Alertmanager configuration</span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">  - static_configs:</span><br><span class="line">    - targets:</span><br><span class="line">      # - alertmanager:9093</span><br><span class="line"> </span><br><span class="line"># Load rules once and periodically evaluate them according to the global &#39;evaluation_interval&#39;.</span><br><span class="line">rule_files:</span><br><span class="line">  # - &quot;first_rules.yml&quot;</span><br><span class="line">  # - &quot;second_rules.yml&quot;</span><br><span class="line"> </span><br><span class="line"># A scrape configuration containing exactly one endpoint to scrape:</span><br><span class="line"># Here it&#39;s Prometheus itself.</span><br><span class="line">scrape_configs:</span><br><span class="line">  # The job name is added as a label &#96;job&#x3D;&lt;job_name&gt;&#96; to any timeseries scraped from this config.</span><br><span class="line">  - job_name: &#39;prometheus&#39;</span><br><span class="line"> </span><br><span class="line">    # metrics_path defaults to &#39;&#x2F;metrics&#39;</span><br><span class="line">    # scheme defaults to &#39;http&#39;.</span><br><span class="line"> </span><br><span class="line">    static_configs:</span><br><span class="line">    #监听的地址（此处为服务器内网ip）</span><br><span class="line">    - targets: [&#39;10.27.158.33:9090&#39;,&#39;10.27.158.33:9100&#39;,&#39;10.27.158.33:18104&#39;]</span><br><span class="line">    - targets: [&#39;10.29.46.54:9100&#39;,&#39;10.29.46.54:18104&#39;]</span><br><span class="line">    - targets: [&#39;10.27.163.172:9100&#39;,&#39;10.27.163.172:18104&#39;]</span><br><span class="line"> </span><br><span class="line">#  - job_name: &#39;GitLab&#39;</span><br><span class="line">#    metrics_path: &#39;&#x2F;-&#x2F;metrics&#39;</span><br><span class="line">#    static_configs:</span><br><span class="line">#    - targets: [&#39;172.23.0.241:10101&#39;]</span><br><span class="line"> </span><br><span class="line">  - job_name: &#39;jenkins&#39;</span><br><span class="line">    metrics_path: &#39;&#x2F;prometheus&#x2F;&#39;</span><br><span class="line">    scheme: http</span><br><span class="line">    bearer_token: bearer_token</span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: [&#39;172.23.0.242:8080&#39;]</span><br><span class="line"> </span><br><span class="line">  - job_name: &quot;Nginx&quot;</span><br><span class="line">    metrics_path: &#39;&#x2F;status&#x2F;format&#x2F;prometheus&#39;</span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: [&#39;172.23.0.242:8088&#39;]</span><br></pre></td></tr></table></figure>

<p>2&gt;启动命令</p>
<p>–net=host，这样 Prometheus Server 可以直接与 Exporter 和 Grafana 通</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 9090:9090 \</span><br><span class="line">-v &#x2F;root&#x2F;Prometheus&#x2F;prometheus.yml:&#x2F;etc&#x2F;prometheus&#x2F;prometheus.yml \</span><br><span class="line">-v &quot;&#x2F;etc&#x2F;localtime:&#x2F;etc&#x2F;localtime&quot; \</span><br><span class="line">--name prometheus \</span><br><span class="line">--net&#x3D;host \</span><br><span class="line">prom&#x2F;prometheus:latest</span><br><span class="line"> </span><br><span class="line"># 当Prometheus容器启动成功后访问</span><br><span class="line"># PS：服务器需开启eth0的外网端口，才可用浏览器访问 9090 0.0.0.0</span><br><span class="line">192.168.224.11:9090</span><br></pre></td></tr></table></figure>

<p>访问<code>http://192.168.224.11:9090</code></p>
<p><a href="https://imgloc.com/i/idALO8"><img src="https://i.328888.xyz/2023/04/21/idALO8.png" alt="idALO8.png"></a></p>
<p>访问<code>http://192.168.224.11:9090/metrics</code></p>
<p><img src="https://i.328888.xyz/2023/04/21/idD05q.png" alt="idD05q.png"></p>
<p>我们配置了9090端口，默认prometheus会抓取自己的/metrics接口<br>在Graph选项已经可以看到监控的数据</p>
<h4 id="4-创建运行Grafana"><a href="#4-创建运行Grafana" class="headerlink" title="4.创建运行Grafana"></a>4.创建运行Grafana</h4><ul>
<li><p>监控服务器安装</p>
</li>
<li><p>用于图像化显示</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -i -p 3000:3000 \</span><br><span class="line">-v &quot;&#x2F;etc&#x2F;localtime:&#x2F;etc&#x2F;localtime&quot; \</span><br><span class="line">-e &quot;GF_SERVER_ROOT_URL&#x3D;http:&#x2F;&#x2F;grafana.server.name&quot; \</span><br><span class="line">-e &quot;GF_SECURITY_ADMIN_PASSWORD&#x3D;admin8888&quot; \</span><br><span class="line">--net&#x3D;host \</span><br><span class="line">grafana&#x2F;grafana</span><br><span class="line"> </span><br><span class="line"># PS：服务器需开启eth0的外网端口，才可用浏览器访问：3000 0.0.0.0</span><br><span class="line">Grafana启动后，在浏览器中打开 192.168.224.11:3000 登录界面，登录：</span><br><span class="line">    用户名：admin</span><br><span class="line">    密码：admin8888</span><br></pre></td></tr></table></figure>

<p>1）添加普罗米修斯服务器</p>
<p><img src="https://i.328888.xyz/2023/04/21/idUjYJ.png" alt="idUjYJ.png"></p>
<p>填写相关数据源信息</p>
<p><a href="https://imgloc.com/i/idUgGz"><img src="https://i.328888.xyz/2023/04/21/idUgGz.png" alt="idUgGz.png"></a></p>
<p><a href="https://imgloc.com/i/idn4pN"><img src="https://i.328888.xyz/2023/04/21/idn4pN.png" alt="idn4pN.png"></a></p>
<p>为添加好的数据源做图形显示</p>
<p><a href="https://imgloc.com/i/idnHpL"><img src="https://i.328888.xyz/2023/04/21/idnHpL.png" alt="idnHpL.png"></a></p>
<p><a href="https://imgloc.com/i/idtVi3"><img src="https://i.328888.xyz/2023/04/21/idtVi3.png" alt="idtVi3.png"></a></p>
<h4 id="5-添加监控模板"><a href="#5-添加监控模板" class="headerlink" title="5.添加监控模板"></a>5.添加监控模板</h4><ul>
<li><p>自己手工创建dashboard有点困难，可以借助开元的力量访问 [监控模板地址]<code>https://grafana.com/grafana/dashboards</code>将会看到很多用于监控 Docker 的 Dashboard。监控模板地址(多种监控模板根据自己需求下载不同的模板)</p>
</li>
<li><p><a href="https://grafana.com/grafana/dashboards">监控模板地址</a></p>
</li>
<li><p>有些dashboard可以下载后直接导入，而有些需要修改后再导入，需要看dashboard的overview</p>
</li>
</ul>
<h4 id="6-键值查询"><a href="#6-键值查询" class="headerlink" title="6.键值查询"></a>6.键值查询</h4><p>通过指标 io_namespace_http_requests_total 我们可以：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">查询应用的请求总量  sum(io_namespace_http_requests_total)</span><br><span class="line">查询每秒Http请求量  sum(rate(io_wise2c_gateway_requests_total[5m]))</span><br><span class="line">查询当前应用请求量Top N的URI </span><br><span class="line">topk(10, sum(io_namespace_http_requests_total) by (path))</span><br></pre></td></tr></table></figure>

<p>配置Prometheus监控Nginx</p>
<blockquote>
<p>1、需给Nginx安装两个模块，才可用Prometheus来监控：nginx-module-vts、geoip</p>
<p>2、思路：原来无论是编译、还是yum装的nginx，都需要下载同版本的tar包，基于原来安装选项的基础上，增加以上两个模块选项，进行编译安装，来替换原来的nginx，最终将原nginx目录的配置文件如nginx.conf文件、conf.d目录再移动到编译安装后的nignx目录内，最后启动nginx即可</p>
</blockquote>
<p>这里官方源安装：<br>1）配置官方源</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> vim &#x2F;etc&#x2F;yum.repos.d&#x2F;nginx.repo</span><br><span class="line">[nginx-stable]</span><br><span class="line">name&#x3D;nginx stable repo</span><br><span class="line">baseurl&#x3D;http:&#x2F;&#x2F;nginx.org&#x2F;packages&#x2F;centos&#x2F;7&#x2F;$basearch&#x2F;</span><br><span class="line">gpgcheck&#x3D;1</span><br><span class="line">enabled&#x3D;1</span><br><span class="line">gpgkey&#x3D;https:&#x2F;&#x2F;nginx.org&#x2F;keys&#x2F;nginx_signing.key</span><br><span class="line">module_hotfixes&#x3D;true</span><br></pre></td></tr></table></figure>

<p>2）安装依赖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y gcc gcc-c++ autoconf pcre pcre-devel make automake wget httpd-tools vim tree</span><br></pre></td></tr></table></figure>

<p>3）安装nginx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y nginx</span><br></pre></td></tr></table></figure>

<p>4）配置nginx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br></pre></td></tr></table></figure>

<p>5）启动服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">直接启动如果有报错&#x3D;&#x3D;》重大错误，80端口有占用&#x3D;&#x3D;》查看占用端口的服务HTTPD，停掉，在重启nginx</span><br><span class="line">systemctl start nginx</span><br></pre></td></tr></table></figure>

<p>1.查看当前Nginx安装选项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">nginx -V</span><br><span class="line">nginx version: nginx&#x2F;1.24.0</span><br><span class="line">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) </span><br><span class="line">built with OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix&#x3D;&#x2F;etc&#x2F;nginx --sbin-path&#x3D;&#x2F;usr&#x2F;sbin&#x2F;nginx --modules-path&#x3D;&#x2F;usr&#x2F;lib64&#x2F;nginx&#x2F;modules --conf-path&#x3D;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf --error-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log --http-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log --pid-path&#x3D;&#x2F;var&#x2F;run&#x2F;nginx.pid --lock-path&#x3D;&#x2F;var&#x2F;run&#x2F;nginx.lock --http-client-body-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;client_temp --http-proxy-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;proxy_temp --http-fastcgi-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;fastcgi_temp --http-uwsgi-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;uwsgi_temp --http-scgi-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;scgi_temp --user&#x3D;nginx --group&#x3D;nginx --with-compat --with-file-aio --with-threads --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-mail --with-mail_ssl_module --with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module --with-cc-opt&#x3D;&#39;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE&#x3D;2 -fexceptions -fstack-protector-strong --param&#x3D;ssp-buffer-size&#x3D;4 -grecord-gcc-switches -m64 -mtune&#x3D;generic -fPIC&#39; --with-ld-opt&#x3D;&#39;-Wl,-z,relro -Wl,-z,now -pie&#39;</span><br></pre></td></tr></table></figure>

<p>2.准备模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">下载、解压新包</span><br><span class="line"> wget http:&#x2F;&#x2F;nginx.org&#x2F;download&#x2F;nginx-1.16.1.tar.gz</span><br><span class="line">  tar xf nginx-1.16.1.tar.gz</span><br><span class="line">  </span><br><span class="line">克隆下载 nginx-module-vts 模块</span><br><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;vozlt&#x2F;nginx-module-vts</span><br><span class="line"></span><br><span class="line">安装GeoIP模块</span><br><span class="line"> yum -y install epel-release geoip-devel</span><br></pre></td></tr></table></figure>

<p>3.停止Nginx服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> 停止nginx服务</span><br><span class="line"> nginx -s stop</span><br><span class="line"> </span><br><span class="line"># 备份原nginx启动文件</span><br><span class="line"> which nginx</span><br><span class="line">&#x2F;usr&#x2F;sbin&#x2F;nginx</span><br><span class="line">mv &#x2F;usr&#x2F;sbin&#x2F;nginx &#x2F;usr&#x2F;sbin&#x2F;nginx.bak</span><br><span class="line"> </span><br><span class="line"># 备份原nignx目录</span><br><span class="line">mv &#x2F;etc&#x2F;nginx nginx-1.12.2.bak</span><br></pre></td></tr></table></figure>

<p>4.编译安装</p>
<p>1&gt; 安装所需依赖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">编译安装时可能会出现 &#96;make: *** 没有规则可以创建“default”需要的目标“build”。 停止&#96;的报错，是因为缺少依赖导致</span><br><span class="line">安装依赖后在进行编译，否则装完依赖还得重新.&#x2F;configure ~</span><br><span class="line"></span><br><span class="line">yum install -y gcc gcc++ bash-completion vim lrzsz wget expect net-tools nc nmap tree dos2unix htop iftop iotop unzip telnet sl psmisc nethogs glances bc pcre-devel zlib zlib-devel openssl openssl-devel libxml2 libxml2-dev libxslt-devel gd gd-devel perl-devel perl-ExtUtils-Embed GeoIP GeoIP-devel GeoIP-data pcre-devel</span><br></pre></td></tr></table></figure>

<p>2&gt; 编译安装</p>
<ul>
<li>进入刚刚解压的nginx目录，编译安装</li>
<li>基于原来安装参数，尾部追加连个参数</li>
</ul>
<p>–add-module=/root/packages/nginx-module-vts<br>–with-http_geoip_module</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;configure  --prefix&#x3D;&#x2F;etc&#x2F;nginx --sbin-path&#x3D;&#x2F;usr&#x2F;sbin&#x2F;nginx --modules-path&#x3D;&#x2F;usr&#x2F;lib64&#x2F;nginx&#x2F;modules --conf-path&#x3D;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf --error-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log --http-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log --pid-path&#x3D;&#x2F;var&#x2F;run&#x2F;nginx.pid --lock-path&#x3D;&#x2F;var&#x2F;run&#x2F;nginx.lock --http-client-body-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;client_temp --http-proxy-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;proxy_temp --http-fastcgi-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;fastcgi_temp --http-uwsgi-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;uwsgi_temp --http-scgi-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;scgi_temp --user&#x3D;nginx --group&#x3D;nginx --with-compat --with-file-aio --with-threads --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-mail --with-mail_ssl_module --with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module --with-cc-opt&#x3D;&#39;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE&#x3D;2 -fexceptions -fstack-protector-strong --param&#x3D;ssp-buffer-size&#x3D;4 -grecord-gcc-switches -m64 -mtune&#x3D;generic -fPIC&#39; --with-ld-opt&#x3D;&#39;-Wl,-z,relro -Wl,-z,now -pie&#39; --add-module&#x3D;&#x2F;root&#x2F;nginx-module-vts --with-http_geoip_module</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">编译安装</span><br><span class="line"># -j 多核编译（配置低的不建议使用此参数，会卡住~）</span><br><span class="line">make -j &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<p>5.配置Nginx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp -r nginx-1.12.2.bak&#x2F;conf.d&#x2F; &#x2F;etc&#x2F;nginx&#x2F;</span><br><span class="line">cp -r nginx-1.12.2.bak&#x2F;nginx.conf &#x2F;etc&#x2F;nginx&#x2F;</span><br><span class="line">rm -f &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;default.conf</span><br></pre></td></tr></table></figure>

<p>配置Nginx配置文件</p>
<p> http层</p>
<p>server层</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">    ···</span><br><span class="line">http &#123;  </span><br><span class="line">    ···</span><br><span class="line">    include &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;*.conf;</span><br><span class="line"> </span><br><span class="line">    ##################### 1.http层：添加三行配置 ##################### </span><br><span class="line">    vhost_traffic_status_zone;</span><br><span class="line">    vhost_traffic_status_filter_by_host on;</span><br><span class="line">    geoip_country &#x2F;usr&#x2F;share&#x2F;GeoIP&#x2F;GeoIP.dat;</span><br><span class="line"> </span><br><span class="line">    ##################### 2.server层：指定server层端口号，建议8088端口，不冲突直接复制粘贴即可#####################</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       8088;</span><br><span class="line">        server_name  localhost;</span><br><span class="line">        # 以下vhost配置写在此location内</span><br><span class="line">        location &#x2F;status &#123;</span><br><span class="line">        vhost_traffic_status on;    # 流量状态，默认即为on，可不写此行</span><br><span class="line">        vhost_traffic_status_display;</span><br><span class="line">        vhost_traffic_status_display_format html;</span><br><span class="line">        vhost_traffic_status_filter_by_set_key $uri uri::$server_name;     #每个uri访问量</span><br><span class="line">        vhost_traffic_status_filter_by_set_key $geoip_country_code country::$server_name;     #不同国家&#x2F;区域请求量</span><br><span class="line">        vhost_traffic_status_filter_by_set_key $status $server_name;     #http code统计</span><br><span class="line">        vhost_traffic_status_filter_by_set_key $upstream_addr upstream::backend;     #后端&gt;转发统计</span><br><span class="line">        vhost_traffic_status_filter_by_set_key $remote_port client::ports::$server_name;     #请求端口统计</span><br><span class="line">        vhost_traffic_status_filter_by_set_key $remote_addr client::addr::$server_name;     #请求IP统计</span><br><span class="line"> </span><br><span class="line">        location ~ ^&#x2F;storage&#x2F;(.+)&#x2F;.*$ &#123;</span><br><span class="line">            set $volume $1;</span><br><span class="line">            vhost_traffic_status_filter_by_set_key $volume storage::$server_name;     #请求路径统计</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ##################### server层：可新建一个server，或在原有的不打紧的配置上修改也可以#####################</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>6.启动Nginx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nginx</span><br><span class="line">netstat -putnal |grep nginx</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">浏览器访问：</span><br><span class="line">192.168.224.11:80     # nginx 默认官方页面</span><br><span class="line">192.168.224.11:8088&#x2F;status  #nignx 监控项页面</span><br></pre></td></tr></table></figure>

<p><a href="https://imgloc.com/i/idcGyb"><img src="https://i.328888.xyz/2023/04/21/idcGyb.png" alt="idcGyb.png"></a></p>
<h4 id="7-使用Prometheus监控"><a href="#7-使用Prometheus监控" class="headerlink" title="7.使用Prometheus监控"></a>7.使用Prometheus监控</h4><ul>
<li>prometheus服务端配置prometheus.yml，并重启prometheus容器</li>
<li>metrics_path：定义接口后缀类型，默认为/metrics</li>
<li>即我们输入ip+端口后，浏览器会自动追加/metrics后缀</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vim prometheus.yml</span><br><span class="line">···</span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &quot;Nginx&quot;</span><br><span class="line">    metrics_path: &#39;&#x2F;status&#x2F;format&#x2F;prometheus&#39;</span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: [&#39;192.168.224.11:8088&#39;]</span><br><span class="line">···</span><br><span class="line"></span><br><span class="line"> docker restart prometheus</span><br><span class="line">此时进入prometheus管理页面，则能查询nginx的监控项</span><br></pre></td></tr></table></figure>

<p><a href="https://imgloc.com/i/idBWno"><img src="https://i.328888.xyz/2023/04/21/idBWno.png" alt="idBWno.png"></a></p>
<h4 id="8-各个监控项的含义"><a href="#8-各个监控项的含义" class="headerlink" title="8.各个监控项的含义"></a>8.各个监控项的含义</h4><p>Nginx-module-vts提供了多种监控项，了解监控项含义，有助于帮助自己生成需要的图表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"># HELP nginx_vts_info Nginx info</span><br><span class="line"># TYPE nginx_vts_info gauge</span><br><span class="line">nginx_vts_info&#123;hostname&#x3D;&quot;hbhly_21_205&quot;,version&#x3D;&quot;1.16.1&quot;&#125; 1</span><br><span class="line"># HELP nginx_vts_start_time_seconds Nginx start time</span><br><span class="line"># TYPE nginx_vts_start_time_seconds gauge</span><br><span class="line">nginx_vts_start_time_seconds 1584268136.439</span><br><span class="line"># HELP nginx_vts_main_connections Nginx connections</span><br><span class="line"># TYPE nginx_vts_main_connections gauge</span><br><span class="line"> </span><br><span class="line"># 区分状态的nginx连接数</span><br><span class="line">nginx_vts_main_connections&#123;status&#x3D;&quot;accepted&quot;&#125; 9271</span><br><span class="line">nginx_vts_main_connections&#123;status&#x3D;&quot;active&quot;&#125; 7</span><br><span class="line">nginx_vts_main_connections&#123;status&#x3D;&quot;handled&quot;&#125; 9271</span><br><span class="line">nginx_vts_main_connections&#123;status&#x3D;&quot;reading&quot;&#125; 0</span><br><span class="line">nginx_vts_main_connections&#123;status&#x3D;&quot;requests&quot;&#125; 438850</span><br><span class="line">nginx_vts_main_connections&#123;status&#x3D;&quot;waiting&quot;&#125; 6</span><br><span class="line">nginx_vts_main_connections&#123;status&#x3D;&quot;writing&quot;&#125; 1</span><br><span class="line"># HELP nginx_vts_main_shm_usage_bytes Shared memory [ngx_http_vhost_traffic_status] info</span><br><span class="line"># TYPE nginx_vts_main_shm_usage_bytes gauge</span><br><span class="line"> </span><br><span class="line"># 内存使用量</span><br><span class="line">nginx_vts_main_shm_usage_bytes&#123;shared&#x3D;&quot;max_size&quot;&#125; 1048575</span><br><span class="line">nginx_vts_main_shm_usage_bytes&#123;shared&#x3D;&quot;used_size&quot;&#125; 24689</span><br><span class="line">nginx_vts_main_shm_usage_bytes&#123;shared&#x3D;&quot;used_node&quot;&#125; 7</span><br><span class="line"># HELP nginx_vts_server_bytes_total The request&#x2F;response bytes</span><br><span class="line"># TYPE nginx_vts_server_bytes_total counter</span><br><span class="line"># HELP nginx_vts_server_requests_total The requests counter</span><br><span class="line"># TYPE nginx_vts_server_requests_total counter</span><br><span class="line"># HELP nginx_vts_server_request_seconds_total The request processing time in seconds</span><br><span class="line"># TYPE nginx_vts_server_request_seconds_total counter</span><br><span class="line"># HELP nginx_vts_server_request_seconds The average of request processing times in seconds</span><br><span class="line"># TYPE nginx_vts_server_request_seconds gauge</span><br><span class="line"># HELP nginx_vts_server_request_duration_seconds The histogram of request processing time</span><br><span class="line"># TYPE nginx_vts_server_request_duration_seconds histogram</span><br><span class="line"># HELP nginx_vts_server_cache_total The requests cache counter</span><br><span class="line"># TYPE nginx_vts_server_cache_total counter</span><br><span class="line"> </span><br><span class="line"># 分Host的进出流量</span><br><span class="line">nginx_vts_server_bytes_total&#123;host&#x3D;&quot;10.160.21.205&quot;,direction&#x3D;&quot;in&quot;&#125; 22921464</span><br><span class="line">nginx_vts_server_bytes_total&#123;host&#x3D;&quot;10.160.21.205&quot;,direction&#x3D;&quot;out&quot;&#125; 1098196005</span><br><span class="line"> </span><br><span class="line"># 分状态码的请求数量统计 1** 2** 3** 4** 5**</span><br><span class="line">nginx_vts_server_requests_total&#123;host&#x3D;&quot;10.160.21.205&quot;,code&#x3D;&quot;1xx&quot;&#125; 0</span><br><span class="line">nginx_vts_server_requests_total&#123;host&#x3D;&quot;10.160.21.205&quot;,code&#x3D;&quot;2xx&quot;&#125; 86809</span><br><span class="line">nginx_vts_server_requests_total&#123;host&#x3D;&quot;10.160.21.205&quot;,code&#x3D;&quot;3xx&quot;&#125; 0</span><br><span class="line">nginx_vts_server_requests_total&#123;host&#x3D;&quot;10.160.21.205&quot;,code&#x3D;&quot;4xx&quot;&#125; 2</span><br><span class="line">nginx_vts_server_requests_total&#123;host&#x3D;&quot;10.160.21.205&quot;,code&#x3D;&quot;5xx&quot;&#125; 0</span><br><span class="line">nginx_vts_server_requests_total&#123;host&#x3D;&quot;10.160.21.205&quot;,code&#x3D;&quot;total&quot;&#125; 86811</span><br><span class="line"> </span><br><span class="line"># 响应时间</span><br><span class="line">nginx_vts_server_request_seconds_total&#123;host&#x3D;&quot;10.160.21.205&quot;&#125; 0.000</span><br><span class="line">nginx_vts_server_request_seconds&#123;host&#x3D;&quot;10.160.21.205&quot;&#125; 0.000</span><br><span class="line"> </span><br><span class="line"># 分状态的缓存的统计</span><br><span class="line">nginx_vts_server_cache_total&#123;host&#x3D;&quot;10.160.21.205&quot;,status&#x3D;&quot;miss&quot;&#125; 0</span><br><span class="line">nginx_vts_server_cache_total&#123;host&#x3D;&quot;10.160.21.205&quot;,status&#x3D;&quot;bypass&quot;&#125; 0</span><br><span class="line">nginx_vts_server_cache_total&#123;host&#x3D;&quot;10.160.21.205&quot;,status&#x3D;&quot;expired&quot;&#125; 0</span><br><span class="line">nginx_vts_server_cache_total&#123;host&#x3D;&quot;10.160.21.205&quot;,status&#x3D;&quot;stale&quot;&#125; 0</span><br><span class="line">nginx_vts_server_cache_total&#123;host&#x3D;&quot;10.160.21.205&quot;,status&#x3D;&quot;updating&quot;&#125; 0</span><br><span class="line">nginx_vts_server_cache_total&#123;host&#x3D;&quot;10.160.21.205&quot;,status&#x3D;&quot;revalidated&quot;&#125; 0</span><br><span class="line">nginx_vts_server_cache_total&#123;host&#x3D;&quot;10.160.21.205&quot;,status&#x3D;&quot;hit&quot;&#125; 0</span><br><span class="line">nginx_vts_server_cache_total&#123;host&#x3D;&quot;10.160.21.205&quot;,status&#x3D;&quot;scarce&quot;&#125; 0</span><br><span class="line">nginx_vts_server_bytes_total&#123;host&#x3D;&quot;devapi.feedback.test&quot;,direction&#x3D;&quot;in&quot;&#125; 3044526</span><br><span class="line">nginx_vts_server_bytes_total&#123;host&#x3D;&quot;devapi.feedback.test&quot;,direction&#x3D;&quot;out&quot;&#125; 41257028</span><br><span class="line"> </span><br><span class="line"># 分状态的连接数的统计</span><br><span class="line">nginx_vts_server_requests_total&#123;host&#x3D;&quot;devapi.feedback.test&quot;,code&#x3D;&quot;1xx&quot;&#125; 0</span><br><span class="line">nginx_vts_server_requests_total&#123;host&#x3D;&quot;devapi.feedback.test&quot;,code&#x3D;&quot;2xx&quot;&#125; 3983</span><br><span class="line">nginx_vts_server_requests_total&#123;host&#x3D;&quot;devapi.feedback.test&quot;,code&#x3D;&quot;3xx&quot;&#125; 0</span><br><span class="line">nginx_vts_server_requests_total&#123;host&#x3D;&quot;devapi.feedback.test&quot;,code&#x3D;&quot;4xx&quot;&#125; 24</span><br><span class="line">nginx_vts_server_requests_total&#123;host&#x3D;&quot;devapi.feedback.test&quot;,code&#x3D;&quot;5xx&quot;&#125; 11</span><br><span class="line">nginx_vts_server_requests_total&#123;host&#x3D;&quot;devapi.feedback.test&quot;,code&#x3D;&quot;total&quot;&#125; 4018</span><br><span class="line">nginx_vts_server_request_seconds_total&#123;host&#x3D;&quot;devapi.feedback.test&quot;&#125; 327.173</span><br><span class="line">nginx_vts_server_request_seconds&#123;host&#x3D;&quot;devapi.feedback.test&quot;&#125; 0.000</span><br><span class="line"> </span><br><span class="line"># nginx缓存计算器，精确到状态和type</span><br><span class="line">nginx_vts_server_cache_total&#123;host&#x3D;&quot;devapi.feedback.test&quot;,status&#x3D;&quot;miss&quot;&#125; 0</span><br><span class="line">nginx_vts_server_cache_total&#123;host&#x3D;&quot;devapi.feedback.test&quot;,status&#x3D;&quot;bypass&quot;&#125; 0</span><br><span class="line">nginx_vts_server_cache_total&#123;host&#x3D;&quot;devapi.feedback.test&quot;,status&#x3D;&quot;expired&quot;&#125; 0</span><br><span class="line">nginx_vts_server_cache_total&#123;host&#x3D;&quot;devapi.feedback.test&quot;,status&#x3D;&quot;stale&quot;&#125; 0</span><br><span class="line">nginx_vts_server_cache_total&#123;host&#x3D;&quot;devapi.feedback.test&quot;,status&#x3D;&quot;updating&quot;&#125; 0</span><br><span class="line">nginx_vts_server_cache_total&#123;host&#x3D;&quot;devapi.feedback.test&quot;,status&#x3D;&quot;revalidated&quot;&#125; 0</span><br><span class="line">nginx_vts_server_cache_total&#123;host&#x3D;&quot;devapi.feedback.test&quot;,status&#x3D;&quot;hit&quot;&#125; 0</span><br><span class="line">nginx_vts_server_cache_total&#123;host&#x3D;&quot;devapi.feedback.test&quot;,status&#x3D;&quot;scarce&quot;&#125; 0</span><br><span class="line">nginx_vts_server_bytes_total&#123;host&#x3D;&quot;testapi.feedback.test&quot;,direction&#x3D;&quot;in&quot;&#125; 55553573</span><br><span class="line">nginx_vts_server_bytes_total&#123;host&#x3D;&quot;testapi.feedback.test&quot;,direction&#x3D;&quot;out&quot;&#125; 9667561188</span><br><span class="line">nginx_vts_server_requests_total&#123;host&#x3D;&quot;testapi.feedback.test&quot;,code&#x3D;&quot;1xx&quot;&#125; 0</span><br><span class="line">nginx_vts_server_requests_total&#123;host&#x3D;&quot;testapi.feedback.test&quot;,code&#x3D;&quot;2xx&quot;&#125; 347949</span><br><span class="line">nginx_vts_server_requests_total&#123;host&#x3D;&quot;testapi.feedback.test&quot;,code&#x3D;&quot;3xx&quot;&#125; 31</span><br><span class="line">nginx_vts_server_requests_total&#123;host&#x3D;&quot;testapi.feedback.test&quot;,code&#x3D;&quot;4xx&quot;&#125; 7</span><br><span class="line">nginx_vts_server_requests_total&#123;host&#x3D;&quot;testapi.feedback.test&quot;,code&#x3D;&quot;5xx&quot;&#125; 33</span><br><span class="line">nginx_vts_server_requests_total&#123;host&#x3D;&quot;testapi.feedback.test&quot;,code&#x3D;&quot;total&quot;&#125; 348020</span><br><span class="line">nginx_vts_server_request_seconds_total&#123;host&#x3D;&quot;testapi.feedback.test&quot;&#125; 2185.177</span><br><span class="line">nginx_vts_server_request_seconds&#123;host&#x3D;&quot;testapi.feedback.test&quot;&#125; 0.001</span><br><span class="line">nginx_vts_server_cache_total&#123;host&#x3D;&quot;testapi.feedback.test&quot;,status&#x3D;&quot;miss&quot;&#125; 0</span><br><span class="line">nginx_vts_server_cache_total&#123;host&#x3D;&quot;testapi.feedback.test&quot;,status&#x3D;&quot;bypass&quot;&#125; 0</span><br><span class="line">nginx_vts_server_cache_total&#123;host&#x3D;&quot;testapi.feedback.test&quot;,status&#x3D;&quot;expired&quot;&#125; 0</span><br><span class="line">nginx_vts_server_cache_total&#123;host&#x3D;&quot;testapi.feedback.test&quot;,status&#x3D;&quot;stale&quot;&#125; 0</span><br><span class="line">nginx_vts_server_cache_total&#123;host&#x3D;&quot;testapi.feedback.test&quot;,status&#x3D;&quot;updating&quot;&#125; 0</span><br><span class="line">nginx_vts_server_cache_total&#123;host&#x3D;&quot;testapi.feedback.test&quot;,status&#x3D;&quot;revalidated&quot;&#125; 0</span><br><span class="line">nginx_vts_server_cache_total&#123;host&#x3D;&quot;testapi.feedback.test&quot;,status&#x3D;&quot;hit&quot;&#125; 0</span><br><span class="line">nginx_vts_server_cache_total&#123;host&#x3D;&quot;testapi.feedback.test&quot;,status&#x3D;&quot;scarce&quot;&#125; 0</span><br><span class="line">nginx_vts_server_bytes_total&#123;host&#x3D;&quot;*&quot;,direction&#x3D;&quot;in&quot;&#125; 81519563</span><br><span class="line">nginx_vts_server_bytes_total&#123;host&#x3D;&quot;*&quot;,direction&#x3D;&quot;out&quot;&#125; 10807014221</span><br><span class="line"> </span><br><span class="line"># 分host请求数量统计</span><br><span class="line">nginx_vts_server_requests_total&#123;host&#x3D;&quot;*&quot;,code&#x3D;&quot;1xx&quot;&#125; 0</span><br><span class="line">nginx_vts_server_requests_total&#123;host&#x3D;&quot;*&quot;,code&#x3D;&quot;2xx&quot;&#125; 438741</span><br><span class="line">nginx_vts_server_requests_total&#123;host&#x3D;&quot;*&quot;,code&#x3D;&quot;3xx&quot;&#125; 31</span><br><span class="line">nginx_vts_server_requests_total&#123;host&#x3D;&quot;*&quot;,code&#x3D;&quot;4xx&quot;&#125; 33</span><br><span class="line">nginx_vts_server_requests_total&#123;host&#x3D;&quot;*&quot;,code&#x3D;&quot;5xx&quot;&#125; 44</span><br><span class="line">nginx_vts_server_requests_total&#123;host&#x3D;&quot;*&quot;,code&#x3D;&quot;total&quot;&#125; 438849</span><br><span class="line">nginx_vts_server_request_seconds_total&#123;host&#x3D;&quot;*&quot;&#125; 2512.350</span><br><span class="line">nginx_vts_server_request_seconds&#123;host&#x3D;&quot;*&quot;&#125; 0.007</span><br><span class="line"> </span><br><span class="line"># 分host缓存统计</span><br><span class="line">nginx_vts_server_cache_total&#123;host&#x3D;&quot;*&quot;,status&#x3D;&quot;miss&quot;&#125; 0</span><br><span class="line">nginx_vts_server_cache_total&#123;host&#x3D;&quot;*&quot;,status&#x3D;&quot;bypass&quot;&#125; 0</span><br><span class="line">nginx_vts_server_cache_total&#123;host&#x3D;&quot;*&quot;,status&#x3D;&quot;expired&quot;&#125; 0</span><br><span class="line">nginx_vts_server_cache_total&#123;host&#x3D;&quot;*&quot;,status&#x3D;&quot;stale&quot;&#125; 0</span><br><span class="line">nginx_vts_server_cache_total&#123;host&#x3D;&quot;*&quot;,status&#x3D;&quot;updating&quot;&#125; 0</span><br><span class="line">nginx_vts_server_cache_total&#123;host&#x3D;&quot;*&quot;,status&#x3D;&quot;revalidated&quot;&#125; 0</span><br><span class="line">nginx_vts_server_cache_total&#123;host&#x3D;&quot;*&quot;,status&#x3D;&quot;hit&quot;&#125; 0</span><br><span class="line">nginx_vts_server_cache_total&#123;host&#x3D;&quot;*&quot;,status&#x3D;&quot;scarce&quot;&#125; 0</span><br><span class="line"># HELP nginx_vts_upstream_bytes_total The request&#x2F;response bytes</span><br><span class="line"># TYPE nginx_vts_upstream_bytes_total counter</span><br><span class="line"># HELP nginx_vts_upstream_requests_total The upstream requests counter</span><br><span class="line"># TYPE nginx_vts_upstream_requests_total counter</span><br><span class="line"># HELP nginx_vts_upstream_request_seconds_total The request Processing time including upstream in seconds</span><br><span class="line"># TYPE nginx_vts_upstream_request_seconds_total counter</span><br><span class="line"># HELP nginx_vts_upstream_request_seconds The average of request processing times including upstream in seconds</span><br><span class="line"># TYPE nginx_vts_upstream_request_seconds gauge</span><br><span class="line"># HELP nginx_vts_upstream_response_seconds_total The only upstream response processing time in seconds</span><br><span class="line"># TYPE nginx_vts_upstream_response_seconds_total counter</span><br><span class="line"># HELP nginx_vts_upstream_response_seconds The average of only upstream response processing times in seconds</span><br><span class="line"># TYPE nginx_vts_upstream_response_seconds gauge</span><br><span class="line"># HELP nginx_vts_upstream_request_duration_seconds The histogram of request processing time including upstream</span><br><span class="line"># TYPE nginx_vts_upstream_request_duration_seconds histogram</span><br><span class="line"># HELP nginx_vts_upstream_response_duration_seconds The histogram of only upstream response processing time</span><br><span class="line"># TYPE nginx_vts_upstream_response_duration_seconds histogram</span><br><span class="line"> </span><br><span class="line"># 分upstream流量统计</span><br><span class="line">nginx_vts_upstream_bytes_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.144.227.162:80&quot;,direction&#x3D;&quot;in&quot;&#125; 12296</span><br><span class="line">nginx_vts_upstream_bytes_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.144.227.162:80&quot;,direction&#x3D;&quot;out&quot;&#125; 13582924</span><br><span class="line">nginx_vts_upstream_requests_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.144.227.162:80&quot;,code&#x3D;&quot;1xx&quot;&#125; 0</span><br><span class="line">nginx_vts_upstream_requests_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.144.227.162:80&quot;,code&#x3D;&quot;2xx&quot;&#125; 25</span><br><span class="line">nginx_vts_upstream_requests_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.144.227.162:80&quot;,code&#x3D;&quot;3xx&quot;&#125; 0</span><br><span class="line">nginx_vts_upstream_requests_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.144.227.162:80&quot;,code&#x3D;&quot;4xx&quot;&#125; 0</span><br><span class="line">nginx_vts_upstream_requests_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.144.227.162:80&quot;,code&#x3D;&quot;5xx&quot;&#125; 0</span><br><span class="line">nginx_vts_upstream_requests_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.144.227.162:80&quot;,code&#x3D;&quot;total&quot;&#125; 25</span><br><span class="line">nginx_vts_upstream_request_seconds_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.144.227.162:80&quot;&#125; 1.483</span><br><span class="line">nginx_vts_upstream_request_seconds&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.144.227.162:80&quot;&#125; 0.000</span><br><span class="line">nginx_vts_upstream_response_seconds_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.144.227.162:80&quot;&#125; 1.484</span><br><span class="line">nginx_vts_upstream_response_seconds&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.144.227.162:80&quot;&#125; 0.000</span><br><span class="line">nginx_vts_upstream_bytes_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.152.218.149:80&quot;,direction&#x3D;&quot;in&quot;&#125; 12471</span><br><span class="line">nginx_vts_upstream_bytes_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.152.218.149:80&quot;,direction&#x3D;&quot;out&quot;&#125; 11790508</span><br><span class="line">nginx_vts_upstream_requests_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.152.218.149:80&quot;,code&#x3D;&quot;1xx&quot;&#125; 0</span><br><span class="line">nginx_vts_upstream_requests_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.152.218.149:80&quot;,code&#x3D;&quot;2xx&quot;&#125; 24</span><br><span class="line">nginx_vts_upstream_requests_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.152.218.149:80&quot;,code&#x3D;&quot;3xx&quot;&#125; 0</span><br><span class="line">nginx_vts_upstream_requests_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.152.218.149:80&quot;,code&#x3D;&quot;4xx&quot;&#125; 0</span><br><span class="line">nginx_vts_upstream_requests_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.152.218.149:80&quot;,code&#x3D;&quot;5xx&quot;&#125; 0</span><br><span class="line">nginx_vts_upstream_requests_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.152.218.149:80&quot;,code&#x3D;&quot;total&quot;&#125; 24</span><br><span class="line">nginx_vts_upstream_request_seconds_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.152.218.149:80&quot;&#125; 1.169</span><br><span class="line">nginx_vts_upstream_request_seconds&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.152.218.149:80&quot;&#125; 0.000</span><br><span class="line">nginx_vts_upstream_response_seconds_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.152.218.149:80&quot;&#125; 1.168</span><br><span class="line">nginx_vts_upstream_response_seconds&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.152.218.149:80&quot;&#125; 0.000</span><br><span class="line">nginx_vts_upstream_bytes_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.160.21.205:8081&quot;,direction&#x3D;&quot;in&quot;&#125; 3036924</span><br><span class="line">nginx_vts_upstream_bytes_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.160.21.205:8081&quot;,direction&#x3D;&quot;out&quot;&#125; 33355357</span><br><span class="line">nginx_vts_upstream_requests_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.160.21.205:8081&quot;,code&#x3D;&quot;1xx&quot;&#125; 0</span><br><span class="line">nginx_vts_upstream_requests_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.160.21.205:8081&quot;,code&#x3D;&quot;2xx&quot;&#125; 3971</span><br><span class="line">nginx_vts_upstream_requests_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.160.21.205:8081&quot;,code&#x3D;&quot;3xx&quot;&#125; 0</span><br><span class="line">nginx_vts_upstream_requests_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.160.21.205:8081&quot;,code&#x3D;&quot;4xx&quot;&#125; 24</span><br><span class="line">nginx_vts_upstream_requests_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.160.21.205:8081&quot;,code&#x3D;&quot;5xx&quot;&#125; 11</span><br><span class="line">nginx_vts_upstream_requests_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.160.21.205:8081&quot;,code&#x3D;&quot;total&quot;&#125; 4006</span><br><span class="line">nginx_vts_upstream_request_seconds_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.160.21.205:8081&quot;&#125; 326.427</span><br><span class="line">nginx_vts_upstream_request_seconds&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.160.21.205:8081&quot;&#125; 0.000</span><br><span class="line">nginx_vts_upstream_response_seconds_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.160.21.205:8081&quot;&#125; 300.722</span><br><span class="line">nginx_vts_upstream_response_seconds&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.160.21.205:8081&quot;&#125; 0.000</span><br><span class="line">nginx_vts_upstream_bytes_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.160.21.205:8082&quot;,direction&#x3D;&quot;in&quot;&#125; 55536408</span><br><span class="line">nginx_vts_upstream_bytes_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.160.21.205:8082&quot;,direction&#x3D;&quot;out&quot;&#125; 9650089427</span><br><span class="line">nginx_vts_upstream_requests_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.160.21.205:8082&quot;,code&#x3D;&quot;1xx&quot;&#125; 0</span><br><span class="line">nginx_vts_upstream_requests_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.160.21.205:8082&quot;,code&#x3D;&quot;2xx&quot;&#125; 347912</span><br><span class="line">nginx_vts_upstream_requests_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.160.21.205:8082&quot;,code&#x3D;&quot;3xx&quot;&#125; 31</span><br><span class="line">nginx_vts_upstream_requests_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.160.21.205:8082&quot;,code&#x3D;&quot;4xx&quot;&#125; 7</span><br><span class="line">nginx_vts_upstream_requests_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.160.21.205:8082&quot;,code&#x3D;&quot;5xx&quot;&#125; 33</span><br><span class="line">nginx_vts_upstream_requests_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.160.21.205:8082&quot;,code&#x3D;&quot;total&quot;&#125; 347983</span><br><span class="line">nginx_vts_upstream_request_seconds_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.160.21.205:8082&quot;&#125; 2183.271</span><br><span class="line">nginx_vts_upstream_request_seconds&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.160.21.205:8082&quot;&#125; 0.001</span><br><span class="line">nginx_vts_upstream_response_seconds_total&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.160.21.205:8082&quot;&#125; 2180.893</span><br><span class="line">nginx_vts_upstream_response_seconds&#123;upstream&#x3D;&quot;::nogroups&quot;,backend&#x3D;&quot;10.160.21.205:8082&quot;&#125; 0.001</span><br></pre></td></tr></table></figure>

<h4 id="9-Prometheus-UI中Target表达式查询"><a href="#9-Prometheus-UI中Target表达式查询" class="headerlink" title="9.Prometheus UI中Target表达式查询"></a>9.Prometheus UI中Target表达式查询</h4><p>1）CAdvisor中获取的典型监控指标</p>
<table>
<thead>
<tr>
<th>指标名称</th>
<th>类型</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>container_cpu_load_average_10s</td>
<td>gauge</td>
<td>过去10秒内容器CPU的平均负载</td>
</tr>
<tr>
<td>container_cpu_usage_seconds_total</td>
<td>counter</td>
<td>容器在每个CPU内核上的累积占用时间 (单位：秒)</td>
</tr>
<tr>
<td>container_cpu_system_seconds_total</td>
<td>counter</td>
<td>System CPU累积占用时间（单位：秒）</td>
</tr>
<tr>
<td>container_cpu_user_seconds_total</td>
<td>counter</td>
<td>User CPU累积占用时间（单位：秒）</td>
</tr>
<tr>
<td>container_fs_usge_bytes</td>
<td>gauge</td>
<td>容器中文件系统的使用量(单位：字节)</td>
</tr>
<tr>
<td>container_network_receive_bytes_total</td>
<td>counter</td>
<td>容器网络累计接受数据总量（单位: 字节）</td>
</tr>
<tr>
<td>container_network_transmit_bytes_total</td>
<td>counter</td>
<td>容器网络累计传输数据总量（单位: 字节）</td>
</tr>
</tbody></table>
<p>2）容器相关</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 容器的CPU使用率</span><br><span class="line">sum(irate(container_cpu_usage_seconds_total&#123;image!&#x3D;&quot;&quot;&#125;[1m])) without (cpu)</span><br><span class="line"> </span><br><span class="line"># 容器内存使用量（单位: 字节）</span><br><span class="line">container_memory_usage_bytes&#123;image!&#x3D;&quot;&quot;&#125;</span><br><span class="line"> </span><br><span class="line"># 容器网络接收量速率（单位: 字节&#x2F;秒）</span><br><span class="line">sum(rate(container_network_receive_bytes_total&#123;image!&#x3D;&quot;&quot;&#125;[1m])) without (interface)</span><br><span class="line"> </span><br><span class="line"># 容器网络传输量速率</span><br><span class="line">sum(rate(container_network_transmit_bytes_total&#123;image!&#x3D;&quot;&quot;&#125;[1m])) without (interface)</span><br><span class="line"> </span><br><span class="line"># 容器文件系统读取速率</span><br><span class="line">sum(rate(container_fs_reads_bytes_total&#123;image!&#x3D;&quot;&quot;&#125;[1m])) without (device)</span><br><span class="line"> </span><br><span class="line"># 容器文件系统写入速率（单位: 字节&#x2F;秒）</span><br><span class="line">sum(rate(container_fs_writes_bytes_total&#123;image!&#x3D;&quot;&quot;&#125;[1m])) without (device)</span><br></pre></td></tr></table></figure>

<p>3）http相关</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># HTTP请求总数</span><br><span class="line">prometheus_http_requests_total</span><br><span class="line"> </span><br><span class="line"># HTTP请求持续时间秒桶</span><br><span class="line">prometheus_http_request_duration_seconds_bucket</span><br><span class="line"> </span><br><span class="line"># HTTP请求持续时间秒数计数</span><br><span class="line">prometheus_http_request_duration_seconds_count</span><br><span class="line"> </span><br><span class="line"># HTTP请求持续时间秒数之和</span><br><span class="line">prometheus_http_request_duration_seconds_sum</span><br><span class="line"> </span><br><span class="line"># HTTP响应大小字节</span><br><span class="line">prometheus_http_response_size_bytes_bucket</span><br><span class="line"> </span><br><span class="line"># HTTP响应大小字节计数计数</span><br><span class="line">prometheus_http_response_size_bytes_count</span><br><span class="line"> </span><br><span class="line"># HTTP响应大小字节的总和</span><br><span class="line">prometheus_http_response_size_bytes_sum</span><br></pre></td></tr></table></figure>

<p>4）Nginx相关</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"># Nginxvts过滤字节总数</span><br><span class="line">nginx_vts_filter_bytes_total</span><br><span class="line"> </span><br><span class="line"># Nginx VTS过滤器缓存总数</span><br><span class="line">nginx_vts_filter_cache_total</span><br><span class="line"> </span><br><span class="line"># Nginx VTS过滤请求秒数</span><br><span class="line">nginx_vts_filter_request_seconds</span><br><span class="line"> </span><br><span class="line"># Nginx VTS过滤器请求总秒数</span><br><span class="line">nginx_vts_filter_request_seconds_total</span><br><span class="line"> </span><br><span class="line"># Nginx VTS过滤器请求总数</span><br><span class="line">nginx_vts_filter_requests_total</span><br><span class="line"> </span><br><span class="line"># nginx信息</span><br><span class="line">nginx_vts_info</span><br><span class="line"> </span><br><span class="line"># Nginx VTS主连接</span><br><span class="line">nginx_vts_main_connections</span><br><span class="line"> </span><br><span class="line"># Nginx VTS主SHM使用字节</span><br><span class="line">nginx_vts_main_shm_usage_bytes</span><br><span class="line"> </span><br><span class="line"># Nginx VTS服务器字节总数</span><br><span class="line">nginx_vts_server_bytes_total</span><br><span class="line"> </span><br><span class="line"># Nginx VTS服务器缓存总数</span><br><span class="line">nginx_vts_server_cache_total</span><br><span class="line"> </span><br><span class="line"># Nginx_vts服务器请求秒</span><br><span class="line">nginx_vts_server_request_seconds</span><br><span class="line"> </span><br><span class="line"># Nginx_vts服务器请求总秒数</span><br><span class="line">nginx_vts_server_request_seconds_total</span><br><span class="line"> </span><br><span class="line"># Nginx_vts服务总请求数</span><br><span class="line">nginx_vts_server_requests_total</span><br><span class="line"> </span><br><span class="line"># Nginx VTS开始时间秒数</span><br><span class="line">nginx_vts_start_time_seconds</span><br></pre></td></tr></table></figure>

<h4 id="10-安装blackbox-exporter"><a href="#10-安装blackbox-exporter" class="headerlink" title="10.安装blackbox_exporter"></a>10.安装blackbox_exporter</h4><ul>
<li>blackbox收集服务状态信息，如判断服务http请求是否返回200继而报警</li>
<li>blackbox_exporter是Prometheus 官方提供的 exporter 之一，可以提供 http、dns、tcp、icmp 的监控数据采集</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">功能：</span><br><span class="line">HTTP 测试</span><br><span class="line">    定义 Request Header 信息</span><br><span class="line">    判断 Http status &#x2F; Http Respones Header &#x2F; Http Body 内容</span><br><span class="line">     </span><br><span class="line">TCP 测试</span><br><span class="line">    业务组件端口状态监听</span><br><span class="line">    应用层协议定义与监听</span><br><span class="line">     </span><br><span class="line">ICMP 测试</span><br><span class="line">    主机探活机制</span><br><span class="line">     </span><br><span class="line">POST 测试</span><br><span class="line">    接口联通性</span><br><span class="line">     </span><br><span class="line">SSL 证书过期时间</span><br><span class="line"> </span><br><span class="line"># 下载、解压</span><br><span class="line">wget https:&#x2F;&#x2F;github.com&#x2F;prometheus&#x2F;blackbox_exporter&#x2F;releases&#x2F;download&#x2F;v0.14.0&#x2F;blackbox_exporter-0.14.0.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line"> tar -xvf blackbox_exporter-0.14.0.linux-amd64.tar.gz</span><br><span class="line"> </span><br><span class="line">mv blackbox_exporter-0.14.0.linux-amd64 &#x2F;usr&#x2F;local&#x2F;blackbox_exporter</span><br><span class="line"> </span><br><span class="line"># 查看安装是否成功</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;blackbox_exporter&#x2F;blackbox_exporter --version</span><br><span class="line">blackbox_exporter, version 0.14.0 (branch: HEAD, revision: bba7ef76193948a333a5868a1ab38b864f7d968a)</span><br><span class="line">  build user:       root@63d11aa5b6c6</span><br><span class="line">  build date:       20190315-13:32:31</span><br><span class="line">  go version:       go1.11.5</span><br><span class="line"> </span><br><span class="line"># 加入systemd管理</span><br><span class="line">vim &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;blackbox_exporter.service</span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;blackbox_exporter</span><br><span class="line">  </span><br><span class="line">[Service]</span><br><span class="line">User&#x3D;root</span><br><span class="line">Type&#x3D;simple</span><br><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;local&#x2F;blackbox_exporter&#x2F;blackbox_exporter --config.file&#x3D;&#x2F;usr&#x2F;local&#x2F;blackbox_exporter&#x2F;blackbox.yml</span><br><span class="line">Restart&#x3D;on-failure</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"># 启动</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable --now blackbox_exporter</span><br></pre></td></tr></table></figure>

<h3 id="二，通过官网源码解压安装"><a href="#二，通过官网源码解压安装" class="headerlink" title="二，通过官网源码解压安装"></a>二，通过官网源码解压安装</h3><p><strong>1.安装Prometheus_server</strong></p>
<p>去官网下载prometheus.io</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;github.com&#x2F;prometheus&#x2F;prometheus&#x2F;releases&#x2F;download&#x2F;v2.43.0&#x2F;prometheus-2.43.0.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>

<p>prometheus的安装非常简单</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar xzf prometheus-2.43.0.linux-amd64.tar.gz</span><br><span class="line">cp -rf prometheus-2.43.0.linux-amd64 &#x2F;usr&#x2F;local&#x2F;prometheus</span><br></pre></td></tr></table></figure>

<p>Prometheus 启动和后台运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;usr&#x2F;local&#x2F;prometheus&#x2F;</span><br><span class="line"></span><br><span class="line">.&#x2F;prometheus </span><br><span class="line"></span><br><span class="line">通过tmux运行程序。</span><br><span class="line">tmux</span><br><span class="line">.&#x2F;prometheus</span><br><span class="line"></span><br><span class="line">Ctrl+b +d 退出当前窗口</span><br><span class="line">tmux a 进入a窗口</span><br></pre></td></tr></table></figure>

<p><strong>第二种加入后台启动的方式</strong></p>
<p>daemonize Unix系统后台守护进程管理软件</p>
<p>优点:更加正规 后台运行更稳定</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">git clone git:&#x2F;&#x2F;github.com&#x2F;bmc&#x2F;daemonize.git </span><br><span class="line"></span><br><span class="line">sh configure &amp;&amp; make &amp;&amp; sudo make install</span><br><span class="line"></span><br><span class="line">daemonize -c &#x2F;data&#x2F;prometheus&#x2F;  &#x2F;data&#x2F;prometheus&#x2F;up.sh</span><br><span class="line">-c 是指定运行路径</span><br><span class="line">&#x2F;data&#x2F;prometheus&#x2F;up.sh是运行路径下的一个启动脚本</span><br></pre></td></tr></table></figure>

<p>下面就是这个启动脚本的内容</p>
<p>内容：就是开启prometheus进程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;data&#x2F;prometheus&#x2F;up.sh</span><br><span class="line">&#x2F;data&#x2F;prometheus&#x2F;prometheus --web.listen-address&#x3D;&quot;0.0.0.0:9090&quot; --web.read-timeout&#x3D;5m --web.max-connections&#x3D;10 --storage.tsdb.retention&#x3D;15d --storage.tsdb.path&#x3D;&quot;data&#x2F;&quot; --query.max-concurrency&#x3D;20 --query.timeout&#x3D;2m </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">参数解释</span><br><span class="line">--web.read-timeout&#x3D;5m </span><br><span class="line">请求链接的最大等待时间，防止太多的空闲链接，占用资源</span><br><span class="line">--storage.tsdb.retention&#x3D;15d</span><br><span class="line">prometheus开始采集监控数据之后，会存在内存中和硬盘中，对于保留期限的设置很重要，太长的话，硬盘和内存都吃不消，太短的话，要查历史数据就没有了，企业中设置15天为宜。</span><br><span class="line">--storage.tsdb.path&#x3D;&quot;data&#x2F;&quot;</span><br><span class="line">存储数据路径，这个也很重要，不要随便放在一个地方就执行，会把&#x2F;跟目录塞满了。</span><br><span class="line">--query.timeout&#x3D;2m</span><br><span class="line">--query.max-concurrency&#x3D;20</span><br><span class="line">这两项是对用户执行prometheus查询时候的优化设置</span><br><span class="line">防止太多的用户同时查询，也防止单个用户执行过大的查询而一直不退出。</span><br><span class="line">配置以上参数后，prometheus运行就相对稳妥多了。</span><br></pre></td></tr></table></figure>

<p><strong>第三种加入后台启动的方式(推荐)</strong></p>
<p>创建一个专门的<code>prometheus</code>用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd -M -s &#x2F;usr&#x2F;sbin&#x2F;nologin  prometheus</span><br></pre></td></tr></table></figure>

<p>更改<code>prometheus</code>用户的文件夹权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown prometheus:prometheus -R &#x2F;usr&#x2F;local&#x2F;prometheus&#x2F;</span><br></pre></td></tr></table></figure>

<p>创建systemd服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[Unit]Description&#x3D;prometheus</span><br><span class="line">Documentation&#x3D;https:&#x2F;&#x2F;prometheus.io&#x2F;</span><br><span class="line">After&#x3D;network.target</span><br><span class="line">[Service]</span><br><span class="line">Type&#x3D;simple</span><br><span class="line">User&#x3D;prometheus</span><br><span class="line">Group&#x3D;prometheus</span><br><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;local&#x2F;prometheus&#x2F;prometheus --config.file&#x3D;&#x2F;usr&#x2F;local&#x2F;prometheus&#x2F;prometheus.yml --storage.tsdb.path&#x3D;&#x2F;usr&#x2F;local&#x2F;prometheus&#x2F;data --web.enable-lifecycle --storage.tsdb.retention&#x3D;30d</span><br><span class="line">Restart&#x3D;on-failure</span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br></pre></td></tr></table></figure>

<p>加载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">启动</span><br><span class="line">systemctl start prometheus.service</span><br></pre></td></tr></table></figure>



<p>然后，看下 ./prometheus 在实际企业运行是启动参数的合理配置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep prometheus</span><br></pre></td></tr></table></figure>



<p>之后默认运行在9090端口</p>
<p>浏览器可以直接打开访问，无账号密码验证(如果希望加上验证，可以使用类似apache httppass方式添加)</p>
<p><code>http://192.168.224.11:9090/graph</code></p>
<p>监控指标</p>
<p><code>http://192.168.224.11:9090/metrics</code></p>
<p>接下来看一下Prometheus的主配置文件</p>
<p>prometheus解压安装之后，就默认自带了一个基本的配置文件如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim   &#x2F;usr&#x2F;local&#x2F;prometheus&#x2F;prometheus.yml</span><br></pre></td></tr></table></figure>

<p>配置文件的大致内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># my global config</span><br><span class="line">global:</span><br><span class="line">  scrape_interval: 15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.</span><br><span class="line">  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.</span><br><span class="line">  # scrape_timeout is set to the global default (10s).</span><br><span class="line"></span><br><span class="line">前面两个是全局变量</span><br><span class="line">scrape_interval 抓取采样数据的时间，默认是15秒去被监控机采样一次，</span><br><span class="line">这个就是prometheus的自定义数据采集频率了。</span><br><span class="line">evaluation_interval 监控数据规则的评估率。</span><br><span class="line">这个参数是prometheus多长时间会进行一次监控规则评估。</span><br><span class="line">比如设置 当内存使用量&gt;70%时，发出警报，这么一条rule(规则)，那么prometheus会默认每15秒来执行一次这个规则，检查内存的情况。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Alertmanager configuration</span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">    - static_configs:</span><br><span class="line">        - targets:</span><br><span class="line">          # - alertmanager:9093</span><br><span class="line"></span><br><span class="line">Alertmanager 是prometheus的一个用于管理和发出报警的插件</span><br><span class="line">我采用的是4.0以上版本的Grafana,本身就已经支持报警发出功能了。</span><br></pre></td></tr></table></figure>

<p><strong>再往后就是prometheus重要的配置采集节点的设置</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># Here it&#39;s Prometheus itself.</span><br><span class="line">scrape_configs:</span><br><span class="line">  # The job name is added as a label &#96;job&#x3D;&lt;job_name&gt;&#96; to any timeseries scraped from this config.</span><br><span class="line">  - job_name: &quot;prometheus&quot;</span><br><span class="line"></span><br><span class="line">    # metrics_path defaults to &#39;&#x2F;metrics&#39;</span><br><span class="line">    # scheme defaults to &#39;http&#39;.</span><br><span class="line"></span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&quot;localhost:9090&quot;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">先定义一个job的名称</span><br><span class="line">  - job_name: &quot;prometheus&quot;</span><br><span class="line"> </span><br><span class="line"> 然后定义监控节点targets</span><br><span class="line">  # metrics_path defaults to &#39;&#x2F;metrics&#39;</span><br><span class="line">    # scheme defaults to &#39;http&#39;.</span><br><span class="line"></span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&quot;localhost:9090&quot;]</span><br></pre></td></tr></table></figure>

<p>-targets 的设定</p>
<p>以这种形式设定默认带了一个prometheus本机的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">static_configs:</span><br><span class="line"></span><br><span class="line">- targets:[&#39;localhost:9090&#39;</span><br></pre></td></tr></table></figure>

<p>这里可以继续扩展加入其他需要被监控的节点</p>
<p>比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &#39;aliyun&#39;</span><br><span class="line">  static_config:</span><br><span class="line">   - targets:[&#39;server04:9100&#39;,&#39;web3:9100&#39;,&#39;nginx06:9100&#39;,&#39;web07:9100&#39;,&#39;redis07:9100&#39;,&#39;log:9100&#39;,&#39;redis02:9100&#39;]</span><br></pre></td></tr></table></figure>

<p>targets可以并列写入多个节点，用逗号隔开，机器名+端口号</p>
<p>端口号:通常用的就是exporters的端口，这里的9100就是node_exporter的默认端口。</p>
<p>如此prometheus就可以通过配置文件识别监控的节点，持续采集数据。</p>
<p>prometheus到此就算初步搭建好了。</p>
<p>光搭建好prometheus_server是不够的，我们需要给监控节点搭建一个exporter用来采集数据，选用企业中最常用的node_exporter这个插件。</p>
<p>node_exporter是一个以http_server方式运行在后台，并且持续采集linux系统中各种操作系统本身相关的监控参数的程序，其采集量是很大很全的，往往默认的采集项目就远超过你的实际需求。</p>
<h4 id="2-安装alermanager"><a href="#2-安装alermanager" class="headerlink" title="2.安装alermanager"></a>2.安装alermanager</h4><p>从官网下载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;prometheus.io&#x2F;download&#x2F;</span><br><span class="line"></span><br><span class="line">wget https:&#x2F;&#x2F;github.com&#x2F;prometheus&#x2F;alertmanager&#x2F;releases&#x2F;download&#x2F;v0.25.0&#x2F;alertmanager-0.25.0.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">解压</span><br><span class="line">tar xzf alertmanager-0.25.0.linux-amd64.tar.gz </span><br><span class="line">mv alertmanager-0.25.0.linux-amd64 &#x2F;usr&#x2F;local&#x2F;alertmanager</span><br><span class="line"></span><br><span class="line">授权</span><br><span class="line">chown -R prometheus.prometheus &#x2F;usr&#x2F;local&#x2F;alertmanager&#x2F;</span><br></pre></td></tr></table></figure>

<p>创建systemd服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;etc&#x2F;systemd&#x2F;system&#x2F;alertmanager.service &lt;&lt; &quot;EOF&quot;</span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;Alert Manager</span><br><span class="line">Wants&#x3D;network-online.target</span><br><span class="line">After&#x3D;network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type&#x3D;simple</span><br><span class="line">User&#x3D;prometheus</span><br><span class="line">Group&#x3D;prometheus</span><br><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;local&#x2F;alertmanager&#x2F;alertmanager \</span><br><span class="line">--config.file&#x3D;&#x2F;usr&#x2F;local&#x2F;alertmanager&#x2F;alertmanager.yml \</span><br><span class="line">--storage.path&#x3D;&#x2F;usr&#x2F;local&#x2F;alertmanager&#x2F;data</span><br><span class="line"></span><br><span class="line">Restart&#x3D;always</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>启动alertmanager</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start alertmanager.service </span><br><span class="line">systemctl status alertmanager.service</span><br></pre></td></tr></table></figure>

<p>访问端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;192.168.224.11:9093&#x2F;#&#x2F;alerts</span><br></pre></td></tr></table></figure>

<p><strong>修改prometheus配置</strong></p>
<p>加入alertmanager</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># Alertmanager configuration</span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">    - static_configs:</span><br><span class="line">        - targets:</span><br><span class="line">          # - alertmanager:9093</span><br><span class="line">          - localhost:9093</span><br><span class="line"></span><br><span class="line"># Load rules once and periodically evaluate them according to the global &#39;evaluation_interval&#39;.</span><br><span class="line">rule_files:</span><br><span class="line">  # - &quot;first_rules.yml&quot;</span><br><span class="line">  # - &quot;second_rules.yml&quot;</span><br><span class="line">  # 根据实际修改文件名</span><br><span class="line">  - &quot;alert.yml&quot;</span><br></pre></td></tr></table></figure>

<p><a href="https://imgse.com/i/p9KRQqx"><img src="https://s1.ax1x.com/2023/04/26/p9KRQqx.png" alt="p9KRQqx.png"></a></p>
<p>增加触发器配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; &#x2F;usr&#x2F;local&#x2F;prometheus&#x2F;alert.yml &lt;&lt;&quot;EOF&quot;</span><br><span class="line">groups:</span><br><span class="line">- name: Prometheus alert</span><br><span class="line">  rules:</span><br><span class="line">   #对任何实例超过30s无法联系的情况发出警报</span><br><span class="line">  - alert: 服务器告警</span><br><span class="line">    expr: up &#x3D;&#x3D; 0</span><br><span class="line">    for: 30s</span><br><span class="line">    labels:</span><br><span class="line">      severity: critical</span><br><span class="line">    annotations:</span><br><span class="line">      instance: &quot;&#123;&#123; $labels.instance &#125;&#125;&quot;</span><br><span class="line">      description: &quot;&#123;&#123; $labels.job &#125;&#125; 服务关闭&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>检查配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;usr&#x2F;local&#x2F;prometheus&#x2F;</span><br><span class="line"> .&#x2F;promtool check config prometheus.yml</span><br></pre></td></tr></table></figure>

<p>重启prometheus或者重载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart prometheus.service </span><br><span class="line">或者重载，需要--web.enable-lifecycle配置</span><br><span class="line">curl -X POST http:&#x2F;&#x2F;localhost:9090&#x2F;-&#x2F;reload</span><br></pre></td></tr></table></figure>

<p>访问地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;192.168.224.11:9093&#x2F;#&#x2F;alerts</span><br></pre></td></tr></table></figure>

<p>检查</p>
<p><a href="https://imgse.com/i/p9KWKfg"><img src="https://s1.ax1x.com/2023/04/26/p9KWKfg.png" alt="p9KWKfg.png"></a></p>
<h4 id="3-安装node-exporter"><a href="#3-安装node-exporter" class="headerlink" title="3.安装node_exporter"></a>3.安装node_exporter</h4><p>从官网下载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;github.com&#x2F;prometheus&#x2F;node_exporter&#x2F;releases&#x2F;download&#x2F;v1.5.0&#x2F;node_exporter-1.5.0.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">解压</span><br><span class="line">tar xzf node_exporter-1.5.0.linux-amd64.tar.gz </span><br><span class="line">cp -rf node_exporter-1.5.0.linux-amd64 &#x2F;usr&#x2F;local&#x2F;node_exporter</span><br><span class="line"></span><br><span class="line">更改 node_exporter文件权限</span><br><span class="line"> chown -R prometheus.prometheus &#x2F;usr&#x2F;local&#x2F;node_exporter&#x2F;</span><br><span class="line"></span><br><span class="line">tmux 进入新终端</span><br><span class="line">cd &#x2F;usr&#x2F;local&#x2F;node_exporter</span><br><span class="line">.&#x2F;node_exporter</span><br><span class="line"></span><br><span class="line">tmux ls 查看已创建的会话终端</span><br><span class="line">tmux a -t 2 进入一个会话，名为2</span><br><span class="line"></span><br><span class="line">查看是否运行起来了。</span><br><span class="line">node_exporter]# netstat -putnal | grep node</span><br><span class="line">tcp6       0      0 :::9100                 :::*                    LISTEN      64349&#x2F;.&#x2F;node_export</span><br></pre></td></tr></table></figure>

<p><strong>创建systemd服务</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;etc&#x2F;systemd&#x2F;system&#x2F;node_exporter.service &lt;&lt; &quot;EOF&quot;</span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;node_exporter</span><br><span class="line">Documentation&#x3D;https:&#x2F;&#x2F;prometheus.io&#x2F;</span><br><span class="line">After&#x3D;network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User&#x3D;prometheus</span><br><span class="line">Group&#x3D;prometheus</span><br><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;local&#x2F;node_exporter&#x2F;node_exporter</span><br><span class="line">Restart&#x3D;on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>启动node_exporter</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start node_exporter.service </span><br><span class="line">systemctl status node_exporter.service </span><br><span class="line">systemctl enable node_exporter.service</span><br></pre></td></tr></table></figure>

<p>检查日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl -u node_exporter.service  -f</span><br></pre></td></tr></table></figure>

<p>修改promethsu.yml配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &quot;node-exporter&quot;</span><br><span class="line">   scrape_interval: 15s</span><br><span class="line">   static_configs:</span><br><span class="line">   - targets: [&quot;localhost:9100&quot;]</span><br><span class="line">     labels:</span><br><span class="line">       instance: Prometheus服务器</span><br></pre></td></tr></table></figure>

<p><a href="https://imgse.com/i/p9KhTFf"><img src="https://s1.ax1x.com/2023/04/26/p9KhTFf.png" alt="p9KhTFf.png"></a></p>
<p>重载prometheus</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart prometheus</span><br><span class="line">或者</span><br><span class="line">curl -X POST http:&#x2F;&#x2F;localhost:9090&#x2F;-&#x2F;reload</span><br></pre></td></tr></table></figure>



<p>可以看到node_exporter默认端口是9100</p>
<p>可以响应prometheus_server发过来的http_get请求，</p>
<p>也可以响应其他方式的http_get请求</p>
<p>可以发送测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl localhost:9100&#x2F;metrics</span><br></pre></td></tr></table></figure>

<p>执行curl 之后，我们看到node_exporter给我们返回了大量的这种metrics类型K/V数据,</p>
<p>这些返回的K/V数据，其中的Key的名称就可以直接复制粘贴在prometheus的查询命令行来查看结果了。</p>
<p>比如查看这一项 node_menory_MemFree</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> curl localhost:9100&#x2F;metrics |grep node_menory_MemFree</span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100 70942    0 70942    0     0  2804k      0 --:--:-- --:--:-- --:--:-- 2886k</span><br></pre></td></tr></table></figure>

<p>也可以在后台才看，比如我查看其他信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_cpu_seconds_total</span><br></pre></td></tr></table></figure>

<p><a href="https://imgloc.com/i/i5IhNq"><img src="https://i.328888.xyz/2023/04/22/i5IhNq.png" alt="i5IhNq.png"></a></p>
<p>直接看到曲线了，</p>
<p>prometheus对Linux CPU的采集并不是直接给我们返回一个现成的CPU百分比，而是返回linux中很底层的cpu时间线累积的数值的这样一个数据(我们平时用惯  了top/uptime这种简便的方式查看CPU使用率，往往浅尝，根本没有好好深入理解，所谓的CPU使用率在linux中到底是怎么回事，)</p>
<p>其实，如果想真的弄明白CPU的使用率这个概念，在linux中，要先从CPU时间这概念开始建立，linux中CPU时间实际是指，从操作系统开启算起CPU就开始工作了，并记录自己在工作中总共使用的”时间”的累积量把他保存在系统中，而累积的CPU使用时间还会分成几个重要的状态类型。</p>
<p>比如CPU time=&gt;分成 CPU user time / sys time / nice  time / idle time / irq/等等。</p>
<p>翻译过来就是CPU用户态使用时间，系统/内核态使用时间，nice值分配使用时间，空闲时间，中断时间等等。</p>
<p>所谓的cpu使用率是什么意思呢。</p>
<p>CPU使用率最准确的定义其实就是CPU各种状态中除了idle(空闲)这个状态外，其他所有 的CPU状态加合/总的CPU时间得出来得就是我们所说的CPU使用率。</p>
<p>所以：如果在prometheus中想对CPU的使用率准确的来查询</p>
<p>正确的方法如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(1-((sum(increase(node_cpu&#123;mode&#x3D;&quot;idle&quot;&#125;[1m]))by(instance))&#x2F;(sum(increase(node_cpu[1m]))by(instance))))*100</span><br><span class="line"></span><br><span class="line">(1-((sum(increase(node_cpu_seconds_total&#123;mode&#x3D;&quot;idle&quot;&#125;[1m]))by(instance))&#x2F;(sum(increase(node_cpu_seconds_total[1m]))by(instance)))) * 100</span><br></pre></td></tr></table></figure>

<p><a href="https://imgloc.com/i/i5eGdF"><img src="https://i.328888.xyz/2023/04/23/i5eGdF.png" alt="i5eGdF.png"></a></p>
<p>prometheus这种底层数据采集所形成的监控，其实是最准确最可信的。</p>
<p>prometheus本身也逼着使用它的运维同学，不踏实下来，好好真正的把linux技术学过关的话，就没有办法使用好这个超强力的监控工具了。</p>
<h3 id="三-prometheus的使用"><a href="#三-prometheus的使用" class="headerlink" title="三, prometheus的使用"></a>三, prometheus的使用</h3><p>指标(Metric)的四种类型 </p>
<p>Prometheus底层存储上其实并没有对指标做类型区分，都是以时间序列形式存储，但为了方便用户的使用和理解不同监控指标之间的差异，Prometheus定义理论counter(计数器)、gauge(仪表盘)、histogram(直方图)、以及summary(摘要)这4中Metrics类型。</p>
<h4 id="Exporter插件来源"><a href="#Exporter插件来源" class="headerlink" title="Exporter插件来源"></a>Exporter插件来源</h4><p><strong>社区提供的</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;prometheus.io&#x2F;docs&#x2F;instrumenting&#x2F;exporters&#x2F;</span><br></pre></td></tr></table></figure>

<p>Prometheus社区提供了丰富的Exporter实现，覆盖了从基础设施，中间件以及网络等各方面的监控功能。这些exporter可以实现大部分通用的监控需求，下面是一些常用的exporter.</p>
<p><a href="https://imgse.com/i/p9MWXz4"><img src="https://s1.ax1x.com/2023/04/27/p9MWXz4.png" alt="p9MWXz4.png"></a></p>
<h4 id="prometheus计算CPU的使用率算法"><a href="#prometheus计算CPU的使用率算法" class="headerlink" title="prometheus计算CPU的使用率算法"></a>prometheus计算CPU的使用率算法</h4><p>12点开机后一直到12:30截止</p>
<p>这30分钟的过程中(当前暂时忽略是几核CPU，就当做1核来说)</p>
<p>CPU被使用在用户态的时间一共是8分钟</p>
<p>CPU被使用在内核态的时间一共是1.5分钟</p>
<p>CPU被使用在IO等待状态的时间一共是0.5分钟</p>
<p>CPU被使用在Idle(空闲状态)的时间一共是20分钟</p>
<p>CPU被使用在其他几个状态的时间是0</p>
<p>CPU的使用率=(所有非空闲状态的CPU使用时间总和) / (所有状态CPU时间的总和)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(user(8mins)+sys(1.5mins)+iowa(0.5min)+0+0+0+0) &#x2F; (30mins)</span><br><span class="line">&#x3D;10分钟&#x2F;30分钟</span><br><span class="line">&#x3D;30%</span><br></pre></td></tr></table></figure>

<p>更简明的算法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">idle(20mins) &#x2F; (30mins) &#x3D; 70%</span><br><span class="line">空闲时间除以总时间等于空闲CPU的比例</span><br><span class="line">100%-70%&#x3D; 30%</span><br></pre></td></tr></table></figure>

<p>上面这样的方法去计算最终只能算出CPU在30分钟内的总平均时间</p>
<p>如果要计算某一分钟之内CPU的总平均时间是多少？？</p>
<p>node_cpu给我们返回的是Counter的数据。Counter是一个一直持续增长的数值</p>
<p>现在面临的问题是30分钟内CPU使用时间持续增长，我们需要截取其中一段增长的增量值，如果我们能获取1分钟的增量值，然后拿这个数值再去使用刚才同样的计算公式，就能得到1分钟的平均值了。</p>
<p>promeheus的数学查询命令行其实给我们提供了非常丰富的计算函数，</p>
<p>increase()</p>
<p>increase函数在prometheus中，是用来针对Counter这种持续增长的数值，截取其中一段时间的增量</p>
<p>increase(node_cpu[1m]) 这样就获取了CPU总使用时间在一分钟内的增量    </p>
<p>实际工作中的CPU大多数都是多核的</p>
<p>node_exporter给我们采集的数据也是细到采集到每一个核的CPU时间</p>
<p>我们在实际监控中，往往并不是太关注每一个CPU核表现时间如何，而是希望知道整个CPU表现如何</p>
<p>如果每一个核都单独来监控曲线图意义不大，而且看着比较混乱。</p>
<p>如何解决这个问题。</p>
<p>prometheus提供了另一个sum()函数。</p>
<p>sum()就如其字面意思一样，起到加合的作用。</p>
<p>sum(increase(node_cpu[1m]))</p>
<p>外面套用一个sum即可把所有核数加合问题就可以解决了。</p>
<p>然后把prometheus计算公式在下一个阶段进行拆分讲解</p>
<p><strong>拆分并解释这个运行公式</strong></p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(1-((sum(increase(node_cpu_seconds_total&#123;mode&#x3D;&quot;idle&quot;&#125;[1m]))by(instance))&#x2F;(sum(increase(node_cpu_seconds_total[1m]))by(instance)))) * 100</span><br></pre></td></tr></table></figure>

<p>这个prometheus的计算公式其实就是那个使用100%-(空闲时间/总时间)的方法，不过这个公式直接拿来看还是比较痛苦，来学一下拆分</p>
<p><strong>首先第一步</strong>，</p>
<p>node_cpu_seconds_total是我们需要使用的key name</p>
<p><a href="https://imgloc.com/i/i5dZQk"><img src="https://i.328888.xyz/2023/04/23/i5dZQk.png" alt="i5dZQk.png"></a></p>
<p>直接输入后如上图所示，目前这种图没有任何意义，我们继续完善命令行</p>
<p><strong>第二步</strong></p>
<p>把idle的CPU时间和全部CPU时间都给过滤出来使用{}做过滤</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_cpu_seconds_total&#123;mode&#x3D;&quot;idle&quot;&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://imgloc.com/i/i5dNjJ"><img src="https://i.328888.xyz/2023/04/23/i5dNjJ.png" alt="i5dNjJ.png"></a></p>
<p><strong>第三步</strong></p>
<p>使用increase(    [1m]) 把node_cpu_seconds_total{mode=”idle”}包起来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">increase(node_cpu_seconds_total&#123;mode&#x3D;&quot;idle&quot;&#125;[1m])</span><br></pre></td></tr></table></figure>

<p>这样就把一分钟的增量的CPU时间给取出来了。</p>
<p><a href="https://imgloc.com/i/i5d6Yx"><img src="https://i.328888.xyz/2023/04/23/i5d6Yx.png" alt="i5d6Yx.png"></a></p>
<p>第四步</p>
<p>使用sum()再包一层。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sum(increase(node_cpu_seconds_total&#123;mode&#x3D;&quot;idle&quot;&#125;[1m]))</span><br></pre></td></tr></table></figure>

<p><a href="https://imgloc.com/i/i5docv"><img src="https://i.328888.xyz/2023/04/23/i5docv.png" alt="i5docv.png"></a></p>
<p>现在sum函数不光把每一台机器的多个核加在一起了，还把所有的机器CPU也全都加到一起了，变成了服务器集群总CPU平均值了。如何解决。看下一步。</p>
<p>第五步</p>
<p>新的一个函数</p>
<p>by(instance)</p>
<p>这个函数可以把sum加合到一起的数值按照指定的一个方式进行一层拆分</p>
<p>instance代表的是机器名</p>
<p>意思就是说把sum函数中服务器加合的这个糗事再给它强行拆分出来。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sum(increase(node_cpu_seconds_total&#123;mode&#x3D;&quot;idle&quot;&#125;[1m])) by(instance)</span><br></pre></td></tr></table></figure>

<p><a href="https://imgloc.com/i/i5uCrt"><img src="https://i.328888.xyz/2023/04/23/i5uCrt.png" alt="i5uCrt.png"></a></p>
<p>这下3个问题都解决了。现在把公式写完整</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(1-((sum(increase(node_cpu_seconds_total&#123;mode&#x3D;&quot;idle&quot;&#125;[1m])) by(instance)) &#x2F;(sum(increase(node_cpu_seconds_total[1m])) by (instance)))) * 100</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sum(increase(node_cpu_seconds_total&#123;mode&#x3D;&quot;idle&quot;&#125;[1m])) by(instance)  是空闲CPU时间，1分钟的增量</span><br><span class="line">sum(increase(node_cpu_seconds_total[1m])) by(instance)  是全部CPU时间，1分钟的增量。</span><br><span class="line"></span><br><span class="line">sum(increase(node_cpu_seconds_total&#123;mode&#x3D;&quot;idle&quot;&#125;[1m])) by(instance) &#x2F;sum(increase(node_cpu_seconds_total[1m])) by(instance)</span><br></pre></td></tr></table></figure>



<p><a href="https://imgloc.com/i/iSibmd"><img src="https://i.328888.xyz/2023/04/23/iSibmd.png" alt="iSibmd.png"></a></p>
<p>这样就得到了空闲CPU的百分比了。</p>
<p>第七步</p>
<p>最后一步用1去减掉整个上面的公式再 *100</p>
<p>这样就得到了我们期望的结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(1-((sum(increase(node_cpu_seconds_total&#123;mode&#x3D;&quot;idle&quot;&#125;[1m])) by(instance)) &#x2F;(sum(increase(node_cpu_seconds_total[1m])) by (instance)))) * 100</span><br></pre></td></tr></table></figure>



<p><a href="https://imgloc.com/i/iSZuG8"><img src="https://i.328888.xyz/2023/04/23/iSZuG8.png" alt="iSZuG8.png"></a></p>
<p>查看其他CPU状态时间的使用率</p>
<p>既然要看每一个单独CPU类型的使用率，那么1-idle的方式就不好用了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sum(increase(node_cpu_seconds_total&#123;mode&#x3D;&quot;user&quot;&#125;[1m])) by(instance) &#x2F;sum(increase(node_cpu_seconds_total[1m])) by (instance)</span><br><span class="line"></span><br><span class="line">sum(increase(node_cpu_seconds_total&#123;mode&#x3D;&quot;system&quot;&#125;[1m])) by(instance) &#x2F;sum(increase(node_cpu_seconds_total[1m])) by (instance)</span><br><span class="line"></span><br><span class="line">sum(increase(node_cpu_seconds_total&#123;mode&#x3D;&quot;iowait&quot;&#125;[1m])) by(instance) &#x2F;sum(increase(node_cpu_seconds_total[1m])) by (instance)</span><br></pre></td></tr></table></figure>

<p>这样就可以获取每一种CPU状态时间的使用百分比了。</p>
<p>现在发现TOP命令的这一行，我们就能明白是怎么回事了。</p>
<p><a href="https://imgloc.com/i/iSiE43"><img src="https://i.328888.xyz/2023/04/23/iSiE43.png" alt="iSiE43.png"></a></p>
<h4 id="prometheus命令行使用扩展"><a href="#prometheus命令行使用扩展" class="headerlink" title="prometheus命令行使用扩展"></a>prometheus命令行使用扩展</h4><p><strong>1.prometheus命令格式</strong></p>
<p>这次选择一个新的key来做讲解</p>
<p>count_netstat_wait_connections (TCP wait_connect数)</p>
<p><strong>2.rate函数的使用</strong></p>
<p>rate函数可以说是prometheus提供的最重要的函数之一。</p>
<p>rate()</p>
<p>rate()函数是专门搭配counter类型数据使用的函数</p>
<p>它的功能是按照设置一个时间段，取counter在这个时间段中的平均每秒的增量</p>
<p>这么说可能还有点抽象，举例说下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">node_network_receive_bytes</span><br><span class="line">node_network_receive_bytes_total</span><br></pre></td></tr></table></figure>

<p><a href="https://imgloc.com/i/iSAkl8"><img src="https://i.328888.xyz/2023/04/23/iSAkl8.png" alt="iSAkl8.png"></a></p>
<p>这个例子使用的是node_exporter key  node_network_receive_bytes_total</p>
<p>rate(node_network_receive_bytes_total[1m])</p>
<p>node_network_raceive_bytes_total本身是一个counter类型，字面意思也很好理解，网络接收字节总数</p>
<p>之前学过对于这种持续增长的counter数据，直接输入key是没有任何意义的</p>
<p>我们必须要以获取单位时间内增量的方式来进行加工才能有意义。</p>
<p>那么，对于counter数据，进行第一步初始化的增量获取加工，通常的使用方法就是直接用reate()包上，(increase(),也是可以的，后面会说到)</p>
<p>node_network_receive_bytes_total被rate(.[1m])包上以后，就可以获取到在1分钟时间内，平均每秒钟的增量。</p>
<p><a href="https://imgloc.com/i/iSDUvN"><img src="https://i.328888.xyz/2023/04/23/iSDUvN.png" alt="iSDUvN.png"></a></p>
<p>这样一来，数据就变得有意义了。</p>
<p>所以说，以后在使用任何counter数据类型的时候，永远记得，别的先不做，先给它加上一个rate()或者increase()</p>
<p>接下来我们把rate()做的事情，更加细化的来解释下。</p>
<p><a href="https://imgloc.com/i/iS2Mcy"><img src="https://i.328888.xyz/2023/04/23/iS2Mcy.png" alt="iS2Mcy.png"></a></p>
<p>比如上面的这个图，网络接收字节数一直不停的累加。</p>
<p>从09:40开始到09:41，比如累积量从746250282到了746251282</p>
<p>一分钟内，增加了1000bytes(假设)</p>
<p>从09:41开始到09:46</p>
<p>比如累积量从746251282到了746256282(假设)</p>
<p>加入rate(.[1m])之后</p>
<p>会把1000bytes除以1m*60秒。=~16bytes</p>
<p>就是这样计算出在1分钟内，平均每秒增加16bytes。</p>
<p>接下来把1m修改为5m</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rate(node_network_receive_bytes_total[5m])</span><br></pre></td></tr></table></figure>

<p>这样就变成把5分钟内的增量除以5m*60</p>
<p>5分钟内的增量假如是5000，那么除以300以后，也还是约等于16bytes.</p>
<p>感觉好像是一模一样的</p>
<p>那么我们看下输出rate[5]</p>
<p><a href="https://imgloc.com/i/iSj7dw"><img src="https://i.328888.xyz/2023/04/23/iSj7dw.png" alt="iSj7dw.png"></a></p>
<p>会发现 图形和上面的1分钟发生了一定的变化。</p>
<p>事实是这样的，</p>
<p>如果我们按照rate(1m)这样来取，那么取1分钟内的增量除以秒数</p>
<p>如果我们按照rate(5m)这样来取，那么是取5分钟内的增量除以秒数</p>
<p>而这种取法，是一种平均的取法，而且是假设的</p>
<p>刚才我们说counter在一分钟 5分钟之内的增量1000和5000其实是一种假设的理想状态，</p>
<p>事实上，在生产环境，网络数据接收量可不是这么平均的。</p>
<p>有可能在第一分钟内增加了1000，到第二分钟就变成增加了2500…</p>
<p>所以 ，rate(1m)这样的取值方法比起rate(5m),因为它取的时间段短，所以，在任何某一瞬间的凸起或者降低在成图的时候，会体现的更细致，更敏感。而 rate(5m)把整个5分钟内的都一起    平均了，那么当发生瞬时凸起的时候，会显得图平缓了一些，</p>
<p>那么放大到rate(20m)会怎么样，结果是会更加平缓 。</p>
<p>平时工作中取1m还是5m，这个取决于我们对于监控数据的敏感程度来挑选。</p>
<p><strong>3.increase函数使用</strong></p>
<p>increase函数其实和raate()的概念及使用方法 非常相似  </p>
<p>rate()是取一段时间增量的平均每秒数量</p>
<p>increase()则是取一段时间增量的总量</p>
<p>比如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">increase(node_network_receive_bytes_total[1m])</span><br><span class="line">取的是1分钟内的增量总量</span><br><span class="line">和</span><br><span class="line">rate(node_network_receive_bytes_total[1m])</span><br><span class="line">取的是1分钟内增量除以60秒每秒数量</span><br></pre></td></tr></table></figure>

<p>这两个函数查询数据的曲线走势基本是一样的，但是显示的数量bytes不一样，正好是60倍。</p>
<p><strong>4.sum()函数学习</strong></p>
<p>sum()函数的使用，就是取合，</p>
<p>sum会把结果集的输出进行总加合。</p>
<p>比如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rate(node_network_receive_bytes_total[1m])显示的结果集会包含如下内容。</span><br></pre></td></tr></table></figure>

<p><a href="https://imgloc.com/i/iS7YqL"><img src="https://i.328888.xyz/2023/04/24/iS7YqL.png" alt="iS7YqL.png"></a></p>
<p>从标签上可以看出，有很多台服务器都返回了这个监控数据</p>
<p>当我们使用sum()包起来后，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sum(rate(node_network_receive_bytes_total[1m])) 就变成现在的</span><br><span class="line">一条线了</span><br></pre></td></tr></table></figure>

<p>等于是给出了所有机器的每秒请求量，</p>
<p>如果要进行下一层的拆分，需要在sum()的后面加上by(instance)才可以按照机器名拆分出一层来</p>
<p>sum()加合其实还有更多巧妙使用。</p>
<p>sum() by(cluster_name)</p>
<p>如果是by instance那么其实跟不加sum()的输出结果是一样的。</p>
<p>本来<code>rate(node_network_receive_bytes_total[1m])</code>就已经是按照每台机器返回了，</p>
<p>但是如果我们希望按集群总量输出呢，比如 ，我们返回了20台机器的数据，</p>
<p>其中有6台属于web server,10台属于DB server，其他的属于一般server</p>
<p>那么我们这时候sum() by(cluster_name)就可以帮我们实现集群加合并分成三条曲线输出了，顺带一提的是(cluster_name)这个标签，默认node_exporter是没有办法提供的，node_exporter只能按照不同的机器名去划分，如果希望支持cluster_name，我们需要自行定义标签。</p>
<p>目前我们学了rete() increase() sum() by()函数。</p>
<p>其实prometheus还提供了更多的函数让我们调用，只不过更加专业化了，</p>
<p><strong>5.topk()函数的学习</strong></p>
<p>定义：取前几位的最高值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">topk(3,count_netstat_wait_connections)</span><br></pre></td></tr></table></figure>

<p>Gauge类型的使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">topk(3,count_netstat_wait_connections)</span><br></pre></td></tr></table></figure>

<p>Counter类型的使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">topk(3,rate(node_network_receive_bytes_total[20m]))</span><br></pre></td></tr></table></figure>

<p>这个函数还是比较容易理解的，根据给定的数字，取数值最高&gt;=x的数值，</p>
<p>需要注意的是这个函数一般在使用的时候，只适合在console查看，graph的意义不大，</p>
<p>topk因为对于每个时间点都只取前三高的数值，那么必然会造成单个机器的采集数据不连贯，</p>
<p>比如：server01在这一分钟的wait_connection数量排在所在机器的前三，到了下一分钟，可能就垫底了，自然曲线就会中断，</p>
<p>实际使用的时候一般用topk()函数进行瞬时报警，而不是为了观察曲线。</p>
<p><strong>6.count()函数的学习</strong></p>
<p>定义：把数值符合条件的输出数目进行加合，</p>
<p>比如，找出当前(或者历史的)当TCP等待数大于200的机器数量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">count(count_netstat_wait_connections&gt;200)</span><br></pre></td></tr></table></figure>

<p>这个函数在实际工作中还是很有用的，一般用它进行一些模糊的监控判断。</p>
<p>比如说 企业中有100台服务器，那么当只有10台服务器CPU高于80%的时候，这个时候不需要报警，但是当符合80%CPU的服务器数量超过30台的时候那么就会触发报警。</p>
<p>其他更多的函数可以在prometheus官方网站继续学习</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;prometheus.io&#x2F;docs&#x2F;prometheus&#x2F;latest&#x2F;querying&#x2F;functions&#x2F;</span><br></pre></td></tr></table></figure>

<h4 id="pushgateway的使用"><a href="#pushgateway的使用" class="headerlink" title="pushgateway的使用"></a>pushgateway的使用</h4><p>pushgateway是另一种采用被动推送的方式(而不是exporter主动获取)获取监控数据的prometheus插件，</p>
<p>它是可以单独运行在任何节点上的插件(并不一定要在被监控客户端)</p>
<p>然后通过用户自定义开发脚本 把需要监控的数据，发送给pushgateway,然后pushgateway再把数据推送给prometheus server</p>
<p><strong>pushgatway的安装运行和配置。</strong></p>
<p>pushgateway和prometheus和exporter一样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;prometheus.io&#x2F;download&#x2F;</span><br><span class="line"></span><br><span class="line">wget https:&#x2F;&#x2F;github.com&#x2F;prometheus&#x2F;pushgateway&#x2F;releases&#x2F;download&#x2F;v1.5.1&#x2F;pushgateway-1.5.1.linux-amd64.tar.gz</span><br><span class="line">上面的报错，可以加参数--no-check-certificate</span><br><span class="line"></span><br><span class="line">wget https:&#x2F;&#x2F;github.com&#x2F;prometheus&#x2F;pushgateway&#x2F;releases&#x2F;download&#x2F;v1.5.1&#x2F;pushgateway-1.5.1.linux-amd64.tar.gz --no-check-certificate</span><br><span class="line">解压</span><br><span class="line">tar xzf pushgateway-1.5.1.linux-amd64.tar.gz</span><br><span class="line">mv pushgateway-1.5.1.linux-amd64 &#x2F;usr&#x2F;local&#x2F;pushgateway</span><br><span class="line"></span><br><span class="line">通过后台tmux方式运行。</span><br><span class="line">cd &#x2F;usr&#x2F;local&#x2F;pushgateway</span><br><span class="line">.&#x2F;pushgateway</span><br><span class="line"></span><br><span class="line"> netstat -putnal |grep pushgateway</span><br><span class="line"> 默认端口9091</span><br></pre></td></tr></table></figure>

<p>关于pushgateway的配置，主要指的是在prometheus server端的配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &quot;pushgateway&quot;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#39;localhost:9091&#39;]</span><br></pre></td></tr></table></figure>

<p><a href="https://imgloc.com/i/iS9bgJ"><img src="https://i.328888.xyz/2023/04/24/iS9bgJ.png" alt="iS9bgJ.png"></a></p>
<p>在prometheus.yml配置文件中，单独定义一个job,然后target指向到pushgateway运行所在的机器名和端口，</p>
<p><strong>自定义编写脚本的方法，发送pushgateway采集</strong></p>
<p>pushgateway本身是没有任何抓取监控数据的功能的，它只是被动的等待推送过来，所以需要学习pushgateway编程脚本的写法。</p>
<p>如下是一段生产环境中使用shell编写的pushgateway脚本</p>
<p>用于抓取TCP waiting_connection 瞬时数量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat /usr/local/node_exporter/node_exporter_shell.sh </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">instance_name=$(hostname -f | cut -d'.' -f1) #本机机器名，变量用于之后的标签。</span><br><span class="line">if [ $instance_name == "localhost" ];then #要求机器名不能是localhost,要不然标签就没法区分了。</span><br><span class="line">echo "Must FQDN hostname"</span><br><span class="line">exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">For waitting connections </span></span><br><span class="line">label="count_netstat_wait_connections"  #定一个新的key</span><br><span class="line">count_netstat_wait_connections=$(netstat -an | grep -i wait | wc -l) #定义一个新的值netstat中wait的数量</span><br><span class="line">echo "$label:$count_netstat_wait_connections"</span><br><span class="line">echo "$label $count_netstat_wait_connections" | curl --data-binary @- http://localhost:9091/metrics/job/pushgateway/instance/$instance_name</span><br></pre></td></tr></table></figure>

<p>#最后把key &amp; value 推送给pushgateway</p>
<p>curl –data-binary</p>
<p>将HTTP POST请求中的数据发送给HTTP服务器(pushgateway)，与用户提交html表单时浏览器的行为完全一样。</p>
<p>HTTP POST请求中的数据为纯二进制数据。</p>
<p>脚本最重要的两行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">count_netstat_wait_connections&#x3D;$(netstat -an | grep -i wait | wc -l)</span><br><span class="line">后面的linux命令行就简单的获取到了我们需要监控的数据TCP_WAIT数</span><br><span class="line">http:&#x2F;&#x2F;prometheus.server.com:9091&#x2F;metrics&#x2F;job&#x2F;pushgateway1&#x2F;instance&#x2F;$instance_name</span><br><span class="line">最后这里用post方式把key &amp; value推送给pushgateway的url地址。</span><br><span class="line">这个URL地址中，分成如下三个部分</span><br><span class="line">http:&#x2F;&#x2F;prometheus.server.com:9091&#x2F;metrics&#x2F;job&#x2F;pushgateway1&#x2F;</span><br><span class="line">这里是URL的主location</span><br><span class="line"></span><br><span class="line">job&#x2F;pushgateway1</span><br><span class="line">这里是第二部分，第一个标签：推送到哪一个prometheus定义的job里，</span><br><span class="line"></span><br><span class="line">instance&#x2F;$instance_name</span><br><span class="line">这里是第二个标签，推送后显示的机器名是什么</span><br></pre></td></tr></table></figure>

<p>通过这样的脚本编程方式。我们可以很快速的自定义我们需要的任何监控数据</p>
<p>这个我们编写的监控bash脚本是一次性执行的 ，需要按照时间段反复执行，需要结合contab了。</p>
<p>这里说一下，</p>
<p>crontab默认只能最短一分钟的间隔，如果希望小于一分钟的间隔，</p>
<p>我们使用如下的方法</p>
<p>sleep 10 </p>
<p>sleep 20</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* * * * * &#x2F;usr&#x2F;local&#x2F;node_exporter&#x2F;node_exporter_shell.sh</span><br><span class="line">* * * * * sleep 20;  &#x2F;usr&#x2F;local&#x2F;node_exporter&#x2F;node_exporter_shell.sh</span><br></pre></td></tr></table></figure>



<p>之后回到prometheus主界面，尝试输入我们自己定义的new_key 看看结果，</p>
<p>key的名字就是这个label=”count_netstat_wait_connections”</p>
<p>其他种类的监控数据都可以使用类似的形式直接写脚本发送，使用python也是很好的方式，</p>
<p><strong>使用pushgateway的优缺点</strong></p>
<p>pushgateway这种自定义的采集方式非常的快速，而且极其灵活，几乎不受到任何约束，</p>
<p>一般情况下，只安装node_exporter和DB_exporter两个，其他种类的监控数据可以使用pushgateway的方法采集。</p>
<h4 id="prometheus结合grafana"><a href="#prometheus结合grafana" class="headerlink" title="prometheus结合grafana"></a>prometheus结合grafana</h4><p>官方网站</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;grafana.com&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;grafana.com&#x2F;grafana&#x2F;download</span><br><span class="line">下载：</span><br><span class="line"></span><br><span class="line">yum install -y https:&#x2F;&#x2F;dl.grafana.com&#x2F;enterprise&#x2F;release&#x2F;grafana-enterprise-9.4.7-1.x86_64.rpm</span><br><span class="line"></span><br><span class="line">或者</span><br><span class="line">wget https:&#x2F;&#x2F;dl.grafana.com&#x2F;enterprise&#x2F;release&#x2F;grafana-enterprise-9.4.7-1.x86_64.rpm</span><br><span class="line">yum install -y grafana-enterprise-9.4.7-1.x86_64.rpm</span><br><span class="line"></span><br><span class="line">启动</span><br><span class="line">systemctl start grafana-server</span><br><span class="line">检查grafana是否启动成功，grafana启动时会占用3000端口</span><br><span class="line">lsof -i:3000</span><br></pre></td></tr></table></figure>

<p>grafana部署成功时，可以http访问，ip就是grafana服务的服务器host</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">登录地址：http:&#x2F;&#x2F;192.168.224.11:3000&#x2F;</span><br><span class="line">账号：admin&#x2F;admin</span><br><span class="line">登陆成功后修改新密码。</span><br></pre></td></tr></table></figure>

<p>grafana 安装成功后，会在/etc/grafana目录生成配置文件grafana.ini</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;etc&#x2F;grafana</span><br></pre></td></tr></table></figure>

<p>1.如果需要开启匿名访问，需要修改如下参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;grafana&#x2F;grafana.ini</span><br><span class="line"># 开启匿名访问</span><br><span class="line">enabled &#x3D; true</span><br><span class="line"># 给匿名访问者一个组织</span><br><span class="line">org_name &#x3D; Main Org.</span><br><span class="line">#给匿名访问者一个访问权限，Viewer表示浏览权限，Editor编辑权限，Admin管理员权限</span><br><span class="line">org_role &#x3D; Viewer</span><br></pre></td></tr></table></figure>


<p>2.如果需要开放浏览器iframe嵌套grafana页面设置，需修改如下参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> vim &#x2F;etc&#x2F;grafana&#x2F;grafana.ini</span><br><span class="line"># 允许浏览器渲染grafana到iframe</span><br><span class="line">allow_embedding &#x3D; true</span><br></pre></td></tr></table></figure>

<p>修改了配置之后需要重启grafana</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart grafana-server</span><br></pre></td></tr></table></figure>

<p>3.隐藏grafana左侧菜单和顶部面包屑</p>
<p>只要在url后面追加 &amp;kiosk 参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">示例：http:&#x2F;&#x2F;192.168.224.11:3000&#x2F;?orgId&#x3D;1&amp;kiosk</span><br></pre></td></tr></table></figure>

<p><strong>添加数据源</strong></p>
<p><a href="https://imgloc.com/i/isNjqq"><img src="https://i.328888.xyz/2023/04/25/isNjqq.png" alt="isNjqq.png"></a></p>
<p><strong>主题设置</strong></p>
<p>部署成功后默认只有dark和light两种主题，light白色主题比较刺眼，dark主题看久了有视觉疲劳，grafana可以支持自定义主题设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">安装插件</span><br><span class="line">grafana-cli plugins install yesoreyeram-boomtheme-panel</span><br><span class="line"></span><br><span class="line">systemctl restart grafana-server</span><br></pre></td></tr></table></figure>

<p>2.检查插件是否安装成功</p>
<p><a href="https://imgloc.com/i/isHbGJ"><img src="https://i.328888.xyz/2023/04/25/isHbGJ.png" alt="isHbGJ.png"></a></p>
<p>下载主题样式css文件到grafana指定目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">推荐grafana主题样式gitub地址：https:&#x2F;&#x2F;github.com&#x2F;gilbN&#x2F;theme.park</span><br></pre></td></tr></table></figure>

<p>1.<strong>创建存放css样式的目录</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">grafana部署成功后，会自动创建&#x2F;usr&#x2F;share&#x2F;grafana目录，这些是存放静态资源的</span><br><span class="line">cd &#x2F;usr&#x2F;share&#x2F;grafana&#x2F;public</span><br><span class="line">mkdir css</span><br><span class="line">cd css</span><br><span class="line">mkdir theme-options</span><br><span class="line">pwd</span><br><span class="line">&#x2F;usr&#x2F;share&#x2F;grafana&#x2F;public&#x2F;css</span><br><span class="line"></span><br><span class="line">&#x2F;usr&#x2F;share&#x2F;grafana&#x2F;public&#x2F;css目录作为存放基础css的目录</span><br><span class="line"></span><br><span class="line">&#x2F;usr&#x2F;share&#x2F;grafana&#x2F;public&#x2F;css&#x2F;theme-options是存放主题样式的目录</span><br></pre></td></tr></table></figure>

<p>2.<strong>在上述github上找到<a href="https://github.com/GilbN/theme.park/blob/master/css/base/grafana/grafana-base.css">grafana-base.css</a>和<a href="https://github.com/GilbN/theme.park/blob/master/css/defaults/transparent.css">transparent.css</a></strong></p>
<p>说明：</p>
<p>grafana-base.css文件在css/base/grafana目录下</p>
<p>transparent.css文件在css/defaults目录下</p>
<p>3.<strong>将上述两个文件下载到/usr/share/grafana/public/css目录下</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><a href="https://imgloc.com/i/isOI5y"><img src="https://i.328888.xyz/2023/04/25/isOI5y.png" alt="isOI5y.png"></a></p>
<p>4.<strong>在grafana-base.css文件引入transparent.css文件</strong></p>
<p><strong>编辑grafana-base.css，在文件顶部添加@import url(“transparent.css”);</strong>,以相对路径引入transparent.css</p>
<p><img src="https://i.328888.xyz/2023/04/25/isO5XN.png" alt="isO5XN.png"></p>
<p>5.<strong>下载主题样式文件</strong></p>
<p>将github上css/theme-options中所有css文件下载到/usr/share/grafana/public/css/theme-options目录</p>
<p><a href="https://imgloc.com/i/isbpFw"><img src="https://i.328888.xyz/2023/04/25/isbpFw.png" alt="isbpFw.png"></a></p>
<p>6.<strong>为样式css文件引入grafana-base.css</strong></p>
<p><strong>theme-options目录中所有的css文件头部添加@import url(“../grafana-base.css”);</strong>,以相对路径引入grafana-base.css</p>
<p><a href="https://imgloc.com/i/isbPfP"><img src="https://i.328888.xyz/2023/04/25/isbPfP.png" alt="isbPfP.png"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@import url(“..&#x2F;grafana-base.css”);</span><br></pre></td></tr></table></figure>

<p>然后重启grafana</p>
<p><strong>启用主题</strong></p>
<p><strong>登录grafana &gt; + &gt; dashboard</strong></p>
<p><img src="https://i.328888.xyz/2023/04/25/isbYwc.png" alt="isbYwc.png"></p>
<p><strong>创建panel</strong></p>
<p><a href="https://imgloc.com/i/isjitN"><img src="https://i.328888.xyz/2023/04/25/isjitN.png" alt="isjitN.png"></a></p>
<p><strong>panel &gt; visualization &gt; boom panel &gt; themes &gt; Add New Theme</strong></p>
<p><a href="https://imgloc.com/i/isjA8q"><img src="https://i.328888.xyz/2023/04/25/isjA8q.png" alt="isjA8q.png"></a></p>
<p><strong>主题参数</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;192.168.224.11:3000&#x2F;public&#x2F;css&#x2F;theme-options&#x2F;aquamarine.css</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\HUAWEI\AppData\Roaming\Typora\typora-user-images\image-20230425183804946.png" alt="image-20230425183804946"></p>
<p><strong>设置默认主题</strong></p>
<p><a href="https://imgloc.com/i/isjxut"><img src="https://i.328888.xyz/2023/04/25/isjxut.png" alt="isjxut.png"></a></p>
<h5 id="dashboard模板导入"><a href="#dashboard模板导入" class="headerlink" title="dashboard模板导入"></a><strong>dashboard模板导入</strong></h5><p>对于常用的服务监控，例如主机节点监控，elasticsearch等等常见的服务，grafana官方有已经建好的dashboard面板模板，只要去grafana官网导入模板即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">常用dashboard模板地址： https:&#x2F;&#x2F;grafana.com&#x2F;grafana&#x2F;dashboards&#x2F;</span><br></pre></td></tr></table></figure>

<p>例如：要为prometheus监控elasticsearch导入一个dashboard模板</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">模板搜索</span><br><span class="line">datasource 选择prometheus</span><br></pre></td></tr></table></figure>

<p><a href="https://imgloc.com/i/isjSNb"><img src="https://i.328888.xyz/2023/04/25/isjSNb.png" alt="isjSNb.png"></a></p>
<p><strong>Copy模板id</strong></p>
<p>注意：你要导入的dashboard模板要与自己安装的elasticsearch_exporter插件要匹配，不然数据可能不会展示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">下载地址</span><br><span class="line">wget https:&#x2F;&#x2F;github.com&#x2F;prometheus-community&#x2F;elasticsearch_exporter&#x2F;releases&#x2F;download&#x2F;v1.5.0&#x2F;elasticsearch_exporter-1.5.0.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">加入后台启动，</span><br><span class="line">vim &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;elasticsearch_exporter.service  </span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;elasticsearch_exporter</span><br><span class="line">After&#x3D;syslog.target network.target</span><br><span class="line">[Service]</span><br><span class="line">Type&#x3D;simple</span><br><span class="line">RemainAfterExit&#x3D;no</span><br><span class="line">WorkingDirectory&#x3D;&#x2F;usr&#x2F;local&#x2F;elasticsearch_exporter&#x2F;</span><br><span class="line">User&#x3D;root</span><br><span class="line">Group&#x3D;root</span><br><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;local&#x2F;elasticsearch_exporter&#x2F;elasticsearch_exporter  --es.all --es.indices --es.cluster_settings --es.node&#x3D;&quot;daily_test&quot; --es.indices_settings --es.shards --es.snapshots --es.timeout&#x3D;5s --web.listen-address &quot;:9114&quot; --web.telemetry-path &quot;&#x2F;metrics&quot; --es.ssl-skip-verify --es.clusterinfo.interval&#x3D;5m --es.uri http:&#x2F;&#x2F;localhost:9200</span><br><span class="line">Restart&#x3D;always</span><br><span class="line">RestartSec&#x3D;5</span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br></pre></td></tr></table></figure>



<p><a href="https://imgloc.com/i/isjuZy"><img src="https://i.328888.xyz/2023/04/25/isjuZy.png" alt="isjuZy.png"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">6483</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\HUAWEI\AppData\Roaming\Typora\typora-user-images\image-20230425185217606.png" alt="image-20230425185217606"></p>
<p>粘贴模板id到load栏</p>
<p><a href="https://imgloc.com/i/is88rd"><img src="https://i.328888.xyz/2023/04/25/is88rd.png" alt="is88rd.png"></a></p>
<p>同样可以添加其他node_exporter模板</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ID是： 1860</span><br><span class="line"></span><br><span class="line">nginx监控的模板ID 9614</span><br></pre></td></tr></table></figure>





<h4 id="pagerduty的使用"><a href="#pagerduty的使用" class="headerlink" title="pagerduty的使用"></a>pagerduty的使用</h4><p>pagerduty 注册新账号(免费试用14天)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;signup.pagerduty.com&#x2F;accounts&#x2F;new</span><br><span class="line"></span><br><span class="line">参考步骤，现在需要企业邮箱账号才可以注册</span><br><span class="line">https:&#x2F;&#x2F;help.aliyun.com&#x2F;document_detail&#x2F;266641.html</span><br></pre></td></tr></table></figure>

<p>创建<strong>New Service</strong>之后把new service’s interation key 复制到grafana平台<strong>notification_channel</strong>中，就完成了grafana+pagerduty的连接。</p>
<p>然后设置一下pagerduty给用户发送报警信息</p>
<p>回到Pagerduty的主页面，找到设置里的users选项卡。</p>
<p><a href="https://imgloc.com/i/ioYXjJ"><img src="https://i.328888.xyz/2023/04/25/ioYXjJ.png" alt="ioYXjJ.png"></a></p>
<p>然后点击个人信息，进行相关设置</p>
<p><a href="https://imgloc.com/i/ioYFnd"><img src="https://i.328888.xyz/2023/04/25/ioYFnd.png" alt="ioYFnd.png"></a></p>
<p>之后就可以正式开始使用了，</p>
<p>在企业中使用的时候，把所有需要接收报警信息的员工手机号，邮箱地址同时都设置上，这样一来，每一次发送报警，所有被加入的员工就都会收到了。</p>
</div><ul class="post-copyright"><li><strong>本文标题：</strong><a href="https://yc6.cool/2023/04/28/Prometheus搭建部署/">Prometheus搭建部署</a></li><li><strong>本文作者：</strong><a href="https://yc6.cool">yichen</a></li><li><strong>本文链接：</strong><a href="https://yc6.cool/2023/04/28/Prometheus搭建部署/">https://yc6.cool/2023/04/28/Prometheus搭建部署/</a></li><li><strong>版权声明：</strong><span>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明出处！</span></li></ul><div><div class="recommend-post"><span class="is-size-6 has-text-grey has-mr-7"># 相关文章</span><br><span>  1.<a class="is-size-6" href="/2023/05/10/Prometheus%E4%BD%BF%E7%94%A8%E6%89%8B%E6%9C%BA%E7%94%B5%E8%AF%9D_%E7%9F%AD%E4%BF%A1%E6%8E%A5%E6%94%B6%E5%91%8A%E8%AD%A6%E9%80%9A%E7%9F%A5/" target="_blank">Prometheus使用手机电话_短信接收告警通知</a><br></span><span>  2.<a class="is-size-6" href="/2023/05/10/Prometheus%E4%BD%BF%E7%94%A8%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%8E%A5%E6%94%B6%E5%91%8A%E8%AD%A6%E9%80%9A%E7%9F%A5/" target="_blank">Prometheus使用企业微信接收告警通知</a><br></span><span>  3.<a class="is-size-6" href="/2023/05/10/Prometheus%E4%BD%BF%E7%94%A8%E4%BC%81%E4%B8%9A%E9%92%89%E9%92%89%E5%91%8A%E8%AD%A6%E9%80%9A%E7%9F%A5/" target="_blank">Prometheus使用企业钉钉接收告警通知</a><br></span><span>  4.<a class="is-size-6" href="/2023/05/10/Prometheus%E4%BD%BF%E7%94%A8%E9%82%AE%E7%AE%B1%E6%8E%A5%E6%94%B6%E5%91%8A%E8%AD%A6%E9%80%9A%E7%9F%A5/" target="_blank">Prometheus使用邮件接收告警通知</a><br></span><span>  5.<a class="is-size-6" href="/2023/05/09/%E5%9F%BA%E4%BA%8E_Consul_%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0/" target="_blank">Prometheus基于Consul服务发现</a><br></span><span>  6.<a class="is-size-6" href="/2023/05/09/%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0&amp;%E5%9F%BA%E4%BA%8E%E6%96%87%E4%BB%B6%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0/" target="_blank">Prometheus服务发现</a><br></span><span>  7.<a class="is-size-6" href="/2023/05/08/Prometheus%E7%9B%91%E6%8E%A7domain%E5%9F%9F%E5%90%8D/" target="_blank">Prometheus监控domain域名</a><br></span><span>  8.<a class="is-size-6" href="/2023/05/08/pushgateway/" target="_blank">Prometheus的Pushgateway工具</a><br></span></div><div class="recommend-post"><span class="is-size-6 has-text-grey has-mr-7"># 推荐文章</span><br><span>  1.<a class="is-size-6" href="/2020/08/04/docker%E4%BD%BF%E7%94%A8/" target="_blank">docker的使用</a><br></span><span>  2.<a class="is-size-6" href="/2020/08/03/mysql%E5%9F%BA%E7%A1%80/" target="_blank">mysql基础</a><br></span><span>  3.<a class="is-size-6" href="/2020/08/03/nginx%E5%9F%BA%E7%A1%80/" target="_blank">nginx基础</a><br></span><span>  4.<a class="is-size-6" href="/2020/08/04/python3%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E9%87%8D%E7%82%B9/" target="_blank">python3基础知识重点</a><br></span><span>  5.<a class="is-size-6" href="/2023/05/07/Linux%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%B3%BB%E7%BB%9F%E7%9B%91%E6%8E%A7/" target="_blank">Prometheus监控linux</a><br></span><span>  6.<a class="is-size-6" href="/2023/05/10/Prometheus%E4%BD%BF%E7%94%A8%E9%82%AE%E7%AE%B1%E6%8E%A5%E6%94%B6%E5%91%8A%E8%AD%A6%E9%80%9A%E7%9F%A5/" target="_blank">Prometheus使用邮件接收告警通知</a><br></span></div></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/css/share.min.css"><div class="social-share"></div><script src="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button is-info donate"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="https://yichenxiu.com/tupian/tubiao/alipay1.jpg" alt="支付宝"></span></a><a class="button is-success donate"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="https://i.328888.xyz/2023/03/05/dZXCk.jpeg" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2023/05/07/Prometheus%E7%9B%91%E6%8E%A7nginx,redis,mysql%E7%AD%89/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Prometheus监控nginx,redis,rabbitmq,mongodb,docker等</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2023/04/26/Prometheus%E7%9A%84docker%E9%83%A8%E7%BD%B2/"><span class="level-item">Prometheus的docker部署搭建</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/gitalk/1.6.0/gitalk.css"><script> $.getScript('/js/gitalk.min.js', function () { 
            var gitalk = new Gitalk({
            language:'zh-CN',
            id: '009fc7c98b286c2ad3d5f7355d3a59ca',
            repo: 'issue_database',
            owner: 'zhi666',
            clientID: '1b861f81e9a79ee6028d',
            clientSecret: 'cc629aff090aa9c60d5e13ddf7fcfce14f00a478',
            admin: ["zhi666"],
            createIssueManually: true,
            distractionFreeMode: true,
            perPage: 10,
            pagerDirection: 'last',
            proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token',
            
            enableHotKey: true,
            isLocked: false
        })
        gitalk.render('comment-container')});</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1 is-sticky"><div class="card widget toc-scroll" id="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list toc"><li><a class="is-flex toc-item" id="toc-item-Prometheus搭建部署" href="#Prometheus搭建部署"><span>Prometheus搭建部署</span></a><ul class="menu-list toc"><ul class="menu-list toc"><li><a class="is-flex toc-item" id="toc-item-10-安装blackbox-exporter" href="#10-安装blackbox-exporter"><span>10.安装blackbox_exporter</span></a></li><li><a class="is-flex toc-item" id="toc-item-3-安装node-exporter" href="#3-安装node-exporter"><span>3.安装node_exporter</span></a></li><li><a class="is-flex toc-item" id="toc-item-pagerduty的使用" href="#pagerduty的使用"><span>pagerduty的使用</span></a></li></ul></ul></li></ul></div></div><script type="text/javascript" async>
        $(document).ready(function () { //参考自 https://github.com/ppoffice/hexo-theme-icarus/pull/616/files
            var observerTopMargin;
            var scrollObserver;
            var headerElems = $(".headerlink");
            var activeTocItem;
        
            function initIntersectionObserver(docHeight) {
                observerTopMargin = docHeight;
                scrollObserver = new IntersectionObserver(scrollCallBack,
                    {
                        root: null,  // viewpoint
                        rootMargin: docHeight + "px 0px -80% 0px"  // cover top 30% of viewport to the top of document
                    })
            }
        
            function scrollCallBack(entries, observer) {
                if ($(window).scrollTop() > observerTopMargin * 0.7) { 
                    // User somehow scroll to 70% of observerTopMargin (which is inited as 200% document height)
                    // Observer top margin need to extend to cover all the space to the top of the document
                    initIntersectionObserver(observerTopMargin * 2)
                    observer.disconnect();
                    return;
                }
                let toActive;
                if (entries[0].intersectionRatio == 1) {  // enter viewed area
                    let entry = entries.reduce((u, v) => (u.target.toc_id > v.target.toc_id ? u : v));  // get the lowest item
                    toActive = $("#toc-item-" + $(entry.target).attr("href").substr(1));
                } else {
                    let entry = entries.reduce((u, v) => (u.target.toc_id < v.target.toc_id ? u : v));  // get the highest item
                    let idx = Math.max(entry.target.toc_id - 1, 0);
                    toActive = $("#toc-item-" + $(headerElems[idx]).attr("href").substr(1));
                }
                if (activeTocItem) activeTocItem.removeClass("is-current");
                activeTocItem = toActive
                activeTocItem.addClass("is-current");
            }
        
            initIntersectionObserver($(document).height() * 2);
            headerElems.each(function (index, obj) {
                obj.toc_id = index;
                scrollObserver.observe(obj);
            })
        });</script></div><div class="card widget"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="is-rounded" src="/img/toudong.jpg" alt="逸尘秀"></figure><p class="title is-size-4 is-block line-height-inherit">逸尘秀</p><p class="is-size-6 is-block">只此一生 ， 必须快乐 ！</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>深圳</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">136</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">17</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">55</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://weibo.com/u/6155656382" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-white is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/zhi666"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-white is-marginless" target="_blank" rel="noopener" title="Weibo" href="https://weibo.com/u/6155656382"><i class="fab fa-weibo"></i></a><a class="level-item button is-transparent is-white is-marginless" target="_blank" rel="noopener" title="Email" href="mailto:1378373724@qq.com"><i class="fa fa-envelope"></i></a><a class="level-item button is-transparent is-white is-marginless" target="_blank" rel="noopener" title="Next" href="https://zhi666.github.io/remove.io"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-white is-marginless" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a></div><div><hr><p id="hitokoto">:D 一言句子获取中...</p><script type="text/javascript" defer>function getYiyan(){
                                $.getJSON("https://v1.hitokoto.cn/", function (data) {
                                if(data){
                                    $('#hitokoto').html("");
                                    $('#hitokoto').append("<strong style='color: #3273dc;'>"+data.hitokoto+"</strong>"+
                                    "<p>"+"来源《"+data.from+"》</p><p>提供者-"+data.creator+"</p>");
                                }});}
                                $(function (){getYiyan();$('#hitokoto').click(function(){getYiyan();})});</script></div></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新评论</h3><span class="body_hot_comment">加载中，最新评论有1分钟缓存...</span></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content size-small"><p><time dateTime="2023-11-01T02:25:44.578Z">2023-11-01</time></p><p class="title is-6"><a class="link-muted" href="/2023/11/01/selenlium%E6%89%B9%E9%87%8F%E6%B7%BB%E5%8A%A0dns%E5%9F%9F%E5%90%8D/">批量添加dns域名解析</a></p><p class="is-uppercase"><i class="fas fa-folder-open has-text-grey"> </i><a class="link-muted" href="/categories/python/">python</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2023-05-17T01:45:36.000Z">2023-05-17</time></p><p class="title is-6"><a class="link-muted" href="/2023/05/17/Kubernetes%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2/">Kubernetes高可用集群二进制部署</a></p><p class="is-uppercase"><i class="fas fa-folder-open has-text-grey"> </i><a class="link-muted" href="/categories/linux3/">linux3</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2023-05-10T06:25:36.000Z">2023-05-10</time></p><p class="title is-6"><a class="link-muted" href="/2023/05/10/Prometheus%E4%BD%BF%E7%94%A8%E6%89%8B%E6%9C%BA%E7%94%B5%E8%AF%9D_%E7%9F%AD%E4%BF%A1%E6%8E%A5%E6%94%B6%E5%91%8A%E8%AD%A6%E9%80%9A%E7%9F%A5/">Prometheus使用手机电话_短信接收告警通知</a></p><p class="is-uppercase"><i class="fas fa-folder-open has-text-grey"> </i><a class="link-muted" href="/categories/linux2/">linux2</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2023-05-10T06:22:36.000Z">2023-05-10</time></p><p class="title is-6"><a class="link-muted" href="/2023/05/10/Prometheus%E4%BD%BF%E7%94%A8%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%8E%A5%E6%94%B6%E5%91%8A%E8%AD%A6%E9%80%9A%E7%9F%A5/">Prometheus使用企业微信接收告警通知</a></p><p class="is-uppercase"><i class="fas fa-folder-open has-text-grey"> </i><a class="link-muted" href="/categories/linux2/">linux2</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2023-05-10T06:20:36.000Z">2023-05-10</time></p><p class="title is-6"><a class="link-muted" href="/2023/05/10/Prometheus%E4%BD%BF%E7%94%A8%E4%BC%81%E4%B8%9A%E9%92%89%E9%92%89%E5%91%8A%E8%AD%A6%E9%80%9A%E7%9F%A5/">Prometheus使用企业钉钉接收告警通知</a></p><p class="is-uppercase"><i class="fas fa-folder-open has-text-grey"> </i><a class="link-muted" href="/categories/linux2/">linux2</a></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/English/"><span class="level-start"><span class="level-item">English</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/HTML/"><span class="level-start"><span class="level-item">HTML</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/JS/"><span class="level-start"><span class="level-item">JS</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/html/"><span class="level-start"><span class="level-item">html</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/linux1/"><span class="level-start"><span class="level-item">linux1</span></span><span class="level-end"><span class="level-item tag">15</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/linux2/"><span class="level-start"><span class="level-item">linux2</span></span><span class="level-end"><span class="level-item tag">33</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/linux3/"><span class="level-start"><span class="level-item">linux3</span></span><span class="level-end"><span class="level-item tag">27</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/python/"><span class="level-start"><span class="level-item">python</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/web/"><span class="level-start"><span class="level-item">web</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/work/"><span class="level-start"><span class="level-item">work</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><a class="level is-mobile is-marginless" href="/categories/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/archives/2023/11/"><span class="level-start"><span class="level-item">十一月 2023</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2023/05/"><span class="level-start"><span class="level-item">五月 2023</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2023/04/"><span class="level-start"><span class="level-item">四月 2023</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2023/02/"><span class="level-start"><span class="level-item">二月 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2022/06/"><span class="level-start"><span class="level-item">六月 2022</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><a class="level is-mobile is-marginless" href="/archives/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/linux/"><span class="tag">linux</span><span class="tag is-grey-lightest">18</span></a></div><div class="control"><a class="tags has-addons" href="/tags/docker/"><span class="tag">docker</span><span class="tag is-grey-lightest">16</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Prometheus/"><span class="tag">Prometheus</span><span class="tag is-grey-lightest">14</span></a></div><div class="control"><a class="tags has-addons" href="/tags/html/"><span class="tag">html</span><span class="tag is-grey-lightest">14</span></a></div><div class="control"><a class="tags has-addons" href="/tags/python/"><span class="tag">python</span><span class="tag is-grey-lightest">12</span></a></div><div class="control"><a class="tags has-addons" href="/tags/web/"><span class="tag">web</span><span class="tag is-grey-lightest">12</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nginx/"><span class="tag">nginx</span><span class="tag is-grey-lightest">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mysql/"><span class="tag">mysql</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%AE%B9%E5%99%A8/"><span class="tag">容器</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"><span class="tag">数据库</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/"><span class="tag">科学上网</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/work/"><span class="tag">work</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%87%AA%E5%8A%A8%E5%8C%96/"><span class="tag">自动化</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8D%9A%E5%AE%A2/"><span class="tag">博客</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%B7%A5%E4%BD%9C/"><span class="tag">工作</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%B7%A5%E5%85%B7/"><span class="tag">工具</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ssl/"><span class="tag">ssl</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/"><span class="tag">文件系统</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%97%A5%E5%BF%97/"><span class="tag">日志</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%97%A5%E5%BF%97%E5%8A%A0%E5%AF%86/"><span class="tag">日志加密</span><span class="tag is-grey-lightest">3</span></a></div></div><div class="field is-grouped is-grouped-multiline"><a class="tags has-addons" href="/tags/"><span class="tag">查看全部&gt;&gt;</span></a></div></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=zhi666FeedsId&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="zhi666FeedsId" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button is-primary" type="submit" value="订阅"></div></div><p class="help">输入邮箱开始订阅，更博后邮件通知！</p></form></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.png" alt="逸尘秀" height="28"></a><p class="size-small"><span>&copy; 2023 yichen</span>  Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a>,Modify by <a href="https://github.com/removeif/hexo-theme-amazing" target="_blank">removeif</a> <br><span>© 版权说明：[本网站所有内容均收集于互联网或自己创作,<br />&nbsp;&nbsp;&nbsp;&nbsp;方便于网友与自己学习交流，如有侵权，请<a href="/message" target="_blank">留言</a>，立即处理]<br /></span><span><span id="statistic-times">loading...</span><script>function createTime(time) {
            var n = new Date(time);
            now.setTime(now.getTime() + 250),
                days = (now - n) / 1e3 / 60 / 60 / 24,
                dnum = Math.floor(days),
                hours = (now - n) / 1e3 / 60 / 60 - 24 * dnum,
                hnum = Math.floor(hours),
            1 == String(hnum).length && (hnum = "0" + hnum),
                minutes = (now - n) / 1e3 / 60 - 1440 * dnum - 60 * hnum,
                mnum = Math.floor(minutes),
            1 == String(mnum).length && (mnum = "0" + mnum),
                seconds = (now - n) / 1e3 - 86400 * dnum - 3600 * hnum - 60 * mnum,
                snum = Math.round(seconds),
            1 == String(snum).length && (snum = "0" + snum),
                document.getElementById("statistic-times").innerHTML = "❤️本站自 <strong>"+time.split(" ")[0].replace(/\//g,".")+"</strong> 已运行 <strong>" + dnum + "</strong> 天 <strong>" + hnum + "</strong> 小时 <strong>" + mnum + "</strong> 分 <strong>" + snum + "</strong> 秒！❤️";
        }var now = new Date();setInterval("createTime('2020/08/02 00:00:00')", 250,"");</script><br></span><div class="size-small"><span>❤️感谢 <strong><span id="busuanzi_value_site_uv">99+</span></strong> 小伙伴的 <strong><span id="busuanzi_value_site_pv">99+</span></strong> 次光临！❤️</span></div></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/zhi666"><i class="fab fa-github"></i></a></p></div><div class="sideMusic"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="/js/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><meting-js style="width: auto;height: 2000px;" server="netease" type="playlist" id="2364053447" theme="#2980b9" loop="all" autoplay="false" order="list" storageName="aplayer-setting" lrctype="0" list-max-height="400px" fixed="true"></meting-js></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            site: {
                url: 'https://yc6.cool',
                external_link: {"enable":true,"exclude":[]}
            },
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" defer></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back-to-top.js" defer></script><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.12/js/lightgallery-all.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer></script><!--!--><!--!--><!--!--><script src="/js/toc.js" defer></script><script src="/js/main.js" defer></script><script>$.getScript('/js/comment-issue-data.js',function(){loadIssueData('1b861f81e9a79ee6028d','cc629aff090aa9c60d5e13ddf7fcfce14f00a478','zhi666','issue_database',false);})</script><link rel="stylesheet" href="/css/insight.css"><div class="searchbox ins-search"><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"><input class="searchbox-input ins-search-input" type="text" placeholder="想要查找什么..."><span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"></div></div></div></div><script>(function (window) {
            var INSIGHT_CONFIG = {
                TRANSLATION: {
                    POSTS: '文章',
                    PAGES: '页面',
                    CATEGORIES: '分类',
                    TAGS: '标签',
                    UNTITLED: '(无标题)',
                },
                CONTENT_URL: '/content.json',
            };
            window.INSIGHT_CONFIG = INSIGHT_CONFIG;
        })(window);</script><script src="/js/insight.js" defer></script></body></html>