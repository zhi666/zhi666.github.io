<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="generator" content="Hexo 4.2.0"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><meta name="keywords" content="[object Object]"><meta name="description" content="haproxy概述haproxy       支持4层，7层负载均衡，反向代理,会话保持，大并发。LVS       稳定，效率高，四层调度。不支持7层的内容分发或过滤。不支持会话保持。nginx       支持七层调度，现在也有开发的新的模块来扩展调度相关的功能。在会话保持，内容分发过滤方面比haproxy相比要差"><meta name="author" content="zhi666"><title>haproxy - 逸尘秀</title><meta description="haproxy概述haproxy       支持4层，7层负载均衡，反向代理,会话保持，大并发。LVS       稳定，效率高，四层调度。不支持7层的内容分发或过滤。不支持会话保持。nginx       支持七层调度，现在也有开发的新的模块来扩展调度相关的功能。在会话保持，内容分发过滤方面比haproxy相比要差"><meta property="og:type" content="article"><meta property="og:title" content="haproxy"><meta property="og:url" content="https://yc6.cool/2020/08/03/haproxy/"><meta property="og:site_name" content="逸尘秀"><meta property="og:description" content="haproxy概述haproxy       支持4层，7层负载均衡，反向代理,会话保持，大并发。LVS       稳定，效率高，四层调度。不支持7层的内容分发或过滤。不支持会话保持。nginx       支持七层调度，现在也有开发的新的模块来扩展调度相关的功能。在会话保持，内容分发过滤方面比haproxy相比要差"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2020-08-03T12:55:36.000Z"><meta property="article:modified_time" content="2023-11-01T02:25:44.560Z"><meta property="article:author" content="zhi666"><meta property="article:tag" content="高可用"><meta property="article:tag" content="负载均衡"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://yc6.cool/img/avatar.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://yc6.cool/2020/08/03/haproxy/"},"headline":"haproxy","image":["https://yc6.cool/img/avatar.png"],"datePublished":"2020-08-03T12:55:36.000Z","dateModified":"2023-11-01T02:25:44.560Z","author":{"@type":"Person","name":"zhi666"},"description":"haproxy概述haproxy       支持4层，7层负载均衡，反向代理,会话保持，大并发。LVS       稳定，效率高，四层调度。不支持7层的内容分发或过滤。不支持会话保持。nginx       支持七层调度，现在也有开发的新的模块来扩展调度相关的功能。在会话保持，内容分发过滤方面比haproxy相比要差"}</script><link rel="alternative" href="/atom.xml" title="逸尘秀" type="application/atom+xml"><link rel="icon" href="/img/favicon.png"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css?family=Ubuntu:400,600|Source+Code+Pro|Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Microsoft YaHei:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&amp;amp;subset=latin,latin-ext|Inconsolata|Itim|Lobster.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/atom-one-dark.min.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.12/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><link rel="stylesheet" href="/css/style.css"><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="/js/globalUtils.js"></script><link rel="stylesheet" href="/live2d/waifu.css"><script type="text/javascript" async src="/live2d/autoload.js"></script></head><body class="is-3-column has-navbar-fixed-top"><nav class="navbar navbar-main is-fixed-top"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.png" alt="逸尘秀" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/media">影音</a><a class="navbar-item" href="/album">相册</a><a class="navbar-item" href="/friend">友链</a><a class="navbar-item" href="/self-talking">碎碎念</a><a class="navbar-item" href="/message">留言</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/zhi666"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a><a class="navbar-item" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon" id="night-icon"></i></a></div></div></div></nav><script type="text/javascript" src="/js/theme-setting.js"></script><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2020-08-03  <a class="commentCountImg" href="/2020/08/03/haproxy/#comment-container"><span class="display-none-class">d45469743a050b25a0ad0e2ecbc116bf</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="d45469743a050b25a0ad0e2ecbc116bf">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>44 分钟  <i class="fas fa-pencil-alt"> </i>6.6 k</span><span class="level-item" id="busuanzi_container_page_pv"><i class="far fa-eye"></i>&nbsp;&nbsp;<span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">haproxy</h1><div class="content"><h2 id="haproxy概述"><a href="#haproxy概述" class="headerlink" title="haproxy概述"></a>haproxy概述</h2><p>haproxy       支持4层，7层负载均衡，反向代理,会话保持，大并发。<br>LVS       稳定，效率高，四层调度。不支持7层的内容分发或过滤。不支持会话保持。<br>nginx       支持七层调度，现在也有开发的新的模块来扩展调度相关的功能。在会话保持，内容分发过滤方面比haproxy相比要差</p>
<a id="more"></a>
<ol>
<li>HAProxy 是一款提供高可用性、负载均衡以及基于TCP（第四层）和HTTP（第七层）应用的代理软件，支持虚拟主机，它是免费、快速并且可靠的一种解决方案。 HAProxy特别适用于那些负载特大的web站点，这些站点通常又需要会话保持或七层处理。HAProxy运行在时下的硬件上，完全可以支持数以万计的 并发连接。并且它的运行模式使得它可以很简单安全的整合进您当前的架构中， 同时可以保护你的web服务器不被暴露到网络上。</li>
<li>HAProxy 实现了一种事件驱动、单一进程模型，此模型支持非常大的并发连接数。多进程或多线程模型受内存限制 、系统调度器限制以及无处不在的锁限制，很少能处理数千并发连接。事件驱动模型因为在有更好的资源和时间管理的用户端(User-Space) 实现所有这些任务，所以没有这些问题。此模型的弊端是，在多核系统上，这些程序通常扩展性较差。这就是为什么他们必须进行优化以 使每个CPU时间片(Cycle)做更多的工作。</li>
<li>HAProxy 支持连接拒绝 : 因为维护一个连接的打开的开销是很低的，有时我们很需要限制攻击蠕虫（attack bots），也就是说限制它们的连接打开从而限制它们的危害。 这个已经为一个陷于小型DDoS攻击的网站开发了而且已经拯救了很多站点，这个优点也是其它负载均衡器没有的。</li>
<li>HAProxy 支持全透明代理（已具备硬件防火墙的典型特点）: 可以用客户端IP地址或者任何其他地址来连接后端服务器. 这个特性仅在Linux 2.4/2.6内核打了cttproxy补丁后才可以使用. 这个特性也使得为某特殊服务器处理部分流量同时又不修改服务器的地址成为可能。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.haproxy.org&#x2F;#docs   #haproxy官方社区</span><br><span class="line">www.haproxy.com</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;cbonte.github.io&#x2F;haproxy-dconv&#x2F;2.1&#x2F;configuration.html#2  #文档配置</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http:&#x2F;&#x2F;www.haproxy.org&#x2F;download&#x2F;2.2&#x2F;src&#x2F;haproxy-2.2.0.tar.gz  #下载源码 这个版本编译会报错。</span><br><span class="line">wget http:&#x2F;&#x2F;www.haproxy.org&#x2F;download&#x2F;1.8&#x2F;src&#x2F;haproxy-1.8.25.tar.gz  #下载稳定版本</span><br></pre></td></tr></table></figure>

<h2 id="开始部署haproxy"><a href="#开始部署haproxy" class="headerlink" title="开始部署haproxy"></a>开始部署haproxy</h2><h2 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">打开IP转发</span><br><span class="line">echo &quot;net.ipv4.ip_forward &#x3D; 1&quot; &gt;&gt; &#x2F;etc&#x2F;sysctl.conf &amp;&amp; sysctl -p</span><br><span class="line"></span><br><span class="line"> 安装依赖</span><br><span class="line">yum install -y gcc gcc-c++ pcre pcre-devel openssl openssl-devel systemd-devel</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">tar xf haproxy-1.8.25.tar.gz #解压</span><br><span class="line">cd haproxy-1.8.25&#x2F;</span><br><span class="line">uname -r   #查询系统内核版本</span><br><span class="line">make TARGET&#x3D;linux31 PREFIX&#x3D;&#x2F;usr&#x2F;local&#x2F;haproxy</span><br><span class="line"></span><br><span class="line">make install PREFIX&#x3D;&#x2F;usr&#x2F;local&#x2F;haproxy</span><br><span class="line"></span><br><span class="line">可执行文件拷贝一份到系统执行文件目录，该目录在path变量里面，可以直接使用haproxy命令</span><br><span class="line">cp &#x2F;usr&#x2F;local&#x2F;haproxy&#x2F;sbin&#x2F;haproxy &#x2F;usr&#x2F;sbin&#x2F;</span><br><span class="line">cp .&#x2F;examples&#x2F;haproxy.init &#x2F;etc&#x2F;init.d&#x2F;haproxy</span><br><span class="line">chmod 755 &#x2F;etc&#x2F;init.d&#x2F;haproxy</span><br><span class="line"></span><br><span class="line">useradd -r haproxy</span><br><span class="line">mkdir &#x2F;etc&#x2F;haproxy</span><br></pre></td></tr></table></figure>

<p>编写配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;haproxy&#x2F;haproxy.cfg</span><br><span class="line"># Global settings</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line">global #全局配置</span><br><span class="line"> log 127.0.0.1 local3 info #指定服务器的日志级别</span><br><span class="line"> chroot &#x2F;usr&#x2F;local&#x2F;haproxy #改变工作目录</span><br><span class="line"> user haproxy #用户组和用户</span><br><span class="line"> group haproxy</span><br><span class="line"> daemon #以守护进程的方式运行</span><br><span class="line"> maxconn 4000 #最大连接数</span><br><span class="line">defaults #默认配置</span><br><span class="line"> log global</span><br><span class="line"> mode http #7层http;4层tcp 如果要让haproxy支持虚拟主机，mode 必须设为http</span><br><span class="line"> option httplog #http日志格式</span><br><span class="line"> timeout connect 5000 #连接超时(毫秒)</span><br><span class="line">        timeout client 50000 #客户端超时(毫秒)</span><br><span class="line">        timeout server 50000 #服务器超时(毫秒)</span><br><span class="line"> listen stats</span><br><span class="line"> mode http</span><br><span class="line"> bind 192.168.224.11:1080</span><br><span class="line"> stats enable             </span><br><span class="line"> stats hide-version</span><br><span class="line"> stats uri &#x2F;stats</span><br><span class="line"> stats admin if TRUE</span><br><span class="line">frontend web_front #前端配置 web_front名称可自定义</span><br><span class="line"> bind 192.168.224.11:80 #发起的http请求到80端口，会转发到设置的ip及端口</span><br><span class="line"> mode http</span><br><span class="line"> log global</span><br><span class="line"> option httplog # 启用http日志</span><br><span class="line">        default_backend http_back</span><br><span class="line">backend http_back #后端配置，http_back名称可自定义</span><br><span class="line"> option httpchk GET &#x2F;index.html #设置健康检查页面</span><br><span class="line"> option forwardfor header X-Forwarded-For #传递客户端真实IP</span><br><span class="line"> balance roundrobin #roundrobin 轮询方式</span><br><span class="line"># 需要转发的ip及端口</span><br><span class="line"> server client2.com 192.168.224.12:80 check inter 2000 rise 3 fall 3 weight 30</span><br><span class="line"> server client3.com 192.168.224.13:80 check inter 2000 rise 3 fall 3 weight 30</span><br><span class="line"> server client4.com 192.168.224.14:80 check inter 2000 rise 3 fall 3 weight 30</span><br></pre></td></tr></table></figure>

<p>日志配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">打开rsyslog配置：</span><br><span class="line">vi &#x2F;etc&#x2F;rsyslog.conf</span><br><span class="line">去掉下面两行前面的#号</span><br><span class="line">$ModLoad imudp</span><br><span class="line">$UDPServerRun 514</span><br><span class="line">并添加下面一行</span><br><span class="line">local3.* &#x2F;var&#x2F;log&#x2F;haproxy.log  </span><br><span class="line">重启rsyslog</span><br><span class="line">systemctl restart rsyslog</span><br></pre></td></tr></table></figure>

<p>启动haproxy</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service haproxy start</span><br></pre></td></tr></table></figure>

<p>代理段配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">defaults &lt;name&gt; #为frontend, backend, listen提供默认配置</span><br><span class="line"> frontend &lt;name&gt; # 前端，相当于nginx, server &#123;&#125;</span><br><span class="line"> backend &lt;name&gt; #后端，相当于nginx, upstream &#123;&#125;</span><br><span class="line"> listen &lt;name&gt;同时拥有前端和后端,适用于一对一环境</span><br><span class="line"> mode http #默认的模式mode &#123; tcp|http|health &#125;，tcp是4层，http是7层，health只会返回OK</span><br><span class="line"> log global #应用全局的日志配置</span><br><span class="line"> option httplog # 启用日志记录HTTP请求，默认haproxy日志记录是不记录HTTP请求日志</span><br><span class="line"> option dontlognull # 启用该项，日志中将不会记录空连接。所谓空连接就是在上游的负载均衡器或者监控系统为了探测该服务是否存活可用时，需要定期的连接或者获取某一固定的组件或页面，或者探测扫描端口是否在监听或开放等动作被称为空连接；官方文档中标注，如果该服务上游没有其他的负载均衡器的话，建议不要使用该参数，因为互联网上的恶意扫描或其他动作就不会被记录下来</span><br><span class="line"> option http-server-close #每次请求完毕后主动关闭http通道</span><br><span class="line"> option forwardfor except 127.0.0.0&#x2F;8 #如果服务器上的应用程序想记录发起请求的客户端的IP地址，需要在HAProxy上配置此选项， 这样 HAProxy会把客户端的IP信息发送给服务器，在HTTP请求中添加&quot;X-Forwarded-For&quot;字段。启用X-Forwarded-For，在requests头部插入客户端IP发送给后端的server，使后端server获取到客户端的真实IP。</span><br><span class="line"> option redispatch #当使用了cookie时，haproxy将会将其请求的后端服务器的serverID插入到cookie中，以保证会话的SESSION持久性；而此时，如果后端的服务器宕掉了， 但是客户端的cookie是不会刷新的，如果设置此参数，将会将客户的请求强制定向到另外一个后端server上，以保证服务的正常。</span><br><span class="line"> retries 3 # 定义连接后端服务器的失败重连次数，连接失败次数超过此值后将会将对应后端服务器标记为不可用</span><br><span class="line"> timeout http-request 10s #http请求超时时间</span><br><span class="line"> timeout queue 1m #一个请求在队列里的超时时间</span><br><span class="line"> timeout connect 10s #连接超时时间</span><br><span class="line"> timeout client 1m #客户端超时时间</span><br><span class="line"> timeout server 1m #服务器端超时时间</span><br><span class="line"> timeout http-keep-alive 10s #设置http-keep-alive的超时时间</span><br><span class="line"> timeout check 10s #检测超时时间</span><br><span class="line"> maxconn 3000 #每个进程可用的最大连接数</span><br><span class="line"> frontend main *:80 #监听地址为80</span><br><span class="line"> acl url_static path_beg -i &#x2F;static &#x2F;images &#x2F;javascript &#x2F;stylesheets</span><br><span class="line"> acl url_static path_end -i .jpg .gif .png .css .js</span><br><span class="line"> use_backend static if url_static</span><br><span class="line"> default_backend my_webserver #定义一个名为my_app前端部分。此处将对应的请求转发给后端</span><br><span class="line"> backend static #使用了静态动态分离（如果url_path匹配 .jpg .gif .png .css .js静态文件则访问此后端）</span><br><span class="line"> balance roundrobin #负载均衡算法（#banlance roundrobin 轮询，balance source 保存session值，支持static-rr，leastconn，first，uri等参数）</span><br><span class="line"> server static 127.0.0.1:80 check #静态文件部署在本机（也可以部署在其他机器或者squid缓存服务器）</span><br><span class="line"> backend my_webserver #定义一个名为my_webserver后端部分。PS：此处my_webserver只是一个自定义名字而已，但是需要与frontend里面配置项default_backend 值相一致</span><br><span class="line"> balance roundrobin #负载均衡算法</span><br><span class="line"> server web01 172.31.2.33:80 check inter 2000 fall 3 weight 30 #定义的多个后端</span><br><span class="line"> server web02 172.31.2.34:80 check inter 2000 fall 3 weight 30 #定义的多个后端</span><br><span class="line"> server web03 172.31.2.35:80 check inter 2000 fall 3 weight 30 #定义的多个后端</span><br></pre></td></tr></table></figure>



<h2 id="haproxy部署方式"><a href="#haproxy部署方式" class="headerlink" title="haproxy部署方式"></a>haproxy部署方式</h2><p>下图中haproxy用了两个网段(这里模拟内外网),实际时也可以只用一个网卡(只有内网网卡),公网IP在前端就可以了.这里尽量用两个内网来做，防止桥接网络IP冲突. </p>
<pre><code>           客户端（宿主机) 192.168.2.x    
             |            
             |    
    外网         |        192.168.2.65
          haproxy   
    内网         |        192.168.224.10
             |               
             |
        web1          web2
    192.168.224.11           192.168.224.12</code></pre>
<p>实验前准备: (centos7.3平台)<br>1，配置主机名和主机名互相绑定</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname --static server.com</span><br><span class="line"></span><br><span class="line">vim &#x2F;etc&#x2F;hosts</span><br><span class="line">192.168.224.10	server.com</span><br><span class="line">192.168.224.11	server1.com</span><br><span class="line">192.168.224.12   server2.com</span><br></pre></td></tr></table></figure>

<p>2,静态ip<br>3,关闭iptables，selinux</p>
<p>第一步：<br>1,客户端准备<br>客户端有firefox和curl就可以了</p>
<p>2,后台web服务器准备　<br>把web1和web2装好httpd，然后启动起来，分别做一个不同内容的主页方便验证<br>web1上做：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install httpd httpd-devel -y</span><br><span class="line">systemctl start httpd</span><br><span class="line">systemctl enable httpd</span><br><span class="line">echo web1 &gt; &#x2F;var&#x2F;www&#x2F;html&#x2F;index.html</span><br></pre></td></tr></table></figure>
<p>web2上做：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install httpd* -y</span><br><span class="line">systemctl start httpd</span><br><span class="line">systemctl enable httpd</span><br><span class="line">echo web2 &gt; &#x2F;var&#x2F;www&#x2F;html&#x2F;index.html</span><br></pre></td></tr></table></figure>

<p>第二步：<br>在haproxy服务器上安装haproxy</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> yum install haproxy -y</span><br><span class="line"></span><br><span class="line">&#x2F;usr&#x2F;share&#x2F;doc&#x2F;haproxy-1.5.18&#x2F;haproxy-en.txt	#参数文档</span><br><span class="line">&#x2F;etc&#x2F;haproxy&#x2F;haproxy.cfg	#主配置文件</span><br></pre></td></tr></table></figure>

<p>第三步:</p>
<p>配置haproxy</p>
<p>配置结构介绍:<br>global<br>    全局配置参数（主要配置服务用户，pid,socket,进程，chroot等)</p>
<p>defaults<br>    负载调度相关的全局配置　（调度模式，调度超时时间，调度算法，健康检查等等。配置在这个段，那么就默认对后面的listen,frontend,backend都生效)</p>
<p>frontend<br>    处理前台接收的请求，可以在这个段配置acl进行七层调度等，指定调到对应的backend<br>backend<br>    最终调度的realserver相关配置</p>
<p>listen (就是frontend和backend的综合体)</p>
<p>先备份</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp &#x2F;etc&#x2F;haproxy&#x2F;haproxy.cfg &#x2F;etc&#x2F;haproxy&#x2F;haproxy.cfg.bak</span><br><span class="line"> grep -v &#39;#&#39; &#x2F;etc&#x2F;haproxy&#x2F;haproxy.cfg	 #下面是我的配置示例（global,defaults都基本没有调整，优化相关参数请参考文档和实际生产环境做调整)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">global</span><br><span class="line">    log         127.0.0.1 local2</span><br><span class="line"></span><br><span class="line">    chroot      &#x2F;var&#x2F;lib&#x2F;haproxy</span><br><span class="line">    pidfile     &#x2F;var&#x2F;run&#x2F;haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon</span><br><span class="line">    </span><br><span class="line">    stats socket &#x2F;var&#x2F;lib&#x2F;haproxy&#x2F;stats</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    mode                    http			#支持7层负载均衡，如果改成tcp就只支持4层负载均衡</span><br><span class="line">    log                     global</span><br><span class="line">    option                  httplog</span><br><span class="line">    option                  dontlognull</span><br><span class="line">    option http-server-close</span><br><span class="line">    option forwardfor       except 127.0.0.0&#x2F;8</span><br><span class="line">    option                  redispatch</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout http-request    10s</span><br><span class="line">    timeout queue           1m</span><br><span class="line">    timeout connect         10s</span><br><span class="line">    timeout client          1m</span><br><span class="line">    timeout server          1m</span><br><span class="line">    timeout http-keep-alive 10s</span><br><span class="line">    timeout check           10s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">listen  192.168.2.65 *:80</span><br><span class="line">        balance roundrobin    #roundrobin 轮询方式</span><br><span class="line">        server server1.com 192.168.224.11:80</span><br><span class="line">        server server2.com 192.168.224.12:80</span><br></pre></td></tr></table></figure>
<p>启动haproxy</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start haproxy</span><br><span class="line">systemctl enable haproxy</span><br></pre></td></tr></table></figure>
<p>客户端　curl 192.168.2.65 测试</p>
<p>把上面的listen配置段改成下面的frontend和backend，效果一样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">frontend  192.168.2.65 *:80</span><br><span class="line">        default_backend webs</span><br><span class="line"></span><br><span class="line">backend webs</span><br><span class="line">	balance roundrobin</span><br><span class="line">        server server1.com 192.168.224.11:80</span><br><span class="line">        server server2.com 192.168.224.12:80</span><br></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart haproxy</span><br><span class="line">systemctl enable haproxy</span><br></pre></td></tr></table></figure>

<p>第四步:<br>客户端　curl 192.168.2.65 测试</p>
<p>结果为rr轮循web1,web2</p>
<p>========================================================================<br>查看haproxy状态页面，<br>实际这个页面显示的内容为haproxy的状态页面，不是后台web的显示内容。下面参数中之所以有两台web服务器，是为了统计web服务器的状态。</p>
<p>#配置文件listen配置段加上stats的四行(将listen替换为下面)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">listen  192.168.2.65 *:80</span><br><span class="line">	stats uri &#x2F;haproxy-stats 	#指定访问的路径	</span><br><span class="line">        stats realm Haproxy\ statistics	#指定统计信息提示</span><br><span class="line">        stats auth name:123		#需要验证的用户名和密码才能登录查看</span><br><span class="line">	stats hide-version		#隐藏客户端访问统计页面时的haproxy版本号</span><br><span class="line">        balance roundrobin   </span><br><span class="line">        server server1.com 192.168.224.11:80</span><br><span class="line">        server server2.com 192.168.224.12:80</span><br><span class="line"></span><br><span class="line">systemctl reload haproxy.service</span><br></pre></td></tr></table></figure>

<p>#客户端使用下面的去访问<br><code>http://192.168.2.65/haproxy-stats</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">输入名字 name</span><br><span class="line">密码    123</span><br></pre></td></tr></table></figure>

<p><img src="https://s1.ax1x.com/2020/08/03/adeQvF.png" alt="adeQvF.png"></p>
<p>或者换成下面的配置，效果一样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">frontend  192.168.2.65 *:80</span><br><span class="line">	  default_backend servers</span><br><span class="line"></span><br><span class="line">backend servers</span><br><span class="line">	stats uri &#x2F;haproxy-stats</span><br><span class="line">        stats realm Haproxy\ statistics</span><br><span class="line">        stats auth li:li123</span><br><span class="line">	stats hide-version	</span><br><span class="line">        balance roundrobin</span><br><span class="line">        server server1.com 192.168.224.11:80</span><br><span class="line">        server server2.com 192.168.224.12:80</span><br></pre></td></tr></table></figure>
<p>-客户端使用下面的去访问<br><code>http://192.168.2.65/haproxy-stats</code></p>
<p>＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝</p>
<h3 id="关于haproxy日志"><a href="#关于haproxy日志" class="headerlink" title="关于haproxy日志"></a>关于haproxy日志</h3><p>vim /etc/rsyslog.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ModLoad imudp</span><br><span class="line">$UDPServerRun 514	#打开这两句的注释，表示udp协议514端口接收远程日志（haproxy日志做到127.0.0.1的本地，也要按远程日志做法来做)</span><br><span class="line"></span><br><span class="line">local2.*      &#x2F;var&#x2F;log&#x2F;haproxy.log	#加上这一句，表示local2日志设备的所有级别日志都会记录到后面的文件路径中(local2是和haproxy里的配置对应的。这条语句加在“$UDPServerRun 514”之后）</span><br><span class="line">local2  指的是 &#x2F;etc&#x2F;haproxy&#x2F;haproxy.cfg 里面 26 行</span><br><span class="line"></span><br><span class="line">systemctl restart rsyslog.service</span><br><span class="line">tail -f &#x2F;var&#x2F;log&#x2F;haproxy.log (默认此文件不存在，但是有用户访问网站，日志文件就开始生成，并开始输出日志)</span><br></pre></td></tr></table></figure>
<p>＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝</p>
<h3 id="haproxy的健康检查功能和日志处理。"><a href="#haproxy的健康检查功能和日志处理。" class="headerlink" title="haproxy的健康检查功能和日志处理。"></a>haproxy的健康检查功能和日志处理。</h3><p> 原理是在指定位置放置文件，如果文件存在则认为服务器是健康，否则认为web服务不可用。</p>
<p>vim /etc/haproxy/haproxy.cfg 替换listen整段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">listen  192.168.2.65 *:80</span><br><span class="line">    stats uri &#x2F;haproxy-stats</span><br><span class="line">        stats realm Haproxy\ statistics</span><br><span class="line">        stats auth li:li123</span><br><span class="line">    stats hide-version</span><br><span class="line">        balance roundrobin</span><br><span class="line">        option forwardfor		#日志forward，让后台web记录客户端的IP，而不是haproxy的IP</span><br><span class="line">        option httpchk HEAD &#x2F;check.txt HTTP&#x2F;1.0	#健康检查功能如果后台web服务器家目录中没有check.txt文件，则表示后台web挂掉；此版本要使用http的1.0版，1.1版还不支持</span><br><span class="line">        server server1.com 192.168.224.11:80 check inter 2000 rise 2 fall 5</span><br><span class="line">        server server2.com 192.168.224.12:80 check inter 2000 rise 2 fall 5	#加上检查的间隔2秒，rise 2, 是2次正确表示服务器可用；fall 5表示5次失败表示服务器不可用</span><br></pre></td></tr></table></figure>


<p>创建健康检查文件<br>On Web1<br>touch /var/www/html/check.txt</p>
<p>On Web2:<br>touch /var/www/html/check.txt</p>
<p>重新加载</p>
<p><code>systemctl reload haproxy </code><br>服务正常<br>curl 192.168.224.10  正常显示</p>
<p>客户端验证健康检查：<br>尝试删除文件/var/www/html/check.txt，然后运行命令 curl 192.168.224.10，观察结果变化.结果为有check.txt文件的则可以被调，没有的就不可以.</p>
<p><strong>日志问题1</strong><br>在web服务器端<br>vim /var/log/httpd/access_log<br>后台web里每２秒都会有一句healthcheck的日志，想删除他，方法如下</p>
<p>方法一:<br>写一个脚本就如下两句，定时去执行一次就可以了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sed -i &#39;&#x2F;check.txt\ HTTP\&#x2F;1.0&#x2F;d&#39; &#x2F;var&#x2F;log&#x2F;httpd&#x2F;access_log </span><br><span class="line">note: sed -i 配合字符串末尾的‘d’，实现删除特定字符串</span><br><span class="line"></span><br><span class="line">kill -HUP &#96;cat &#x2F;var&#x2F;run&#x2F;httpd&#x2F;httpd.pid&#96;   </span><br><span class="line">(sed命令修改access_log会导致文件被httpd进程无法持续写入日志 kill -HUP让httpd重启服务)</span><br><span class="line">(如果想要更改配置而不需停止并重新启动服务，请使用该命令。在对配置文件作必要的更改后，发出该命令以动态更新服务配置)</span><br></pre></td></tr></table></figure>

<p>方法二: (推荐)<br>httpd不记录检测日志:    #健康检查有大量的日志，指定不记录它. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;httpd&#x2F;conf&#x2F;httpd.conf, 搜索&#39;CustomLog&#39;，然后修改。(或者注释217行增加下面2行)</span><br><span class="line"></span><br><span class="line">SetEnvIf Request_URI &quot;^&#x2F;check\.txt$&quot; dontlog</span><br><span class="line">CustomLog logs&#x2F;access_log combined env&#x3D;!dontlog</span><br><span class="line"></span><br><span class="line">只要匹配到请求uri为 check.txt 就不记录日志。</span><br></pre></td></tr></table></figure>
<p>重启后端的web服务器<br>systemctl restart httpd</p>
<p><strong>日志问题２:</strong><br>查看后端web的access.log，客户端的正常访问日志的IP并不是实际客户端IP，而是haproxy的内网IP</p>
<p>解决方法如下：<br>方法一：<br>直接使用前端haproxy的日志</p>
<p>方法二：<br>后端apache日志处理  #为了让access.log显示客户端的IP，而不是haproxy调度器的IP<br>配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;httpd&#x2F;conf&#x2F;httpd.conf                   #196行</span><br><span class="line"></span><br><span class="line">LogFormat &quot;%&#123;X-Forwarded-For&#125;i %l %u %t \&quot;%r\&quot; %&gt;s %b &quot; combined   #加这行  </span><br><span class="line">#把原来的combined条目替换 (或者增加这行)</span><br></pre></td></tr></table></figure>

<p><img src="https://s1.ax1x.com/2020/08/03/ade8b9.png" alt="ade8b9.png"></p>
<p>========================================================================</p>
<h3 id="haproxy会话保持"><a href="#haproxy会话保持" class="headerlink" title="haproxy会话保持"></a>haproxy会话保持</h3><p>1,source算法（类似nginx的ip_hash算法或lvs的sh算法)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">vim &#x2F;etc&#x2F;haproxy&#x2F;haproxy.cfg 替换 listen段</span><br><span class="line"></span><br><span class="line">listen  192.168.2.65 *:80</span><br><span class="line">    stats uri &#x2F;haproxy-stats</span><br><span class="line">        stats realm Haproxy\ statistics</span><br><span class="line">        stats auth li:li123</span><br><span class="line">    stats hide-version</span><br><span class="line">        balance source			  #把roundrobin改为source</span><br><span class="line">        option forwardfor</span><br><span class="line">        option httpchk HEAD &#x2F;check.txt HTTP&#x2F;1.0</span><br><span class="line">        server server1.com 192.168.224.11:80 check inter 2000 rise 2 fall 5</span><br><span class="line">        server server2.com 192.168.224.12:80 check inter 2000 rise 2 fall 5</span><br></pre></td></tr></table></figure>

<p><code>systemctl reload haproxy </code>   #reload后客户端测试<br>测试结果为一个客户端的请求会转发到同一个web服务器上。（亲缘性保持）</p>
<p>2,使用cookie(对浏览器有效，对elinks无效）</p>
<p>vim /etc/haproxy/haproxy.cfg</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">listen  192.168.2.65 *:80</span><br><span class="line">    stats uri &#x2F;haproxy-stats</span><br><span class="line">        stats realm Haproxy\ statistics</span><br><span class="line">        stats auth li:li123</span><br><span class="line">    stats hide-version</span><br><span class="line">        balance roundrobin</span><br><span class="line">        option forwardfor</span><br><span class="line">        option httpchk HEAD &#x2F;check.txt HTTP&#x2F;1.0</span><br><span class="line">        cookie web_cookie insert nocache     #web_cookie为名称；当客户端和HAProxy之间存在缓存时，建议将insert配合nocache一起使用</span><br><span class="line">        server server1.com 192.168.224.11:80 cookie web1 check inter 2000 rise 2 fall 5</span><br><span class="line">        server server2.com 192.168.224.12:80 cookie web2 check inter 2000 rise 2 fall 5	 web1和 web2为后端web的cookie名称，不要一样</span><br></pre></td></tr></table></figure>

<p>systemctl reload haproxy  reload后客户端测试<br>测试结果为：使用浏览器访问可以保持亲缘性会话，但是用curl工具则无法保持，因为curl不支持session</p>
<p>3,利用haproxy内置的<code>stick table</code> 来实现会话保持。<br><code>stick table</code> 是haproxy的一个非常优秀的特性，这个表里面存储的是stickiness记录，stickiness记录了客户端和服务端1:1对应的引用关系。通过这个关系，haproxy可以将客户端的请求引导到之前为它服务过的后端服务器上，也就是实现了会话保持的功能。这种记录方式，俗称会话粘性(stickiness)，即将客户端和服务端粘连起来。</p>
<p>stick table中使用key/value的方式映射客户端和后端服务器，key是客户端的标识符，可以使用客户端的源ip(50字节)、cookie以及从报文中过滤出来的部分String。value部分是服务端的标识符。</p>
<p>由于每条stickiness记录占用空间都很小(平均最小50字节，最大166字节，由是否记录额外统计数据以及记录多少来决定占用空间大小)，使得即使在非常繁忙的环境下多个节点之间推送都不会出现压力瓶颈和网络阻塞(可以按节点数量、stickiness记录的大小和平均并发量来计算每秒在网络间推送的数据流量)。</p>
<p>它不像被人诟病的session复制(copy)，因为session复制的数据量比较大，而且是在各应用程序服务器之间进行的。而一个稍大一点的核心应用，提供服务的应用程序服务器数量都不会小，这样复制起来很容出现网络阻塞。</p>
<p>此外，<code>stick table</code> 还可以在haproxy重启时，在同一个机器内新旧两个进程间进行复制，这是本地复制。当haproxy重启时，旧haproxy进程会和新haproxy进程建立TCP连接，将其维护的<code>stick table</code> 推送给新进程。这样新进程不会丢失粘性信息，和其他节点也能最大程度地保持同步，使得其他节点只需要推送该节点重启过程中新增加的stickiness记录就能完全保持同步。</p>
<p>vim /etc/haproxy/haproxy.cfg    (替换listen块)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">listen  192.168.2.65 *:80</span><br><span class="line">	stick-table type ip size 1m expire 1m</span><br><span class="line">        stick on src         #以源ip为key进行粘贴，size 1m表示能记录100W条，1分钟没请求粘贴过期					</span><br><span class="line">        stats uri &#x2F;haproxy-stats</span><br><span class="line">        stats realm Haproxy\ statistics</span><br><span class="line">        stats auth li:li123</span><br><span class="line">        stats hide-version</span><br><span class="line">    balance roundrobin</span><br><span class="line">        option forwardfor</span><br><span class="line">        option httpchk HEAD &#x2F;check.txt HTTP&#x2F;1.0</span><br><span class="line">        server server1.com 192.168.224.11:80 check inter 2000 rise 2 fall 5</span><br><span class="line">        server server2.com 192.168.224.12:80 check inter 2000 rise 2 fall 5</span><br></pre></td></tr></table></figure>
<p><code>systemctl reload haproxy </code>   重新加载后客户端测试<br>注意：这里最好用listen格式写，用frontend,backend格式写的话，以源ip为key的参数不生效。</p>
<p>验证：<br>无论使用Curl还是浏览器都可以保持亲缘性会话。</p>
<p>第二次做实验用frontend,backend格式写，以源ip为key的参数可以生效。测试时间(2020-7-13)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">frontend  192.168.224.10 *:80</span><br><span class="line">         fefault_backend servers</span><br><span class="line"></span><br><span class="line">backend servers</span><br><span class="line">        stick-table type ip size 1m expire 1m</span><br><span class="line">        stick on src</span><br><span class="line"></span><br><span class="line">        stats uri &#x2F;haproxy-stats</span><br><span class="line">        stats realm Haproxy\ statistics</span><br><span class="line">        stats auth li:li123</span><br><span class="line">        stats hide-version</span><br><span class="line"></span><br><span class="line">        balance roundrobin</span><br><span class="line">        option forwardfor</span><br><span class="line">        option httpchk HEAD &#x2F;check.txt HTTP&#x2F;1.0</span><br><span class="line">        server server1.com 192.168.224.11:80  check inter 2000 rise 2 fall 5</span><br><span class="line">        server server2.com 192.168.224.12:80  check inter 2000 rise 2 fall 5</span><br><span class="line"></span><br><span class="line">listen statspage           # 定义监控管理接口的界面</span><br><span class="line">    bind *:8888            # 定义访问页面端口</span><br><span class="line">    stats enable           # 启用管理界面</span><br><span class="line">    stats hide-version     # 隐藏版本</span><br><span class="line">    stats uri &#x2F;admin?stats    # 访问路径</span><br><span class="line">    stats auth li:li123    # 访问时需要验证登录</span><br><span class="line">    stats admin if TRUE    # 如果登录成功就可以管理在线服务器</span><br></pre></td></tr></table></figure>



<p>==============================================================</p>
<h3 id="使用haproxy做动静分离或网站数据切分（七层调度"><a href="#使用haproxy做动静分离或网站数据切分（七层调度" class="headerlink" title="使用haproxy做动静分离或网站数据切分（七层调度)"></a>使用haproxy做动静分离或网站数据切分（七层调度)</h3><p><strong>通过HAProxy的ACL规则实现智能负载均衡</strong></p>
<p>**由于HAProxy可以工作在七层模型下， 因此，要实现HAProxy的强大功能，一定要使用强大灵活的ACL规则，通过ACL规则可以实现基于HAProxy的智能负载均衡系统。HAProxy通过ACL规则完成两种主要的功能，分别是：<br>**</p>
<p>1）通过设置的ACL规则检查客户端请求是否合法。如果符合ACL规则要求，那么就将放行，反正，如果不符合规则，则直接中断请求。</p>
<p>2）符合ACL规则要求的请求将被提交到后端的backend服务器集群，进而实现基于ACL规则的负载均衡。</p>
<p>HAProxy中的ACL规则经常使用在frontend段中，使用方法如下：</p>
<p>acl 自定义的acl名称 acl方法 -i [匹配的路径或文件]</p>
<p>其中：</p>
<p>acl：是一个关键字，表示定义ACL规则的开始。后面需要跟上自定义的ACL名称 。</p>
<p>acl方法:这个字段用来定义实现ACL的方法，HAProxy定义了很多ACL方法，经常使用的方法有hdr_reg(host)、hdr_dom(host)、hdr_beg(host)、url_sub、url_dir、path_beg、path_end等。</p>
<p>-i：表示忽略大小写，后面需要跟上匹配的路径或文件或正则表达式。</p>
<p>与ACL规则一起使用的HAProxy参数还有use_backend，use_backend后面需要跟上一个backend实例名，表示在满足ACL规则后去请求哪个backend实例，与use_backend对应的还有default_backend参数，它表示在没有满足ACL条件的时候默认使用哪个后端backend。</p>
<p>下面列举几个常见的ACL规则例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">acl www_policy hdr_reg(host) -i ^(www.z.cn|z.cn)</span><br><span class="line"></span><br><span class="line">acl bbs_policy hdr_dom(host) -i bbs.z.cn</span><br><span class="line"></span><br><span class="line">acl url_policy url_sub -i buy_sid&#x3D;</span><br><span class="line"></span><br><span class="line">use_backend server_wwwifwww_policy</span><br><span class="line"></span><br><span class="line">use_backend server_appifurl_policy</span><br><span class="line"></span><br><span class="line">use_backend server_bbsifbbs_policy</span><br><span class="line"></span><br><span class="line">default_backend server_cache</span><br></pre></td></tr></table></figure>

<p>一个动静分离的例子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">acl url_static path_beg -i &#x2F;data&#x2F;static&#x2F;images&#x2F;javascript&#x2F;stylesheets #url开头为这些的静态内容</span><br><span class="line"></span><br><span class="line">acl url_static path_end -i .jpg .gif .png .css .js .html .ico #url结尾带为这些的静态内容</span><br><span class="line"></span><br><span class="line">use_backend staser if url_static #如果静态内容符合url_static的条件，就调度到staser中的服务器</span><br><span class="line"></span><br><span class="line">default_backend      dyser  #其他默认调度到dyser中的服务器</span><br></pre></td></tr></table></figure>



<p>实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;haproxy&#x2F;haproxy.cfg    (替换listen块)</span><br><span class="line"></span><br><span class="line">frontend 192.168.2.65 *:80</span><br><span class="line">   # acl invalid_src src 192.168.2.x    #如果你要拒绝它访问，就把注释打开   </span><br><span class="line">      block if invalid_src </span><br><span class="line"></span><br><span class="line">      acl url_static path_end .html .png .jpg .css .js      #url_static相当于变量名   		#path_end表示以什么结束的文件，表示以.html .png .jpg .css .js 结尾的uri 都是url_static</span><br><span class="line">     </span><br><span class="line">        use_backend static if url_static          #static 为自定义名，</span><br><span class="line">        # usr_backend表示使用backend服务，if表示如果满足url_static这个条件就调度到static这台服务器上也就是server1.com  </span><br><span class="line">       default_backend dynamic                       #dynamic  为自定义名 其他类型转发给dynamic </span><br><span class="line"></span><br><span class="line">backend static  # 定义调用后端的静态页面的服务器上</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server server1.com 192.168.224.11:80 check inter 2000 rise 2 fall 5</span><br><span class="line">	    </span><br><span class="line">backend dynamic</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server server2.com 192.168.224.12:80 check inter 2000 rise 2 fall 5</span><br></pre></td></tr></table></figure>
<p><img src="https://s1.ax1x.com/2020/08/03/adea8K.png" alt="adea8K.png"></p>
<p> <code>systemctl restart haproxy</code> </p>
<p>测试结果：<br>    .html .png .jpg .css .js 被认为是静态文件，都会转发到 224.11, 其他类型的文件请求都会被转发到224.12<br>测试方法：<br>    在web服务器上建立.txt类型的文件测试是否请求会被转发到224.12. 也可以请求不存在的文件，haproxy仍然会将请求转发到后台web。通过查看后台web日志可以判定请求被转发到了那个web. web日志查看命令： tail -f /var/log/httpd/access_log</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">echo web1-html &gt; &#x2F;var&#x2F;www&#x2F;html&#x2F;1.html</span><br><span class="line">echo web1-txt &gt; &#x2F;var&#x2F;www&#x2F;html&#x2F;1.txt</span><br><span class="line"></span><br><span class="line">echo web2-html &gt; &#x2F;var&#x2F;www&#x2F;html&#x2F;1.html</span><br><span class="line">echo web2-txt &gt; &#x2F;var&#x2F;www&#x2F;html&#x2F;1.txt</span><br><span class="line"></span><br><span class="line">curl 192.168.224.10&#x2F;1.html</span><br><span class="line">web1-html</span><br><span class="line">curl 192.168.224.10&#x2F;1.txt</span><br><span class="line">web2-txt</span><br></pre></td></tr></table></figure>



<h3 id="实现网站切分"><a href="#实现网站切分" class="headerlink" title="实现网站切分"></a>实现网站切分</h3><p> vim /etc/haproxy/haproxy.cfg    (替换listen块)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">frontend 192.168.2.65 *:80</span><br><span class="line">	acl url_static  path_beg    &#x2F;static &#x2F;images &#x2F;img  </span><br><span class="line">    acl url_static  path_end .html .png .jpg .css .js         #url_static相当于变量名</span><br><span class="line">    </span><br><span class="line">    acl host_static hdr_beg(host) -i img. video. download.    #host_static相当于变量名</span><br><span class="line">    acl host_www    hdr_beg(host) -i www       #定义ACL名称为host_www,对应的请求的主机头是www</span><br><span class="line"></span><br><span class="line">  use_backend static if url_static               #满足条件就调度到static中的服务器中</span><br><span class="line">  use_backend static if host_static    #主机头包含host_static定义的内容就调度到static中             </span><br><span class="line">  use_backend dynamic if host_www </span><br><span class="line"></span><br><span class="line">backend static                                              #定义static服务器。</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server server1.com 192.168.224.11:80 check inter 2000 rise 2 fall 5</span><br><span class="line"></span><br><span class="line">backend dynamic</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server server2.com 192.168.224.12:80 check inter 2000 rise 2 fall 5</span><br></pre></td></tr></table></figure>



<p>在客户端编辑hosts</p>
<p>vim /etc/hosts</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">192.168.2.65    www.abc.com</span><br><span class="line">192.168.2.65    img.abc.com</span><br></pre></td></tr></table></figure>
<p>测试结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;www.abc.com                  -&gt; Web2</span><br><span class="line">curl http:&#x2F;&#x2F;www.abc.com&#x2F;static&#x2F;abc.abc   -&gt; Web1</span><br><span class="line">curl http:&#x2F;&#x2F;192.168.2.65&#x2F;1.html          -&gt; Web1</span><br><span class="line">curl http:&#x2F;&#x2F;img.abc.com&#x2F;static&#x2F;abc.abc   -&gt; Web1</span><br></pre></td></tr></table></figure>

<p>重点：<br><code>http://www.abc.com</code>  因为是www开头，所以定义为动态内容<br><code>http://www.abc.com/static/abc.abc </code> 尽管/www开头，但是由web1处理，</p>
<p>如果URL同时命中了多条ACL规则，那URL结尾所访问的文件类型优先级别最高</p>
<p>Lvs, Haproxy, Nginx这几种软件的特点。</p>
<p>squid,,nginx cache可以做缓存加速</p>
<p>开源负载均衡<br>nginx<br>harpoxy<br>lvs</p>
<p>lvs  四层<br>nginx,haproxy  七层</p>
<p>抗并发   lvs &gt;  haproxy  &gt; nginx<br>应用范围 lvs最广<br>网络复杂度 lvs复杂<br>会话保持  haproxy会话保持的方式较多<br>负载均衡算法   lvs最多</p>
<p>========================================================================</p>
</div><ul class="post-copyright"><li><strong>本文标题：</strong><a href="https://yc6.cool/2020/08/03/haproxy/">haproxy</a></li><li><strong>本文作者：</strong><a href="https://yc6.cool">yichen</a></li><li><strong>本文链接：</strong><a href="https://yc6.cool/2020/08/03/haproxy/">https://yc6.cool/2020/08/03/haproxy/</a></li><li><strong>版权声明：</strong><span>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明出处！</span></li></ul><div><div class="recommend-post"><span class="is-size-6 has-text-grey has-mr-7"># 相关文章</span><br><span>  1.<a class="is-size-6" href="/2023/05/17/Kubernetes%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2/" target="_blank">Kubernetes高可用集群二进制部署</a><br></span><span>  2.<a class="is-size-6" href="/2022/03/12/openresty%E7%BB%93%E5%90%88lua%E5%AF%B9%E5%90%8C%E4%B8%80%E6%9D%A1%E5%9F%9F%E5%90%8D%E5%88%A4%E6%96%AD%E5%8F%82%E6%95%B0%E5%81%9A%E8%B4%9F%E8%BD%BD/" target="_blank">openresty结合lua对域名参数做负载均衡</a><br></span><span>  3.<a class="is-size-6" href="/2021/07/31/nginx%E5%88%A4%E6%96%AD%E5%BE%AE%E4%BF%A1%E7%AB%AF%E8%B7%B3%E8%BD%AC%E4%B8%8D%E5%90%8C%E9%A1%B5%E9%9D%A2/" target="_blank">nginx判断微信端跳转不同页面</a><br></span><span>  4.<a class="is-size-6" href="/2020/09/30/nftables/" target="_blank">nftables</a><br></span><span>  5.<a class="is-size-6" href="/2020/08/04/k8s%E4%B8%ADYAML%E6%96%87%E4%BB%B6%E7%BC%96%E5%86%99%E4%B8%8E%E4%BD%BF%E7%94%A8/" target="_blank">k8s中yaml文件编写与使用</a><br></span><span>  6.<a class="is-size-6" href="/2020/08/04/k8s%E6%90%AD%E5%BB%BA/" target="_blank">kubernetes搭建</a><br></span><span>  7.<a class="is-size-6" href="/2020/08/04/%E5%88%9B%E5%BB%BAcentos%E9%95%9C%E5%83%8F%E6%94%AF%E6%8C%81ssh/" target="_blank">创建centos镜像支持ssh远程连接</a><br></span><span>  8.<a class="is-size-6" href="/2020/08/04/docker%E4%B8%80%E9%94%AE%E5%AE%89%E8%A3%85%E9%85%B7Q%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BAQQ%E6%9C%BA%E5%99%A8%E4%BA%BA/" target="_blank">docke一键安装酷Q搭建个人QQ机器人</a><br></span></div><div class="recommend-post"><span class="is-size-6 has-text-grey has-mr-7"># 推荐文章</span><br><span>  1.<a class="is-size-6" href="/2020/08/04/docker%E4%BD%BF%E7%94%A8/" target="_blank">docker的使用</a><br></span><span>  2.<a class="is-size-6" href="/2020/08/03/mysql%E5%9F%BA%E7%A1%80/" target="_blank">mysql基础</a><br></span><span>  3.<a class="is-size-6" href="/2020/08/03/nginx%E5%9F%BA%E7%A1%80/" target="_blank">nginx基础</a><br></span><span>  4.<a class="is-size-6" href="/2020/08/04/python3%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E9%87%8D%E7%82%B9/" target="_blank">python3基础知识重点</a><br></span><span>  5.<a class="is-size-6" href="/2023/05/07/Linux%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%B3%BB%E7%BB%9F%E7%9B%91%E6%8E%A7/" target="_blank">Prometheus监控linux</a><br></span><span>  6.<a class="is-size-6" href="/2023/05/10/Prometheus%E4%BD%BF%E7%94%A8%E9%82%AE%E7%AE%B1%E6%8E%A5%E6%94%B6%E5%91%8A%E8%AD%A6%E9%80%9A%E7%9F%A5/" target="_blank">Prometheus使用邮件接收告警通知</a><br></span></div></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/css/share.min.css"><div class="social-share"></div><script src="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button is-info donate"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="https://yichenxiu.com/tupian/tubiao/alipay1.jpg" alt="支付宝"></span></a><a class="button is-success donate"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="https://i.328888.xyz/2023/03/05/dZXCk.jpeg" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/08/03/lvs-ipvsadm%E5%9B%9B%E5%B1%82%E6%95%88%E7%8E%87%E9%AB%98/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">lvs-ipvsadm调度</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/08/03/keepalived%E9%AB%98%E5%8F%AF%E7%94%A8%E4%B8%BB%E5%A4%87/"><span class="level-item">keepalived高可用主备</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/gitalk/1.6.0/gitalk.css"><script> $.getScript('/js/gitalk.min.js', function () { 
            var gitalk = new Gitalk({
            language:'zh-CN',
            id: 'd45469743a050b25a0ad0e2ecbc116bf',
            repo: 'issue_database',
            owner: 'zhi666',
            clientID: '1b861f81e9a79ee6028d',
            clientSecret: 'cc629aff090aa9c60d5e13ddf7fcfce14f00a478',
            admin: ["zhi666"],
            createIssueManually: true,
            distractionFreeMode: true,
            perPage: 10,
            pagerDirection: 'last',
            proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token',
            
            enableHotKey: true,
            isLocked: false
        })
        gitalk.render('comment-container')});</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1 is-sticky"><!--!--><div class="card widget"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="is-rounded" src="/img/toudong.jpg" alt="逸尘秀"></figure><p class="title is-size-4 is-block line-height-inherit">逸尘秀</p><p class="is-size-6 is-block">只此一生 ， 必须快乐 ！</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>深圳</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">136</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">17</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">55</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://weibo.com/u/6155656382" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-white is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/zhi666"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-white is-marginless" target="_blank" rel="noopener" title="Weibo" href="https://weibo.com/u/6155656382"><i class="fab fa-weibo"></i></a><a class="level-item button is-transparent is-white is-marginless" target="_blank" rel="noopener" title="Email" href="mailto:1378373724@qq.com"><i class="fa fa-envelope"></i></a><a class="level-item button is-transparent is-white is-marginless" target="_blank" rel="noopener" title="Next" href="https://zhi666.github.io/remove.io"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-white is-marginless" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a></div><div><hr><p id="hitokoto">:D 一言句子获取中...</p><script type="text/javascript" defer>function getYiyan(){
                                $.getJSON("https://v1.hitokoto.cn/", function (data) {
                                if(data){
                                    $('#hitokoto').html("");
                                    $('#hitokoto').append("<strong style='color: #3273dc;'>"+data.hitokoto+"</strong>"+
                                    "<p>"+"来源《"+data.from+"》</p><p>提供者-"+data.creator+"</p>");
                                }});}
                                $(function (){getYiyan();$('#hitokoto').click(function(){getYiyan();})});</script></div></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新评论</h3><span class="body_hot_comment">加载中，最新评论有1分钟缓存...</span></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content size-small"><p><time dateTime="2023-11-01T02:25:44.578Z">2023-11-01</time></p><p class="title is-6"><a class="link-muted" href="/2023/11/01/selenlium%E6%89%B9%E9%87%8F%E6%B7%BB%E5%8A%A0dns%E5%9F%9F%E5%90%8D/">批量添加dns域名解析</a></p><p class="is-uppercase"><i class="fas fa-folder-open has-text-grey"> </i><a class="link-muted" href="/categories/python/">python</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2023-05-17T01:45:36.000Z">2023-05-17</time></p><p class="title is-6"><a class="link-muted" href="/2023/05/17/Kubernetes%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2/">Kubernetes高可用集群二进制部署</a></p><p class="is-uppercase"><i class="fas fa-folder-open has-text-grey"> </i><a class="link-muted" href="/categories/linux3/">linux3</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2023-05-10T06:25:36.000Z">2023-05-10</time></p><p class="title is-6"><a class="link-muted" href="/2023/05/10/Prometheus%E4%BD%BF%E7%94%A8%E6%89%8B%E6%9C%BA%E7%94%B5%E8%AF%9D_%E7%9F%AD%E4%BF%A1%E6%8E%A5%E6%94%B6%E5%91%8A%E8%AD%A6%E9%80%9A%E7%9F%A5/">Prometheus使用手机电话_短信接收告警通知</a></p><p class="is-uppercase"><i class="fas fa-folder-open has-text-grey"> </i><a class="link-muted" href="/categories/linux2/">linux2</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2023-05-10T06:22:36.000Z">2023-05-10</time></p><p class="title is-6"><a class="link-muted" href="/2023/05/10/Prometheus%E4%BD%BF%E7%94%A8%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%8E%A5%E6%94%B6%E5%91%8A%E8%AD%A6%E9%80%9A%E7%9F%A5/">Prometheus使用企业微信接收告警通知</a></p><p class="is-uppercase"><i class="fas fa-folder-open has-text-grey"> </i><a class="link-muted" href="/categories/linux2/">linux2</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2023-05-10T06:20:36.000Z">2023-05-10</time></p><p class="title is-6"><a class="link-muted" href="/2023/05/10/Prometheus%E4%BD%BF%E7%94%A8%E4%BC%81%E4%B8%9A%E9%92%89%E9%92%89%E5%91%8A%E8%AD%A6%E9%80%9A%E7%9F%A5/">Prometheus使用企业钉钉接收告警通知</a></p><p class="is-uppercase"><i class="fas fa-folder-open has-text-grey"> </i><a class="link-muted" href="/categories/linux2/">linux2</a></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/English/"><span class="level-start"><span class="level-item">English</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/HTML/"><span class="level-start"><span class="level-item">HTML</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/JS/"><span class="level-start"><span class="level-item">JS</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/html/"><span class="level-start"><span class="level-item">html</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/linux1/"><span class="level-start"><span class="level-item">linux1</span></span><span class="level-end"><span class="level-item tag">15</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/linux2/"><span class="level-start"><span class="level-item">linux2</span></span><span class="level-end"><span class="level-item tag">33</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/linux3/"><span class="level-start"><span class="level-item">linux3</span></span><span class="level-end"><span class="level-item tag">27</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/python/"><span class="level-start"><span class="level-item">python</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/web/"><span class="level-start"><span class="level-item">web</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/work/"><span class="level-start"><span class="level-item">work</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><a class="level is-mobile is-marginless" href="/categories/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/archives/2023/11/"><span class="level-start"><span class="level-item">十一月 2023</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2023/05/"><span class="level-start"><span class="level-item">五月 2023</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2023/04/"><span class="level-start"><span class="level-item">四月 2023</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2023/02/"><span class="level-start"><span class="level-item">二月 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2022/06/"><span class="level-start"><span class="level-item">六月 2022</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><a class="level is-mobile is-marginless" href="/archives/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/linux/"><span class="tag">linux</span><span class="tag is-grey-lightest">18</span></a></div><div class="control"><a class="tags has-addons" href="/tags/docker/"><span class="tag">docker</span><span class="tag is-grey-lightest">16</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Prometheus/"><span class="tag">Prometheus</span><span class="tag is-grey-lightest">14</span></a></div><div class="control"><a class="tags has-addons" href="/tags/html/"><span class="tag">html</span><span class="tag is-grey-lightest">14</span></a></div><div class="control"><a class="tags has-addons" href="/tags/python/"><span class="tag">python</span><span class="tag is-grey-lightest">12</span></a></div><div class="control"><a class="tags has-addons" href="/tags/web/"><span class="tag">web</span><span class="tag is-grey-lightest">12</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nginx/"><span class="tag">nginx</span><span class="tag is-grey-lightest">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mysql/"><span class="tag">mysql</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%AE%B9%E5%99%A8/"><span class="tag">容器</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"><span class="tag">数据库</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/"><span class="tag">科学上网</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/work/"><span class="tag">work</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%87%AA%E5%8A%A8%E5%8C%96/"><span class="tag">自动化</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8D%9A%E5%AE%A2/"><span class="tag">博客</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%B7%A5%E4%BD%9C/"><span class="tag">工作</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%B7%A5%E5%85%B7/"><span class="tag">工具</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ssl/"><span class="tag">ssl</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/"><span class="tag">文件系统</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%97%A5%E5%BF%97/"><span class="tag">日志</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%97%A5%E5%BF%97%E5%8A%A0%E5%AF%86/"><span class="tag">日志加密</span><span class="tag is-grey-lightest">3</span></a></div></div><div class="field is-grouped is-grouped-multiline"><a class="tags has-addons" href="/tags/"><span class="tag">查看全部&gt;&gt;</span></a></div></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=zhi666FeedsId&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="zhi666FeedsId" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button is-primary" type="submit" value="订阅"></div></div><p class="help">输入邮箱开始订阅，更博后邮件通知！</p></form></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.png" alt="逸尘秀" height="28"></a><p class="size-small"><span>&copy; 2023 yichen</span>  Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a>,Modify by <a href="https://github.com/removeif/hexo-theme-amazing" target="_blank">removeif</a> <br><span>© 版权说明：[本网站所有内容均收集于互联网或自己创作,<br />&nbsp;&nbsp;&nbsp;&nbsp;方便于网友与自己学习交流，如有侵权，请<a href="/message" target="_blank">留言</a>，立即处理]<br /></span><span><span id="statistic-times">loading...</span><script>function createTime(time) {
            var n = new Date(time);
            now.setTime(now.getTime() + 250),
                days = (now - n) / 1e3 / 60 / 60 / 24,
                dnum = Math.floor(days),
                hours = (now - n) / 1e3 / 60 / 60 - 24 * dnum,
                hnum = Math.floor(hours),
            1 == String(hnum).length && (hnum = "0" + hnum),
                minutes = (now - n) / 1e3 / 60 - 1440 * dnum - 60 * hnum,
                mnum = Math.floor(minutes),
            1 == String(mnum).length && (mnum = "0" + mnum),
                seconds = (now - n) / 1e3 - 86400 * dnum - 3600 * hnum - 60 * mnum,
                snum = Math.round(seconds),
            1 == String(snum).length && (snum = "0" + snum),
                document.getElementById("statistic-times").innerHTML = "❤️本站自 <strong>"+time.split(" ")[0].replace(/\//g,".")+"</strong> 已运行 <strong>" + dnum + "</strong> 天 <strong>" + hnum + "</strong> 小时 <strong>" + mnum + "</strong> 分 <strong>" + snum + "</strong> 秒！❤️";
        }var now = new Date();setInterval("createTime('2020/08/02 00:00:00')", 250,"");</script><br></span><div class="size-small"><span>❤️感谢 <strong><span id="busuanzi_value_site_uv">99+</span></strong> 小伙伴的 <strong><span id="busuanzi_value_site_pv">99+</span></strong> 次光临！❤️</span></div></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/zhi666"><i class="fab fa-github"></i></a></p></div><div class="sideMusic"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="/js/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><meting-js style="width: auto;height: 2000px;" server="netease" type="playlist" id="2364053447" theme="#2980b9" loop="all" autoplay="false" order="list" storageName="aplayer-setting" lrctype="0" list-max-height="400px" fixed="true"></meting-js></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            site: {
                url: 'https://yc6.cool',
                external_link: {"enable":true,"exclude":[]}
            },
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" defer></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back-to-top.js" defer></script><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.12/js/lightgallery-all.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer></script><!--!--><!--!--><!--!--><script src="/js/toc.js" defer></script><script src="/js/main.js" defer></script><script>$.getScript('/js/comment-issue-data.js',function(){loadIssueData('1b861f81e9a79ee6028d','cc629aff090aa9c60d5e13ddf7fcfce14f00a478','zhi666','issue_database',false);})</script><link rel="stylesheet" href="/css/insight.css"><div class="searchbox ins-search"><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"><input class="searchbox-input ins-search-input" type="text" placeholder="想要查找什么..."><span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"></div></div></div></div><script>(function (window) {
            var INSIGHT_CONFIG = {
                TRANSLATION: {
                    POSTS: '文章',
                    PAGES: '页面',
                    CATEGORIES: '分类',
                    TAGS: '标签',
                    UNTITLED: '(无标题)',
                },
                CONTENT_URL: '/content.json',
            };
            window.INSIGHT_CONFIG = INSIGHT_CONFIG;
        })(window);</script><script src="/js/insight.js" defer></script></body></html>