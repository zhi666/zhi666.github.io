<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="generator" content="Hexo 4.2.0"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><meta name="keywords" content="[object Object]"><meta name="description" content="nginx基础1"><meta name="author" content="zhi666"><title>nginx基础 - 逸尘秀</title><meta description="nginx基础1"><meta property="og:type" content="article"><meta property="og:title" content="nginx基础"><meta property="og:url" content="https://yc6.cool/2020/08/03/nginx%E5%9F%BA%E7%A1%80/"><meta property="og:site_name" content="逸尘秀"><meta property="og:description" content="nginx基础1"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2020-08-03T12:15:36.000Z"><meta property="article:modified_time" content="2023-11-01T02:25:44.575Z"><meta property="article:author" content="zhi666"><meta property="article:tag" content="web"><meta property="article:tag" content="nginx"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://yc6.cool/img/avatar.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://yc6.cool/2020/08/03/nginx%E5%9F%BA%E7%A1%80/"},"headline":"nginx基础","image":["https://yc6.cool/img/avatar.png"],"datePublished":"2020-08-03T12:15:36.000Z","dateModified":"2023-11-01T02:25:44.575Z","author":{"@type":"Person","name":"zhi666"},"description":"nginx基础1"}</script><link rel="alternative" href="/atom.xml" title="逸尘秀" type="application/atom+xml"><link rel="icon" href="/img/favicon.png"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css?family=Ubuntu:400,600|Source+Code+Pro|Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Microsoft YaHei:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&amp;amp;subset=latin,latin-ext|Inconsolata|Itim|Lobster.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/atom-one-dark.min.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.12/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><link rel="stylesheet" href="/css/style.css"><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="/js/globalUtils.js"></script><link rel="stylesheet" href="/live2d/waifu.css"><script type="text/javascript" async src="/live2d/autoload.js"></script></head><body class="is-3-column has-navbar-fixed-top"><nav class="navbar navbar-main is-fixed-top"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.png" alt="逸尘秀" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/media">影音</a><a class="navbar-item" href="/album">相册</a><a class="navbar-item" href="/friend">友链</a><a class="navbar-item" href="/self-talking">碎碎念</a><a class="navbar-item" href="/message">留言</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/zhi666"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a><a class="navbar-item" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon" id="night-icon"></i></a></div></div></div></nav><script type="text/javascript" src="/js/theme-setting.js"></script><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><div style="color: #3273dc;font-size: 1.8rem;"><i class="fas fa-arrow-alt-circle-up"></i> </div><i class="far fa-calendar-plus"> </i>2020-08-03  <a class="commentCountImg" href="/2020/08/03/nginx%E5%9F%BA%E7%A1%80/#comment-container"><span class="display-none-class">5d0a937847be41559b1297d8a075ec38</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="5d0a937847be41559b1297d8a075ec38">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>2 小时  <i class="fas fa-pencil-alt"> </i>14.2 k</span><span class="level-item" id="busuanzi_container_page_pv"><i class="far fa-eye"></i>&nbsp;&nbsp;<span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">nginx基础</h1><div class="content"><h1 id="一-nginx基础"><a href="#一-nginx基础" class="headerlink" title="一.nginx基础"></a>一.nginx基础</h1><h2 id="1-nginx安装"><a href="#1-nginx安装" class="headerlink" title="1.nginx安装"></a><strong>1.nginx安装</strong></h2><p>nginx的官网安装文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;nginx.org&#x2F;en&#x2F;linux_packages.html#RHEL-CentOS</span><br></pre></td></tr></table></figure>

<a id="more"></a>
<p><strong>0.yum安装</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">yum install -y epel-release             &#x2F;&#x2F;安装扩展源</span><br><span class="line">yum install -y nginx</span><br><span class="line"></span><br><span class="line">查看nginx安装过程执行了哪些操作。</span><br><span class="line">rpm -q --scripts nginx-filesystem  </span><br><span class="line"></span><br><span class="line">查看nginx生成了哪些文件</span><br><span class="line"> rpm -ql nginx</span><br></pre></td></tr></table></figure>

<p>除了上面之外，还可以自定义源，这样的话安装nginx的版本比上面更新</p>
<p><strong>1.搭建yum仓库安装</strong></p>
<p><strong>安装相关yum工具</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y yum-utils</span><br></pre></td></tr></table></figure>

<p>配置yum源</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;yum.repos.d&#x2F;nginx.repo</span><br><span class="line"></span><br><span class="line">[nginx-stable]</span><br><span class="line">name&#x3D;nginx stable repo</span><br><span class="line">baseurl&#x3D;http:&#x2F;&#x2F;nginx.org&#x2F;packages&#x2F;centos&#x2F;$releasever&#x2F;$basearch&#x2F;</span><br><span class="line">gpgcheck&#x3D;1</span><br><span class="line">enabled&#x3D;1</span><br><span class="line">gpgkey&#x3D;https:&#x2F;&#x2F;nginx.org&#x2F;keys&#x2F;nginx_signing.key</span><br><span class="line">module_hotfixes&#x3D;true</span><br><span class="line"></span><br><span class="line">[nginx-mainline]</span><br><span class="line">name&#x3D;nginx mainline repo</span><br><span class="line">baseurl&#x3D;http:&#x2F;&#x2F;nginx.org&#x2F;packages&#x2F;mainline&#x2F;centos&#x2F;$releasever&#x2F;$basearch&#x2F;</span><br><span class="line">gpgcheck&#x3D;1</span><br><span class="line">enabled&#x3D;0</span><br><span class="line">gpgkey&#x3D;https:&#x2F;&#x2F;nginx.org&#x2F;keys&#x2F;nginx_signing.key</span><br><span class="line">module_hotfixes&#x3D;true</span><br></pre></td></tr></table></figure>

<p>//如果有epel源则先要禁用，否则冲突</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">如果这个变量识别不了的话是缺少软件包，</span><br><span class="line">$releasever</span><br><span class="line">下载就可以了</span><br><span class="line">yum install centos-release</span><br></pre></td></tr></table></figure>



<p>清除yum缓存和重新加载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum clean all</span><br><span class="line"></span><br><span class="line">yum makecache fast</span><br></pre></td></tr></table></figure>



<p>默认情况下，使用稳定的nginx软件包的存储库。如果要使用主线nginx软件包，请运行以下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum-config-manager --enable nginx-mainline</span><br></pre></td></tr></table></figure>

<p>开始安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install nginx</span><br></pre></td></tr></table></figure>

<p><strong>2.源码安装</strong></p>
<p>编译安装nginx来定制自己的模块,首先安装缺少的依赖包：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install gcc gcc-c++ make libtool zlib zlib-devel openssl openssl-devel pcre pcre-devel</span><br></pre></td></tr></table></figure>

<p>下载源码包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;usr&#x2F;local&#x2F;src&#x2F;</span><br><span class="line">wget http:&#x2F;&#x2F;nginx.org&#x2F;download&#x2F;nginx-1.18.0.tar.gz</span><br><span class="line">解压</span><br><span class="line">tar zxf nginx-1.18.0.tar.gz</span><br></pre></td></tr></table></figure>

<p>为了后续准备我们另外下载2个插件模块：<a href="https://github.com/yaoweibin/nginx_upstream_check_module/releases">nginx_upstream_check_module-0.3.0.tar.gz</a> —— 检查后端服务器的状态，<a href="https://bitbucket.org/nginx-goodies/nginx-sticky-module-ng/downloads">nginx-goodies-nginx-sticky-module-ng-bd312d586752.tar.gz</a>（建议在/usr/local/src下解压后将目录重命名为<code>nginx-sticky-module-ng-1.2.6</code>） —— 后端做负载均衡解决session sticky问题（与upstream_check模块结合使用需要另外打补丁）。</p>
<p>请注意插件与nginx的版本兼容问题，一般插件越新越好，nginx不用追新，稳定第一。nginx-1.4.7，nginx-sticky-module-1.1，nginx_upstream_check_module-0.2.0，这个搭配也没问题。sticky-1.1与nginx-1.6版本由于更新没跟上编译出错。（可以直接使用Tengine，默认就包括了这些模块）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">下载nginx-upstream_check_module模块</span><br><span class="line">wget https:&#x2F;&#x2F;github.com&#x2F;yaoweibin&#x2F;nginx_upstream_check_module&#x2F;archive&#x2F;v0.3.0.tar.gz</span><br><span class="line">tar xzf v0.3.0.tar.gz</span><br><span class="line"></span><br><span class="line">下载nginx-goodies-nginx-sticky模块</span><br><span class="line">wget https:&#x2F;&#x2F;bitbucket.org&#x2F;nginx-goodies&#x2F;nginx-sticky-module-ng&#x2F;get&#x2F;1.2.6.tar.gz</span><br><span class="line"></span><br><span class="line">tar zxf 1.2.6.tar.gz</span><br><span class="line">mv nginx-goodies-nginx-sticky-module-ng-c78b7dd79d0d nginx-sticky-module-ng-1.2.6</span><br></pre></td></tr></table></figure>

<p><img src="https://s1.ax1x.com/2020/08/03/adi8YD.png" alt="adi8YD.png"></p>
<p>开始初始化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cd nginx-1.18.0&#x2F;</span><br><span class="line"></span><br><span class="line">.&#x2F;configure --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx       &#x2F;&#x2F;如果有报错，yum安装pcre-devel和zlib-devel</span><br><span class="line">上面这种是最简单的编译安装</span><br><span class="line"></span><br><span class="line">其他的</span><br><span class="line">创建运行用户、组</span><br><span class="line">useradd -M -s &#x2F;sbin&#x2F;nologin nginx</span><br><span class="line"></span><br><span class="line">.&#x2F;configure --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx-1.8 --user&#x3D;nginx --group&#x3D;nginx --with-pcre --with-http_stub_status_module --with-http_ssl_module --with-http_gzip_static_module --with-http_realip_module --add-module&#x3D;..&#x2F;nginx_upstream_check_module-0.3.0</span><br></pre></td></tr></table></figure>

<p>初始化完成会出现下面的结果</p>
<p><img src="https://s1.ax1x.com/2020/08/03/aditld.png" alt="aditld.png"></p>
<p>开始安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<p>安装成功/usr/local/就会有nginx目录</p>
<p><strong>2.2 常用编译选项说明</strong></p>
<p>nginx大部分常用模块，编译时<code>./configure --help</code>以<code>--without</code>开头的都默认安装。</p>
<ul>
<li><code>--prefix=PATH</code> ： 指定nginx的安装目录。默认 <code>/usr/local/nginx</code></li>
<li><code>--conf-path=PATH</code> ： 设置nginx.conf配置文件的路径。nginx允许使用不同的配置文件启动，通过命令行中的-c选项。默认为<em>prefix/conf/nginx.conf</em></li>
<li><code>--user=name</code>： 设置nginx工作进程的用户。安装完成后，可以随时在nginx.conf配置文件更改user指令。默认的用户名是nobody。<code>--group=name</code>类似</li>
<li><code>--with-pcre</code> ： 设置PCRE库的源码路径，如果已通过yum方式安装，使用<code>--with-pcre</code>自动找到库文件。使用<code>--with-pcre=PATH</code>时，需要从PCRE网站下载pcre库的源码（版本4.4 – 8.30）并解压，剩下的就交给Nginx的<code>./configure</code>和<code>make</code>来完成。perl正则表达式使用在<code>location</code>指令和 <code>ngx_http_rewrite_module</code>模块中。</li>
<li><code>--with-zlib=PATH</code> ： 指定 zlib（版本1.1.3 – 1.2.5）的源码解压目录。在默认就启用的网络传输压缩模块<code>ngx_http_gzip_module</code>时需要使用zlib 。</li>
<li><code>--with-http_ssl_module</code> ： 使用https协议模块。默认情况下，该模块没有被构建。前提是openssl与openssl-devel已安装</li>
<li><code>--with-http_stub_status_module</code> ： 用来监控 Nginx 的当前状态</li>
<li><code>--with-http_realip_module</code> ： 通过这个模块允许我们改变客户端请求头中客户端IP地址值(例如X-Real-IP 或 X-Forwarded-For)，意义在于能够使得后台服务器记录原始客户端的IP地址</li>
<li><code>--add-module=PATH</code> ： 添加第三方外部模块，如nginx-sticky-module-ng或缓存模块。每次添加新的模块都要重新编译（Tengine可以在新加入module时无需重新编译）</li>
</ul>
<p><strong>为主程序设置环境变量</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;profile</span><br><span class="line">在末尾添加</span><br><span class="line">export PATH&#x3D;$PATH:&#x2F;usr&#x2F;local&#x2F;nginx-1.8&#x2F;sbin&#x2F;</span><br><span class="line">保存退出</span><br><span class="line"></span><br><span class="line">source &#x2F;etc&#x2F;profile</span><br><span class="line"></span><br><span class="line">或者直接添加软连接也可以</span><br><span class="line">ln -s &#x2F;usr&#x2F;local&#x2F;nginx-1.8&#x2F;sbin&#x2F;nginx &#x2F;usr&#x2F;local&#x2F;sbin&#x2F;nginx</span><br></pre></td></tr></table></figure>

<p><strong>nginx启动相关命令</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">nginx -h 查看所有命令帮助</span><br><span class="line"></span><br><span class="line">检测配置文件是否正确</span><br><span class="line">nginx -t </span><br><span class="line"></span><br><span class="line">查看编译的选项或版本</span><br><span class="line">nginx -V </span><br><span class="line"></span><br><span class="line">启动关闭或重新加载</span><br><span class="line">nginx </span><br><span class="line"></span><br><span class="line">nginx -s stop </span><br><span class="line">nginx -s reload</span><br><span class="line"></span><br><span class="line">-s signal —向 主进程发送信号。参数信号可以是以下之一：</span><br><span class="line">stop —快速关闭</span><br><span class="line">quit —正常关闭</span><br><span class="line">reload —重新加载配置，使用新配置启动新工作进程，并正常关闭旧工作进程。</span><br><span class="line">reopen —重新打开日志文件</span><br><span class="line"></span><br><span class="line">把这个日子文件重新分隔 &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;access.log</span><br><span class="line">mv access.log access.log.bak</span><br><span class="line">再新建access.log </span><br><span class="line">touch access.log </span><br><span class="line">这时候需要执行下reopen命令</span><br><span class="line">nginx -s reopen</span><br></pre></td></tr></table></figure>

<p>查看nginx是否启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -aux |grep nginx</span><br></pre></td></tr></table></figure>

<p><img src="https://s1.ax1x.com/2020/08/03/adidmt.png" alt="adidmt.png"></p>
<p><strong>通过信号量控制nginx</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">官方文档</span><br><span class="line">http:&#x2F;&#x2F;nginx.org&#x2F;en&#x2F;docs&#x2F;control.html</span><br><span class="line"></span><br><span class="line">nginx可以通过信号进行控制。&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;nginx.pid默认情况下，主进程的进程ID被写入文件 。可以在配置时或nginx.conf使用 pid 伪指令更改此名称 。主进程支持以下信号：</span><br><span class="line"></span><br><span class="line">TERM, INT	快速关机</span><br><span class="line">QUIT	    正常关关机，优雅的关闭进程，等待请求结束后再关闭</span><br><span class="line">HUP	        更改配置，使用新配置启动新工作进程，正常关闭旧工作进程，和reload一样</span><br><span class="line">USR1	 	重新打开日志文件，在日志按月&#x2F;日分隔时有用</span><br><span class="line">USR2		升级可执行文件 平滑的升级</span><br><span class="line">WINCH	    优雅关闭旧工作进程(配合USR2来进行升级)</span><br><span class="line"></span><br><span class="line">示例:</span><br><span class="line">kill -INT 19569   快速关闭nginx主进程</span><br><span class="line">kill -QUIT 25914  优雅的关闭</span><br><span class="line">kill -HUP 26172   重新加载配置文件，同nginx -s reload一样</span><br><span class="line"></span><br><span class="line">可以不用每次都查看进程号，</span><br><span class="line">kill -HUP $(cat &#x2F;usr&#x2F;local&#x2F;nginx-1.8&#x2F;logs&#x2F;nginx.pid)</span><br></pre></td></tr></table></figure>

<p><strong>源码安装配置system服务</strong></p>
<p>编写启动脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">vim  &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;nginx.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;nginx</span><br><span class="line"></span><br><span class="line">After&#x3D;network.target remote-fs.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"></span><br><span class="line">Type&#x3D;forking</span><br><span class="line"></span><br><span class="line">PIDFile&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx-1.8&#x2F;logs&#x2F;nginx.pid</span><br><span class="line"></span><br><span class="line">ExecStartPost&#x3D;&#x2F;bin&#x2F;sleep 0.1</span><br><span class="line"></span><br><span class="line">ExecStartPre&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx-1.8&#x2F;sbin&#x2F;nginx -t -c &#x2F;usr&#x2F;local&#x2F;nginx-1.8&#x2F;conf&#x2F;nginx.conf</span><br><span class="line"></span><br><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx-1.8&#x2F;sbin&#x2F;nginx -c &#x2F;usr&#x2F;local&#x2F;nginx-1.8&#x2F;conf&#x2F;nginx.conf</span><br><span class="line"></span><br><span class="line">ExecReload&#x3D;&#x2F;bin&#x2F;kill -s HUP $MAINPID</span><br><span class="line"></span><br><span class="line">ExecStop&#x3D;&#x2F;bin&#x2F;kill -s QUIT $MAINPID</span><br><span class="line"></span><br><span class="line">PrivateTmp&#x3D;true</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line"></span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br></pre></td></tr></table></figure>

<p>加载下系统</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure>



<p>这时候就可以通过下面几种方式启动了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">启动停止，重启</span><br><span class="line">systemctl start nginx</span><br><span class="line">systemctl stop nginx</span><br><span class="line">systemctl restart nginx</span><br><span class="line">重新加载</span><br><span class="line">systemctl reload nginx</span><br><span class="line"></span><br><span class="line">开机自启动和diable</span><br><span class="line">systemctl enable nginx</span><br><span class="line">systemctl disable nginx</span><br></pre></td></tr></table></figure>

<p>这里需要注意的是配置了system服务后。通过systemctl start nginx启动的服务。然后通过nginx -s stop也是可以关闭nginx的，但是通过直接通过nginx 启动的，就不能通过systemctl stop nginx 来关闭， </p>
<p>同时再通过systemctl start nginx来启动nginx也会报错。因为nginx已经在启动了</p>
<h2 id="2-nginx配置"><a href="#2-nginx配置" class="headerlink" title="2.nginx配置"></a><strong>2.nginx配置</strong></h2><p>官方文档地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;nginx.org&#x2F;en&#x2F;docs&#x2F;</span><br></pre></td></tr></table></figure>

<h3 id="1-nginx-conf配置文件"><a href="#1-nginx-conf配置文件" class="headerlink" title="1.nginx.conf配置文件"></a>1.nginx.conf配置文件</h3><p>Nginx配置文件主要分成四部分：main（全局设置）、server（主机设置）、upstream（上游服务器设置，主要为反向代理、负载均衡相关配置）和 location（URL匹配特定位置后的设置），每部分包含若干个指令。</p>
<p><strong>main</strong>部分设置的指令将影响其它所有部分的设置；</p>
<p><strong>server</strong>部分的指令主要用于指定虚拟主机域名、IP和端口；</p>
<p><strong>upstream</strong>的指令用于设置一系列的后端服务器，设置反向代理及后端服务器的负载均衡；</p>
<p><strong>location</strong>部分用于匹配网页位置（比如，根目录“/”,“/images”,等等）。</p>
<p>他们之间的关系式：server继承main，location继承server；upstream既不会继承指令也不会被继承。它有自己的特殊指令，不需要在其他地方的应用。</p>
<p>当前nginx支持的几个指令上下文</p>
<p><strong>通用模板</strong></p>
<p>下面的<code>nginx.conf</code>简单的实现nginx在前端做反向代理服务器的例子，处理js、png等静态文件，jsp等动态请求转发到其它服务器tomcat：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line">user nginx nginx;</span><br><span class="line">worker_processes 2;  #这里可以指定auto; 自动</span><br><span class="line">  </span><br><span class="line">error_log logs&#x2F;error.log;</span><br><span class="line">#error_log logs&#x2F;error.log notice;</span><br><span class="line">#error_log logs&#x2F;error.log info;</span><br><span class="line">  </span><br><span class="line">pid logs&#x2F;nginx.pid;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">events &#123;</span><br><span class="line">use epoll;</span><br><span class="line">worker_connections 2048;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">http &#123;</span><br><span class="line">include mime.types;</span><br><span class="line">default_type application&#x2F;octet-stream;</span><br><span class="line">  </span><br><span class="line">#log_format main &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span><br><span class="line"># &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span><br><span class="line"># &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;</span><br><span class="line">  </span><br><span class="line">#access_log logs&#x2F;access.log main;</span><br><span class="line">  </span><br><span class="line">sendfile on;</span><br><span class="line"># tcp_nopush on;</span><br><span class="line">  </span><br><span class="line">keepalive_timeout 65;</span><br><span class="line">  </span><br><span class="line"># gzip压缩功能设置</span><br><span class="line">gzip on;</span><br><span class="line">gzip_min_length 1k;</span><br><span class="line">gzip_buffers 32 4k;</span><br><span class="line">gzip_http_version 1.1;</span><br><span class="line">gzip_comp_level 6;</span><br><span class="line">gzip_types  text&#x2F;plain text&#x2F;css text&#x2F;javascript application&#x2F;json application&#x2F;javascript application&#x2F;x-javascript application&#x2F;xml;</span><br><span class="line">gzip_vary on;</span><br><span class="line">  </span><br><span class="line"># http_proxy 设置</span><br><span class="line">client_max_body_size 10m;</span><br><span class="line">client_body_buffer_size 128k;</span><br><span class="line">proxy_connect_timeout 75;</span><br><span class="line">proxy_send_timeout 75;</span><br><span class="line">proxy_read_timeout 75;</span><br><span class="line">proxy_buffer_size 4k;</span><br><span class="line">proxy_buffers 4 32k;</span><br><span class="line">proxy_busy_buffers_size 64k;</span><br><span class="line">proxy_temp_file_write_size 64k;</span><br><span class="line">proxy_temp_path &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;proxy_temp 1 2;</span><br><span class="line">  </span><br><span class="line"># 设定负载均衡后台服务器列表</span><br><span class="line">upstream backend &#123;</span><br><span class="line">#ip_hash;</span><br><span class="line">server 192.168.224.11:8080 max_fails&#x3D;2 fail_timeout&#x3D;30s ;</span><br><span class="line">server 192.168.224.12:8080 max_fails&#x3D;2 fail_timeout&#x3D;30s ;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"># 很重要的虚拟主机配置</span><br><span class="line">server &#123;</span><br><span class="line">listen 80;</span><br><span class="line">server_name itoatest.example.com;</span><br><span class="line">root &#x2F;apps&#x2F;oaapp;</span><br><span class="line">  </span><br><span class="line">charset utf-8;</span><br><span class="line">access_log logs&#x2F;host.access.log main;</span><br><span class="line">  </span><br><span class="line">#对 &#x2F; 所有做负载均衡+反向代理</span><br><span class="line">location &#x2F; &#123;</span><br><span class="line">root &#x2F;apps&#x2F;oaapp;</span><br><span class="line">index index.jsp index.html index.htm;</span><br><span class="line">  </span><br><span class="line">proxy_pass http:&#x2F;&#x2F;backend;</span><br><span class="line">proxy_redirect off;</span><br><span class="line"># 后端的Web服务器可以通过X-Forwarded-For获取用户真实IP</span><br><span class="line">proxy_set_header Host $host;</span><br><span class="line">proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">#静态文件，nginx自己处理，不去backend请求tomcat</span><br><span class="line">location ~* &#x2F;download&#x2F; &#123;</span><br><span class="line">root &#x2F;apps&#x2F;oa&#x2F;fs;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line">location ~ .*\.(gif|jpg|jpeg|bmp|png|ico|txt|js|css)$</span><br><span class="line">&#123;</span><br><span class="line">root &#x2F;apps&#x2F;oaapp;</span><br><span class="line">expires 7d;</span><br><span class="line">&#125;</span><br><span class="line">location &#x2F;nginx_status &#123;</span><br><span class="line">stub_status on;</span><br><span class="line">access_log off;</span><br><span class="line">allow 192.168.224.0&#x2F;24;</span><br><span class="line">deny all;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">location ~ ^&#x2F;(WEB-INF)&#x2F; &#123;</span><br><span class="line">deny all;</span><br><span class="line">&#125;</span><br><span class="line">#error_page 404 &#x2F;404.html;</span><br><span class="line">  </span><br><span class="line"># redirect server error pages to the static page &#x2F;50x.html</span><br><span class="line">#</span><br><span class="line">error_page 500 502 503 504 &#x2F;50x.html;</span><br><span class="line">location &#x3D; &#x2F;50x.html &#123;</span><br><span class="line">root html;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">include &#x2F;software&#x2F;站点配置文件&#x2F;*.conf;</span><br><span class="line">  </span><br><span class="line">## 其它虚拟主机，server 指令开始</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-配置nginx的正常访问"><a href="#2-配置nginx的正常访问" class="headerlink" title="2.配置nginx的正常访问"></a>2.配置nginx的正常访问</h3><p><strong>主要修改server段</strong></p>
<p>正常80端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  server1.com;</span><br><span class="line"></span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">            root   &#x2F;software&#x2F;server1;</span><br><span class="line">            index    index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>本机的域名绑定可以通过windos下修改hosts文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">win+ R键 输入下面的命令，去etc找hosts文件去修改内容。</span><br><span class="line">C:\Windows\System32\drivers\etc\</span><br><span class="line"></span><br><span class="line">如果权限不足，可以鼠标右击点击属性，点击安全，进行权限编辑。</span><br></pre></td></tr></table></figure>

<h3 id="3-nginx日志管理"><a href="#3-nginx日志管理" class="headerlink" title="3.nginx日志管理"></a>3.nginx日志管理</h3><p><strong>1.日志格式，是指记录哪些选项</strong></p>
<p>默认的日志格式: main</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span><br><span class="line">                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span><br><span class="line">                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">  access_log  logs&#x2F;access.log  main;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ip地址 - 远程用户 - 用户时间 请求方式(如GET&#x2F;POST)  status状态 请求体body长度(如果状态是304的话,长度一般是0 )  referer来源信息,也就是当前网页的url地址。 </span><br><span class="line">http_user_agent 用户代理&#x2F;蜘蛛， 被转发的请求的原始ip.</span><br><span class="line">http_x_forwarded_for: 在经过代理时，代理把你的本来ip加在此头信息中。传输你的原始ip</span><br></pre></td></tr></table></figure>

<p>蜘蛛</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">这里可以看到各种蜘蛛名，有百度、谷歌、搜狗等等。</span><br><span class="line">www.baidu.com&#x2F;robots.txt</span><br><span class="line"></span><br><span class="line">User-agent: Googlebot</span><br><span class="line">Disallow: &#x2F;baidu</span><br><span class="line">Disallow: &#x2F;s?</span><br><span class="line">Disallow: &#x2F;shifen&#x2F;</span><br><span class="line">Disallow: &#x2F;homepage&#x2F;</span><br><span class="line">Disallow: &#x2F;cpro</span><br><span class="line">Disallow: &#x2F;ulink?</span><br><span class="line">Disallow: &#x2F;link?</span><br><span class="line">Disallow: &#x2F;home&#x2F;news&#x2F;data&#x2F;</span><br><span class="line">Disallow: &#x2F;bh</span><br><span class="line"></span><br><span class="line">上面表示google蜘蛛爬虫 不能爬的目录有哪些。，有些是竞价用的。</span><br></pre></td></tr></table></figure>





<p>自定义格式1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">log_format  main  &#39;[\$time_local] \$http_host &quot;\$request&quot; \$remote_addr \$remote_user &#39;</span><br><span class="line">                      &#39;\$status \$body_bytes_sent &quot;\$http_referer&quot; &quot;\$http_user_agent&quot; &#39;</span><br><span class="line">                      &#39;&quot;\$http_x_forwarded_for&quot; \$request_time \$upstream_response_time &#39;</span><br><span class="line">                      &#39;&quot;\$upstream_addr&quot; \$upstream_status&#39;;</span><br><span class="line"></span><br><span class="line">request_time: 请求的用的时间  </span><br><span class="line">upstream_reponse_time  响应时间</span><br><span class="line">$upstream_addr 后端服务的地址</span><br><span class="line">upstream_statu后端响应的状态</span><br></pre></td></tr></table></figure>

<p>nginx允许针对不同的server做不同的Log(有的web服务器不支持)</p>
<p>修改下配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  yichen1.com;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">            root   &#x2F;software&#x2F;yichen1;</span><br><span class="line">            index    index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">        access_log &#x2F;usr&#x2F;local&#x2F;nginx-1.8&#x2F;logs&#x2F;yichen1.com.access.log main;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后重新加载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl reload nginx</span><br><span class="line"></span><br><span class="line">这时候就会发现对应的目录下生成的yichen1的日志。也是main格式的。</span><br></pre></td></tr></table></figure>

<p><strong>2.nginx定时任务完成日志切割</strong></p>
<p>用shell脚本实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">vim runlog.sh</span><br><span class="line"></span><br><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">LOGPATH&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx-1.8&#x2F;logs&#x2F;access.log</span><br><span class="line">BASEPATH&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx-1.8&#x2F;logs</span><br><span class="line"></span><br><span class="line">bak&#x3D;$BASEPATH&#x2F;$(date -d yesterday +%Y%m%d).assess.log #昨天的时间</span><br><span class="line">#bak&#x3D;$BASEPATH&#x2F;$(date -d yesterday +%Y%m%d%H%M).access.log</span><br><span class="line">echo $bak</span><br><span class="line">mv $LOGPATH $bak</span><br><span class="line"></span><br><span class="line">#压缩日志</span><br><span class="line">tar -czf $&#123;bak&#125;.gz $bak 2&amp;&gt; &#x2F;dev&#x2F;null</span><br><span class="line">     </span><br><span class="line">touch $LOGPATH</span><br><span class="line"></span><br><span class="line">kill -USR1  $(cat &#x2F;usr&#x2F;local&#x2F;nginx-1.8&#x2F;logs&#x2F;nginx.pid)</span><br><span class="line"></span><br><span class="line">rm -rf $bak   #删除原有日志没有压缩的</span><br></pre></td></tr></table></figure>

<p>然后做定时任务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cronte -e </span><br><span class="line">00 0 * * *  sh  &#x2F;software&#x2F;runlog.sh   #每天执行</span><br><span class="line"></span><br><span class="line">#每个月的1号，11号，21号，31号执行</span><br><span class="line">0 0 *&#x2F;10 * *  sh  &#x2F;software&#x2F;runlog.sh</span><br><span class="line"></span><br><span class="line">#每个月执行</span><br><span class="line">0 0 1 * *   sh  &#x2F;software&#x2F;runlog.sh</span><br></pre></td></tr></table></figure>

<p><strong>3.其他方式日志轮转</strong></p>
<p>参考网址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;ethendev.github.io&#x2F;2019&#x2F;01&#x2F;10&#x2F;roate-nginx-log&#x2F;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    # 日志轮转</span><br><span class="line">    cat &lt;&lt;EOF &gt;&#x2F;etc&#x2F;logrotate.d&#x2F;nginx</span><br><span class="line">&#x2F;etc&#x2F;nginx&#x2F;logs&#x2F;*log &#123;</span><br><span class="line">    daily</span><br><span class="line">    rotate 10</span><br><span class="line">    missingok</span><br><span class="line">    notifempty</span><br><span class="line">    compress</span><br><span class="line">    sharedscripts</span><br><span class="line">    dateext</span><br><span class="line">    postrotate</span><br><span class="line">        [ ! -f &#x2F;usr&#x2F;local&#x2F;openresty&#x2F;nginx&#x2F;logs&#x2F;nginx.pid ] || &#x2F;bin&#x2F;kill -USR1 &#96;cat &#x2F;usr&#x2F;local&#x2F;openresty&#x2F;nginx&#x2F;logs&#x2F;nginx.pid 2&gt;&#x2F;dev&#x2F;null&#96; 2&gt;&#x2F;dev&#x2F;null || true</span><br><span class="line">    endscript</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>调试脚本，测试脚本是否正确</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo &#x2F;usr&#x2F;sbin&#x2F;logrotate -d -f &#x2F;etc&#x2F;logrotate.d&#x2F;nginx</span><br></pre></td></tr></table></figure>

<p>手动运行运行脚本分割日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo &#x2F;usr&#x2F;sbin&#x2F;logrotate -f &#x2F;etc&#x2F;logrotate.d&#x2F;nginx</span><br></pre></td></tr></table></figure>

<p><strong>添加定时任务</strong></p>
<p>通过下面的命令添加定时任务(注意需要指定运行 nginx 的用户，不然可能没有权限无法正确执行)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo crontab -u root -e </span><br><span class="line"></span><br><span class="line"># rotate nginx log erery day</span><br><span class="line">0 0 * * * &#x2F;usr&#x2F;sbin&#x2F;logrotate -f &#x2F;etc&#x2F;logrotate.d&#x2F;nginx   #每天执行</span><br></pre></td></tr></table></figure>

<p>如果要删除上面的定时任务，运行如下命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crontab -r</span><br></pre></td></tr></table></figure>

<p>如果任务没有正确执行，可以通过如下命令查看任务日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;var&#x2F;log&#x2F;cron</span><br></pre></td></tr></table></figure>

<h3 id="4-location的正则匹配"><a href="#4-location的正则匹配" class="headerlink" title="4.location的正则匹配"></a>4.location的正则匹配</h3><p><strong>location</strong>: 用来设定不同的uri的文件系统的路径映射，一个server中可以设置多个<code>location</code>,<code>nginx</code>会根据用户请求的<code>uri</code>地址来逐个判断<code>location</code>,找出最佳匹配规则，然后应用该<code>location</code>中定义的配置。<code>location</code>是<code>nginx</code>使用频率非常非常高的指令，匹配规则以及匹配优先级是<code>location</code>指令比较复杂的地方,</p>
<p><strong>网址的解释</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;yichen1.com&#x2F;index.html?channelCode&#x3D;22&amp;&amp;b&#x3D;2</span><br><span class="line">url 表示整个网址</span><br><span class="line">uri 表示域名后面的字符串 &#x2F;index.html?channelCode&#x3D;22&amp;&amp;b&#x3D;2</span><br><span class="line">host 表示域名 yichen1.com</span><br><span class="line"></span><br><span class="line">而location是匹配uri的。</span><br><span class="line">配置文件里面可以通过变量提取</span><br><span class="line">https:&#x2F;&#x2F;$host$request_uri;</span><br><span class="line">$host表示yichen1.com $request_uri表示 &#x2F;index.html?channelCode&#x3D;22&amp;&amp;b&#x3D;2</span><br></pre></td></tr></table></figure>

<p><strong>基本语法</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">语法:	location [ &#x3D; | ~ | ~* | ^~ ] uri &#123;...&#125;</span><br><span class="line">location @name &#123;...&#125;</span><br><span class="line">默认:	 —</span><br><span class="line">可以使用的块:	server, location</span><br></pre></td></tr></table></figure>

<p>其中:</p>
<p><code>=</code>:对<code>uri</code>做精确匹配，优先级最高，如果匹配成功，则停止向下搜索，并立即处理此请求。比如:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location &#x3D; &#x2F; &#123;</span><br><span class="line">... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当请求<code>https://www.baidu.com/</code>时匹配，但当访问<code>https://www.baidu.com/index.html</code>则不匹配；</p>
<p><code>^~</code>:   对<code>uri</code><strong>起始字符</strong>做字符串匹配(注意: 不是正则匹配), 区分大小写，会检索所有匹配，以匹配长度为优先，一旦匹配上，不再进行正则匹配;</p>
<p><code>~</code>:   对<code>uri</code>(<strong>可以不是起始字符</strong>)做正则表达式匹配，区分大小写；</p>
<p><code>~*</code>:   对<code>uri</code>(<strong>可以不是起始字符</strong>)做正则表达式匹配，不区分大小写；</p>
<p><strong>不带符号</strong>:   <strong>匹配起始于此字符</strong>串的所有<code>uri</code>,区分大小写。</p>
<p><strong>注意</strong>:  字符串匹配(无论是 ^~ 还是 无符号 匹配)，后面都必须以<code>/</code>  开头，否则将永远匹配不上。正则匹配可以。</p>
<p>它们匹配度优先级为： <code>=</code> &gt; <code>^&gt;</code> &gt; <code>~</code> = <code>~*</code> &gt; <code>不带符号</code> </p>
<p>下面可以测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line"></span><br><span class="line">        listen 80 ;</span><br><span class="line">        listen 443 ssl;</span><br><span class="line">        server_name  yichen2.com;</span><br><span class="line">        root &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;</span><br><span class="line">              index test.html ;</span><br><span class="line">        ssl_certificate  &#x2F;root&#x2F;ssl&#x2F;yichen2.crt;</span><br><span class="line">        ssl_certificate_key &#x2F;root&#x2F;ssl&#x2F;yichen2.key;</span><br><span class="line">   location  &#x3D; &#x2F; &#123;</span><br><span class="line">        return 701;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">   location ^~ &#x2F;img &#123;</span><br><span class="line"></span><br><span class="line">      return  702;</span><br><span class="line">&#125;</span><br><span class="line">   location ~ &#x2F;img &#123;</span><br><span class="line"></span><br><span class="line">      return 703;</span><br><span class="line">&#125;</span><br><span class="line">   location ~* &#x2F;img &#123;</span><br><span class="line">      return 704;</span><br><span class="line">&#125;</span><br><span class="line">   location   &#x2F;imgs &#123;</span><br><span class="line"></span><br><span class="line">      return 705;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  location &#x2F;  &#123;</span><br><span class="line"></span><br><span class="line">      return 666;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过curl 来方式测试下优先级</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -k -I yichen2.com         返回701 </span><br><span class="line">curl -k -I yichen2.com&#x2F;img     返回702</span><br><span class="line">curl -k -I yichen2.com&#x2F;imgs    返回703  #因为正则比无符号优先级高</span><br><span class="line">curl -k -I yichen2.com&#x2F;ssdjdj  返回666</span><br></pre></td></tr></table></figure>

<p>正则匹配和普通匹配</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  yichen1.com;</span><br><span class="line"></span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">            root   &#x2F;software&#x2F;yichen1;</span><br><span class="line">            index    index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">        #access_log &#x2F;usr&#x2F;local&#x2F;nginx-1.8&#x2F;logs&#x2F;yichen1.com.access.log main;</span><br><span class="line"></span><br><span class="line">        location ~ image &#123;</span><br><span class="line">		  root &#x2F;software&#x2F;;</span><br><span class="line">        index index.html;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>index 的内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src&#x3D;&quot;.&#x2F;image&#x2F;6dong.gif&quot; &#x2F;&gt;</span><br></pre></td></tr></table></figure>

<p>创建一个放image的目录。让放入图片</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;software&#x2F;image</span><br></pre></td></tr></table></figure>

<p>此时访问yichen1.com  会出现图片。但是路径是访问的/software/image/6dong.gif的图片。而不是默认的/software/yichen1/image/的图片。</p>
<p><strong>总结: location的命中过程是这样的。</strong></p>
<p><strong>1.先判断精准命中，如果命中。立刻返回结果并结束解析过程</strong></p>
<p><strong>2.判断普通命中，如果有多个命中，记录下来最长的命中结果。(注意: 记录但不结束，最长的为准)</strong></p>
<p><strong>3.继续判断正则表达式解析的结果，按配置里的正则表达式顺序为准，由上到下开始匹配，一旦匹配成功1个，立即返回结果，并结束解析过程。</strong></p>
<p>延时分析：a. 普通命中 顺序无所谓，是因为按命中的长短来确定的。</p>
<p>​    b. 正则命中，顺序有所谓，因为是从前往后命中的。</p>
<h3 id="5-rewrite语法详解"><a href="#5-rewrite语法详解" class="headerlink" title="5.rewrite语法详解"></a>5.rewrite语法详解</h3><p><strong>官方文档</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;nginx.org&#x2F;en&#x2F;docs&#x2F;http&#x2F;ngx_http_rewrite_module.html</span><br></pre></td></tr></table></figure>

<p><strong>重写中常用的指令</strong></p>
<p>break #跳出 rewrite</p>
<p>if (条件) {} 设定条件再进行重写</p>
<p>return #返回状态码，也可以在返回新的url地址</p>
<p>rewrite #重写</p>
<p>set #设置变量</p>
<p><strong>指令1:  break</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	break;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	server, location, if</span><br><span class="line"></span><br><span class="line">语法: break;</span><br><span class="line">默认:  -</span><br><span class="line">可以使用的块: server, location, if,</span><br></pre></td></tr></table></figure>

<p>如果在<a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#location">location中</a>指定了伪指令，则 在此位置继续进行请求的进一步处理。</p>
<p>列</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if ($slow) &#123;</span><br><span class="line">    limit_rate 10k;</span><br><span class="line">    break;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>指令2:  if</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">语法:	if (condition) &#123; ... &#125;</span><br><span class="line">默认:	 —</span><br><span class="line">可以使用的块:	server, location</span><br></pre></td></tr></table></figure>

<p>指定的condition(条件表达式)被评估。如果为true，则执行大括号内指定的此模块指令，并在指令内为请求分配配置 <code>if</code>。<code>if</code>指令中的配置是从先前的配置级别继承的。</p>
<p>条件可以是以下任意一种：</p>
<ul>
<li><p>变量名；如果变量的值为空字符串或“ 0 ”，则为false；否则为false 。</p>
<blockquote>
<p>在1.0.1版之前，任何以“ <code>0</code>” 开头的字符串都被视为错误值。</p>
</blockquote>
</li>
<li><p>使用“ <code>=</code>”和“ <code>!=</code>”运算符将变量与字符串进行比较；</p>
</li>
<li><p>使用“ <code>~</code>”（用于区分大小写的匹配）和“ <code>~*</code>”（用于不区分大小写的匹配）运算符将变量与正则表达式进行匹配。正则表达式可以包含捕获，这些捕获可用于以后在<code>$1</code>.. <code>$9</code>变量中重用。负运算符“ <code>!~</code>”和“ <code>!~*</code>”也可用。如果正则表达式包含“ <code>}</code>”或“ <code>;</code>”字符，则整个表达式应用单引号或双引号引起来。</p>
</li>
<li><p>使用“ <code>-f</code>”和“ <code>!-f</code>”运算符检查文件是否存在；</p>
</li>
<li><p>使用“ <code>-d</code>”和“ <code>!-d</code>”运算符检查目录是否存在；</p>
</li>
<li><p>使用“ <code>-e</code>”和“ <code>!-e</code>”运算符检查文件，目录或符号链接是否存在；</p>
</li>
<li><p>使用“ <code>-x</code>”和“ <code>!-x</code>”运算符检查可执行文件。</p>
</li>
</ul>
<p>例子：</p>
<p>可以引用的变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> cat conf&#x2F;fastcgi.conf</span><br><span class="line">可以去这里看。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">if ($http_user_agent ~ MSIE) &#123;</span><br><span class="line">    rewrite ^(.*)$ &#x2F;msie&#x2F;$1 break;</span><br><span class="line">&#125;  #如果客户端浏览器是IE浏览器 则重写到&#x2F;msie&#x2F;$1  目录下的内容。break 退出</span><br><span class="line"></span><br><span class="line">if ($http_cookie ~* &quot;id&#x3D;([^;]+)(?:;|$)&quot;) &#123;</span><br><span class="line">    set $id $1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if ($request_method &#x3D; POST) &#123;</span><br><span class="line">    return 405;</span><br><span class="line">&#125; #如果请求模式是post 就返回405</span><br><span class="line"></span><br><span class="line">if ($slow) &#123;</span><br><span class="line">    limit_rate 10k;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if ($invalid_referer) &#123;</span><br><span class="line">    return 403;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">下面的是：如果访问ip是224.1的就返回403,不让访问下面的家目录。</span><br><span class="line">location &#x2F; &#123;</span><br><span class="line">           if ($remote_addr &#x3D; 192.168.224.1) &#123;</span><br><span class="line">        return 403;</span><br><span class="line">&#125;</span><br><span class="line">            root   &#x2F;software&#x2F;yichen1;</span><br><span class="line">            index    index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">如果是ie浏览器访问的键跳转其他页面。</span><br><span class="line"> location &#x2F; &#123;</span><br><span class="line">           if ($http_user_agent ~ Trident) &#123;</span><br><span class="line"></span><br><span class="line">        rewrite ^(.*)$  &#x2F;ie.html break;</span><br><span class="line">&#125;</span><br><span class="line">            root   &#x2F;software&#x2F;yichen1&#x2F;;</span><br><span class="line">            index    index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">判断路径文件不存在就返回404.html页面。</span><br><span class="line"> location &#x2F; &#123;</span><br><span class="line">           if ( !-e $document_root$fastcgi_script_name) &#123;</span><br><span class="line"></span><br><span class="line">        rewrite ^(.*)$  &#x2F;404.html break;</span><br><span class="line">&#125;</span><br><span class="line">            root   &#x2F;software&#x2F;yichen1&#x2F;;</span><br><span class="line">            index    index.html index.htm;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p><strong>指令3: return</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">语法：	return code [text];</span><br><span class="line"></span><br><span class="line">      return code URL;</span><br><span class="line">      return URL;</span><br><span class="line">默认：	-</span><br><span class="line">可以使用的块：	server，location，if</span><br><span class="line"></span><br><span class="line">另外，URL可以将带有代码302 的用于临时重定向的a 指定为唯一参数。这样的参数应以“ http:&#x2F;&#x2F;”，“ https:&#x2F;&#x2F;”或“ $scheme”字符串开头。一个URL可以包含变量。</span><br></pre></td></tr></table></figure>

<p><strong>指令4: rewrite</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">语法：	rewrite 正则表达式 replacement [flag];</span><br><span class="line">默认：	-</span><br><span class="line">可以使用的块：	server，location，if</span><br><span class="line"></span><br><span class="line">replacement: 替换的新内容</span><br></pre></td></tr></table></figure>

<p>如果指定的正则表达式与请求URI匹配，则URI将按照<code>replacement</code>字符串中的指定进行更改。该<code>rewrite</code>指令在其在配置文件中出现的顺序执行。可以使用标志终止指令的进一步处理。如果替换字符串以“ <code>http://</code>”，“ <code>https://</code>”或“ <code>$scheme</code>” 开头，则处理将停止并将重定向返回给客户端。</p>
<p>可选<code>*flag*</code>参数可以是以下之一：</p>
<ul>
<li><p><code>last</code></p>
<p>停止处理当前<code>ngx_http_rewrite_module</code>指令集， 并开始搜索与更改后的URI相匹配的新位置；</p>
</li>
<li><p><code>break</code></p>
<p><code>ngx_http_rewrite_module</code>与<a href="http://nginx.org/en/docs/http/ngx_http_rewrite_module.html#break">break</a>指令一样， 停止处理当前的指令集 ；</p>
</li>
<li><p><code>redirect</code></p>
<p>返回带有302代码的临时重定向；如果替换字符串不是以“ <code>http://</code>”，“ <code>https://</code>”或“ <code>$scheme</code>” 开头，则使用</p>
</li>
<li><p><code>permanent</code></p>
<p>返回带有301代码的永久重定向。</p>
<p>完整的重定向URL是根据请求方案（<code>$scheme</code>）以及 <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#server_name_in_redirect">server_name_in_redirect</a>和 <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#port_in_redirect">port_in_redirect</a>指令形成的。</p>
</li>
</ul>
<p><strong>break 和permanent的区别</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> location ~ &#123;</span><br><span class="line"></span><br><span class="line">        rewrite goods-(\d+).html  &#x2F;test.html break;</span><br><span class="line">&#125;</span><br><span class="line">#访问http:&#x2F;&#x2F;yichen.com&#x2F;goods-122.html 会显示&#x2F;test.html的内容，但是网页上还是显示当前的url  http:&#x2F;&#x2F;yichen.com&#x2F;goods-122.html;</span><br><span class="line"></span><br><span class="line"> location ~ &#123;</span><br><span class="line"></span><br><span class="line">        rewrite goods-(\d+).html  &#x2F;test.html permanent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#访问http:&#x2F;&#x2F;yichen.com&#x2F;goods-122.html 会直接永久重写到&#x2F;test.html的内容，且url会跳转到http:&#x2F;&#x2F;yichen.com&#x2F;test.html</span><br></pre></td></tr></table></figure>



<p>例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    ...</span><br><span class="line">    rewrite ^(&#x2F;download&#x2F;.*)&#x2F;media&#x2F;(.*)\..*$ $1&#x2F;mp3&#x2F;$2.mp3 last;</span><br><span class="line">    rewrite ^(&#x2F;download&#x2F;.*)&#x2F;audio&#x2F;(.*)\..*$ $1&#x2F;mp3&#x2F;$2.ra  last;</span><br><span class="line">    return  403;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是，如果将这些指令放在“ <code>/download/</code>”位置，<code>last</code>则应将标志替换为 <code>break</code>，否则nginx将执行10个循环并返回500错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">location &#x2F;download&#x2F; &#123;</span><br><span class="line">    rewrite ^(&#x2F;download&#x2F;.*)&#x2F;media&#x2F;(.*)\..*$ $1&#x2F;mp3&#x2F;$2.mp3 break;</span><br><span class="line">    rewrite ^(&#x2F;download&#x2F;.*)&#x2F;audio&#x2F;(.*)\..*$ $1&#x2F;mp3&#x2F;$2.ra  break;</span><br><span class="line">    return  403;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果<code>*replacement*</code>字符串包含新的请求参数，则先前的请求参数将附加在它们之后。如果不希望这样，请在替换字符串的末尾添加问号，避免附加它们，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rewrite ^&#x2F;users&#x2F;(.*)$ &#x2F;show?user&#x3D;$1? last;</span><br></pre></td></tr></table></figure>

<p><strong>指令5:  set</strong></p>
<table>
<thead>
<tr>
<th align="left">语法：</th>
<th>set  $variable  value;</th>
</tr>
</thead>
<tbody><tr>
<td align="left">默认：</td>
<td>-</td>
</tr>
<tr>
<td align="left">可以同的块：</td>
<td><code>server</code>，<code>location</code>，<code>if</code></td>
</tr>
</tbody></table>
<p><code>value</code>为指定的 设置<code>variable</code>。该<code>value</code>可以包含文本，变量，他们的组合</p>
<p>set是设置变量用的，可以用来达到多个条件判断时做标记用，如下</p>
<p>判断是IE浏览器并重写，其不用break退出。也能防止死循环。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">    if ($http_user_agent ~* trident) &#123;</span><br><span class="line">        set $isie 1;</span><br><span class="line">&#125;  #如果是IE isie变量的值为1</span><br><span class="line">    if ($fastcgi_script_name &#x3D; ie.html)&#123;</span><br><span class="line">   set $isie 0;  #如果跳转到路径名是ie.html isie变量的值为0</span><br><span class="line">&#125;</span><br><span class="line">      if ($isie &#x3D; 1) &#123;</span><br><span class="line"></span><br><span class="line">  rewrite ^(.*)$  &#x2F;ie.html;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-url重写实战"><a href="#1-url重写实战" class="headerlink" title="1.url重写实战"></a>1.url重写实战</h4><p>访问指定的html就重写到真实的地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">location &#x2F;ecshop &#123;</span><br><span class="line"></span><br><span class="line">        rewrite &#39;goods-(\d&#123;1,7&#125;)\.html&#39; &#x2F;ecshop&#x2F;goods.php?id&#x3D;1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#只要匹配的goods-3454.html,就重写到&#x2F;ecshop&#x2F;goods.php?id&#x3D;1;的内容。</span><br><span class="line"></span><br><span class="line">location &#x2F;ecshop &#123;</span><br><span class="line"></span><br><span class="line">        rewrite &#39;goods-(\d&#123;1,7&#125;)\.html&#39; &#x2F;ecshop&#x2F;goods.php?id&#x3D;$1;</span><br><span class="line">&#125;</span><br><span class="line">#只要匹配的goods-3454.html,就重写到&#x2F;ecshop&#x2F;goods.php?id&#x3D;3454的内容。</span><br><span class="line">目的在于不让客户端知道&#x2F;etcshop&#x2F;goods.php?id&#x3D;3454的这个参数。</span><br></pre></td></tr></table></figure>

<h3 id="6-gzip压缩提升网站速度"><a href="#6-gzip压缩提升网站速度" class="headerlink" title="6. gzip压缩提升网站速度"></a>6. gzip压缩提升网站速度</h3><p>官网文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;nginx.org&#x2F;en&#x2F;docs&#x2F;http&#x2F;ngx_http_gzip_module.html</span><br></pre></td></tr></table></figure>

<p>常用参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">gzip            on|off; 是否开启gzip</span><br><span class="line">gzip_buffers   32 4k | 16 8k 缓冲(压缩在内存中缓冲几块?每块多大?)</span><br><span class="line">gzip_comp_level [1-9] 推荐6 压缩级别(级别越高，压的越小。也浪费cpu资源)</span><br><span class="line">gzip_disable  #正则匹配UA 什么样的url不进行gzip</span><br><span class="line">gzip_http_version 1.0 | 1.1  开始压缩的http协议版本。(可以不用设置)</span><br><span class="line">gzip_min_length 1000;   设置将被压缩的响应的最小长度。(再小就不用压缩了，意义不大)</span><br><span class="line">gzip_proxied    ;响应为代理请求启用或禁用响应的压缩</span><br><span class="line">gzip_types      text&#x2F;plain application&#x2F;xml; #对哪些类型的文件用压缩。</span><br><span class="line">gzip_vary on|off #是否传输gzip压缩标志，是否告诉客户端是否有压缩。</span><br></pre></td></tr></table></figure>

<p>注意: </p>
<p>图片和视频 这样的二进制文件，不必压缩 因为压缩比比较小，比如100-&gt;80 字节。而且压缩也是耗费cpu资源的。</p>
<h3 id="7-expires缓存提升网站负载"><a href="#7-expires缓存提升网站负载" class="headerlink" title="7.expires缓存提升网站负载"></a>7.expires缓存提升网站负载</h3><p>官网文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;nginx.org&#x2F;en&#x2F;docs&#x2F;http&#x2F;ngx_http_core_module.html</span><br></pre></td></tr></table></figure>

<p>设置过期时间。</p>
<p>在location 或if段里来写</p>
<p>格式  expires  30s</p>
<p>expires 30m;  30分过期</p>
<p>expires 2h; 2小时</p>
<p>expires 30d;  30天。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">location &#x2F;images&#x2F; &#123;</span><br><span class="line">    try_files $uri &#x2F;images&#x2F;default.gif;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location &#x3D; &#x2F;images&#x2F;default.gif &#123;</span><br><span class="line">    expires 30s;</span><br><span class="line">&#125;   表示&#x2F;images&#x2F;default.gif这个里面的图片在客户浏览器中30秒后过期。。</span><br><span class="line"></span><br><span class="line">location ~* \.(jpg|jpeg|gif|png) &#123;</span><br><span class="line"> expires 1d;</span><br><span class="line">&#125;</span><br><span class="line">#只要是图片都1天后才过期。</span><br></pre></td></tr></table></figure>

<p>注意：服务器的日期要准确。</p>
<p>另: 304也是一种很好的缓存手段</p>
<h3 id="8-HTTP跳转HTTPS协议几种方式性能对比"><a href="#8-HTTP跳转HTTPS协议几种方式性能对比" class="headerlink" title="8.HTTP跳转HTTPS协议几种方式性能对比"></a>8.<strong>HTTP跳转HTTPS协议几种方式性能对比</strong></h3><p>我这里已<code>http://yichen2.com</code> 为例，要求所有访问该页面的请求全部跳转至<code>https://yichen2.com</code>,</p>
<p>并请求的<code>uri</code> 和参数<code>$query_string</code> 要保留下来。</p>
<p>常见的几种方法:</p>
<p><strong>1.使用if进行协议判断   –最差</strong></p>
<p>这种情况下，多为把<code>http</code>和<code>https</code>写在同一个<code>server</code>中，配置如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">   server &#123;</span><br><span class="line"></span><br><span class="line">        listen 80 default_server;</span><br><span class="line">        listen 443 ssl;</span><br><span class="line">        server_name  yichen2.com;</span><br><span class="line">        root &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;</span><br><span class="line">        index  test.html ;</span><br><span class="line">        ssl_certificate  &#x2F;root&#x2F;ssl&#x2F;yichen2.crt;</span><br><span class="line">        ssl_certificate_key &#x2F;root&#x2F;ssl&#x2F;yichen2.key;</span><br><span class="line">        charset  utf-8;</span><br><span class="line">        if ( $scheme &#x3D; http ) &#123;</span><br><span class="line">        rewrite ^&#x2F;(.*)$ https:&#x2F;&#x2F;yichen2.com&#x2F;$1 permanent ;</span><br><span class="line">&#125;</span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种配置看起来简洁很多，但是性能是最差的，首先每次连接进来都需要<code>nginx</code> 进行协议判断，其次判断<code>http</code> 协议时进行地址匹配、重写、返回、再次判断，最后还有正则表达式的处理… …. 所以，生产上我们极不建议 这种写法。另外，能少用<code>if</code> 的尽量不用，如果一定要使用，也最好在<code>location</code> 段，并且结合<code>ruturn</code>  或者<code>rewrite ... last</code> 来使用。</p>
<p><strong>2.rewrite 方法1 –差</strong></p>
<p>一般80端口 443 ssl端口不要写在同一个<code>server</code> 中，这样虽然代码简洁了一些，但是性能并不是很好。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">   server &#123;</span><br><span class="line"></span><br><span class="line">        listen 80 default_server;</span><br><span class="line">        listen 443 ssl;</span><br><span class="line">        server_name  yichen2.com;</span><br><span class="line">        root &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;</span><br><span class="line">        index  test.html ;</span><br><span class="line">        ssl_certificate  &#x2F;root&#x2F;ssl&#x2F;yichen2.crt;</span><br><span class="line">        ssl_certificate_key &#x2F;root&#x2F;ssl&#x2F;yichen2.key;</span><br><span class="line">        charset  utf-8;</span><br><span class="line">        rewrite ^&#x2F;(.*)$ https:&#x2F;&#x2F;yichen2.com&#x2F;$1 permanent;</span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl -k -I yichen2.com&#x2F;a.html?a&#x3D;3</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 301 Moved Permanently</span><br><span class="line">Server: nginx&#x2F;1.16.1</span><br><span class="line">Date: Mon, 29 Jun 2020 22:10:12 GMT</span><br><span class="line">Content-Type: text&#x2F;html</span><br><span class="line">Content-Length: 169</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Location: https:&#x2F;&#x2F;yichen2.com&#x2F;a.html?a&#x3D;3</span><br></pre></td></tr></table></figure>

<p>可以看到实现了<code>http</code> 到<code>https</code>的跳转。并且保留了参数</p>
<p><strong>3.rewrite 方法2  –好</strong></p>
<p>不使用正则表达式。而使用变量来提升性能:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  yichen2.com;</span><br><span class="line">        rewrite      ^ https:&#x2F;&#x2F;yichen2.com$request_uri? permanent;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line"></span><br><span class="line">        listen       443 ssl;</span><br><span class="line">        server_name  yichen2.com;</span><br><span class="line">        root &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;</span><br><span class="line">        index  test.html ;</span><br><span class="line">        ssl_certificate  &#x2F;root&#x2F;ssl&#x2F;yichen2.crt;</span><br><span class="line">        ssl_certificate_key &#x2F;root&#x2F;ssl&#x2F;yichen2.key;</span><br><span class="line">        charset  utf-8;</span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>: <code>$request_uri</code> 已经包含了查询参数，所以要在其重写规则后面加上<code>?</code> 以禁止再次传递参数，这种方法避免了<code>nginx</code> 内部处理正则的性能损坏，相比较上面的方式好了很多。</p>
<p><strong>4.return 301实现最优解  – 最好</strong></p>
<p>虽然上面我们使用参数代替了正则，但是<code>rewrite</code> 规则会先对<code>url</code> 进行匹配，匹配上了再执行相应的规则，而 <code>return</code> 没有匹配<code>url</code> 层面的性能消耗，直接返回用户新的连接，所以是最优的解决方案。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  yichen2.com;</span><br><span class="line">        return       301 https:&#x2F;&#x2F;$host$request_uri ;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line"></span><br><span class="line">        listen       443 ssl;</span><br><span class="line">        server_name  yichen2.com;</span><br><span class="line">        root &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;</span><br><span class="line">        index  test.html ;</span><br><span class="line">        ssl_certificate  &#x2F;root&#x2F;ssl&#x2F;yichen2.crt;</span><br><span class="line">        ssl_certificate_key &#x2F;root&#x2F;ssl&#x2F;yichen2.key;</span><br><span class="line">        charset  utf-8;</span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>: 在<code>return</code> 中， <code>$request_uri</code> 后面不用加<code>?</code> (加<code>?</code> 用来避免携带参数是<code>rewrite</code> 中的特性)。</p>
<p>如果希望实现永久重定向，则使用<code>return 301 https://$host$request_uri</code> , 不过想要两个域名都会使用，所以更多情况下使用<code>302</code> 临时重定向。</p>
<p><strong>301重定向和302重定向的区别</strong></p>
<p>　　302重定向只是暂时的重定向，搜索引擎会抓取新的内容而保留旧的地址，<strong>因为服务器返回302，所以，搜索搜索引擎认为新的网址是暂时的。</strong></p>
<p>　　<strong>而301重定向是永久的重定向，搜索引擎在抓取新的内容的同时也将旧的网址替换为了重定向之后的网址。</strong></p>
<p><strong>5.关于错误497 495 496的配置</strong>　　</p>
<p>495和496表示证书错误和没有证书。 497表示http跳转https错误。一般是通过http访问了其他https端口。比如: </p>
<p><code>http://yichen2.com:2020</code> 此时2020端口是https的。通过http访问就会报错误。这种情况可以跳转指定uri。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  yichen2.com;</span><br><span class="line">        return       301 https:&#x2F;&#x2F;$host$request_uri ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        listen 888;</span><br><span class="line">        listen [::]:888;</span><br><span class="line">        server_name yichen2.com;</span><br><span class="line">        root &#x2F;software&#x2F;yichen2.com&#x2F;html;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        listen 443 ssl http2;</span><br><span class="line">        listen [::]:443 ssl http2;</span><br><span class="line">        listen 2020 ssl http2;</span><br><span class="line">        listen [::]:2020 ssl http2;</span><br><span class="line">        listen 999 ssl http2;</span><br><span class="line">        listen [::]:999 ssl http2;</span><br><span class="line">        server_name  yichen2.com;</span><br><span class="line">        root &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;</span><br><span class="line">        index  test.html ;</span><br><span class="line">        error_page 495 496 http:&#x2F;&#x2F;$host:888;    #证书有问题或者过期。就直接跳转http:888端口</span><br><span class="line">        error_page 497 https:&#x2F;&#x2F;$host:2020;     #http跳转https有问题。就直接默认跳转指定端口</span><br><span class="line">        </span><br><span class="line">        ssl_certificate  &#x2F;root&#x2F;ssl&#x2F;yichen2.crt;</span><br><span class="line">        ssl_certificate_key &#x2F;root&#x2F;ssl&#x2F;yichen2.key;</span><br><span class="line">        charset  utf-8;</span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>　　</p>
<h2 id="3-nginx负载均衡"><a href="#3-nginx负载均衡" class="headerlink" title="3.nginx负载均衡"></a><strong>3.nginx负载均衡</strong></h2><p>参考文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;nginx.org&#x2F;en&#x2F;docs&#x2F;http&#x2F;ngx_http_upstream_module.html</span><br></pre></td></tr></table></figure>

<p><strong>1.基础负载均衡</strong></p>
<p>客户端 —-&gt; nginx  .html  —-&gt;  proxy_pass —-&gt;  apache 或 php  </p>
<p>这种动静分离。动静分离不是一个严谨的说法。叫反向代理比较规范。</p>
<p>反向代理后端如果有多台服务器，自然可形成负载均衡。</p>
<p>但 prox_pass 如何指向多台服务器呢？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location &#x2F; &#123;</span><br><span class="line">		proxy_pass http:&#x2F;&#x2F;192.168.224.11&#x2F;;</span><br><span class="line">		proxy_pass http:&#x2F;&#x2F;192.168.224.12&#x2F;;</span><br><span class="line">		proxy_set_header Host $host;</span><br><span class="line">		proxy_set_header X-Forwarded-For $remote_addr;	</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>这样是会出现错误。</p>
<p>解决办法。</p>
<p>把多个台服务器用 upstream 指定绑定在一起并起个组名。</p>
<p>然后 proxy_pass 指向该组。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> upstream backendweb &#123;</span><br><span class="line">        server yichen2.com:81  weight&#x3D;1 max_fails&#x3D;2 fail_timeout&#x3D;1s;</span><br><span class="line">        server server2.com:82  weight&#x3D;1 max_fails&#x3D;2 fail_timeout&#x3D;1s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">这样就可以了。</span><br><span class="line">location &#x2F; &#123;</span><br><span class="line">                proxy_pass http:&#x2F;&#x2F;backendweb;</span><br><span class="line">                proxy_set_header Host $host;</span><br><span class="line">                proxy_set_header X-Forwarded-For $remote_addr;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>模块用于定义可以由<a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass">proxy_pass</a>， <a href="http://nginx.org/en/docs/http/ngx_http_fastcgi_module.html#fastcgi_pass">fastcgi_pass</a>， <a href="http://nginx.org/en/docs/http/ngx_http_uwsgi_module.html#uwsgi_pass">uwsgi_pass</a>， <a href="http://nginx.org/en/docs/http/ngx_http_scgi_module.html#scgi_pass">scgi_pass</a>， <a href="http://nginx.org/en/docs/http/ngx_http_memcached_module.html#memcached_pass">memcached_pass</a>和 <a href="http://nginx.org/en/docs/http/ngx_http_grpc_module.html#grpc_pass">grpc_pass</a>指令引用的服务器组</p>
<p>参数说明:</p>
<p>weight 表示权重。默认为1 。</p>
<p>max_fails = 2 表示持续时间内与服务器通信失败2次，则认为该服务器不可用。</p>
<p>fail_timeout=1s 代表健康检查(检查后台web是否ok，访问超时1秒，并两次超时，则认为不健康</p>
<p>负载均衡(lb load banlance)一般要注意四个方面:</p>
<p>1,算法 round-robin</p>
<p>2,健康检查</p>
<p>3,会话保持 </p>
<p>4,数据一致   rsync  drbd 　　 共享存储   　　分布式存储</p>
<p><strong>2.使用ip_hash.实现同一ip客户端一旦调到一台，就一直调那一台</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> upstream backendweb &#123;</span><br><span class="line">      ip_hash;   #在上个例子的基础上只加这一句;</span><br><span class="line">        server yichen2.com:81  weight&#x3D;1 max_fails&#x3D;2 fail_timeout&#x3D;1s;</span><br><span class="line">        server server2.com:82  weight&#x3D;1 max_fails&#x3D;2 fail_timeout&#x3D;1s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>nginx的ip_hash的意思是,如果一个客户端的访问被调度到其中一台后台服务器,那么同一个源IP来的</p>
<p>访问都只会被调到这个后台服务器；这里测试时，如果都用同一个网段的内网IP来做客户端测试，可能会</p>
<p>都只转到一个后台（因为nginx的hash算法是按网段来算的，如果是公网不同网段的客户端IP就不一样了）</p>
<p><strong>对于nginx的upstrem算法总结:</strong></p>
<p>1,round-robin 轮循（平均分配）</p>
<p>2,weight 权重（人为地分配权重，用于后台服务器性能不均的情况）</p>
<p>3,fair         响应时间（按后台的响应时间来分配，需要第三方模块，但如果后台服务器都在内网，就没太大必要使用这种算法了）</p>
<p>4,url_hash    按访问url的hash结果来分配请求，使每个url定向到同一个后端服务器，后端服务器为多台缓存时比较有效，提高缓存命中率（后面例子会讲）</p>
<p>5,ip_hash 在负载均衡的基础上加上会话保持（优点是配置方便，缺点是不能完全的负载均衡）</p>
<h2 id="4-nginx常用搭建方式"><a href="#4-nginx常用搭建方式" class="headerlink" title="4.nginx常用搭建方式"></a><strong>4.nginx常用搭建方式</strong></h2><p><strong>1.网站的数据切分</strong></p>
<p>什么是网站数据切分?</p>
<p>其实也是七层调度</p>
<p>比如我要把新浪新闻，新浪体育给分开</p>
<p><strong>方法1:</strong></p>
<p>用DNS的二级域名(直接dns解析成不同的ip)</p>
<p>新浪新闻  news.sina.com  新浪国内新闻　news.sina.com/china/ –说明没有用二级域名             </p>
<p>​              新浪国际新闻 news.sina.com/world/</p>
<p>​             新浪国内新闻　china.news.sina.com      #用了四级域名    </p>
<p>​              新浪国际新闻 world.news.sina.com</p>
<p>新浪体育　 sports.sina.com 新浪体育nba sports.sina.com/nba/</p>
<p>​               新浪体育nba nba.sports.sina.com  </p>
<p><strong>方法2:</strong></p>
<p>前端使用代理(squid,varnish,apache,nginx,haproxy)</p>
<p>通过代理软件七层调度来分离</p>
<p>location 网站数据切分</p>
<p>​      client(宿主机) 192.168.2.x</p>
<p>​                      192.168.2.19</p>
<p>​             nginx（虚拟机1） </p>
<p>​                      192.168.224.10</p>
<p>​         web1(虚拟机2)        web2(虚拟机3）</p>
<p>​        192.168.224.11        192.168.224.12</p>
<p>nginx配置如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">location &#x2F;nba&#x2F; &#123;</span><br><span class="line">	proxy_pass http:&#x2F;&#x2F;192.168.224.11&#x2F;;</span><br><span class="line">	proxy_set_header Host $host;</span><br><span class="line">	proxy_set_header X-Forwarded-For $remote_addr;		</span><br><span class="line">&#125;	</span><br><span class="line">location &#x2F;cba&#x2F; &#123;</span><br><span class="line">	proxy_pass http:&#x2F;&#x2F;192.168.224.12&#x2F;;</span><br><span class="line">	proxy_set_header Host $host;</span><br><span class="line">	proxy_set_header X-Forwarded-For $remote_addr;		</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后重启</p>
<p>接着在11和12服务器上操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">在11和12操作</span><br><span class="line">yum install -y httpd</span><br><span class="line">echo web2 &gt; &#x2F;var&#x2F;www&#x2F;html&#x2F;index.html</span><br><span class="line">systemctl restart httpd</span><br><span class="line">curl 192.168.224.12</span><br></pre></td></tr></table></figure>

<p>客户端验证</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;192.168.2.19&#x2F;nba&#x2F;</span><br><span class="line">web1</span><br><span class="line">http:&#x2F;&#x2F;192.168.2.19&#x2F;cba&#x2F;</span><br><span class="line">web2</span><br></pre></td></tr></table></figure>

<p><strong>2.网站动静分离</strong></p>
<p>把location段修改为如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">location ~* \.(html|htm|gif|jpeg|jpg|css|js|png|swf)$ &#123;</span><br><span class="line">		proxy_pass http:&#x2F;&#x2F;192.168.224.11;</span><br><span class="line">		proxy_set_header Host $host;</span><br><span class="line">		proxy_set_header X-Forwarded-For $remote_addr;			</span><br><span class="line">    &#125;  #静态文件走这台服务器</span><br><span class="line">    </span><br><span class="line">    location ~  \.(php|cgi|txt)$ &#123;</span><br><span class="line">		proxy_pass http:&#x2F;&#x2F;192.168.224.12;  #使用正则表达式IP后面不用加&#x2F;号，会报错</span><br><span class="line">		proxy_set_header Host $host;</span><br><span class="line">		proxy_set_header X-Forwarded-For $remote_addr;</span><br><span class="line">    &#125;  #动态文件php|cgi等，走这台服务器。</span><br></pre></td></tr></table></figure>

<h2 id="5-nginx集群搭建"><a href="#5-nginx集群搭建" class="headerlink" title="5.nginx集群搭建"></a><strong>5.nginx集群搭建</strong></h2><p>​                          client     192.168.2.x     </p>
<p>​                                |</p>
<p>​                                 |    192.168.2.19(模拟网站公网ip，整个架构的域名假设为server1.com )</p>
<p>​                  nginx 反向代理           192.168.224.10 </p>
<p>​                                 ｜        </p>
<p>​                 －－－－－－－－－－－</p>
<p>​                                  ｜                        ｜   命中 hit 直接返回  </p>
<p>动态程序文件.php  ｜                         |</p>
<p>​                                 ｜               squid（web加速，缓存静态文件或图片) </p>
<p>直接找web             ｜                              |            192.168.224.12</p>
<p>​                 －－－－                                 |  没命中 miss 找后端web去取</p>
<p>​                                  ｜        |                       </p>
<p>​                              lnmp &lt;—- | </p>
<p>​                        192.168.224.11</p>
<p>实验前准备：</p>
<p>1,所有机器配置主机名并在/etc/hosts里互相绑定主机</p>
<p>2,几台服务器都能互相连接ping通</p>
<p>创建4台centos</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">创建网络</span><br><span class="line">docker network create -d bridge mynginx</span><br><span class="line"></span><br><span class="line">创建centos容器。</span><br><span class="line">centos容器</span><br><span class="line">docker run -it --restart&#x3D;always --privileged&#x3D;true --name centos -p 88:80 -h centos --network mynginx  -v &#x2F;etc&#x2F;localtime:&#x2F;etc&#x2F;localtime -d centos:7 &#x2F;usr&#x2F;sbin&#x2F;init</span><br><span class="line"></span><br><span class="line">centos1容器</span><br><span class="line">docker run -it --restart&#x3D;always  --privileged&#x3D;true --name centos1 -p 8080:80 -h centos1 --network mynginx  -v &#x2F;etc&#x2F;localtime:&#x2F;etc&#x2F;localtime -d centos:7 &#x2F;usr&#x2F;sbin&#x2F;init</span><br><span class="line"></span><br><span class="line">centos2容器</span><br><span class="line">docker run -it --restart&#x3D;always  --privileged&#x3D;true --name centos2  -h centos2 --network mynginx  -v &#x2F;etc&#x2F;localtime:&#x2F;etc&#x2F;localtime -d centos:7 &#x2F;usr&#x2F;sbin&#x2F;init</span><br><span class="line"></span><br><span class="line">centos3容器</span><br><span class="line">docker run -it --restart&#x3D;always --privileged&#x3D;true --name centos3  -h centos3 --network mynginx  -v &#x2F;etc&#x2F;localtime:&#x2F;etc&#x2F;localtime -d centos:7 &#x2F;usr&#x2F;sbin&#x2F;init</span><br></pre></td></tr></table></figure>

<p>分别进去容器测试是否正常ping通</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it centos &#x2F;bin&#x2F;bash</span><br><span class="line"></span><br><span class="line">docker exec -it centos1 &#x2F;bin&#x2F;bash</span><br><span class="line"></span><br><span class="line">docker exec -it centos2 &#x2F;bin&#x2F;bash</span><br><span class="line"></span><br><span class="line">docker exec -it centos3 &#x2F;bin&#x2F;bash</span><br><span class="line"></span><br><span class="line">安装相关命令</span><br><span class="line">yum provides ip</span><br><span class="line"></span><br><span class="line">yum install -y iproute net-tools vim</span><br><span class="line"></span><br><span class="line">ping centos1</span><br><span class="line">ping centos2</span><br><span class="line">ping centos3</span><br><span class="line"></span><br><span class="line">vim &#x2F;etc&#x2F;hosts</span><br><span class="line">增加</span><br><span class="line"></span><br><span class="line">172.30.0.2      centos  centos.com</span><br><span class="line">172.30.0.3      centos1 centos1.com</span><br><span class="line">172.30.0.4      centos2 centos2.com</span><br><span class="line">172.30.0.5      centos3 centos3.com</span><br></pre></td></tr></table></figure>



<p><strong>开始部署</strong></p>
<h3 id="第一大步-配置discuz论坛"><a href="#第一大步-配置discuz论坛" class="headerlink" title="第一大步:配置discuz论坛"></a>第一大步:配置discuz论坛</h3><p><strong>1.在上图中的lnmp服务器上安装并配置discuz论坛</strong></p>
<p>centos1上操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">yum install epel-release -y</span><br><span class="line">	yum install mariadb mariadb-server php php-mysql php-gd libjpeg\* php-ldap php-odbc php-pear php-xml php-xmlrpc php-mbstring php-bcmath php-mhash php-fpm  php-pecl-zendopcache nginx -y</span><br><span class="line"></span><br><span class="line">rpm -qa|grep php</span><br><span class="line"></span><br><span class="line">systemctl restart mariadb.service</span><br><span class="line">systemctl enable mariadb.service</span><br><span class="line">systemctl status mariadb.service</span><br><span class="line">设置新密码</span><br><span class="line">mysqladmin password &#39;123.yichen&#39;</span><br></pre></td></tr></table></figure>

<p><strong>2.优化php-fpm</strong></p>
<p>优化php-fpm，并启动(php-fpm为php的fastcgi模式，简单来说就是php的服务模式)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> vim &#x2F;etc&#x2F;php-fpm.d&#x2F;www.conf   #打开php-fpm主配置文件并进行优化(以下优化在生产环境视具体情况而定)</span><br><span class="line"> </span><br><span class="line">12  listen &#x3D; &#x2F;var&#x2F;run&#x2F;php-fpm&#x2F;fastcgi.socket	#原来是监听127.0.0.1:9000也是可以的，我这里换成socket来做(本机连接可以使用socket或tcp&#x2F;ip协议方式，远程连接只能使用tcp&#x2F;ip协议方式)</span><br><span class="line"></span><br><span class="line">31 listen.owner &#x3D; nginx</span><br><span class="line">32 listen.group &#x3D; nginx		#socket文件的权限设置。用户与组和跑nginx服务的用户一致，避免权限问题（如果前面使用的是tcp&#x2F;ip的方式，这里就注释就好)</span><br><span class="line">33 listen.mode &#x3D; 0666</span><br><span class="line"></span><br><span class="line">39 user &#x3D; nginx			#用户与组和跑nginx服务的用户一致，避免权限问题	</span><br><span class="line">41 group &#x3D; nginx</span><br><span class="line"></span><br><span class="line">60 pm &#x3D; dynamic           #对于专用服务器，pm可以设置为static。如果选择static，则由pm.max_children指定固定的子进程数。如果选择dynamic,则可以动态调整下面几个参数</span><br><span class="line">70 pm.max_children &#x3D; 64	　#子进程最大数,我这里只是参考值（看系统资源决定，视实际环境测试后调整，下几个参数也一样）</span><br><span class="line">75 pm.start_servers &#x3D; 20　	#启动时默认启动的进程数</span><br><span class="line">80 pm.min_spare_servers &#x3D; 5	#保证空闲进程数最小值，如果空闲进程小于此值，则创建新的子进程</span><br><span class="line">85 pm.max_spare_servers &#x3D; 35    #保证空闲进程数最大值，如果空闲进程大于此值，此进行清理</span><br><span class="line"></span><br><span class="line">160 rlimit_files &#x3D; 65535     #打开的文件描述符数量，不能大于系统的限制（系统可以使用ulimit命令查看和设置，后面有例子)</span><br><span class="line">218 php_flag[display_errors] &#x3D; on	#打开php错误显示功能</span><br></pre></td></tr></table></figure>

<p>修改php-fpm的权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown nginx.nginx &#x2F;var&#x2F;run&#x2F;php-fpm&#x2F; -R</span><br></pre></td></tr></table></figure>

<p>设置系统打开的文件描述符数量，与上面的配置对应</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ulimit -n</span><br><span class="line"></span><br><span class="line">ulimit -SHn 65535</span><br><span class="line"></span><br><span class="line">echo &quot;ulimit -SHn 65535&quot; &gt;&gt; &#x2F;etc&#x2F;rc.local （设置永久生效）</span><br></pre></td></tr></table></figure>

<p>启动php-fpm服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl start php-fpm.service</span><br><span class="line">systemctl status php-fpm.service </span><br><span class="line">systemctl enable php-fpm.service</span><br></pre></td></tr></table></figure>

<p><strong>3.配置nginx</strong></p>
<p>nginx的配置server段修改如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">  server &#123;</span><br><span class="line">        listen       80 default_server;</span><br><span class="line">        listen       [::]:80 default_server;</span><br><span class="line">        server_name  centos1.com;</span><br><span class="line">        root         &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;</span><br><span class="line">         index index.php index.html;</span><br><span class="line">        include &#x2F;etc&#x2F;nginx&#x2F;default.d&#x2F;*.conf;</span><br><span class="line"></span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">	location ~\.php$ &#123;</span><br><span class="line">	    fastcgi_pass    127.0.0.1:9000; #表示转发到本地的9000端口php处理此类文件</span><br><span class="line">            fastcgi_index  index.php;	</span><br><span class="line">            fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;</span><br><span class="line">            include        fastcgi_params;</span><br><span class="line">	    include &#x2F;etc&#x2F;nginx&#x2F;fastcgi.conf;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl start nginx.service        #80端口不要被其它服务（如httpd）占用了</span><br><span class="line">systemctl enable nginx.service</span><br><span class="line">systemctl status nginx.service</span><br><span class="line"> curl -I 127.0.0.1   #(访问本机80端口，验证Nginx服务)</span><br></pre></td></tr></table></figure>

<p><strong>4.测试nginx工作是否支持PHP</strong></p>
<p>在nginx家目录里加上php测试页</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> vim &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;test.php</span><br><span class="line"> </span><br><span class="line"> &lt;?php</span><br><span class="line">        phpinfo();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>在浏览器输入地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;server1.com:8080&#x2F;test.php</span><br><span class="line"></span><br><span class="line">curl -i  centos1.com&#x2F;test.php</span><br></pre></td></tr></table></figure>

<p>如果有出现php的版本信息，说明架构搭建好了。</p>
<p><strong>1,解压discuz到nginx家目录</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">yum install -y unzip</span><br><span class="line">mkdir &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;discuz&#x2F;</span><br><span class="line">通过主机把包往容器里面复制。</span><br><span class="line">docker cp Discuz_X3.3_SC_UTF8.zip centos1:&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;discuz&#x2F;</span><br><span class="line"></span><br><span class="line">unzip Discuz_X3.3_SC_UTF8.zip -d &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;discuz&#x2F;</span><br><span class="line"></span><br><span class="line">cd &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;discuz&#x2F;</span><br><span class="line"></span><br><span class="line">mv upload&#x2F;* .&#x2F;</span><br><span class="line"> rm upload&#x2F; -rf</span><br></pre></td></tr></table></figure>

<p>环境检查这一步，有些目录和文件权限需要修改(下面直接使用简单方式全改成nginx的owner和group)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown nginx.nginx &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;discuz -R</span><br></pre></td></tr></table></figure>

<p><strong>2.mariadb数据库授权</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql -p</span><br><span class="line">MariaDB [(none)]&gt; create database discuz;  #创建一个库，用于存放将要安装的discuz论坛的表</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; grant all on discuz.* to &#39;discuz&#39;@&#39;localhost&#39; identified by &#39;123&#39;;   #授权一个用户，用于discuz论坛程序连接mysql</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; flush privileges;</span><br></pre></td></tr></table></figure>

<p><strong>3.开始访问</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;192.168.224.11:8080&#x2F;discuz&#x2F;</span><br><span class="line">填上对应的数据库地址,库,用户,密码。开始安装</span><br><span class="line">    On web page wizard:</span><br><span class="line">        选择：全新安装 Discuz! X (含 UCenter Server)</span><br><span class="line">        数据库名:discuz</span><br><span class="line">        数据库用户名：discuz</span><br><span class="line">        数据库密码：123</span><br><span class="line">        管理员密码：123</span><br><span class="line">        重复密码：123</span><br><span class="line"></span><br><span class="line">如果发现权限不可写，把权限改下就可以了。</span><br><span class="line">chmod o+w &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;discuz&#x2F;* -R</span><br></pre></td></tr></table></figure>

<p><strong>4.测试论坛</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;192.168.224.11:8080&#x2F;discuz&#x2F;forum.php 测试论坛</span><br></pre></td></tr></table></figure>

<h3 id="第二大步-在上图中的nginx服务器上安装并配置nginx"><a href="#第二大步-在上图中的nginx服务器上安装并配置nginx" class="headerlink" title="第二大步:在上图中的nginx服务器上安装并配置nginx"></a>第二大步:在上图中的nginx服务器上安装并配置nginx</h3><p>centos上操作 <strong>这部可以在宿主机操作</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install nginx -y</span><br></pre></td></tr></table></figure>

<p>配置文件如下 http段的内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">upstream squid &#123;</span><br><span class="line">    server centos2.com;</span><br><span class="line">&#125;</span><br><span class="line">upstream web &#123;</span><br><span class="line">    server centos1.com;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> server &#123;</span><br><span class="line">        listen       80 default_server;</span><br><span class="line">        listen       [::]:80 default_server;</span><br><span class="line">        server_name  192.168.224.11;  #替换为实际的名字</span><br><span class="line">        root         &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;</span><br><span class="line"></span><br><span class="line">        include &#x2F;etc&#x2F;nginx&#x2F;default.d&#x2F;*.conf;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       location ~ .*\.php$ &#123;</span><br><span class="line">            proxy_pass   http:&#x2F;&#x2F;web;</span><br><span class="line">            proxy_set_header Host $host;</span><br><span class="line">            proxy_set_header X-Forwarded-For $remote_addr;</span><br><span class="line">        &#125;</span><br><span class="line">        location ~ .*\.(html|htm|gif|jpeg|jpg|css|js|png|swf)$ &#123;</span><br><span class="line">            proxy_pass   http:&#x2F;&#x2F;squid;</span><br><span class="line">            proxy_set_header Host $host;</span><br><span class="line">            proxy_set_header X-Forwarded-For $remote_addr;</span><br><span class="line">        &#125;</span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">            proxy_pass   http:&#x2F;&#x2F;squid;</span><br><span class="line">            proxy_set_header Host $host;</span><br><span class="line">            proxy_set_header X-Forwarded-For $remote_addr;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>重启nginx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart nginx</span><br></pre></td></tr></table></figure>

<h3 id="第三大步-安装并配置squid"><a href="#第三大步-安装并配置squid" class="headerlink" title="第三大步:安装并配置squid"></a>第三大步:安装并配置squid</h3><p>1.在上图中的squid服务器上安装并配置squid</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install squid -y</span><br></pre></td></tr></table></figure>

<p>2.配置squid主配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> vim &#x2F;etc&#x2F;squid&#x2F;squid.conf </span><br><span class="line"> </span><br><span class="line"> http_access allow all		#把这一行前面的全删除，再把这行修改成允许所有。注意！有多个重复的http_access，都要删除</span><br><span class="line"> </span><br><span class="line"> http_port 80 accel vhost vport  #修改成支持反向代理模式，端口也为80与nginx的配置对应(这里如果用3128也可以，nginx和这里对应的端口也要改成3128，并且后面清缓存的http:&#x2F;&#x2F;192.168.2.19&#x2F;static&#x2F;image&#x2F;common&#x2F;logo.png要改成http:&#x2F;&#x2F;192.168.2.19:3128&#x2F;static&#x2F;image&#x2F;common&#x2F;logo.png)</span><br><span class="line"></span><br><span class="line">cache_dir ufs &#x2F;var&#x2F;spool&#x2F;squid 256 16 256	#打开缓存目录的定义这一句</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cache_peer 172.30.0.3 parent 80 0 no-query originserver name&#x3D;web    172.30.0.3是 lnmp server</span><br><span class="line">cache_peer_domain web 192.168.224.11	</span><br><span class="line">#加上这两句,表示代理后台的lnmp的80端口;server1.com为网站的域名,192.168.2.19为我这个架构最前端的nginx的IP</span><br></pre></td></tr></table></figure>

<p><img src="https://s1.ax1x.com/2020/08/03/adiH1J.png" alt="adiH1J.png"></p>
<p>3,启动squid</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> yum install openssl -y #需要安装OpenSSL，否则无法启动squid</span><br><span class="line"></span><br><span class="line">在&#x2F;etc&#x2F;hosts中配置nginx的外部网卡IP和域名的绑定</span><br><span class="line"></span><br><span class="line">systemctl restart squid</span><br></pre></td></tr></table></figure>

<p>查询目前所有缓存的资料</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;bin&#x2F;squidclient -p 80 mgr:objects | grep png</span><br></pre></td></tr></table></figure>

<h3 id="第四大步-验证"><a href="#第四大步-验证" class="headerlink" title="第四大步:验证"></a>第四大步:验证</h3><p>在客户端机器192.168.2.x上首先绑定静态DNS </p>
<p>#用于模拟DNS，如果不绑定，也可以直接使用公网IP192.168.2.19来访问，因为在squid里配置了（cache_peer_domain web server1.com   和 cache_peer_domain web 192.168.2.19 两句)</p>
<p>cat /etc/hosts</p>
<p>192.168.2.19 server1.com #IP要为前端nginx的IP，名字为这个网站的域名要和squid里的cache_peer_domain web server1.com 要对应</p>
<p>1,在客户端用firefox访问<a href="http://server1.com/discuz%E6%88%96http://192.168.2.19/discuz%E6%98%AF%E5%8F%AF%E4%BB%A5%E6%AD%A3%E5%B8%B8%E7%9C%8B%E5%88%B0%E6%88%91%E7%9A%84lnmp%E5%AE%89%E8%A3%85%E7%9A%84discuz%E8%AE%BA%E5%9D%9B">http://server1.com/discuz或http://192.168.2.19/discuz是可以正常看到我的lnmp安装的discuz论坛</a></p>
<p>2,在客户端使用下面的命令验证discuz论坛的一个logo,可以看到在squid上命中的信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -I http:&#x2F;&#x2F;192.168.224.11:&#x2F;discuz&#x2F;static&#x2F;image&#x2F;common&#x2F;logo.png</span><br></pre></td></tr></table></figure>

<p>[<img src="https://s1.ax1x.com/2020/08/03/adFShD.png" alt="adFShD.png"></p>
<p> 3,关闭squid,在客户端用firefox访问,会发现整个网站都没有图片(静态的元素)</p>
<p>用curl -I <a href="http://server1.com/discuz/static/image/common/logo.png%E6%9D%A5%E9%AA%8C%E8%AF%81%E4%B9%9F%E4%BC%9A%E6%8A%A5%E9%94%99">http://server1.com/discuz/static/image/common/logo.png来验证也会报错</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -I http:&#x2F;&#x2F;server1.com&#x2F;discuz&#x2F;static&#x2F;image&#x2F;common&#x2F;logo.png</span><br><span class="line">报502错误</span><br></pre></td></tr></table></figure>

<p>因为我的架构里只有一台squid,再次启动squid后,一切又恢复正常</p>
<p>4,关于squid手动清缓存</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;squid&#x2F;squid.conf</span><br><span class="line"></span><br><span class="line">acl purge_admin src 127.0.0.1  #设定管理员为purge_admin 从本地可以清除缓存</span><br><span class="line">acl purge method PURGE         </span><br><span class="line">http_access allow purge_admin purge  #允许purge_admin执行purge</span><br><span class="line">http_access deny all purge           #默认禁止所有用户操作清除缓存</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> systemctl restart squid</span><br></pre></td></tr></table></figure>

<p>最基本的清除一条缓存的操作,必须要在squid本机执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">squidclient -m PURGE -h 127.0.0.1 -p 80 http:&#x2F;&#x2F;192.168.224.11&#x2F;discuz&#x2F;static&#x2F;image&#x2F;common&#x2F;logo.png</span><br><span class="line"># -h参数后只能接127.0.0.1;-p 80是squid的监听端口;最后的路径就是客户端访问的路径</span><br><span class="line">清除缓存后再到客户端访问，就变成miss了</span><br></pre></td></tr></table></figure>

<p>如果要批量清除squid,可以使用下面的脚本(你需要修改成自己对应的路径)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> vim &#x2F;tmp&#x2F;purge_squid.sh</span><br><span class="line"> </span><br><span class="line"> #!&#x2F;bin&#x2F;bash</span><br><span class="line">squidcache_path&#x3D;&quot;&#x2F;var&#x2F;spool&#x2F;squid&#x2F;&quot;</span><br><span class="line">squidclient_path&#x3D;&quot;&#x2F;usr&#x2F;bin&#x2F;squidclient&quot;</span><br><span class="line">grep -a -r $1 $squidcache_path&#x2F;* | strings | grep ^&quot;http&quot; | while read url</span><br><span class="line">do</span><br><span class="line">$squidclient_path -h 127.0.0.1 -m PURGE -p 80 $url &gt; &#x2F;dev&#x2F;null 2&gt;&amp;1</span><br><span class="line">echo &quot;$url被清除&quot;</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">注意：脚本的squidcache_path修改成你对应的缓存目录，squidclient_path修改成squidclient命令的路径；-h 127.0.0.1是因为我做了acl限制的，所以只能在squid本机上清除</span><br><span class="line"></span><br><span class="line">批量清除的方法:</span><br><span class="line">sh &#x2F;tmp&#x2F;purge_squid.sh .txt   #表示清除所有的.txt结尾的缓存</span><br><span class="line">sh &#x2F;tmp&#x2F;purge_squid.sh .      #表示清除所有缓存</span><br><span class="line">sh &#x2F;tmp&#x2F;purge_squid.sh &#x2F;aaa&#x2F;  #表示url里有&#x2F;aaa&#x2F;路径就清掉缓存</span><br></pre></td></tr></table></figure>

<p>在上面的架构基础上多加一台squid2(我这里IP为172.30.0.5),</p>
<p>client 192.168.2.x</p>
<p>​                   |</p>
<p>​                   | 192.168.2.19</p>
<p>​                   nginx   </p>
<p>​                   | 192.168.224.11</p>
<p>​                   |</p>
<p>​               |————|—————      </p>
<p>​               |         |       |</p>
<p>​               |      squid1              squid2    centos3.com</p>
<p>​               |      centos2.com </p>
<p>​               |————|</p>
<p>​                   |</p>
<p>​                   | </p>
<p>​                   lnmp</p>
<p>​                 centos1.com</p>
<p>以下练习在Squid2进行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install openssl -y</span><br><span class="line">yum install squid -y</span><br></pre></td></tr></table></figure>

<p>在squid2中安装squid软件，配置文件与squid服务器中的配置保持一致/etc/squid/squid.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;squid&#x2F;squid.conf</span><br><span class="line"></span><br><span class="line">http_access allow all</span><br><span class="line"></span><br><span class="line">acl purge_admin src 127.0.0.1</span><br><span class="line">acl purge method PURGE</span><br><span class="line">http_access allow purge_admin purge</span><br><span class="line">http_access deny all purge</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Squid normally listens to port 3128</span><br><span class="line">http_port 80 accel vhost vport</span><br><span class="line"></span><br><span class="line"># Uncomment and adjust the following to add a disk cache directory.</span><br><span class="line">cache_dir ufs &#x2F;var&#x2F;spool&#x2F;squid 256 16 256</span><br><span class="line">cache_peer 172.30.0.3 parent 80 0 no-query originserver name&#x3D;web</span><br><span class="line">cache_peer_domain web server.example.com</span><br><span class="line">cache_peer_domain web 192.168.224.11</span><br><span class="line"></span><br><span class="line"># Leave coredumps in the first cache dir</span><br><span class="line">coredump_dir &#x2F;var&#x2F;spool&#x2F;squid</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># Add any of your own refresh_pattern entries above these.</span><br><span class="line">#</span><br><span class="line">refresh_pattern ^ftp:           1440    20%     10080</span><br><span class="line">refresh_pattern ^gopher:        1440    0%      1440</span><br><span class="line">refresh_pattern -i (&#x2F;cgi-bin&#x2F;|\?) 0     0%      0</span><br><span class="line">refresh_pattern .               0       20%     4320</span><br></pre></td></tr></table></figure>

<p>重启2台squid服务器上的squid服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart squid</span><br></pre></td></tr></table></figure>

<p>做法，在nginx配置要修改为下面一段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">upstream squid &#123;</span><br><span class="line">    server 172.30.0.4 weight&#x3D;1 max_fails&#x3D;2 fail_timeout&#x3D;3s;</span><br><span class="line">    server 172.30.0.5 weight&#x3D;1 max_fails&#x3D;2 fail_timeout&#x3D;3s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">systemctl restart nginx</span><br></pre></td></tr></table></figure>

<p>在客户端用curl -I去测试多个不同的文件请求，看缓存情况,如:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -I http:&#x2F;&#x2F;server1.com&#x2F;discuz&#x2F;static&#x2F;image&#x2F;common&#x2F;logo.png</span><br><span class="line">curl -I http:&#x2F;&#x2F;server1.com&#x2F;discuz&#x2F;static&#x2F;image&#x2F;feed&#x2F;task_b.png</span><br><span class="line">curl -I http:&#x2F;&#x2F;server1.com&#x2F;discuz&#x2F;static&#x2F;image&#x2F;feed&#x2F;album_b.png</span><br><span class="line">curl -I http:&#x2F;&#x2F;server1.com&#x2F;discuz&#x2F;static&#x2F;image&#x2F;feed&#x2F;portal_b.png</span><br><span class="line">curl -I http:&#x2F;&#x2F;server1.com&#x2F;discuz&#x2F;static&#x2F;image&#x2F;feed&#x2F;wall_b.png</span><br></pre></td></tr></table></figure>

<p>测试结果为:第一次squid1(conts2),第二次squid2(centos3),第三次squid1…以此类推(round-robin)</p>
<p>但这个做法的缺点为:比如同一个url的请求，连续访问，它也会RR轮循给squid1和squid2，这样会造成两个squid重复缓存。</p>
<p>改进的做法为:使用nginx的url_hash的算法，把同一个url的请求只给同一个后台squid，以提高缓存命中率。如果要做这个改进的话，只需要把nginx的配置再修改成如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream squid &#123;</span><br><span class="line">    hash $request_uri;</span><br><span class="line">    server 172.30.0.4 weight&#x3D;1 max_fails&#x3D;2 fail_timeout&#x3D;3s;</span><br><span class="line">    server 172.30.0.5 weight&#x3D;1 max_fails&#x3D;2 fail_timeout&#x3D;3s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再次测试:</p>
<p>结果为:新的请求仍然会RR轮循调给squid1和squid2，但已经请求过的地址再次被请求，会调给第一次调的squid，提高缓存命中率。</p>
<p> 查询缓存</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;bin&#x2F;squidclient -p 80 mgr:objects | grep png</span><br></pre></td></tr></table></figure>



<h3 id="nginx又做反向代理又做缓存"><a href="#nginx又做反向代理又做缓存" class="headerlink" title="nginx又做反向代理又做缓存"></a>nginx又做反向代理又做缓存</h3><p>在上面的架构中，把squid去掉，由nginx又做反向代理，又做缓存</p>
<p>nginx做缓存需要一个另外一个软件(ngx_cache_purge)</p>
<p>下载网址为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget  http:&#x2F;&#x2F;labs.frickle.com&#x2F;files&#x2F;ngx_cache_purge-2.3.tar.gz</span><br></pre></td></tr></table></figure>

<p>这时候nginx需要重新源码安装，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">下面的源码包都可以，一个是旧版本，一个是新版本。</span><br><span class="line">wget  http:&#x2F;&#x2F;nginx.org&#x2F;download&#x2F;nginx-1.8.1.tar.gz</span><br><span class="line">wget http:&#x2F;&#x2F;nginx.org&#x2F;download&#x2F;nginx-1.12.2.tar.gz</span><br></pre></td></tr></table></figure>

<p>架构图，在上面做的基础上把squid去掉。</p>
<p>client     192.168.2.x      </p>
<p>​              |</p>
<p>​              |    192.168.2.19</p>
<p>​             nginx 反向代理加缓存  </p>
<p>​              |      192.168.224.11</p>
<p>​              |</p>
<p>​             lnmp         </p>
<p>​                  cetos1.com</p>
<p> 192.168.224.11虚拟机在上一个实验的基础上继续做。但是需要停掉nginx（恢复快照也可以，但是要</p>
<p>自己创建nginx用户，useradd -s /usr/sbin/nologin nginx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ystemctl stop nginx</span><br><span class="line">systemctl disable nginx</span><br></pre></td></tr></table></figure>

<p>第一步:</p>
<p>先把squid停掉</p>
<p>使用源码版本编译</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install pcre-devel zlib-devel gcc  openssl-devel -y</span><br></pre></td></tr></table></figure>

<p>复制压缩包到本地</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tar xf nginx-1.8.1.tar.gz -C &#x2F;usr&#x2F;src&#x2F;</span><br><span class="line"></span><br><span class="line">tar xf ngx_cache_purge-2.3.tar.gz -C &#x2F;usr&#x2F;src&#x2F;</span><br><span class="line">cd &#x2F;usr&#x2F;src&#x2F;nginx-1.8.1&#x2F;</span><br><span class="line"></span><br><span class="line">.&#x2F;configure --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx --user&#x3D;nginx --group&#x3D;nginx --with-http_gzip_static_module  --with-http_stub_status_module  --add-module&#x3D;..&#x2F;ngx_cache_purge-2.3&#x2F;</span><br><span class="line"></span><br><span class="line">使用--add-module&#x3D;..&#x2F;ngx_cache_purge-2.3&#x2F;参数加上缓存模块的功能，两个目录是同级目录（从编译的路径可以看出来）</span><br></pre></td></tr></table></figure>

<p>如果上一步执行报错需要安装gcc: yum -y install gcc</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<p>第二步：</p>
<p>修改nginx主配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">user  nginx;</span><br><span class="line">worker_processes  auto;</span><br><span class="line">error_log  logs&#x2F;error.log  info;</span><br><span class="line">pid        logs&#x2F;nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  65535;</span><br><span class="line">    use epoll;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application&#x2F;octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span><br><span class="line">                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span><br><span class="line">                      &#39;&quot;$http_user_agent&quot; &quot;$upstream_cache_status&quot;&#39;;</span><br><span class="line">    sendfile        on;</span><br><span class="line">    tcp_nopush     on;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line">    gzip on;</span><br><span class="line"></span><br><span class="line">    proxy_temp_path   &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;proxy_temp_dir 1 2;</span><br><span class="line">    proxy_cache_path  &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;proxy_cache_dir&#x2F;cache  levels&#x3D;1:2 keys_zone&#x3D;cache:100m inactive&#x3D;1d max_size&#x3D;10g;	</span><br><span class="line"></span><br><span class="line">upstream web &#123;</span><br><span class="line">    server 172.30.0.3 weight&#x3D;1 max_fails&#x3D;2 fail_timeout&#x3D;30s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  server1.com;</span><br><span class="line">	access_log  logs&#x2F;host.access.log  main;</span><br><span class="line"></span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">        proxy_pass   http:&#x2F;&#x2F;web;</span><br><span class="line">	    proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Forwarded-For $remote_addr;</span><br><span class="line">	    proxy_cache cache;</span><br><span class="line">	    proxy_cache_key $host$uri$is_args$args;</span><br><span class="line">	    proxy_cache_valid 200 304 10m;	</span><br><span class="line">        add_header X-Cache &#39;$upstream_cache_status from $host&#39;;</span><br><span class="line">	    expires 1d;</span><br><span class="line">        &#125;</span><br><span class="line">        location ~ .*\.(php|cgi)$ &#123;</span><br><span class="line">        proxy_pass   http:&#x2F;&#x2F;web;</span><br><span class="line">	    proxy_set_header Host $host;</span><br><span class="line">	    proxy_set_header X-Forwarded-For $remote_addr;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的配置参数说明</p>
<p>1、http段设置。</p>
<p>proxy_temp_path /usr/local/nginx/proxy_temp_dir;   #设置临时目录</p>
<p>proxy_cache_path /usr/local/nginx/proxy_cache_dir/cache levels=1:2 keys_zone=cache:100m inactive=1d max_size=10g;</p>
<p><strong>keys_zone=cache:100m</strong>           #表示这个zone名称为cache，分配的内存大小为100MB</p>
<p><strong>/usr/local/nginx/proxy_cache_dir/cache</strong>  #表示cache这个zone的文件要存放的目录</p>
<p><strong>levels=1:2</strong>   #表示缓存目录的第一级目录是1个字符，第二级目录是2个字符，即/usr/local/nginx/proxy_cache_dir/cache/a/1b这种形式</p>
<p><strong>inactive=1d</strong>  #表示这个zone中的缓存文件如果在1天内都没有被访问，那么文件会被cache manager进程删除掉</p>
<p><strong>max_size=10g</strong>   表示这个zone的硬盘容量为10GB</p>
<p>2、server段设置</p>
<p>proxy_cache cache;                                          #设置缓存共享内存区块，也就是keys_zone名称</p>
<p>proxy_cache_key $host$uri$is_args$args;    #设置缓存key</p>
<p>proxy_cache_valid 200 304 10m;                    #设置http状态码为200,304缓存时间为10分钟</p>
<p>add_header X-Cache ‘$upstream_cache_status from $host’;                #$upstream_cache_status表示资源缓存的状态，有HIT MISS EXPIRED三种状态</p>
<p>expires 1d;   #设置失期时间，为1天</p>
<p>保存主配置文件后，建立对应的缓存目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;proxy_cache_dir&#x2F;cache -p</span><br><span class="line"></span><br><span class="line">ls &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;proxy_cache_dir&#x2F;cache</span><br></pre></td></tr></table></figure>

<p>启动nginx</p>
<p>/usr/local/nginx/sbin/nginx</p>
<p>/usr/local/nginx/sbin/nginx -t</p>
<p><a href="https://imgchr.com/i/adFPcd"><img src="https://s1.ax1x.com/2020/08/03/adFPcd.jpg" alt="adFPcd.jpg"></a></p>
<p>如果遇到句柄限制就执行 ulimit -n 65535</p>
<p><img src="https://s1.ax1x.com/2020/08/03/adFABt.jpg" alt="adFABt.jpg"></p>
<p>参考：停止服务 /usr/local/nginx/sbin/nginx -s stop</p>
<p>警告信息没有了</p>
<p><img src="https://s1.ax1x.com/2020/08/03/adFm4S.jpg" alt="adFm4S.jpg"></p>
<p>创建软连接，可以方便启动</p>
<p>ln -s /usr/local/nginx/sbin/nginx /usr/local/sbin/nginx</p>
<p>nginx -s quit 停止nginx</p>
<p> 第三大步：</p>
<p>客户端测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1，使用下面的命令访问</span><br><span class="line"> curl -I http:&#x2F;&#x2F;192.168.224.11&#x2F;discuz&#x2F;static&#x2F;image&#x2F;common&#x2F;logo.png</span><br><span class="line">curl -I http:&#x2F;&#x2F;192.168.224.11&#x2F;discuz&#x2F;static&#x2F;image&#x2F;common&#x2F;logo.png</span><br><span class="line"></span><br><span class="line">第一次为MISS </span><br><span class="line">第二次为HIT</span><br></pre></td></tr></table></figure>

<p>2，在客户端用户firefox访问<a href="http://192.168.224.11/discuz,%E5%8F%AF%E4%BB%A5%E8%AE%BF%E9%97%AE%E6%95%B4%E4%B8%AAdiscuz%E8%AE%BA%E5%9D%9B">http://192.168.224.11/discuz,可以访问整个discuz论坛</a></p>
<p>在nginx上查看缓存目录，会看到很多子目录（缓存都在这些目录里)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;proxy_cache_dir&#x2F;cache</span><br></pre></td></tr></table></figure>

<p>3,nginx的缓存清除</p>
<p>在nginx服务器写一个脚本，如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;tmp&#x2F;purge_nginx_cache.sh</span><br><span class="line"></span><br><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">cachedir&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;proxy_cache_dir&#x2F;cache</span><br><span class="line"></span><br><span class="line">grep -ra  $1 $cachedir |grep $1 | awk -F&#39;:&#39; &#39;&#123;print $1,$3&#125;&#39;|while read cacheurl url</span><br><span class="line">do</span><br><span class="line">	rm  -rf  $cacheurl</span><br><span class="line">        echo &quot;$url 被清除&quot;</span><br><span class="line">done</span><br><span class="line">echo &quot;缓存清除成功&quot;</span><br></pre></td></tr></table></figure>

<p>清除方法为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash &#x2F;tmp&#x2F;purge_nginx_cache.sh .png$   #清除所有的.png结尾的缓存</span><br></pre></td></tr></table></figure>

<p>手动搜索缓存文件，txt后面要有$符号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -ra .png$ &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;proxy_cache_dir&#x2F;cache&#x2F;</span><br></pre></td></tr></table></figure>

<h2 id="6，nginx优化"><a href="#6，nginx优化" class="headerlink" title="6，nginx优化"></a><strong>6，nginx优化</strong></h2><h3 id="1-ab压力测试及nginx性能统计模块"><a href="#1-ab压力测试及nginx性能统计模块" class="headerlink" title="1.ab压力测试及nginx性能统计模块"></a>1.ab压力测试及nginx性能统计模块</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">windos下载地址</span><br><span class="line">https:&#x2F;&#x2F;www.apachehaus.com&#x2F;cgi-bin&#x2F;download.plx</span><br><span class="line"></span><br><span class="line">yum install -y httpd   #安装httpd 就有ab 这个工具了。</span><br><span class="line">yum -y install httpd-tools  #或者只下载工具</span><br><span class="line"></span><br><span class="line">测试场景：模拟1000个用户，对首页发起总共5万次请求。</span><br><span class="line">ab -c 1000 -n 50000  http:&#x2F;&#x2F;192.168.224.12&#x2F;index.html</span><br></pre></td></tr></table></figure>

<p><strong>ab常用参数的介绍：</strong></p>
<p>-n ：总共的请求执行数，缺省是1；</p>
<p>-c： 并发数，缺省是1；</p>
<p>-t：测试所进行的总时间，秒为单位，缺省50000s</p>
<p>-p：POST时的数据文件</p>
<p> -k   启用HTTP KeepAlive功能，即在一个HTTP会话中执行多个请求。默认时，不启用KeepAlive功能</p>
<p>-w: 以HTML表的格式输出结果</p>
<p>继续测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ab -c 2000 -n 80000  http:&#x2F;&#x2F;192.168.224.12&#x2F;index.html</span><br><span class="line">并发达到2000后服务器响应速度就变慢了，</span><br></pre></td></tr></table></figure>

<p><img src="https://s1.ax1x.com/2020/08/03/adFK3Q.png" alt="adFK3Q.png"></p>
<p>开始优化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ulimit -n   发现最大打开文件描述符是1024， 这时候要优化了，把改为最大65535</span><br><span class="line"></span><br><span class="line">ulimit -SHn 65535</span><br><span class="line">echo &quot;ulimit -SHn 65535&quot; &gt;&gt; &#x2F;etc&#x2F;rc.local （设置永久生效）</span><br></pre></td></tr></table></figure>

<p><strong>配置nginx性能统计模块</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        listen       80 ;</span><br><span class="line">        server_name  server2.com;  #工作中一般选择localhost</span><br><span class="line"></span><br><span class="line">        location &#x3D; &#x2F;status &#123;</span><br><span class="line">            access_log off;</span><br><span class="line">            stub_status on;</span><br><span class="line">            allow 127.0.0.1 ;</span><br><span class="line">         allow 192.168.224.12 ;</span><br><span class="line">        allow 192.168.224.1;</span><br><span class="line">            deny all; #限制所有</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">访问就能出现结果了；</span><br><span class="line">http:&#x2F;&#x2F;server2.com&#x2F;status </span><br><span class="line"></span><br><span class="line">Active connections: 2  #活跃连接数，并发</span><br><span class="line">server accepts handled requests</span><br><span class="line"> 750427 750427 747109 </span><br><span class="line">Reading: 0 Writing: 1 Waiting: 1</span><br></pre></td></tr></table></figure>

<p><strong>1.优化socket层面</strong></p>
<p>优化nginx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">worker_rlimit_nofile 10000; </span><br><span class="line">worker_processes auto;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 65535; #设置子进程能打开多少个sock连接。设置最大。</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>系统层面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;somaxconn #这里面都是系统运行状态的值。发现是128 把改大</span><br><span class="line">128</span><br><span class="line">echo 50000 &gt; &#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;somaxconn</span><br><span class="line"></span><br><span class="line">加快tcp连接的回收回收recycle</span><br><span class="line">cat &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_tw_recycle</span><br><span class="line">0 #表示不回收，</span><br><span class="line">echo 1 &gt;  &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_tw_recycle</span><br><span class="line"></span><br><span class="line">空的tcp是否允许回收利用reuse</span><br><span class="line">cat &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_tw_reuse</span><br><span class="line">0</span><br><span class="line">echo 1 &gt; &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_tw_reuse</span><br><span class="line"></span><br><span class="line">关闭洪峰防御</span><br><span class="line">cat &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_syncookies</span><br><span class="line">1</span><br><span class="line"></span><br><span class="line">echo 0 &gt; &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_syncookies</span><br></pre></td></tr></table></figure>

<p>直接写个脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vim tcpopt.sh</span><br><span class="line"></span><br><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line"></span><br><span class="line">echo 50000 &gt; &#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;somaxconn</span><br><span class="line">echo 1 &gt;  &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_tw_recycle</span><br><span class="line">echo 1 &gt; &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_tw_reuse</span><br><span class="line">echo 0 &gt; &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_syncookies</span><br></pre></td></tr></table></figure>

<p>这时候再去访问，会发现可以支持2000并发了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ab -c 2000 -n 100000   http:&#x2F;&#x2F;192.168.224.12&#x2F;index.html</span><br></pre></td></tr></table></figure>

<p>5千的并发,客户端撑不住了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ab -c 5000 -n 200000   http:&#x2F;&#x2F;192.168.224.12&#x2F;index.html</span><br></pre></td></tr></table></figure>

<p>客户端也优化下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ulimit -SHn 65535</span><br><span class="line">echo 50000 &gt; &#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;somaxconn</span><br></pre></td></tr></table></figure>

<p>用两台客户端测试分别5000并发</p>
<p>这时服务端还是可以支持共1万的并发</p>
<p>下面在测试其他参数加个-k参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ab -c 5000 -n 200000 -k  http:&#x2F;&#x2F;192.168.224.12&#x2F;index.html</span><br></pre></td></tr></table></figure>

<p>这时候会发现很多是Waiting状态。等待状态。</p>
<p>需要修改nginx的keeplive_timeout的时间</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">keepalive_timeout   65; #65秒太多了。对于高并发的网站，这个需要修改最小。</span><br><span class="line"></span><br><span class="line">keepalive_timeout   0;  #修改为0秒。</span><br></pre></td></tr></table></figure>

<p>系统层面的优化还有其他参数需要修改。可以向上面的动态修改关机重启就恢复默认了，也可以写入/etc/sysctl.conf文件中</p>
<p>如下参考:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;sysctl.conf</span><br><span class="line"></span><br><span class="line">fs.file-max &#x3D; 1000000</span><br><span class="line">fs.inotify.max_user_instances &#x3D; 8192</span><br><span class="line">net.ipv4.tcp_syncookies &#x3D; 1    #1是打开洪峰防御</span><br><span class="line">net.ipv4.tcp_fin_timeout &#x3D; 30</span><br><span class="line">net.ipv4.tcp_tw_reuse &#x3D; 1      # 对应上面的&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_tw_reuse 文件</span><br><span class="line">net.ipv4.ip_local_port_range &#x3D; 1024 65000</span><br><span class="line">net.ipv4.tcp_max_syn_backlog &#x3D; 16384</span><br><span class="line">net.ipv4.tcp_max_tw_buckets &#x3D; 6000</span><br><span class="line">net.ipv4.route.gc_timeout &#x3D; 100</span><br><span class="line">net.ipv4.tcp_syn_retries &#x3D; 1     #默认为6次尝试连接。大概就是63秒 ，所以改为1。</span><br><span class="line">net.ipv4.tcp_synack_retries &#x3D; 1</span><br><span class="line">net.core.somaxconn &#x3D; 50000     #对应上面的&#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;somaxconn 文件。</span><br><span class="line">net.core.netdev_max_backlog &#x3D; 32768</span><br><span class="line">net.ipv4.tcp_timestamps &#x3D; 0</span><br><span class="line">net.ipv4.tcp_max_orphans &#x3D; 32768</span><br><span class="line"># forward ipv4</span><br><span class="line">net.ipv4.ip_forward &#x3D; 1</span><br></pre></td></tr></table></figure>

<p>sync洪峰攻击测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y hping3</span><br><span class="line"></span><br><span class="line">hping3 -c 1000 -d 120 -S -w 64 -p 80 --flood --rand-source  192.168.224.12</span><br></pre></td></tr></table></figure>

<p>使用 netstart  -nat 会发现很多tcp的连接状态是属于SYN_RECV状态</p>
<p><img src="https://s1.ax1x.com/2020/08/03/adF3Bq.png" alt="adF3Bq.png"> </p>
</div><ul class="post-copyright"><li><strong>本文标题：</strong><a href="https://yc6.cool/2020/08/03/nginx基础/">nginx基础</a></li><li><strong>本文作者：</strong><a href="https://yc6.cool">yichen</a></li><li><strong>本文链接：</strong><a href="https://yc6.cool/2020/08/03/nginx基础/">https://yc6.cool/2020/08/03/nginx基础/</a></li><li><strong>版权声明：</strong><span>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明出处！</span></li></ul><div><div class="recommend-post"><span class="is-size-6 has-text-grey has-mr-7"># 相关文章</span><br><span>  1.<a class="is-size-6" href="/2023/05/17/Kubernetes%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2/" target="_blank">Kubernetes高可用集群二进制部署</a><br></span><span>  2.<a class="is-size-6" href="/2022/03/12/openresty%E7%BB%93%E5%90%88lua%E5%AF%B9%E5%90%8C%E4%B8%80%E6%9D%A1%E5%9F%9F%E5%90%8D%E5%88%A4%E6%96%AD%E5%8F%82%E6%95%B0%E5%81%9A%E8%B4%9F%E8%BD%BD/" target="_blank">openresty结合lua对域名参数做负载均衡</a><br></span><span>  3.<a class="is-size-6" href="/2021/07/31/nginx%E5%88%A4%E6%96%AD%E5%BE%AE%E4%BF%A1%E7%AB%AF%E8%B7%B3%E8%BD%AC%E4%B8%8D%E5%90%8C%E9%A1%B5%E9%9D%A2/" target="_blank">nginx判断微信端跳转不同页面</a><br></span><span>  4.<a class="is-size-6" href="/2020/09/30/nftables/" target="_blank">nftables</a><br></span><span>  5.<a class="is-size-6" href="/2020/08/04/k8s%E4%B8%ADYAML%E6%96%87%E4%BB%B6%E7%BC%96%E5%86%99%E4%B8%8E%E4%BD%BF%E7%94%A8/" target="_blank">k8s中yaml文件编写与使用</a><br></span><span>  6.<a class="is-size-6" href="/2020/08/04/k8s%E6%90%AD%E5%BB%BA/" target="_blank">kubernetes搭建</a><br></span><span>  7.<a class="is-size-6" href="/2020/08/04/%E5%88%9B%E5%BB%BAcentos%E9%95%9C%E5%83%8F%E6%94%AF%E6%8C%81ssh/" target="_blank">创建centos镜像支持ssh远程连接</a><br></span><span>  8.<a class="is-size-6" href="/2020/08/04/docker%E4%B8%80%E9%94%AE%E5%AE%89%E8%A3%85%E9%85%B7Q%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BAQQ%E6%9C%BA%E5%99%A8%E4%BA%BA/" target="_blank">docke一键安装酷Q搭建个人QQ机器人</a><br></span></div><div class="recommend-post"><span class="is-size-6 has-text-grey has-mr-7"># 推荐文章</span><br><span>  1.<a class="is-size-6" href="/2020/08/04/docker%E4%BD%BF%E7%94%A8/" target="_blank">docker的使用</a><br></span><span>  2.<a class="is-size-6" href="/2020/08/03/mysql%E5%9F%BA%E7%A1%80/" target="_blank">mysql基础</a><br></span><span>  3.<a class="is-size-6" href="/2020/08/03/nginx%E5%9F%BA%E7%A1%80/" target="_blank">nginx基础</a><br></span><span>  4.<a class="is-size-6" href="/2020/08/04/python3%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E9%87%8D%E7%82%B9/" target="_blank">python3基础知识重点</a><br></span><span>  5.<a class="is-size-6" href="/2023/05/07/Linux%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%B3%BB%E7%BB%9F%E7%9B%91%E6%8E%A7/" target="_blank">Prometheus监控linux</a><br></span><span>  6.<a class="is-size-6" href="/2023/05/10/Prometheus%E4%BD%BF%E7%94%A8%E9%82%AE%E7%AE%B1%E6%8E%A5%E6%94%B6%E5%91%8A%E8%AD%A6%E9%80%9A%E7%9F%A5/" target="_blank">Prometheus使用邮件接收告警通知</a><br></span></div></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/css/share.min.css"><div class="social-share"></div><script src="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button is-info donate"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="https://yichenxiu.com/tupian/tubiao/alipay1.jpg" alt="支付宝"></span></a><a class="button is-success donate"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="https://i.328888.xyz/2023/03/05/dZXCk.jpeg" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/08/03/nginx%E6%9C%AC%E5%9C%B0ssl%E8%AF%81%E4%B9%A6%E5%88%B6%E4%BD%9C/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">nginx本地ssl证书制作</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/08/03/Win10%E7%B3%BB%E7%BB%9F%E7%BC%BA%E6%8D%9F%E6%96%87%E4%BB%B6%E6%88%96%E8%80%85%E6%96%87%E4%BB%B6%E4%B8%A2%E5%A4%B1%E7%9A%84%E4%BF%AE%E5%A4%8D%E6%96%B9%E6%B3%95/"><span class="level-item">Win10系统缺损文件或者文件丢失修复方法</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/gitalk/1.6.0/gitalk.css"><script> $.getScript('/js/gitalk.min.js', function () { 
            var gitalk = new Gitalk({
            language:'zh-CN',
            id: '5d0a937847be41559b1297d8a075ec38',
            repo: 'issue_database',
            owner: 'zhi666',
            clientID: '1b861f81e9a79ee6028d',
            clientSecret: 'cc629aff090aa9c60d5e13ddf7fcfce14f00a478',
            admin: ["zhi666"],
            createIssueManually: true,
            distractionFreeMode: true,
            perPage: 10,
            pagerDirection: 'last',
            proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token',
            
            enableHotKey: true,
            isLocked: false
        })
        gitalk.render('comment-container')});</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1 is-sticky"><div class="card widget toc-scroll" id="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list toc"><li><a class="is-flex toc-item" id="toc-item-一-nginx基础" href="#一-nginx基础"><span>一.nginx基础</span></a><ul class="menu-list toc"><li><a class="is-flex toc-item" id="toc-item-1-nginx安装" href="#1-nginx安装"><span>1.nginx安装</span></a></li><li><a class="is-flex toc-item" id="toc-item-2-nginx配置" href="#2-nginx配置"><span>2.nginx配置</span></a><ul class="menu-list toc"><li><a class="is-flex toc-item" id="toc-item-1-nginx-conf配置文件" href="#1-nginx-conf配置文件"><span>1.nginx.conf配置文件</span></a></li><li><a class="is-flex toc-item" id="toc-item-2-配置nginx的正常访问" href="#2-配置nginx的正常访问"><span>2.配置nginx的正常访问</span></a></li><li><a class="is-flex toc-item" id="toc-item-3-nginx日志管理" href="#3-nginx日志管理"><span>3.nginx日志管理</span></a></li><li><a class="is-flex toc-item" id="toc-item-4-location的正则匹配" href="#4-location的正则匹配"><span>4.location的正则匹配</span></a></li><li><a class="is-flex toc-item" id="toc-item-1-url重写实战" href="#1-url重写实战"><span>1.url重写实战</span></a></li><li><a class="is-flex toc-item" id="toc-item-6-gzip压缩提升网站速度" href="#6-gzip压缩提升网站速度"><span>6. gzip压缩提升网站速度</span></a></li><li><a class="is-flex toc-item" id="toc-item-7-expires缓存提升网站负载" href="#7-expires缓存提升网站负载"><span>7.expires缓存提升网站负载</span></a></li><li><a class="is-flex toc-item" id="toc-item-8-HTTP跳转HTTPS协议几种方式性能对比" href="#8-HTTP跳转HTTPS协议几种方式性能对比"><span>8.HTTP跳转HTTPS协议几种方式性能对比</span></a></li></ul></li><li><a class="is-flex toc-item" id="toc-item-3-nginx负载均衡" href="#3-nginx负载均衡"><span>3.nginx负载均衡</span></a></li><li><a class="is-flex toc-item" id="toc-item-4-nginx常用搭建方式" href="#4-nginx常用搭建方式"><span>4.nginx常用搭建方式</span></a></li><li><a class="is-flex toc-item" id="toc-item-5-nginx集群搭建" href="#5-nginx集群搭建"><span>5.nginx集群搭建</span></a><ul class="menu-list toc"><li><a class="is-flex toc-item" id="toc-item-第一大步-配置discuz论坛" href="#第一大步-配置discuz论坛"><span>第一大步:配置discuz论坛</span></a></li><li><a class="is-flex toc-item" id="toc-item-第二大步-在上图中的nginx服务器上安装并配置nginx" href="#第二大步-在上图中的nginx服务器上安装并配置nginx"><span>第二大步:在上图中的nginx服务器上安装并配置nginx</span></a></li><li><a class="is-flex toc-item" id="toc-item-第三大步-安装并配置squid" href="#第三大步-安装并配置squid"><span>第三大步:安装并配置squid</span></a></li><li><a class="is-flex toc-item" id="toc-item-第四大步-验证" href="#第四大步-验证"><span>第四大步:验证</span></a></li><li><a class="is-flex toc-item" id="toc-item-nginx又做反向代理又做缓存" href="#nginx又做反向代理又做缓存"><span>nginx又做反向代理又做缓存</span></a></li></ul></li><li><a class="is-flex toc-item" id="toc-item-6，nginx优化" href="#6，nginx优化"><span>6，nginx优化</span></a><ul class="menu-list toc"><li><a class="is-flex toc-item" id="toc-item-1-ab压力测试及nginx性能统计模块" href="#1-ab压力测试及nginx性能统计模块"><span>1.ab压力测试及nginx性能统计模块</span></a></li></ul></li></ul></li></ul></div></div><script type="text/javascript" async>
        $(document).ready(function () { //参考自 https://github.com/ppoffice/hexo-theme-icarus/pull/616/files
            var observerTopMargin;
            var scrollObserver;
            var headerElems = $(".headerlink");
            var activeTocItem;
        
            function initIntersectionObserver(docHeight) {
                observerTopMargin = docHeight;
                scrollObserver = new IntersectionObserver(scrollCallBack,
                    {
                        root: null,  // viewpoint
                        rootMargin: docHeight + "px 0px -80% 0px"  // cover top 30% of viewport to the top of document
                    })
            }
        
            function scrollCallBack(entries, observer) {
                if ($(window).scrollTop() > observerTopMargin * 0.7) { 
                    // User somehow scroll to 70% of observerTopMargin (which is inited as 200% document height)
                    // Observer top margin need to extend to cover all the space to the top of the document
                    initIntersectionObserver(observerTopMargin * 2)
                    observer.disconnect();
                    return;
                }
                let toActive;
                if (entries[0].intersectionRatio == 1) {  // enter viewed area
                    let entry = entries.reduce((u, v) => (u.target.toc_id > v.target.toc_id ? u : v));  // get the lowest item
                    toActive = $("#toc-item-" + $(entry.target).attr("href").substr(1));
                } else {
                    let entry = entries.reduce((u, v) => (u.target.toc_id < v.target.toc_id ? u : v));  // get the highest item
                    let idx = Math.max(entry.target.toc_id - 1, 0);
                    toActive = $("#toc-item-" + $(headerElems[idx]).attr("href").substr(1));
                }
                if (activeTocItem) activeTocItem.removeClass("is-current");
                activeTocItem = toActive
                activeTocItem.addClass("is-current");
            }
        
            initIntersectionObserver($(document).height() * 2);
            headerElems.each(function (index, obj) {
                obj.toc_id = index;
                scrollObserver.observe(obj);
            })
        });</script></div><div class="card widget"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="is-rounded" src="/img/toudong.jpg" alt="逸尘秀"></figure><p class="title is-size-4 is-block line-height-inherit">逸尘秀</p><p class="is-size-6 is-block">只此一生 ， 必须快乐 ！</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>深圳</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">136</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">17</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">55</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://weibo.com/u/6155656382" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-white is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/zhi666"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-white is-marginless" target="_blank" rel="noopener" title="Weibo" href="https://weibo.com/u/6155656382"><i class="fab fa-weibo"></i></a><a class="level-item button is-transparent is-white is-marginless" target="_blank" rel="noopener" title="Email" href="mailto:1378373724@qq.com"><i class="fa fa-envelope"></i></a><a class="level-item button is-transparent is-white is-marginless" target="_blank" rel="noopener" title="Next" href="https://zhi666.github.io/remove.io"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-white is-marginless" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a></div><div><hr><p id="hitokoto">:D 一言句子获取中...</p><script type="text/javascript" defer>function getYiyan(){
                                $.getJSON("https://v1.hitokoto.cn/", function (data) {
                                if(data){
                                    $('#hitokoto').html("");
                                    $('#hitokoto').append("<strong style='color: #3273dc;'>"+data.hitokoto+"</strong>"+
                                    "<p>"+"来源《"+data.from+"》</p><p>提供者-"+data.creator+"</p>");
                                }});}
                                $(function (){getYiyan();$('#hitokoto').click(function(){getYiyan();})});</script></div></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新评论</h3><span class="body_hot_comment">加载中，最新评论有1分钟缓存...</span></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content size-small"><p><time dateTime="2023-11-01T02:25:44.578Z">2023-11-01</time></p><p class="title is-6"><a class="link-muted" href="/2023/11/01/selenlium%E6%89%B9%E9%87%8F%E6%B7%BB%E5%8A%A0dns%E5%9F%9F%E5%90%8D/">批量添加dns域名解析</a></p><p class="is-uppercase"><i class="fas fa-folder-open has-text-grey"> </i><a class="link-muted" href="/categories/python/">python</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2023-05-17T01:45:36.000Z">2023-05-17</time></p><p class="title is-6"><a class="link-muted" href="/2023/05/17/Kubernetes%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2/">Kubernetes高可用集群二进制部署</a></p><p class="is-uppercase"><i class="fas fa-folder-open has-text-grey"> </i><a class="link-muted" href="/categories/linux3/">linux3</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2023-05-10T06:25:36.000Z">2023-05-10</time></p><p class="title is-6"><a class="link-muted" href="/2023/05/10/Prometheus%E4%BD%BF%E7%94%A8%E6%89%8B%E6%9C%BA%E7%94%B5%E8%AF%9D_%E7%9F%AD%E4%BF%A1%E6%8E%A5%E6%94%B6%E5%91%8A%E8%AD%A6%E9%80%9A%E7%9F%A5/">Prometheus使用手机电话_短信接收告警通知</a></p><p class="is-uppercase"><i class="fas fa-folder-open has-text-grey"> </i><a class="link-muted" href="/categories/linux2/">linux2</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2023-05-10T06:22:36.000Z">2023-05-10</time></p><p class="title is-6"><a class="link-muted" href="/2023/05/10/Prometheus%E4%BD%BF%E7%94%A8%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%8E%A5%E6%94%B6%E5%91%8A%E8%AD%A6%E9%80%9A%E7%9F%A5/">Prometheus使用企业微信接收告警通知</a></p><p class="is-uppercase"><i class="fas fa-folder-open has-text-grey"> </i><a class="link-muted" href="/categories/linux2/">linux2</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2023-05-10T06:20:36.000Z">2023-05-10</time></p><p class="title is-6"><a class="link-muted" href="/2023/05/10/Prometheus%E4%BD%BF%E7%94%A8%E4%BC%81%E4%B8%9A%E9%92%89%E9%92%89%E5%91%8A%E8%AD%A6%E9%80%9A%E7%9F%A5/">Prometheus使用企业钉钉接收告警通知</a></p><p class="is-uppercase"><i class="fas fa-folder-open has-text-grey"> </i><a class="link-muted" href="/categories/linux2/">linux2</a></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/English/"><span class="level-start"><span class="level-item">English</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/HTML/"><span class="level-start"><span class="level-item">HTML</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/JS/"><span class="level-start"><span class="level-item">JS</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/html/"><span class="level-start"><span class="level-item">html</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/linux1/"><span class="level-start"><span class="level-item">linux1</span></span><span class="level-end"><span class="level-item tag">15</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/linux2/"><span class="level-start"><span class="level-item">linux2</span></span><span class="level-end"><span class="level-item tag">33</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/linux3/"><span class="level-start"><span class="level-item">linux3</span></span><span class="level-end"><span class="level-item tag">27</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/python/"><span class="level-start"><span class="level-item">python</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/web/"><span class="level-start"><span class="level-item">web</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/work/"><span class="level-start"><span class="level-item">work</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><a class="level is-mobile is-marginless" href="/categories/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/archives/2023/11/"><span class="level-start"><span class="level-item">十一月 2023</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2023/05/"><span class="level-start"><span class="level-item">五月 2023</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2023/04/"><span class="level-start"><span class="level-item">四月 2023</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2023/02/"><span class="level-start"><span class="level-item">二月 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2022/06/"><span class="level-start"><span class="level-item">六月 2022</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><a class="level is-mobile is-marginless" href="/archives/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/linux/"><span class="tag">linux</span><span class="tag is-grey-lightest">18</span></a></div><div class="control"><a class="tags has-addons" href="/tags/docker/"><span class="tag">docker</span><span class="tag is-grey-lightest">16</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Prometheus/"><span class="tag">Prometheus</span><span class="tag is-grey-lightest">14</span></a></div><div class="control"><a class="tags has-addons" href="/tags/html/"><span class="tag">html</span><span class="tag is-grey-lightest">14</span></a></div><div class="control"><a class="tags has-addons" href="/tags/python/"><span class="tag">python</span><span class="tag is-grey-lightest">12</span></a></div><div class="control"><a class="tags has-addons" href="/tags/web/"><span class="tag">web</span><span class="tag is-grey-lightest">12</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nginx/"><span class="tag">nginx</span><span class="tag is-grey-lightest">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mysql/"><span class="tag">mysql</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%AE%B9%E5%99%A8/"><span class="tag">容器</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"><span class="tag">数据库</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/"><span class="tag">科学上网</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/work/"><span class="tag">work</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%87%AA%E5%8A%A8%E5%8C%96/"><span class="tag">自动化</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8D%9A%E5%AE%A2/"><span class="tag">博客</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%B7%A5%E4%BD%9C/"><span class="tag">工作</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%B7%A5%E5%85%B7/"><span class="tag">工具</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ssl/"><span class="tag">ssl</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/"><span class="tag">文件系统</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%97%A5%E5%BF%97/"><span class="tag">日志</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%97%A5%E5%BF%97%E5%8A%A0%E5%AF%86/"><span class="tag">日志加密</span><span class="tag is-grey-lightest">3</span></a></div></div><div class="field is-grouped is-grouped-multiline"><a class="tags has-addons" href="/tags/"><span class="tag">查看全部&gt;&gt;</span></a></div></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=zhi666FeedsId&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="zhi666FeedsId" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button is-primary" type="submit" value="订阅"></div></div><p class="help">输入邮箱开始订阅，更博后邮件通知！</p></form></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.png" alt="逸尘秀" height="28"></a><p class="size-small"><span>&copy; 2023 yichen</span>  Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a>,Modify by <a href="https://github.com/removeif/hexo-theme-amazing" target="_blank">removeif</a> <br><span>© 版权说明：[本网站所有内容均收集于互联网或自己创作,<br />&nbsp;&nbsp;&nbsp;&nbsp;方便于网友与自己学习交流，如有侵权，请<a href="/message" target="_blank">留言</a>，立即处理]<br /></span><span><span id="statistic-times">loading...</span><script>function createTime(time) {
            var n = new Date(time);
            now.setTime(now.getTime() + 250),
                days = (now - n) / 1e3 / 60 / 60 / 24,
                dnum = Math.floor(days),
                hours = (now - n) / 1e3 / 60 / 60 - 24 * dnum,
                hnum = Math.floor(hours),
            1 == String(hnum).length && (hnum = "0" + hnum),
                minutes = (now - n) / 1e3 / 60 - 1440 * dnum - 60 * hnum,
                mnum = Math.floor(minutes),
            1 == String(mnum).length && (mnum = "0" + mnum),
                seconds = (now - n) / 1e3 - 86400 * dnum - 3600 * hnum - 60 * mnum,
                snum = Math.round(seconds),
            1 == String(snum).length && (snum = "0" + snum),
                document.getElementById("statistic-times").innerHTML = "❤️本站自 <strong>"+time.split(" ")[0].replace(/\//g,".")+"</strong> 已运行 <strong>" + dnum + "</strong> 天 <strong>" + hnum + "</strong> 小时 <strong>" + mnum + "</strong> 分 <strong>" + snum + "</strong> 秒！❤️";
        }var now = new Date();setInterval("createTime('2020/08/02 00:00:00')", 250,"");</script><br></span><div class="size-small"><span>❤️感谢 <strong><span id="busuanzi_value_site_uv">99+</span></strong> 小伙伴的 <strong><span id="busuanzi_value_site_pv">99+</span></strong> 次光临！❤️</span></div></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/zhi666"><i class="fab fa-github"></i></a></p></div><div class="sideMusic"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="/js/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><meting-js style="width: auto;height: 2000px;" server="netease" type="playlist" id="2364053447" theme="#2980b9" loop="all" autoplay="false" order="list" storageName="aplayer-setting" lrctype="0" list-max-height="400px" fixed="true"></meting-js></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            site: {
                url: 'https://yc6.cool',
                external_link: {"enable":true,"exclude":[]}
            },
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" defer></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back-to-top.js" defer></script><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.12/js/lightgallery-all.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer></script><!--!--><!--!--><!--!--><script src="/js/toc.js" defer></script><script src="/js/main.js" defer></script><script>$.getScript('/js/comment-issue-data.js',function(){loadIssueData('1b861f81e9a79ee6028d','cc629aff090aa9c60d5e13ddf7fcfce14f00a478','zhi666','issue_database',false);})</script><link rel="stylesheet" href="/css/insight.css"><div class="searchbox ins-search"><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"><input class="searchbox-input ins-search-input" type="text" placeholder="想要查找什么..."><span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"></div></div></div></div><script>(function (window) {
            var INSIGHT_CONFIG = {
                TRANSLATION: {
                    POSTS: '文章',
                    PAGES: '页面',
                    CATEGORIES: '分类',
                    TAGS: '标签',
                    UNTITLED: '(无标题)',
                },
                CONTENT_URL: '/content.json',
            };
            window.INSIGHT_CONFIG = INSIGHT_CONFIG;
        })(window);</script><script src="/js/insight.js" defer></script></body></html>